name: Agent Builder (Context Aware)

on:
  issue_comment:
    types: [created]

jobs:
  builder:
    if: contains(github.event.comment.body, '/code-zhangxiaohao-agent')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate File Tree
        id: file_tree
        run: |
          TREE=$(find . -maxdepth 5 -not -path '*/.*' -not -path '*/node_modules*' -not -path '*/dist*' -not -path '*/build*' -not -path '*/.next*' | sed 's|./||' | sort)
          echo "TREE<<EOF" >> $GITHUB_ENV
          echo "$TREE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Execute Frontend Implementation
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          PROJECT_TREE: ${{ env.TREE }}
        with:
          script: |
            const projectTree = process.env.PROJECT_TREE;
            const existingFiles = new Set(projectTree.split('\n').filter(f => f.trim()));
            
            // é¡¹ç›®ç»“æ„è§„èŒƒ
            const PROJECT_STRUCTURE = {
              pages: 'frontend/app',
              components: 'frontend/components',
              uiComponents: 'frontend/components/ui',
              featureComponents: 'frontend/components/features',
              hooks: 'frontend/hooks',
              lib: 'frontend/lib',
              types: 'frontend/types',
              validExtensions: ['.tsx', '.ts', '.css', '.json'],
              protectedFiles: ['frontend/app/layout.tsx', 'frontend/app/globals.css', 'frontend/package.json']
            };

            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            const fileExists = async (path) => {
              try {
                await github.rest.repos.getContent({ ...context.repo, path });
                return true;
              } catch (e) {
                return false;
              }
            };

            // è¯»å–æ–‡ä»¶å†…å®¹
            const readFileContent = async (path) => {
              try {
                const { data } = await github.rest.repos.getContent({ ...context.repo, path });
                if (data.size < 80000 && data.content) {
                  return Buffer.from(data.content, 'base64').toString();
                }
              } catch (e) {}
              return null;
            };

            // éªŒè¯è·¯å¾„æ˜¯å¦ç¬¦åˆé¡¹ç›®è§„èŒƒï¼ˆæ”¯æŒçˆ¶çº§è§„èŒƒè¦†ç›–ï¼‰
            const validatePath = (path, parentSpecText = '') => {
              const errors = [];
              
              // æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨çˆ¶çº§è§„èŒƒä¸­è¢«æ˜ç¡®æåŠï¼ˆå¦‚æœæ˜¯ï¼Œåˆ™å…è®¸ï¼‰
              const isInParentSpec = parentSpecText && (
                parentSpecText.includes(path) || 
                parentSpecText.includes(path.replace('frontend/', ''))
              );
              
              // é¡µé¢æ–‡ä»¶å¿…é¡»åœ¨ app/ ç›®å½•
              if (path.includes('/page.tsx') && !path.startsWith('frontend/app/')) {
                if (!isInParentSpec) {
                  errors.push(`é¡µé¢æ–‡ä»¶å¿…é¡»åœ¨ frontend/app/ ç›®å½•: ${path}`);
                }
              }
              
              // ç»„ä»¶ä¸èƒ½ç›´æ¥æ”¾åœ¨ app/ ç›®å½•ï¼ˆé™¤äº† page.tsx, layout.tsx ç­‰ï¼‰
              const appOnlyFiles = ['page.tsx', 'layout.tsx', 'loading.tsx', 'error.tsx', 'not-found.tsx', 'template.tsx'];
              if (path.startsWith('frontend/app/') && path.endsWith('.tsx')) {
                const fileName = path.split('/').pop();
                if (!appOnlyFiles.includes(fileName) && !isInParentSpec) {
                  errors.push(`ç»„ä»¶ä¸åº”æ”¾åœ¨ app/ ç›®å½•ï¼Œåº”æ”¾åœ¨ components/: ${path}`);
                }
              }
              
              // UI ç»„ä»¶åº”æ”¾åœ¨ components/ui/
              if (path.includes('Button') || path.includes('Input') || path.includes('Modal') || path.includes('Dialog')) {
                if (!path.includes('components/ui/') && !path.includes('components/features/') && !isInParentSpec) {
                  errors.push(`UI ç»„ä»¶åº”æ”¾åœ¨ components/ui/ æˆ– components/features/: ${path}`);
                }
              }
              
              return errors;
            };

            // 1. è¯»å–å½“å‰ issue çš„è¯„è®º
            console.log("ğŸ“¥ è¯»å–å½“å‰ issue çš„è¯„è®º...");
            const comments = await github.rest.issues.listComments({
              ...context.repo,
              issue_number: context.issue.number
            });
            
            // è¯†åˆ«å‰ç«¯è§„èŒƒå’Œå‰ç«¯æ–¹æ¡ˆçš„æ ‡è®°
            const frontendSpecMarkers = [
              /å‰ç«¯è§„èŒƒ/i,
              /å‰ç«¯çº¦æŸ/i,
              /frontend spec/i,
              /frontend constraint/i,
              /\[å‰ç«¯è§„èŒƒ\]/i,
              /\[å‰ç«¯çº¦æŸ\]/i,
              /## å‰ç«¯è§„èŒƒ/i,
              /## å‰ç«¯çº¦æŸ/i
            ];
            
            const frontendPlanMarkers = [
              /ğŸ—ï¸\s*å‰ç«¯å®æ–½æ–¹æ¡ˆ/i,
              /ğŸ—ï¸\s*å‰ç«¯å®æ–½è®¡åˆ’/i,
              /å‰ç«¯å®æ–½æ–¹æ¡ˆ/i,
              /å‰ç«¯å®æ–½è®¡åˆ’/i,
              /frontend implementation plan/i,
              /frontend implementation/i
            ];
            
            // è¯†åˆ«åˆ†æ”¯ç­–ç•¥çš„æ ‡è®°
            const branchMarkers = [
              /ä½¿ç”¨åˆ†æ”¯[\s:ï¼š]+([^\s\n]+)/i,
              /åœ¨åˆ†æ”¯[\s:ï¼š]+([^\s\n]+)/i,
              /åˆ†æ”¯[\s:ï¼š]+([^\s\n]+)/i,
              /branch[\s:ï¼š]+([^\s\n]+)/i,
              /ä½¿ç”¨[\s:ï¼š]+([^\s\n]+)\s*åˆ†æ”¯/i,
              /åŸºäº[\s:ï¼š]+([^\s\n]+)\s*åˆ†æ”¯/i,
              /zhangxiaohao\/issue-(\d+)/i
            ];
            
            // ä»å½“å‰ issue çš„è¯„è®ºä¸­æå–å‰ç«¯è§„èŒƒã€å‰ç«¯æ–¹æ¡ˆå’Œåˆ†æ”¯ä¿¡æ¯
            let frontendSpec = '';
            let frontendPlan = '';
            let branchFromComment = null; // ä»è¯„è®ºä¸­æå–çš„åˆ†æ”¯ä¿¡æ¯
            const generalComments = [];
            
            // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ—©çš„åœ¨å‰ï¼‰
            const sortedComments = comments.data.sort((a, b) => 
              new Date(a.created_at) - new Date(b.created_at)
            );
            
            sortedComments.forEach(comment => {
              const hasSpec = frontendSpecMarkers.some(marker => marker.test(comment.body));
              const hasPlan = frontendPlanMarkers.some(marker => marker.test(comment.body));
              
              // æ£€æŸ¥æ˜¯å¦åŒ…å«åˆ†æ”¯ä¿¡æ¯ï¼ˆåé¢çš„è¯„è®ºä¼˜å…ˆçº§æ›´é«˜ï¼‰
              let branchMatch = null;
              for (const marker of branchMarkers) {
                const match = comment.body.match(marker);
                if (match) {
                  branchMatch = match;
                  break;
                }
              }
              
              if (hasSpec) {
                // æå–å‰ç«¯è§„èŒƒï¼ˆåé¢çš„ä¼šè¦†ç›–å‰é¢çš„ï¼‰
                frontendSpec = comment.body;
                console.log(`ğŸ“‹ å‘ç°å‰ç«¯è§„èŒƒ: ${comment.html_url}`);
              } else if (hasPlan) {
                // æå–å‰ç«¯æ–¹æ¡ˆï¼ˆåé¢çš„ä¼šè¦†ç›–å‰é¢çš„ï¼‰
                frontendPlan = comment.body;
                console.log(`ğŸ“‹ å‘ç°å‰ç«¯æ–¹æ¡ˆ: ${comment.html_url}`);
              } else if (branchMatch) {
                // æå–åˆ†æ”¯ä¿¡æ¯ï¼ˆåé¢çš„ä¼šè¦†ç›–å‰é¢çš„ï¼‰
                const branchValue = branchMatch[1].trim();
                // å¦‚æœæ˜¯ issue å·ï¼Œè½¬æ¢ä¸ºåˆ†æ”¯å
                if (/^\d+$/.test(branchValue)) {
                  branchFromComment = `zhangxiaohao/issue-${branchValue}`;
                } else if (branchValue.startsWith('zhangxiaohao/issue-')) {
                  branchFromComment = branchValue;
                } else {
                  branchFromComment = branchValue;
                }
                console.log(`ğŸ”— ä»è¯„è®ºä¸­å‘ç°åˆ†æ”¯ä¿¡æ¯: ${branchFromComment} (${comment.html_url})`);
              } else {
                // ä¿ç•™æ™®é€šè¯„è®º
                generalComments.push(comment);
              }
            });
            
            const discussionHistory = generalComments
              .map(c => `[User: ${c.user.login}]:\n${c.body}`)
              .join("\n\n---\n\n");
            
            // åˆå¹¶æ‰€æœ‰æ–‡æœ¬æ¥æºï¼ˆç”¨äºæ–‡ä»¶è·¯å¾„è¯†åˆ«ï¼‰
            const fullDiscussionText = comments.data.map(c => c.body).join('\n') + '\n' + process.env.ISSUE_BODY;
            let contextBody = process.env.ISSUE_BODY;
            if (frontendSpec) {
              contextBody += '\n\n--- [å‰ç«¯è§„èŒƒ] ---\n' + frontendSpec;
            }
            if (frontendPlan) {
              contextBody += '\n\n--- [å‰ç«¯æ–¹æ¡ˆ] ---\n' + frontendPlan;
            }

            // 2. è¯»å–çˆ¶çº§ issue åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚æœå½“å‰ issue æ²¡æœ‰å‰ç«¯è§„èŒƒå’Œå‰ç«¯æ–¹æ¡ˆï¼Œåˆ™ä»çˆ¶çº§ issue çš„è¯„è®ºä¸­æå–
            let parentSpec = '';
            const parentRegex = /(?:Parent|Ref|çˆ¶ä»»åŠ¡|çˆ¶çº§|çˆ¶éœ€æ±‚|å…³è”çˆ¶éœ€æ±‚)[\s:ï¼š]+#(\d+)/i;
            const parentMatch = contextBody.match(parentRegex) || process.env.ISSUE_BODY.match(parentRegex);
            
            if (parentMatch) {
              try {
                const parentId = parentMatch[1];
                console.log(`ğŸ”— è¯»å–çˆ¶çº§ issue: #${parentId}`);
                
                // è¯»å–çˆ¶çº§ issue çš„åŸºæœ¬ä¿¡æ¯ï¼ˆbodyï¼‰
                const p = await github.rest.issues.get({ ...context.repo, issue_number: parentId });
                parentSpec = p.data.body || '';
                
                // å¦‚æœå½“å‰ issue çš„è¯„è®ºä¸­æ²¡æœ‰å‰ç«¯è§„èŒƒå’Œå‰ç«¯æ–¹æ¡ˆï¼Œåˆ™ä»çˆ¶çº§ issue çš„è¯„è®ºä¸­æå–
                if (!frontendSpec && !frontendPlan) {
                  console.log(`ğŸ“‹ å½“å‰ issue æ²¡æœ‰å‰ç«¯è§„èŒƒå’Œå‰ç«¯æ–¹æ¡ˆï¼Œå°è¯•ä»çˆ¶çº§ issue è¯„è®ºä¸­æå–...`);
                  
                  // è¯»å–çˆ¶çº§ issue çš„è¯„è®º
                  const parentComments = await github.rest.issues.listComments({
                    ...context.repo,
                    issue_number: parentId
                  });
                  
                  // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ—©çš„åœ¨å‰ï¼‰
                  const sortedParentComments = parentComments.data.sort((a, b) => 
                    new Date(a.created_at) - new Date(b.created_at)
                  );
                  
                  sortedParentComments.forEach(comment => {
                    const hasSpec = frontendSpecMarkers.some(marker => marker.test(comment.body));
                    const hasPlan = frontendPlanMarkers.some(marker => marker.test(comment.body));
                    
                    if (hasSpec && !frontendSpec) {
                      // æå–çˆ¶çº§å‰ç«¯è§„èŒƒï¼ˆåé¢çš„ä¼šè¦†ç›–å‰é¢çš„ï¼‰
                      frontendSpec = comment.body;
                      console.log(`ğŸ“‹ ä»çˆ¶çº§ issue å‘ç°å‰ç«¯è§„èŒƒ: ${comment.html_url}`);
                    } else if (hasPlan && !frontendPlan) {
                      // æå–çˆ¶çº§å‰ç«¯æ–¹æ¡ˆï¼ˆåé¢çš„ä¼šè¦†ç›–å‰é¢çš„ï¼‰
                      frontendPlan = comment.body;
                      console.log(`ğŸ“‹ ä»çˆ¶çº§ issue å‘ç°å‰ç«¯æ–¹æ¡ˆ: ${comment.html_url}`);
                    }
                  });
                  
                  // æ›´æ–° contextBodyï¼ˆå¦‚æœä»çˆ¶çº§æå–åˆ°äº†è§„èŒƒå’Œæ–¹æ¡ˆï¼‰
                  if (frontendSpec) {
                    contextBody += '\n\n--- [å‰ç«¯è§„èŒƒï¼ˆæ¥è‡ªçˆ¶çº§ Issueï¼‰] ---\n' + frontendSpec;
                  }
                  if (frontendPlan) {
                    contextBody += '\n\n--- [å‰ç«¯æ–¹æ¡ˆï¼ˆæ¥è‡ªçˆ¶çº§ Issueï¼‰] ---\n' + frontendPlan;
                  }
                }
                
                if (parentSpec) {
                  contextBody += '\n\n--- [çˆ¶çº§ Issue åŸºæœ¬ä¿¡æ¯] ---\n' + parentSpec;
                  console.log(`âœ… å·²è¯»å–çˆ¶çº§ issue åŸºæœ¬ä¿¡æ¯ï¼Œé•¿åº¦: ${parentSpec.length} å­—ç¬¦`);
                }
              } catch(e) {
                console.log(`âš ï¸ è¯»å–çˆ¶çº§ issue å¤±è´¥: ${e.message}`);
              }
            }

            // 3. æ™ºèƒ½æ–‡ä»¶è·¯å¾„è¯†åˆ«ï¼ˆå¢å¼ºç‰ˆï¼‰
            console.log("ğŸ” æ‰«æç›¸å…³æ–‡ä»¶...");
            
            // åˆå¹¶æ‰€æœ‰æ–‡æœ¬æ¥æºï¼ˆåŒ…æ‹¬çˆ¶çº§è§„èŒƒï¼‰
            const allTextSources = fullDiscussionText + '\n' + (parentSpec || '');
            
            // å¤šç§è·¯å¾„æ ¼å¼åŒ¹é…ï¼ˆæ”¯æŒ app/(main) ç­‰è·¯ç”±ç»„ï¼‰
            const pathPatterns = [
              /(?:frontend|src)\/[\w\-\.\/\(\)]+\.(?:tsx|ts|css|json)/g,
              /app\/[\w\-\.\/\(\)]+\.(?:tsx|ts)/g,
              /components\/[\w\-\.\/]+\.(?:tsx|ts)/g,
              /hooks\/[\w\-\.\/]+\.(?:tsx|ts)/g,
              /lib\/[\w\-\.\/]+\.(?:tsx|ts)/g,
              /types\/[\w\-\.\/]+\.(?:tsx|ts)/g
            ];
            
            let foundPaths = new Set();
            for (const pattern of pathPatterns) {
              // ä»æ‰€æœ‰æ–‡æœ¬æ¥æºä¸­åŒ¹é…
              const matches = allTextSources.match(pattern) || [];
              matches.forEach(p => {
                // æ ‡å‡†åŒ–è·¯å¾„
                let normalized = p;
                if (!normalized.startsWith('frontend/') && !normalized.startsWith('src/')) {
                  normalized = 'frontend/' + normalized;
                }
                foundPaths.add(normalized);
              });
            }
            
            console.log(`ğŸ“‹ ä»çˆ¶çº§è§„èŒƒå’Œè®¨è®ºä¸­è¯†åˆ«åˆ° ${foundPaths.size} ä¸ªæ–‡ä»¶è·¯å¾„`);
            
            // æ”¶é›†ç°æœ‰æ–‡ä»¶å’Œæ–°æ–‡ä»¶
            const existingFilesContext = [];
            const newFilePaths = [];
            
            for (const path of foundPaths) {
              const exists = await fileExists(path);
              if (exists) {
                const content = await readFileContent(path);
                if (content) {
                  existingFilesContext.push({ path, content, action: 'MODIFY' });
                  console.log(`ğŸ“„ [å­˜åœ¨] ${path}`);
                  
                  // è‡ªåŠ¨å‘ç°å…³è”æ–‡ä»¶ï¼ˆimport è¯­å¥ï¼‰
                  const importRegex = /from\s+['"](@\/|\.\.\/|\.\/)([^'"]+)['"]/g;
                  let match;
                  while ((match = importRegex.exec(content)) !== null) {
                    let importPath = match[2];
                    if (!importPath.endsWith('.tsx') && !importPath.endsWith('.ts')) {
                      importPath += '.tsx';
                    }
                    if (match[1] === '@/') {
                      importPath = 'frontend/' + importPath;
                    }
                    if (!foundPaths.has(importPath)) {
                      const importExists = await fileExists(importPath);
                      if (importExists) {
                        const importContent = await readFileContent(importPath);
                        if (importContent) {
                          existingFilesContext.push({ path: importPath, content: importContent, action: 'REFERENCE' });
                          console.log(`ğŸ“„ [å…³è”] ${importPath}`);
                        }
                      }
                    }
                  }
                }
              } else {
                newFilePaths.push(path);
                console.log(`ğŸ†• [æ–°å»º] ${path}`);
              }
            }

            // 4. è¯»å–å…³é”®ä¸Šä¸‹æ–‡æ–‡ä»¶
            const criticalFiles = ['frontend/app/layout.tsx', 'frontend/app/globals.css'];
            for (const path of criticalFiles) {
              if (!existingFilesContext.find(f => f.path === path)) {
                const content = await readFileContent(path);
                if (content) {
                  existingFilesContext.push({ path, content, action: 'REFERENCE' });
                }
              }
            }

            // è¯»å– package.json
            let packageJsonContent = "{}";
            const pkgPath = await fileExists('frontend/package.json') ? 'frontend/package.json' : 'package.json';
            const pkgContent = await readFileContent(pkgPath);
            if (pkgContent) packageJsonContent = pkgContent;

            // è¯»å–å‰ç«¯å¼€å‘è§„èŒƒæ–‡æ¡£
            let styleGuideContent = '';
            const styleGuidePath = 'frontend/STYLE_GUIDE.md';
            const styleGuideExists = await fileExists(styleGuidePath);
            if (styleGuideExists) {
              const styleGuide = await readFileContent(styleGuidePath);
              if (styleGuide) {
                // ç›´æ¥ä½¿ç”¨åŸå§‹å†…å®¹ï¼Œä¸éœ€è¦è½¬ä¹‰
                styleGuideContent = styleGuide;
                console.log('ğŸ“š å·²è¯»å–å‰ç«¯å¼€å‘è§„èŒƒæ–‡æ¡£: ' + styleGuidePath);
              }
            }

            // 5. æ„å»ºç»“æ„åŒ– Prompt
            const existingFilesStr = existingFilesContext.map(f => 
              '### ' + f.action + ': ' + f.path + '\n```\n' + f.content + '\n```'
            ).join('\n\n');

            const newFilesList = newFilePaths.length > 0 ? newFilePaths.map(p => '- ' + p).join('\n') : 'æ— ';
            
            // 5.5. ç¡®å®šåˆ†æ”¯åï¼ˆä¼˜å…ˆçº§ï¼šè¯„è®ºä¸­çš„åˆ†æ”¯ä¿¡æ¯ > å½“å‰issueåˆ†æ”¯ï¼‰
            let branchName = `zhangxiaohao/issue-${context.issue.number}`;
            
            // ä¼˜å…ˆçº§1ï¼šå¦‚æœè¯„è®ºä¸­æŒ‡å®šäº†åˆ†æ”¯ï¼Œä½¿ç”¨è¯„è®ºä¸­çš„åˆ†æ”¯
            if (branchFromComment) {
              branchName = branchFromComment;
              console.log(`ğŸ”— ä½¿ç”¨è¯„è®ºä¸­æŒ‡å®šçš„åˆ†æ”¯: ${branchName}`);
            } else {
              // ä¼˜å…ˆçº§2ï¼šä½¿ç”¨å½“å‰issueçš„åˆ†æ”¯ï¼ˆé»˜è®¤ï¼‰
              console.log(`ğŸ”— ä½¿ç”¨å½“å‰issueçš„åˆ†æ”¯: ${branchName}`);
            }
            
            // æ£€æŸ¥æ–‡ä»¶åœ¨å½“å‰åˆ†æ”¯æ˜¯å¦å­˜åœ¨
            const fileExistsInBranch = async (path, branch) => {
              try {
                await github.rest.repos.getContent({ 
                  ...context.repo, 
                  path,
                  ref: branch
                });
                return true;
              } catch (e) {
                return false;
              }
            };
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºé¡µé¢ï¼šä»éœ€æ±‚æè¿°ã€å‰ç«¯è§„èŒƒå’Œæ–¹æ¡ˆä¸­æå–é¡µé¢è·¯å¾„ï¼ˆåœ¨ç¡®å®šåˆ†æ”¯åï¼‰
            let requiredPagePath = null;
            const pagePathPatterns = [
              /frontend\/app\/\(main\)\/[\w\-\.\/]+page\.tsx/g,
              /frontend\/app\/[\w\-\.\/]+page\.tsx/g,
              /app\/\(main\)\/[\w\-\.\/]+page\.tsx/g,
              /app\/[\w\-\.\/]+page\.tsx/g
            ];
            
            // ä»æ‰€æœ‰æ–‡æœ¬æ¥æºä¸­æŸ¥æ‰¾é¡µé¢è·¯å¾„
            const allTextForPageCheck = (frontendSpec || '') + '\n' + (frontendPlan || '') + '\n' + contextBody + '\n' + newFilesList;
            for (const pattern of pagePathPatterns) {
              const matches = allTextForPageCheck.match(pattern);
              if (matches && matches.length > 0) {
                // æ‰¾åˆ°ç¬¬ä¸€ä¸ªé¡µé¢è·¯å¾„
                let foundPath = matches[0];
                if (!foundPath.startsWith('frontend/')) {
                  foundPath = 'frontend/' + foundPath;
                }
                // æ£€æŸ¥é¡µé¢æ˜¯å¦åœ¨å½“å‰åˆ†æ”¯å·²å­˜åœ¨ï¼ˆè€Œä¸æ˜¯ main åˆ†æ”¯ï¼‰
                const pageExists = await fileExistsInBranch(foundPath, branchName);
                if (!pageExists) {
                  requiredPagePath = foundPath;
                  console.log(`ğŸ“„ æ£€æµ‹åˆ°éœ€è¦åˆ›å»ºçš„é¡µé¢: ${requiredPagePath} (åœ¨å½“å‰åˆ†æ”¯ ${branchName} ä¸å­˜åœ¨)`);
                  break;
                } else {
                  console.log(`ğŸ“„ é¡µé¢å·²å­˜åœ¨: ${foundPath} (åœ¨å½“å‰åˆ†æ”¯ ${branchName})`);
                }
              }
            }
            
            // æ„å»ºé¡µé¢æ£€æŸ¥æç¤º
            let pageCheckNote = '';
            if (requiredPagePath) {
              pageCheckNote = '\n\nã€é‡è¦ï¼šå¿…é¡»åˆ›å»ºé¡µé¢ã€‘\n' +
                'æ£€æµ‹åˆ°éœ€æ±‚ä¸­æåˆ°äº†é¡µé¢è·¯å¾„ ' + requiredPagePath + 'ï¼Œä½†è¯¥é¡µé¢ä¸å­˜åœ¨ã€‚\n' +
                '**ä½ å¿…é¡»åˆ›å»ºè¿™ä¸ªé¡µé¢æ–‡ä»¶**ï¼Œå¦åˆ™åŠŸèƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‚\n' +
                'è¯·ç¡®ä¿åœ¨è¾“å‡ºä¸­åŒ…å«ï¼š\n' +
                '### CREATE: ' + requiredPagePath + '\n' +
                '```tsx\n' +
                '(å®Œæ•´çš„é¡µé¢ä»£ç )\n' +
                '```\n';
            } else if (newFilesList.includes('page.tsx') || contextBody.includes('é¡µé¢') || contextBody.includes('page') || frontendSpec.includes('é¡µé¢') || frontendPlan.includes('é¡µé¢')) {
              // å¦‚æœæåˆ°äº†é¡µé¢ä½†æ²¡æœ‰æ‰¾åˆ°å…·ä½“è·¯å¾„ï¼Œæé†’ AI æ£€æŸ¥
              pageCheckNote = '\n\nã€é¡µé¢æ£€æŸ¥ã€‘\n' +
                'éœ€æ±‚ä¸­æåˆ°äº†é¡µé¢ç›¸å…³çš„å†…å®¹ï¼Œè¯·æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºæ–°çš„é¡µé¢æ–‡ä»¶ã€‚\n' +
                'å¦‚æœéœ€è¦åˆ›å»ºé¡µé¢ï¼Œè¯·ä½¿ç”¨æ­£ç¡®çš„è·¯å¾„æ ¼å¼ï¼ˆå¦‚ frontend/app/(main)/video/page.tsxï¼‰ã€‚\n' +
                '**å¦‚æœå‰ç«¯è§„èŒƒæˆ–å‰ç«¯æ–¹æ¡ˆä¸­æåˆ°äº†é¡µé¢è·¯å¾„ï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§è§„èŒƒåˆ›å»ºé¡µé¢**ã€‚\n';
            }
            
            // æ„å»ºå‰ç«¯è§„èŒƒå’Œæ–¹æ¡ˆæç¤ºï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
            let frontendSpecNote = '';
            if (frontendSpec || frontendPlan) {
              frontendSpecNote = '\n\nã€å‰ç«¯è§„èŒƒå’Œæ–¹æ¡ˆï¼ˆæœ€é«˜ä¼˜å…ˆçº§ - å¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ã€‘\n';
              frontendSpecNote += '**é‡è¦ï¼šä»¥ä¸‹è§„èŒƒä¼˜å…ˆçº§é«˜äºæ‰€æœ‰å…¶ä»–è§„èŒƒï¼ˆåŒ…æ‹¬åŸºç¡€å¼€å‘è§„èŒƒæ–‡æ¡£ï¼‰ã€‚å¦‚æœ‰å†²çªï¼Œå¿…é¡»ä¼˜å…ˆéµå¾ªä»¥ä¸‹è§„èŒƒã€‚**\n\n';
              if (frontendSpec) {
                // æ£€æŸ¥æ˜¯å¦æ¥è‡ªçˆ¶çº§ issueï¼ˆé€šè¿‡æ£€æŸ¥ contextBody ä¸­æ˜¯å¦åŒ…å«"æ¥è‡ªçˆ¶çº§ Issue"ï¼‰
                const isFromParent = contextBody.includes('å‰ç«¯è§„èŒƒï¼ˆæ¥è‡ªçˆ¶çº§ Issueï¼‰');
                const source = isFromParent ? 'ï¼ˆæ¥è‡ªçˆ¶çº§ Issue è¯„è®ºï¼‰' : 'ï¼ˆæ¥è‡ªå½“å‰ Issue è¯„è®ºï¼‰';
                frontendSpecNote += `**å‰ç«¯è§„èŒƒ${source}**ï¼š\n` + frontendSpec + '\n\n';
              }
              if (frontendPlan) {
                // æ£€æŸ¥æ˜¯å¦æ¥è‡ªçˆ¶çº§ issue
                const isFromParent = contextBody.includes('å‰ç«¯æ–¹æ¡ˆï¼ˆæ¥è‡ªçˆ¶çº§ Issueï¼‰');
                const source = isFromParent ? 'ï¼ˆæ¥è‡ªçˆ¶çº§ Issue è¯„è®ºï¼‰' : 'ï¼ˆæ¥è‡ªå½“å‰ Issue è¯„è®ºï¼‰';
                frontendSpecNote += `**å‰ç«¯æ–¹æ¡ˆ${source}**ï¼š\n` + frontendPlan + '\n\n';
              }
            }
            
            // æ„å»ºçˆ¶çº§è§„èŒƒæç¤º
            let parentSpecNote = '';
            if (parentSpec) {
              parentSpecNote = '\n\nã€çˆ¶çº§ Issue åŸºæœ¬ä¿¡æ¯ã€‘\n' +
                'ä»¥ä¸‹å†…å®¹æ¥è‡ªçˆ¶çº§ Issueï¼Œä¾›å‚è€ƒï¼š\n' +
                parentSpec + '\n';
            }
            
            // æ„å»ºå‰ç«¯å¼€å‘è§„èŒƒæç¤ºï¼ˆåŸºç¡€è§„èŒƒï¼Œä¼˜å…ˆçº§ä½äºè¯„è®º/Issue è§„èŒƒï¼‰
            let styleGuideNote = '';
            if (styleGuideContent) {
              const hasFrontendSpec = frontendSpec || frontendPlan;
              const priorityNote = hasFrontendSpec 
                ? '\n**æ³¨æ„ï¼šè¿™æ˜¯åŸºç¡€å¼€å‘è§„èŒƒã€‚å¦‚æœä¸Šé¢çš„å‰ç«¯è§„èŒƒå’Œæ–¹æ¡ˆä¸­æœ‰å†²çªçš„è§„èŒƒï¼Œä¼˜å…ˆéµå¾ªä¸Šé¢çš„è§„èŒƒã€‚**\n'
                : '\n**è¿™æ˜¯é¡¹ç›®çš„åŸºç¡€å‰ç«¯å¼€å‘è§„èŒƒï¼Œæ‰€æœ‰ä»£ç å¿…é¡»ä¸¥æ ¼éµå¾ªã€‚**\n';
              
              styleGuideNote = '\n\nã€å‰ç«¯å¼€å‘è§„èŒƒï¼ˆåŸºç¡€è§„èŒƒï¼‰ã€‘\n' +
                priorityNote +
                styleGuideContent + '\n\n' +
                '**åŸºç¡€è§„èŒƒè¦ç‚¹**ï¼š\n' +
                '- å¿…é¡»ä½¿ç”¨è¯­ä¹‰åŒ–çš„ Tailwind é¢œè‰²ç±»ï¼ˆå¦‚ bg-backgroundã€text-foregroundï¼‰ï¼Œç¦æ­¢ç¡¬ç¼–ç é¢œè‰²å€¼\n' +
                '- ä¸šåŠ¡é¢œè‰²å¿…é¡»ä½¿ç”¨ text-profitï¼ˆç›ˆåˆ©ï¼‰æˆ– text-lossï¼ˆäºæŸï¼‰\n' +
                '- ç»„ä»¶å¿…é¡»ä» @/components/ui å¯¼å…¥ shadcn/ui ç»„ä»¶ï¼ˆNew York é£æ ¼ï¼‰\n' +
                '- æ‰€æœ‰å‡½æ•°å’Œç»„ä»¶å¿…é¡»æœ‰å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰\n' +
                '- ä½¿ç”¨ cn() å·¥å…·å‡½æ•°åˆå¹¶ç±»å\n' +
                '- ä¼˜å…ˆä½¿ç”¨ Flexbox å’Œ Grid å¸ƒå±€ï¼Œé¿å…ä½¿ç”¨ position: relative è¿›è¡Œå¸ƒå±€\n' +
                '- éµå¾ªç›®å½•ç»“æ„è§„èŒƒ\n\n';
            }
            
            const prompt = 'ä½ æ˜¯ä¸€å Next.js å‰ç«¯ä¸“å®¶ï¼Œè´Ÿè´£æ ¹æ®éœ€æ±‚ç²¾å‡†ä¿®æ”¹æˆ–åˆ›å»ºä»£ç ã€‚\n\n' +
              'ã€é¡¹ç›®ç»“æ„è§„èŒƒï¼ˆé»˜è®¤ï¼‰ã€‘\n' +
              '- é¡µé¢æ–‡ä»¶: frontend/app/[route]/page.tsx\n' +
              '- å¸ƒå±€æ–‡ä»¶: frontend/app/[route]/layout.tsx\n' +
              '- é€šç”¨ç»„ä»¶: frontend/components/ui/\n' +
              '- ä¸šåŠ¡ç»„ä»¶: frontend/components/features/\n' +
              '- Hooks: frontend/hooks/\n' +
              '- å·¥å…·å‡½æ•°: frontend/lib/utils/\n' +
              '- ç±»å‹å®šä¹‰: frontend/types/\n' +
              frontendSpecNote +
              parentSpecNote +
              styleGuideNote +
              pageCheckNote +
              '\nã€å½“å‰ç›®å½•ç»“æ„ã€‘\n' +
              projectTree + '\n\n' +
              'ã€ç°æœ‰æ–‡ä»¶å†…å®¹ã€‘\n' +
              'ä»¥ä¸‹æ–‡ä»¶å·²å­˜åœ¨äºé¡¹ç›®ä¸­ï¼š\n' +
              existingFilesStr + '\n\n' +
              'ã€å¾…åˆ›å»ºæ–‡ä»¶è·¯å¾„ã€‘\n' +
              'ä»¥ä¸‹è·¯å¾„è¢«æåŠä½†ä¸å­˜åœ¨ï¼Œéœ€è¦æ–°å»ºï¼š\n' +
              newFilesList + '\n\n' +
              'ã€package.jsonã€‘\n' +
              packageJsonContent + '\n\n' +
              'ã€éœ€æ±‚ã€‘\n' +
              'æ ‡é¢˜ï¼š' + process.env.ISSUE_TITLE + '\n' +
              'æè¿°ï¼š' + contextBody + '\n' +
              'è®¨è®ºï¼š' + discussionHistory + '\n\n' +
              'ã€æ“ä½œè§„åˆ™ã€‘\n' +
              '1. **MODIFYï¼ˆä¿®æ”¹ç°æœ‰æ–‡ä»¶ï¼‰**ï¼š\n' +
              '   - åŸºäºç°æœ‰ä»£ç å¢é‡ä¿®æ”¹\n' +
              '   - ä¿ç•™æ‰€æœ‰ä¸æœ¬æ¬¡éœ€æ±‚æ— å…³çš„ä»£ç \n' +
              '   - ä¿ç•™æ‰€æœ‰ç°æœ‰ import è¯­å¥\n' +
              '   - ä¿ç•™æ‰€æœ‰ç°æœ‰å‡½æ•°å’Œç»„ä»¶\n' +
              '   - åªæ·»åŠ æˆ–ä¿®æ”¹éœ€æ±‚ç›¸å…³çš„éƒ¨åˆ†\n' +
              '   - è¾“å‡ºå®Œæ•´çš„å¯è¿è¡Œä»£ç \n\n' +
              '2. **CREATEï¼ˆåˆ›å»ºæ–°æ–‡ä»¶ï¼‰**ï¼š\n' +
              '   - åªæœ‰åœ¨æ–‡ä»¶ä¸å­˜åœ¨æ—¶æ‰èƒ½åˆ›å»º\n' +
              '   - **å¦‚æœçˆ¶çº§è§„èŒƒä¸­æ˜ç¡®æŒ‡å®šäº†æ–‡ä»¶è·¯å¾„ï¼ˆå¦‚ app/(main)/video/page.tsxï¼‰ï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§çˆ¶çº§è§„èŒƒæ‰§è¡Œ**\n' +
              '   - å¦‚æœçˆ¶çº§è§„èŒƒæœªæŒ‡å®šï¼Œé¡µé¢æ”¾åœ¨ frontend/app/[route]/page.tsx\n' +
              '   - ç»„ä»¶å¿…é¡»æ”¾åœ¨ frontend/components/ ä¸‹ï¼ˆæˆ–çˆ¶çº§è§„èŒƒæŒ‡å®šçš„ä½ç½®ï¼‰\n' +
              '   - æ£€æŸ¥æ˜¯å¦æœ‰å¯å¤ç”¨çš„ç°æœ‰ç»„ä»¶\n' +
              '   - **ä¼˜å…ˆä½¿ç”¨ã€å¾…åˆ›å»ºæ–‡ä»¶è·¯å¾„ã€‘ä¸­åˆ—å‡ºçš„è·¯å¾„ï¼Œè¿™äº›è·¯å¾„æ¥è‡ªçˆ¶çº§è§„èŒƒå’Œè®¨è®º**\n\n' +
              '3. **CSS å¸ƒå±€è§„èŒƒ**ï¼š\n' +
              '   - **ä¼˜å…ˆä½¿ç”¨ Flexboxï¼ˆflexï¼‰å’Œ Gridï¼ˆgridï¼‰å¸ƒå±€**ï¼Œè€Œä¸æ˜¯ç›¸å¯¹å®šä½ï¼ˆrelative positioningï¼‰\n' +
              '   - åªæœ‰åœ¨ Flexbox å’Œ Grid æ— æ³•å®ç°çš„æƒ…å†µä¸‹ï¼Œæ‰å…è®¸ä½¿ç”¨ç›¸å¯¹å®šä½ï¼ˆposition: relativeï¼‰\n' +
              '   - é¿å…ä½¿ç”¨ `position: relative` è¿›è¡Œå¸ƒå±€ï¼Œä¼˜å…ˆè€ƒè™‘ `display: flex`ã€`display: grid` ç­‰ç°ä»£å¸ƒå±€æ–¹å¼\n' +
              '   - ä½¿ç”¨ Tailwind CSS çš„å¸ƒå±€ç±»ï¼š`flex`ã€`grid`ã€`flex-col`ã€`flex-row`ã€`grid-cols-*`ã€`gap-*` ç­‰\n' +
              '   - åªæœ‰åœ¨éœ€è¦ç»å¯¹å®šä½ï¼ˆabsoluteï¼‰çš„çˆ¶å®¹å™¨æ—¶ï¼Œæ‰ä½¿ç”¨ `relative`\n\n' +
              '4. **ç¦æ­¢æ“ä½œ**ï¼š\n' +
              '   - ç¦æ­¢åˆ é™¤ç°æœ‰ä»£ç \n' +
              '   - ç¦æ­¢é‡å†™å·²å­˜åœ¨çš„æ–‡ä»¶ï¼ˆåªèƒ½ä¿®æ”¹ï¼‰\n' +
              '   - ç¦æ­¢åœ¨ app/ ç›®å½•åˆ›å»ºéé¡µé¢ç»„ä»¶\n' +
              '   - ç¦æ­¢åˆ›å»ºä¸ç°æœ‰ç»„ä»¶åŠŸèƒ½é‡å¤çš„æ–°ç»„ä»¶\n' +
              '   - **ä¸¥ç¦åœ¨ä»£ç å—å†…è¾“å‡ºä»»ä½• Markdown æ ¼å¼å†…å®¹**ï¼ˆæ ‡é¢˜ ###ã€åˆ—è¡¨ -ã€åˆ†éš”ç¬¦ --- ç­‰ï¼‰\n' +
              '   - **ä¸¥ç¦åœ¨ä»£ç å—å†…è¾“å‡ºæ–‡æ¡£è¯´æ˜ã€å®ç°è¯´æ˜ã€æ­¥éª¤è¯´æ˜ç­‰éä»£ç å†…å®¹**\n' +
              '   - **ä»£ç å—å†…åªèƒ½åŒ…å«çº¯ä»£ç ï¼Œä¸èƒ½æœ‰ä»»ä½•æ–‡å­—è¯´æ˜æˆ– Markdown æ ¼å¼**\n' +
              '   - ä»£ç å—å¿…é¡»ä»æ–‡ä»¶å¼€å¤´åˆ°ç»“å°¾çš„å®Œæ•´ä»£ç ï¼Œç»“æŸåç«‹å³å…³é—­ ```\n\n' +
              'ã€è¾“å‡ºæ ¼å¼ã€‘\n' +
              'æ¯ä¸ªæ–‡ä»¶ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼Œå¿…é¡»æ ‡æ˜æ“ä½œç±»å‹ï¼š\n\n' +
              '### MODIFY: frontend/app/xxx/page.tsx\n' +
              '```tsx\n' +
              '(å®Œæ•´çš„ä¿®æ”¹åä»£ç ï¼Œä»…ä»£ç ï¼Œæ— åˆ†éš”ç¬¦ï¼Œæ— æ–‡æ¡£è¯´æ˜)\n' +
              '```\n\n' +
              '### CREATE: frontend/components/features/xxx.tsx\n' +
              '```tsx\n' +
              '(æ–°æ–‡ä»¶çš„å®Œæ•´ä»£ç ï¼Œä»…ä»£ç ï¼Œæ— åˆ†éš”ç¬¦ï¼Œæ— æ–‡æ¡£è¯´æ˜)\n' +
              '```\n\n' +
              'å¦‚éœ€æ–°å¢ä¾èµ–ï¼š\n' +
              '### MODIFY: frontend/package.json\n' +
              '```json\n' +
              '(å®Œæ•´çš„ package.jsonï¼Œä»… JSONï¼Œæ— åˆ†éš”ç¬¦ï¼Œæ— æ–‡æ¡£è¯´æ˜)\n' +
              '```\n\n' +
              'ã€ç»å¯¹ç¦æ­¢ - ä»£ç å—å†…å®¹è§„åˆ™ã€‘\n' +
              'ä»£ç å—ï¼ˆ```tsx å’Œ ```json ä¹‹é—´çš„å†…å®¹ï¼‰å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹è§„åˆ™ï¼š\n' +
              '1. **åªèƒ½åŒ…å«å¯æ‰§è¡Œçš„ä»£ç **ï¼šTypeScript/TSX/JSON ä»£ç ï¼Œä¸èƒ½æœ‰ä»»ä½•å…¶ä»–å†…å®¹\n' +
              '2. **ç¦æ­¢ä»»ä½• Markdown æ ¼å¼**ï¼š\n' +
              '   - ç¦æ­¢ Markdown æ ‡é¢˜ï¼ˆå¦‚ ### æ ‡é¢˜ã€## æ ‡é¢˜ã€# æ ‡é¢˜ï¼‰\n' +
              '   - ç¦æ­¢ Markdown åˆ—è¡¨ï¼ˆå¦‚ - é¡¹ç›®ã€* é¡¹ç›®ã€1. é¡¹ç›®ï¼‰\n' +
              '   - ç¦æ­¢ Markdown åˆ†éš”ç¬¦ï¼ˆå¦‚ ---ã€***ï¼‰\n' +
              '   - ç¦æ­¢ Markdown æ³¨é‡Šï¼ˆå¦‚ <!-- æ³¨é‡Š -->ï¼‰\n' +
              '3. **ç¦æ­¢ä»»ä½•æ–‡æ¡£è¯´æ˜**ï¼š\n' +
              '   - ç¦æ­¢å®ç°è¯´æ˜ã€æ­¥éª¤è¯´æ˜ã€æ³¨é‡Šè¯´æ˜ç­‰æ–‡å­—æè¿°\n' +
              '   - ç¦æ­¢åœ¨ä»£ç ä¸­æ·»åŠ æ­¥éª¤1ã€æ­¥éª¤2ç­‰è¯´æ˜æ€§æ–‡å­—\n' +
              '   - ç¦æ­¢åœ¨ä»£ç æœ«å°¾æ·»åŠ ä»»ä½•è¯´æ˜æ€§å†…å®¹\n' +
              '4. **åªå…è®¸ä»£ç æ³¨é‡Š**ï¼š\n' +
              '   - åªå…è®¸ä½¿ç”¨ // æˆ– /* */ æ ¼å¼çš„ä»£ç æ³¨é‡Š\n' +
              '   - æ³¨é‡Šå¿…é¡»æ˜¯ä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œä¸èƒ½æ˜¯ç‹¬ç«‹çš„è¯´æ˜æ®µè½\n' +
              '5. **ä»£ç å—å¿…é¡»å®Œæ•´**ï¼š\n' +
              '   - ä»£ç å—å¿…é¡»ä»æ–‡ä»¶å¼€å¤´åˆ°æ–‡ä»¶ç»“å°¾çš„å®Œæ•´ä»£ç \n' +
              '   - ä»£ç å—ç»“æŸåç«‹å³å…³é—­ ```ï¼Œä¸èƒ½æœ‰ä»»ä½•åç»­å†…å®¹\n' +
              '\n' +
              'ã€ç¤ºä¾‹ - æ­£ç¡®æ ¼å¼ã€‘\n' +
              '### CREATE: frontend/app/test/page.tsx\n' +
              '```tsx\n' +
              '"use client";\n' +
              '\n' +
              'export default function TestPage() {\n' +
              '  return <div>Test</div>;\n' +
              '}\n' +
              '```\n' +
              '\n' +
              'ã€ç¤ºä¾‹ - é”™è¯¯æ ¼å¼ï¼ˆç¦æ­¢ï¼‰ã€‘\n' +
              '### CREATE: frontend/app/test/page.tsx\n' +
              '```tsx\n' +
              '"use client";\n' +
              '\n' +
              'export default function TestPage() {\n' +
              '  return <div>Test</div>;\n' +
              '}\n' +
              '\n' +
              '### ç±»å‹å¯¼å‡º  <-- ç¦æ­¢ï¼è¿™æ˜¯ Markdown æ ‡é¢˜\n' +
              '```  <-- ç¦æ­¢ï¼ä»£ç å—å†…ä¸èƒ½æœ‰ Markdown';

            console.log("ğŸ¤– è°ƒç”¨ AI...");

            const aiRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: "anthropic/claude-sonnet-4.5",
                messages: [{ role: "user", content: prompt }]
              })
            });
            
            if (!aiRes.ok) {
              const errText = await aiRes.text();
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `âŒ AI API è°ƒç”¨å¤±è´¥: ${errText.substring(0, 500)}`
              });
              throw new Error(`AI API Error: ${errText}`);
            }
            
            const aiData = await aiRes.json();
            const rawContent = aiData.choices[0].message.content;

            // 6. è§£æ AI è¾“å‡º
            console.log("ğŸ“¦ è§£ææ–‡ä»¶...");
            const files = [];
            const lines = rawContent.split('\n');
            let currentFile = null;
            let currentAction = null;
            let currentContentLines = [];
            let inCodeBlock = false;

            const cleanContent = (linesArray) => {
              let content = linesArray.join('\n').trim();
              // ç§»é™¤ä»£ç å—æ ‡è®°
              content = content.replace(/^```[\w\-\.]*\s*$/gm, '');
              content = content.replace(/^```\s*$/gm, '');
              // ç§»é™¤åˆ†éš”ç¬¦è¡Œï¼ˆ--- æˆ–ç±»ä¼¼çš„ï¼‰
              content = content.replace(/^---+[\s-]*$/gm, '');
              // ç§»é™¤ Markdown æ ‡é¢˜ï¼ˆ###, ##, #ï¼‰
              content = content.replace(/^#{1,6}\s+.+$/gm, '');
              // ç§»é™¤ Markdown åˆ—è¡¨é¡¹ï¼ˆ- , * , 1. ç­‰ï¼‰
              content = content.replace(/^[\s]*[-*+]\s+.+$/gm, '');
              content = content.replace(/^[\s]*\d+\.\s+.+$/gm, '');
              // ç§»é™¤æ–‡ä»¶æœ«å°¾çš„ç©ºè¡Œå’Œåˆ†éš”ç¬¦
              content = content.replace(/\n+---+[\s-]*\n*$/g, '');
              content = content.replace(/\n+---+[\s-]*$/g, '');
              // ç§»é™¤å¤šä½™çš„ç©ºè¡Œï¼ˆè¿ç»­3ä¸ªæˆ–ä»¥ä¸Šç©ºè¡Œï¼‰
              content = content.replace(/\n{3,}/g, '\n\n');
              return content.trim();
            };

            for (const line of lines) {
              const modifyMatch = line.trim().match(/^###\s*MODIFY:\s*(.+)$/);
              const createMatch = line.trim().match(/^###\s*CREATE:\s*(.+)$/);
              const fileMatch = line.trim().match(/^###\s*FILE:\s*(.+)$/);
              
              if (modifyMatch || createMatch || fileMatch) {
                if (currentFile) {
                  files.push({ 
                    path: currentFile, 
                    content: cleanContent(currentContentLines),
                    action: currentAction 
                  });
                }
                currentFile = (modifyMatch || createMatch || fileMatch)[1].trim();
                currentAction = modifyMatch ? 'MODIFY' : (createMatch ? 'CREATE' : 'UNKNOWN');
                currentContentLines = [];
                inCodeBlock = false;
              } else {
                currentContentLines.push(line);
              }
            }
            
            if (currentFile) {
              files.push({ 
                path: currentFile, 
                content: cleanContent(currentContentLines),
                action: currentAction 
              });
            }

            if (files.length === 0) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `âŒ AI æœªç”Ÿæˆæœ‰æ•ˆçš„æ–‡ä»¶å—ï¼Œè¯·æ£€æŸ¥éœ€æ±‚æè¿°æ˜¯å¦æ¸…æ™°ã€‚`
              });
              throw new Error("è§£æå¤±è´¥ï¼šAI æœªç”Ÿæˆä»»ä½•æœ‰æ•ˆæ–‡ä»¶å—");
            }

            // 7. éªŒè¯å’Œè¿‡æ»¤æ–‡ä»¶
            const validFiles = [];
            const warnings = [];
            
            for (const file of files) {
              // è·³è¿‡åç«¯æ–‡ä»¶
              if (file.path.endsWith('.go') || file.path.includes('backend/')) continue;
              
              // éªŒè¯è·¯å¾„ï¼ˆä¼ å…¥çˆ¶çº§è§„èŒƒï¼Œå…è®¸çˆ¶çº§è§„èŒƒè¦†ç›–é»˜è®¤è§„åˆ™ï¼‰
              const pathErrors = validatePath(file.path, parentSpec);
              if (pathErrors.length > 0) {
                warnings.push(...pathErrors);
              }
              
              // JSON æ ¡éªŒ
              if (file.path.endsWith('.json')) {
                try { 
                  JSON.parse(file.content); 
                } catch (e) { 
                  warnings.push(`JSON è¯­æ³•é”™è¯¯: ${file.path}`);
                  continue; 
                }
              }
              
              // æ£€æŸ¥ CREATE æ“ä½œçš„æ–‡ä»¶æ˜¯å¦åœ¨å½“å‰åˆ†æ”¯å·²å­˜åœ¨ï¼ˆè€Œä¸æ˜¯ main åˆ†æ”¯ï¼‰
              if (file.action === 'CREATE') {
                const exists = await fileExistsInBranch(file.path, branchName);
                if (exists) {
                  warnings.push(`æ–‡ä»¶åœ¨å½“å‰åˆ†æ”¯å·²å­˜åœ¨ï¼ŒCREATE æ“ä½œæ”¹ä¸º MODIFY: ${file.path}`);
                  file.action = 'MODIFY';
                }
              }
              
              // æ£€æŸ¥å—ä¿æŠ¤æ–‡ä»¶
              if (PROJECT_STRUCTURE.protectedFiles.includes(file.path) && file.action === 'CREATE') {
                warnings.push(`å—ä¿æŠ¤æ–‡ä»¶ä¸èƒ½è¢«è¦†ç›–åˆ›å»º: ${file.path}`);
                file.action = 'MODIFY';
              }
              
              // å†…å®¹ä¸èƒ½ä¸ºç©º
              if (!file.content || file.content.trim().length === 0) {
                warnings.push(`æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œè·³è¿‡: ${file.path}`);
                continue;
              }
              
              validFiles.push(file);
            }

            // 8. åˆ›å»ºæˆ–è·å–åˆ†æ”¯å¹¶å†™å…¥æ–‡ä»¶ï¼ˆåˆ†æ”¯åå·²åœ¨ç¬¬5.5æ­¥ç¡®å®šï¼‰
            const baseRef = await github.rest.git.getRef({ ...context.repo, ref: 'heads/main' });
            
            // æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å·²å­˜åœ¨
            let branchExists = false;
            try {
              await github.rest.git.getRef({ ...context.repo, ref: `heads/${branchName}` });
              branchExists = true;
              console.log(`âœ… åˆ†æ”¯å·²å­˜åœ¨: ${branchName}`);
            } catch (e) {
              // åˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åˆ†æ”¯
              try {
                await github.rest.git.createRef({ 
                  ...context.repo, 
                  ref: `refs/heads/${branchName}`, 
                  sha: baseRef.data.object.sha 
                });
                console.log(`âœ… åˆ›å»ºæ–°åˆ†æ”¯: ${branchName}`);
              } catch (e2) {
                console.log(`âš ï¸ åˆ›å»ºåˆ†æ”¯å¤±è´¥: ${e2.message}`);
              }
            }

            const createdFiles = [];
            const modifiedFiles = [];
            
            for (const file of validFiles) {
              console.log(`ğŸ“ ${file.action}: ${file.path}`);
              
              let sha;
              try {
                const { data } = await github.rest.repos.getContent({ 
                  ...context.repo, 
                  path: file.path, 
                  ref: branchName 
                });
                sha = data.sha;
              } catch (e) {} 
              
              await github.rest.repos.createOrUpdateFileContents({
                ...context.repo,
                path: file.path,
                message: `${file.action === 'CREATE' ? 'feat' : 'refactor'}(fe): ${file.action.toLowerCase()} ${file.path.split('/').pop()}`,
                content: Buffer.from(file.content).toString('base64'),
                branch: branchName,
                sha: sha
              });
              
              if (file.action === 'CREATE') {
                createdFiles.push(file.path);
              } else {
                modifiedFiles.push(file.path);
              }
            }

            // 9. åˆ›å»º PR
            let prBody = '### ğŸ“¦ å˜æ›´æ¸…å•\n\n';
            if (createdFiles.length > 0) {
              prBody += '**æ–°å»ºæ–‡ä»¶ï¼š**\n' + createdFiles.map(f => '- `' + f + '`').join('\n') + '\n';
            }
            if (modifiedFiles.length > 0) {
              prBody += '**ä¿®æ”¹æ–‡ä»¶ï¼š**\n' + modifiedFiles.map(f => '- `' + f + '`').join('\n') + '\n';
            }
            if (warnings.length > 0) {
              prBody += '\n### âš ï¸ è­¦å‘Š\n' + warnings.map(w => '- ' + w).join('\n');
            }
            prBody += '\n\n---\næŒ‡ä»¤: `/code-zhangxiaohao-agent`\nIssue: #' + context.issue.number;

            try {
              const pr = await github.rest.pulls.create({
                ...context.repo,
                title: `[FE] ${process.env.ISSUE_TITLE}`,
                head: branchName,
                base: 'main',
                body: prBody
              });
              
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `PR: ${pr.data.html_url}\n\næ–°å»º: ${createdFiles.length} | ä¿®æ”¹: ${modifiedFiles.length}${warnings.length > 0 ? `\n\nâš ï¸ ${warnings.length} ä¸ªè­¦å‘Šï¼Œè¯¦è§ PR` : ''}`
              });
            } catch(e) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `åˆ†æ”¯å·²æ›´æ–°: \`${branchName}\`\n\næ–°å»º: ${createdFiles.length} | ä¿®æ”¹: ${modifiedFiles.length}`
              });
            }