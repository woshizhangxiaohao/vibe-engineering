name: Agent Builder (Context Aware)

on:
  issue_comment:
    types: [created]

jobs:
  builder:
    if: contains(github.event.comment.body, '/code-zhangxiaohao-agent')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate File Tree
        id: file_tree
        run: |
          TREE=$(find . -maxdepth 5 -not -path '*/.*' -not -path '*/node_modules*' -not -path '*/dist*' -not -path '*/build*' -not -path '*/.next*' | sed 's|./||' | sort)
          echo "TREE<<EOF" >> $GITHUB_ENV
          echo "$TREE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Execute Frontend Implementation
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          PROJECT_TREE: ${{ env.TREE }}
        with:
          script: |
            const projectTree = process.env.PROJECT_TREE;
            const existingFiles = new Set(projectTree.split('\n').filter(f => f.trim()));
            
            // é¡¹ç›®ç»“æ„è§„èŒƒ
            const PROJECT_STRUCTURE = {
              pages: 'frontend/app',
              components: 'frontend/components',
              uiComponents: 'frontend/components/ui',
              featureComponents: 'frontend/components/features',
              hooks: 'frontend/hooks',
              lib: 'frontend/lib',
              types: 'frontend/types',
              validExtensions: ['.tsx', '.ts', '.css', '.json'],
              protectedFiles: ['frontend/app/layout.tsx', 'frontend/app/globals.css', 'frontend/package.json']
            };

            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            const fileExists = async (path) => {
              try {
                await github.rest.repos.getContent({ ...context.repo, path });
                return true;
              } catch (e) {
                return false;
              }
            };

            // è¯»å–æ–‡ä»¶å†…å®¹
            const readFileContent = async (path) => {
              try {
                const { data } = await github.rest.repos.getContent({ ...context.repo, path });
                if (data.size < 80000 && data.content) {
                  return Buffer.from(data.content, 'base64').toString();
                }
              } catch (e) {}
              return null;
            };

            // éªŒè¯è·¯å¾„æ˜¯å¦ç¬¦åˆé¡¹ç›®è§„èŒƒï¼ˆæ”¯æŒçˆ¶çº§è§„èŒƒè¦†ç›–ï¼‰
            const validatePath = (path, parentSpecText = '') => {
              const errors = [];
              
              // æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨çˆ¶çº§è§„èŒƒä¸­è¢«æ˜ç¡®æåŠï¼ˆå¦‚æœæ˜¯ï¼Œåˆ™å…è®¸ï¼‰
              const isInParentSpec = parentSpecText && (
                parentSpecText.includes(path) || 
                parentSpecText.includes(path.replace('frontend/', ''))
              );
              
              // é¡µé¢æ–‡ä»¶å¿…é¡»åœ¨ app/ ç›®å½•
              if (path.includes('/page.tsx') && !path.startsWith('frontend/app/')) {
                if (!isInParentSpec) {
                  errors.push(`é¡µé¢æ–‡ä»¶å¿…é¡»åœ¨ frontend/app/ ç›®å½•: ${path}`);
                }
              }
              
              // ç»„ä»¶ä¸èƒ½ç›´æ¥æ”¾åœ¨ app/ ç›®å½•ï¼ˆé™¤äº† page.tsx, layout.tsx ç­‰ï¼‰
              const appOnlyFiles = ['page.tsx', 'layout.tsx', 'loading.tsx', 'error.tsx', 'not-found.tsx', 'template.tsx'];
              if (path.startsWith('frontend/app/') && path.endsWith('.tsx')) {
                const fileName = path.split('/').pop();
                if (!appOnlyFiles.includes(fileName) && !isInParentSpec) {
                  errors.push(`ç»„ä»¶ä¸åº”æ”¾åœ¨ app/ ç›®å½•ï¼Œåº”æ”¾åœ¨ components/: ${path}`);
                }
              }
              
              // UI ç»„ä»¶åº”æ”¾åœ¨ components/ui/
              if (path.includes('Button') || path.includes('Input') || path.includes('Modal') || path.includes('Dialog')) {
                if (!path.includes('components/ui/') && !path.includes('components/features/') && !isInParentSpec) {
                  errors.push(`UI ç»„ä»¶åº”æ”¾åœ¨ components/ui/ æˆ– components/features/: ${path}`);
                }
              }
              
              return errors;
            };

            // 1. è¯»å–è®¨è®ºè®°å½•
            console.log("ğŸ“¥ è¯»å–è®¨è®ºè®°å½•...");
            const comments = await github.rest.issues.listComments({
              ...context.repo,
              issue_number: context.issue.number
            });
            
            const fullDiscussionText = comments.data.map(c => c.body).join('\n') + '\n' + process.env.ISSUE_BODY;
            const discussionHistory = comments.data
              .map(c => `[User: ${c.user.login}]:\n${c.body}`)
              .join("\n\n---\n\n");

            // 2. è¯»å–çˆ¶çº§è§„èŒƒï¼ˆåŒ…å«è¯„è®ºï¼‰å¹¶ç¡®å®šåˆ†æ”¯ç­–ç•¥
            let contextBody = process.env.ISSUE_BODY;
            let parentSpec = '';
            let parentIssueNumber = null;
            let parentImplementationPlan = null; // çˆ¶çº§å‰ç«¯å®æ–½æ–¹æ¡ˆ
            const parentRegex = /(?:Parent|Ref|çˆ¶ä»»åŠ¡|çˆ¶çº§|çˆ¶éœ€æ±‚|å…³è”çˆ¶éœ€æ±‚)[\s:ï¼š]+#(\d+)/i;
            const parentMatch = contextBody.match(parentRegex);
            if (parentMatch) {
              try {
                const parentId = parentMatch[1];
                parentIssueNumber = parseInt(parentId);
                console.log(`ğŸ”— è¯»å–çˆ¶çº§è§„èŒƒ: #${parentId}`);
                
                // è¯»å–çˆ¶çº§ issue body
                const p = await github.rest.issues.get({ ...context.repo, issue_number: parentId });
                parentSpec = p.data.body;
                
                // è¯»å–çˆ¶çº§ issue çš„è¯„è®ºï¼ˆå¯èƒ½åŒ…å«æ¶æ„å¸ˆçš„è®¾è®¡æ–¹æ¡ˆå’Œå‰ç«¯çº¦æŸï¼‰
                const parentComments = await github.rest.issues.listComments({
                  ...context.repo,
                  issue_number: parentId
                });
                
                // æ™ºèƒ½æå–å‰ç«¯çº¦æŸå’Œå®æ–½æ–¹æ¡ˆï¼šæŒ‰æ—¶é—´é¡ºåºå¤„ç†ï¼Œåé¢çš„è¯„è®ºä¼˜å…ˆçº§æ›´é«˜
                if (parentComments.data.length > 0) {
                  // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼ˆæœ€æ—©çš„åœ¨å‰ï¼‰
                  const sortedComments = parentComments.data.sort((a, b) => 
                    new Date(a.created_at) - new Date(b.created_at)
                  );
                  
                  // è¯†åˆ«å‰ç«¯å®æ–½æ–¹æ¡ˆçš„æ ‡è®°ï¼ˆğŸ—ï¸ å‰ç«¯å®æ–½æ–¹æ¡ˆï¼‰
                  const implementationPlanMarkers = [
                    /ğŸ—ï¸\s*å‰ç«¯å®æ–½æ–¹æ¡ˆ/i,
                    /ğŸ—ï¸\s*å‰ç«¯å®æ–½è®¡åˆ’/i,
                    /å‰ç«¯å®æ–½æ–¹æ¡ˆ/i,
                    /frontend implementation plan/i,
                    /frontend implementation/i
                  ];
                  
                  // è¯†åˆ«å‰ç«¯çº¦æŸçš„æ ‡è®°æ¨¡å¼ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
                  const constraintMarkers = [
                    /å‰ç«¯çº¦æŸ/i,
                    /å‰ç«¯è§„èŒƒ/i,
                    /frontend constraint/i,
                    /frontend spec/i,
                    /\[å‰ç«¯çº¦æŸ\]/i,
                    /\[å‰ç«¯è§„èŒƒ\]/i,
                    /## å‰ç«¯çº¦æŸ/i,
                    /## å‰ç«¯è§„èŒƒ/i,
                    /### å‰ç«¯çº¦æŸ/i,
                    /### å‰ç«¯è§„èŒƒ/i
                  ];
                  
                  // è¯†åˆ«çº¦æŸæ›´æ–°/æ’¤é”€æ ‡è®°
                  const updateMarkers = [
                    /æ›´æ–°çº¦æŸ/i,
                    /æ›´æ–°è§„èŒƒ/i,
                    /æ’¤é”€çº¦æŸ/i,
                    /æ’¤é”€è§„èŒƒ/i,
                    /update constraint/i,
                    /revoke constraint/i
                  ];
                  
                  // æå–å‰ç«¯å®æ–½æ–¹æ¡ˆå’Œçº¦æŸçš„è¯„è®º
                  const constraintComments = [];
                  const generalComments = [];
                  
                  sortedComments.forEach(comment => {
                    // ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯å‰ç«¯å®æ–½æ–¹æ¡ˆ
                    const hasImplementationPlan = implementationPlanMarkers.some(marker => 
                      marker.test(comment.body)
                    );
                    
                    const hasConstraint = constraintMarkers.some(marker => 
                      marker.test(comment.body)
                    );
                    
                    const isUpdate = updateMarkers.some(marker => 
                      marker.test(comment.body)
                    );
                    
                    if (hasImplementationPlan) {
                      // æå–å‰ç«¯å®æ–½æ–¹æ¡ˆï¼ˆå–æœ€æ–°çš„ï¼‰
                      parentImplementationPlan = {
                        body: comment.body,
                        user: comment.user.login,
                        createdAt: comment.created_at,
                        url: comment.html_url
                      };
                      console.log(`ğŸ“‹ å‘ç°çˆ¶çº§å‰ç«¯å®æ–½æ–¹æ¡ˆ: ${comment.html_url}`);
                    } else if (hasConstraint || isUpdate) {
                      constraintComments.push({
                        body: comment.body,
                        user: comment.user.login,
                        createdAt: comment.created_at,
                        url: comment.html_url,
                        isUpdate: isUpdate
                      });
                    } else {
                      // ä¹Ÿä¿ç•™æ™®é€šè¯„è®ºï¼Œå¯èƒ½åŒ…å«é‡è¦ä¿¡æ¯
                      generalComments.push({
                        body: comment.body,
                        user: comment.user.login,
                        createdAt: comment.created_at
                      });
                    }
                  });
                  
                  // æ„å»ºçº¦æŸæ–‡æœ¬ï¼šåé¢çš„è¯„è®ºä¼šè¦†ç›–å‰é¢çš„
                  let constraintsText = '';
                  if (constraintComments.length > 0) {
                    console.log(`ğŸ“‹ å‘ç° ${constraintComments.length} ä¸ªåŒ…å«å‰ç«¯çº¦æŸçš„è¯„è®º`);
                    
                    // æå–çº¦æŸå†…å®¹ï¼ˆå»é™¤æ ‡è®°ï¼Œåªä¿ç•™å®é™…çº¦æŸï¼‰
                    const extractedConstraints = constraintComments.map((c, index) => {
                      let constraintContent = c.body;
                      
                      // å°è¯•æå–çº¦æŸéƒ¨åˆ†ï¼ˆåœ¨æ ‡è®°ä¹‹åçš„å†…å®¹ï¼‰
                      const constraintMatch = constraintContent.match(
                        /(?:å‰ç«¯çº¦æŸ|å‰ç«¯è§„èŒƒ|frontend constraint|frontend spec|\[å‰ç«¯çº¦æŸ\]|\[å‰ç«¯è§„èŒƒ\]|## å‰ç«¯çº¦æŸ|## å‰ç«¯è§„èŒƒ|### å‰ç«¯çº¦æŸ|### å‰ç«¯è§„èŒƒ|å‰ç«¯å®æ–½æ–¹æ¡ˆ|frontend implementation|æ›´æ–°çº¦æŸ|æ›´æ–°è§„èŒƒ|æ’¤é”€çº¦æŸ|æ’¤é”€è§„èŒƒ|update constraint|revoke constraint)[\s:ï¼š]*\n?([\s\S]*)/i
                      );
                      
                      if (constraintMatch && constraintMatch[1]) {
                        constraintContent = constraintMatch[1].trim();
                      }
                      
                      return {
                        content: constraintContent,
                        user: c.user,
                        createdAt: c.created_at,
                        url: c.url,
                        order: index + 1,
                        isUpdate: c.isUpdate,
                        timestamp: new Date(c.created_at).getTime()
                      };
                    });
                    
                    // æŒ‰æ—¶é—´é¡ºåºåˆå¹¶çº¦æŸï¼ˆåé¢çš„ä¼˜å…ˆçº§æ›´é«˜ï¼‰
                    constraintsText = '--- [çˆ¶çº§ Issue å‰ç«¯çº¦æŸ - æŒ‰æ—¶é—´é¡ºåºï¼Œåé¢çš„ä¼˜å…ˆçº§æ›´é«˜] ---\n\n';
                    constraintsText += `**é‡è¦æç¤º**ï¼šå…±æœ‰ ${extractedConstraints.length} ä¸ªçº¦æŸè¯„è®ºï¼ŒæŒ‰æ—¶é—´é¡ºåºå¤„ç†ã€‚\n`;
                    constraintsText += `**åé¢çš„çº¦æŸä¼šè¦†ç›–æˆ–è¡¥å……å‰é¢çš„çº¦æŸ**ï¼Œè¯·ä»”ç»†é˜…è¯»æ‰€æœ‰çº¦æŸï¼Œä»¥æœ€æ–°çš„ä¸ºå‡†ã€‚\n\n`;
                    
                    extractedConstraints.forEach((constraint, index) => {
                      const timeStr = new Date(constraint.createdAt).toISOString().replace('T', ' ').substring(0, 19);
                      const typeLabel = constraint.isUpdate ? 'ã€æ›´æ–°çº¦æŸã€‘' : 'ã€çº¦æŸã€‘';
                      
                      constraintsText += `${typeLabel} #${constraint.order} - ${constraint.user} @ ${timeStr}\n`;
                      constraintsText += `æ¥æº: ${constraint.url}\n\n`;
                      constraintsText += `${constraint.content}\n\n`;
                      
                      if (index < extractedConstraints.length - 1) {
                        constraintsText += '---\n\n';
                      }
                    });
                    
                    // æ·»åŠ çº¦æŸä¼˜å…ˆçº§è¯´æ˜
                    if (extractedConstraints.length > 1) {
                      const latestConstraint = extractedConstraints[extractedConstraints.length - 1];
                      constraintsText += `\n**âš ï¸ çº¦æŸä¼˜å…ˆçº§è¯´æ˜**ï¼š\n`;
                      constraintsText += `- æœ€æ–°çº¦æŸï¼šçº¦æŸ #${latestConstraint.order} (${latestConstraint.user} @ ${new Date(latestConstraint.createdAt).toISOString().substring(0, 10)})\n`;
                      constraintsText += `- å¦‚æœçº¦æŸä¹‹é—´æœ‰å†²çªï¼Œä»¥æœ€æ–°çš„çº¦æŸä¸ºå‡†\n`;
                      constraintsText += `- å¦‚æœçº¦æŸæ˜¯"æ›´æ–°"ç±»å‹ï¼Œè¡¨ç¤ºæ˜¯å¯¹ä¹‹å‰çº¦æŸçš„ä¿®æ”¹\n`;
                    }
                  }
                  
                  // åˆå¹¶æ‰€æœ‰å†…å®¹
                  if (constraintsText) {
                    parentSpec += '\n\n' + constraintsText;
                  }
                  
                  // å¦‚æœæœ‰å…¶ä»–è¯„è®ºï¼ˆä¸åŒ…å«çº¦æŸæ ‡è®°ï¼‰ï¼Œä¹Ÿæ·»åŠ è¿›å»ï¼ˆä½†æ ‡è®°ä¸ºä¸€èˆ¬è®¨è®ºï¼‰
                  if (generalComments.length > 0) {
                    const generalText = generalComments
                      .map(c => `[${c.user} @ ${new Date(c.createdAt).toISOString()}]:\n${c.body}`)
                      .join("\n\n---\n\n");
                    parentSpec += '\n\n--- [çˆ¶çº§ Issue å…¶ä»–è®¨è®º] ---\n' + generalText;
                  }
                }
                
                contextBody += '\n\n--- [çˆ¶çº§è§„èŒƒ - å¿…é¡»ä¸¥æ ¼éµå®ˆ] ---\n' + parentSpec;
                console.log(`âœ… å·²è¯»å–çˆ¶çº§è§„èŒƒï¼Œé•¿åº¦: ${parentSpec.length} å­—ç¬¦`);
              } catch(e) {
                console.log(`âš ï¸ è¯»å–çˆ¶çº§è§„èŒƒå¤±è´¥: ${e.message}`);
              }
            }

            // 3. æ™ºèƒ½æ–‡ä»¶è·¯å¾„è¯†åˆ«ï¼ˆå¢å¼ºç‰ˆï¼‰
            console.log("ğŸ” æ‰«æç›¸å…³æ–‡ä»¶...");
            
            // åˆå¹¶æ‰€æœ‰æ–‡æœ¬æ¥æºï¼ˆåŒ…æ‹¬çˆ¶çº§è§„èŒƒï¼‰
            const allTextSources = fullDiscussionText + '\n' + (parentSpec || '');
            
            // å¤šç§è·¯å¾„æ ¼å¼åŒ¹é…ï¼ˆæ”¯æŒ app/(main) ç­‰è·¯ç”±ç»„ï¼‰
            const pathPatterns = [
              /(?:frontend|src)\/[\w\-\.\/\(\)]+\.(?:tsx|ts|css|json)/g,
              /app\/[\w\-\.\/\(\)]+\.(?:tsx|ts)/g,
              /components\/[\w\-\.\/]+\.(?:tsx|ts)/g,
              /hooks\/[\w\-\.\/]+\.(?:tsx|ts)/g,
              /lib\/[\w\-\.\/]+\.(?:tsx|ts)/g,
              /types\/[\w\-\.\/]+\.(?:tsx|ts)/g
            ];
            
            let foundPaths = new Set();
            for (const pattern of pathPatterns) {
              // ä»æ‰€æœ‰æ–‡æœ¬æ¥æºä¸­åŒ¹é…
              const matches = allTextSources.match(pattern) || [];
              matches.forEach(p => {
                // æ ‡å‡†åŒ–è·¯å¾„
                let normalized = p;
                if (!normalized.startsWith('frontend/') && !normalized.startsWith('src/')) {
                  normalized = 'frontend/' + normalized;
                }
                foundPaths.add(normalized);
              });
            }
            
            console.log(`ğŸ“‹ ä»çˆ¶çº§è§„èŒƒå’Œè®¨è®ºä¸­è¯†åˆ«åˆ° ${foundPaths.size} ä¸ªæ–‡ä»¶è·¯å¾„`);
            
            // æ”¶é›†ç°æœ‰æ–‡ä»¶å’Œæ–°æ–‡ä»¶
            const existingFilesContext = [];
            const newFilePaths = [];
            
            for (const path of foundPaths) {
              const exists = await fileExists(path);
              if (exists) {
                const content = await readFileContent(path);
                if (content) {
                  existingFilesContext.push({ path, content, action: 'MODIFY' });
                  console.log(`ğŸ“„ [å­˜åœ¨] ${path}`);
                  
                  // è‡ªåŠ¨å‘ç°å…³è”æ–‡ä»¶ï¼ˆimport è¯­å¥ï¼‰
                  const importRegex = /from\s+['"](@\/|\.\.\/|\.\/)([^'"]+)['"]/g;
                  let match;
                  while ((match = importRegex.exec(content)) !== null) {
                    let importPath = match[2];
                    if (!importPath.endsWith('.tsx') && !importPath.endsWith('.ts')) {
                      importPath += '.tsx';
                    }
                    if (match[1] === '@/') {
                      importPath = 'frontend/' + importPath;
                    }
                    if (!foundPaths.has(importPath)) {
                      const importExists = await fileExists(importPath);
                      if (importExists) {
                        const importContent = await readFileContent(importPath);
                        if (importContent) {
                          existingFilesContext.push({ path: importPath, content: importContent, action: 'REFERENCE' });
                          console.log(`ğŸ“„ [å…³è”] ${importPath}`);
                        }
                      }
                    }
                  }
                }
              } else {
                newFilePaths.push(path);
                console.log(`ğŸ†• [æ–°å»º] ${path}`);
              }
            }

            // 4. è¯»å–å…³é”®ä¸Šä¸‹æ–‡æ–‡ä»¶
            const criticalFiles = ['frontend/app/layout.tsx', 'frontend/app/globals.css'];
            for (const path of criticalFiles) {
              if (!existingFilesContext.find(f => f.path === path)) {
                const content = await readFileContent(path);
                if (content) {
                  existingFilesContext.push({ path, content, action: 'REFERENCE' });
                }
              }
            }

            // è¯»å– package.json
            let packageJsonContent = "{}";
            const pkgPath = await fileExists('frontend/package.json') ? 'frontend/package.json' : 'package.json';
            const pkgContent = await readFileContent(pkgPath);
            if (pkgContent) packageJsonContent = pkgContent;

            // 5. æ„å»ºç»“æ„åŒ– Prompt
            const existingFilesStr = existingFilesContext.map(f => 
              '### ' + f.action + ': ' + f.path + '\n```\n' + f.content + '\n```'
            ).join('\n\n');

            const newFilesList = newFilePaths.length > 0 ? newFilePaths.map(p => '- ' + p).join('\n') : 'æ— ';
            
            // æ„å»ºçˆ¶çº§è§„èŒƒæç¤º
            let parentSpecNote = '';
            if (parentSpec) {
              parentSpecNote = '\n\nã€âš ï¸ çˆ¶çº§è§„èŒƒ - æœ€é«˜ä¼˜å…ˆçº§ã€‘\n' +
                'ä»¥ä¸‹å†…å®¹æ¥è‡ªçˆ¶çº§ Issueï¼Œ**å¿…é¡»ä¸¥æ ¼éµå®ˆ**ï¼Œç‰¹åˆ«æ˜¯ç›®å½•ç»“æ„å’Œæ–‡ä»¶è·¯å¾„ï¼š\n' +
                'å¦‚æœçˆ¶çº§è§„èŒƒä¸­æ˜ç¡®æŒ‡å®šäº†ç›®å½•ç»“æ„ï¼ˆå¦‚ app/(main)/video/page.tsxï¼‰ï¼Œ\n' +
                '**å¿…é¡»ä¸¥æ ¼æŒ‰ç…§çˆ¶çº§è§„èŒƒæ‰§è¡Œï¼Œä¸è¦ä½¿ç”¨é»˜è®¤çš„ app/[route]/page.tsx æ ¼å¼**ã€‚\n' +
                'çˆ¶çº§è§„èŒƒä¼˜å…ˆçº§é«˜äºé¡¹ç›®ç»“æ„è§„èŒƒã€‚\n';
            }
            
            const prompt = 'ä½ æ˜¯ä¸€å Next.js å‰ç«¯ä¸“å®¶ï¼Œè´Ÿè´£æ ¹æ®éœ€æ±‚ç²¾å‡†ä¿®æ”¹æˆ–åˆ›å»ºä»£ç ã€‚\n\n' +
              'ã€é¡¹ç›®ç»“æ„è§„èŒƒï¼ˆé»˜è®¤ï¼‰ã€‘\n' +
              '- é¡µé¢æ–‡ä»¶: frontend/app/[route]/page.tsx\n' +
              '- å¸ƒå±€æ–‡ä»¶: frontend/app/[route]/layout.tsx\n' +
              '- é€šç”¨ç»„ä»¶: frontend/components/ui/\n' +
              '- ä¸šåŠ¡ç»„ä»¶: frontend/components/features/\n' +
              '- Hooks: frontend/hooks/\n' +
              '- å·¥å…·å‡½æ•°: frontend/lib/utils/\n' +
              '- ç±»å‹å®šä¹‰: frontend/types/\n' +
              parentSpecNote +
              '\nã€å½“å‰ç›®å½•ç»“æ„ã€‘\n' +
              projectTree + '\n\n' +
              'ã€ç°æœ‰æ–‡ä»¶å†…å®¹ã€‘\n' +
              'ä»¥ä¸‹æ–‡ä»¶å·²å­˜åœ¨äºé¡¹ç›®ä¸­ï¼š\n' +
              existingFilesStr + '\n\n' +
              'ã€å¾…åˆ›å»ºæ–‡ä»¶è·¯å¾„ã€‘\n' +
              'ä»¥ä¸‹è·¯å¾„è¢«æåŠä½†ä¸å­˜åœ¨ï¼Œéœ€è¦æ–°å»ºï¼š\n' +
              newFilesList + '\n\n' +
              'ã€package.jsonã€‘\n' +
              packageJsonContent + '\n\n' +
              'ã€éœ€æ±‚ã€‘\n' +
              'æ ‡é¢˜ï¼š' + process.env.ISSUE_TITLE + '\n' +
              'æè¿°ï¼š' + contextBody + '\n' +
              'è®¨è®ºï¼š' + discussionHistory + '\n\n' +
              'ã€æ“ä½œè§„åˆ™ã€‘\n' +
              '1. **MODIFYï¼ˆä¿®æ”¹ç°æœ‰æ–‡ä»¶ï¼‰**ï¼š\n' +
              '   - åŸºäºç°æœ‰ä»£ç å¢é‡ä¿®æ”¹\n' +
              '   - ä¿ç•™æ‰€æœ‰ä¸æœ¬æ¬¡éœ€æ±‚æ— å…³çš„ä»£ç \n' +
              '   - ä¿ç•™æ‰€æœ‰ç°æœ‰ import è¯­å¥\n' +
              '   - ä¿ç•™æ‰€æœ‰ç°æœ‰å‡½æ•°å’Œç»„ä»¶\n' +
              '   - åªæ·»åŠ æˆ–ä¿®æ”¹éœ€æ±‚ç›¸å…³çš„éƒ¨åˆ†\n' +
              '   - è¾“å‡ºå®Œæ•´çš„å¯è¿è¡Œä»£ç \n\n' +
              '2. **CREATEï¼ˆåˆ›å»ºæ–°æ–‡ä»¶ï¼‰**ï¼š\n' +
              '   - åªæœ‰åœ¨æ–‡ä»¶ä¸å­˜åœ¨æ—¶æ‰èƒ½åˆ›å»º\n' +
              '   - **å¦‚æœçˆ¶çº§è§„èŒƒä¸­æ˜ç¡®æŒ‡å®šäº†æ–‡ä»¶è·¯å¾„ï¼ˆå¦‚ app/(main)/video/page.tsxï¼‰ï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§çˆ¶çº§è§„èŒƒæ‰§è¡Œ**\n' +
              '   - å¦‚æœçˆ¶çº§è§„èŒƒæœªæŒ‡å®šï¼Œé¡µé¢æ”¾åœ¨ frontend/app/[route]/page.tsx\n' +
              '   - ç»„ä»¶å¿…é¡»æ”¾åœ¨ frontend/components/ ä¸‹ï¼ˆæˆ–çˆ¶çº§è§„èŒƒæŒ‡å®šçš„ä½ç½®ï¼‰\n' +
              '   - æ£€æŸ¥æ˜¯å¦æœ‰å¯å¤ç”¨çš„ç°æœ‰ç»„ä»¶\n' +
              '   - **ä¼˜å…ˆä½¿ç”¨ã€å¾…åˆ›å»ºæ–‡ä»¶è·¯å¾„ã€‘ä¸­åˆ—å‡ºçš„è·¯å¾„ï¼Œè¿™äº›è·¯å¾„æ¥è‡ªçˆ¶çº§è§„èŒƒå’Œè®¨è®º**\n\n' +
              '3. **ç¦æ­¢æ“ä½œ**ï¼š\n' +
              '   - ç¦æ­¢åˆ é™¤ç°æœ‰ä»£ç \n' +
              '   - ç¦æ­¢é‡å†™å·²å­˜åœ¨çš„æ–‡ä»¶ï¼ˆåªèƒ½ä¿®æ”¹ï¼‰\n' +
              '   - ç¦æ­¢åœ¨ app/ ç›®å½•åˆ›å»ºéé¡µé¢ç»„ä»¶\n' +
              '   - ç¦æ­¢åˆ›å»ºä¸ç°æœ‰ç»„ä»¶åŠŸèƒ½é‡å¤çš„æ–°ç»„ä»¶\n' +
              '   - **ä¸¥ç¦åœ¨ä»£ç å—å†…è¾“å‡ºä»»ä½• Markdown æ ¼å¼å†…å®¹**ï¼ˆæ ‡é¢˜ ###ã€åˆ—è¡¨ -ã€åˆ†éš”ç¬¦ --- ç­‰ï¼‰\n' +
              '   - **ä¸¥ç¦åœ¨ä»£ç å—å†…è¾“å‡ºæ–‡æ¡£è¯´æ˜ã€å®ç°è¯´æ˜ã€æ­¥éª¤è¯´æ˜ç­‰éä»£ç å†…å®¹**\n' +
              '   - **ä»£ç å—å†…åªèƒ½åŒ…å«çº¯ä»£ç ï¼Œä¸èƒ½æœ‰ä»»ä½•æ–‡å­—è¯´æ˜æˆ– Markdown æ ¼å¼**\n' +
              '   - ä»£ç å—å¿…é¡»ä»æ–‡ä»¶å¼€å¤´åˆ°ç»“å°¾çš„å®Œæ•´ä»£ç ï¼Œç»“æŸåç«‹å³å…³é—­ ```\n\n' +
              'ã€è¾“å‡ºæ ¼å¼ã€‘\n' +
              'æ¯ä¸ªæ–‡ä»¶ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼Œå¿…é¡»æ ‡æ˜æ“ä½œç±»å‹ï¼š\n\n' +
              '### MODIFY: frontend/app/xxx/page.tsx\n' +
              '```tsx\n' +
              '(å®Œæ•´çš„ä¿®æ”¹åä»£ç ï¼Œä»…ä»£ç ï¼Œæ— åˆ†éš”ç¬¦ï¼Œæ— æ–‡æ¡£è¯´æ˜)\n' +
              '```\n\n' +
              '### CREATE: frontend/components/features/xxx.tsx\n' +
              '```tsx\n' +
              '(æ–°æ–‡ä»¶çš„å®Œæ•´ä»£ç ï¼Œä»…ä»£ç ï¼Œæ— åˆ†éš”ç¬¦ï¼Œæ— æ–‡æ¡£è¯´æ˜)\n' +
              '```\n\n' +
              'å¦‚éœ€æ–°å¢ä¾èµ–ï¼š\n' +
              '### MODIFY: frontend/package.json\n' +
              '```json\n' +
              '(å®Œæ•´çš„ package.jsonï¼Œä»… JSONï¼Œæ— åˆ†éš”ç¬¦ï¼Œæ— æ–‡æ¡£è¯´æ˜)\n' +
              '```\n\n' +
              'ã€âš ï¸ ç»å¯¹ç¦æ­¢ - ä»£ç å—å†…å®¹è§„åˆ™ã€‘\n' +
              'ä»£ç å—ï¼ˆ```tsx å’Œ ```json ä¹‹é—´çš„å†…å®¹ï¼‰å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹è§„åˆ™ï¼š\n' +
              '1. **åªèƒ½åŒ…å«å¯æ‰§è¡Œçš„ä»£ç **ï¼šTypeScript/TSX/JSON ä»£ç ï¼Œä¸èƒ½æœ‰ä»»ä½•å…¶ä»–å†…å®¹\n' +
              '2. **ç¦æ­¢ä»»ä½• Markdown æ ¼å¼**ï¼š\n' +
              '   - ç¦æ­¢ Markdown æ ‡é¢˜ï¼ˆå¦‚ ### æ ‡é¢˜ã€## æ ‡é¢˜ã€# æ ‡é¢˜ï¼‰\n' +
              '   - ç¦æ­¢ Markdown åˆ—è¡¨ï¼ˆå¦‚ - é¡¹ç›®ã€* é¡¹ç›®ã€1. é¡¹ç›®ï¼‰\n' +
              '   - ç¦æ­¢ Markdown åˆ†éš”ç¬¦ï¼ˆå¦‚ ---ã€***ï¼‰\n' +
              '   - ç¦æ­¢ Markdown æ³¨é‡Šï¼ˆå¦‚ <!-- æ³¨é‡Š -->ï¼‰\n' +
              '3. **ç¦æ­¢ä»»ä½•æ–‡æ¡£è¯´æ˜**ï¼š\n' +
              '   - ç¦æ­¢å®ç°è¯´æ˜ã€æ­¥éª¤è¯´æ˜ã€æ³¨é‡Šè¯´æ˜ç­‰æ–‡å­—æè¿°\n' +
              '   - ç¦æ­¢åœ¨ä»£ç ä¸­æ·»åŠ "æ­¥éª¤1"ã€"æ­¥éª¤2"ç­‰è¯´æ˜æ€§æ–‡å­—\n' +
              '   - ç¦æ­¢åœ¨ä»£ç æœ«å°¾æ·»åŠ ä»»ä½•è¯´æ˜æ€§å†…å®¹\n' +
              '4. **åªå…è®¸ä»£ç æ³¨é‡Š**ï¼š\n' +
              '   - åªå…è®¸ä½¿ç”¨ // æˆ– /* */ æ ¼å¼çš„ä»£ç æ³¨é‡Š\n' +
              '   - æ³¨é‡Šå¿…é¡»æ˜¯ä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œä¸èƒ½æ˜¯ç‹¬ç«‹çš„è¯´æ˜æ®µè½\n' +
              '5. **ä»£ç å—å¿…é¡»å®Œæ•´**ï¼š\n' +
              '   - ä»£ç å—å¿…é¡»ä»æ–‡ä»¶å¼€å¤´åˆ°æ–‡ä»¶ç»“å°¾çš„å®Œæ•´ä»£ç \n' +
              '   - ä»£ç å—ç»“æŸåç«‹å³å…³é—­ ```ï¼Œä¸èƒ½æœ‰ä»»ä½•åç»­å†…å®¹\n' +
              '\n' +
              'ã€ç¤ºä¾‹ - æ­£ç¡®æ ¼å¼ã€‘\n' +
              '### CREATE: frontend/app/test/page.tsx\n' +
              '```tsx\n' +
              '"use client";\n' +
              '\n' +
              'export default function TestPage() {\n' +
              '  return <div>Test</div>;\n' +
              '}\n' +
              '```\n' +
              '\n' +
              'ã€ç¤ºä¾‹ - é”™è¯¯æ ¼å¼ï¼ˆç¦æ­¢ï¼‰ã€‘\n' +
              '### CREATE: frontend/app/test/page.tsx\n' +
              '```tsx\n' +
              '"use client";\n' +
              '\n' +
              'export default function TestPage() {\n' +
              '  return <div>Test</div>;\n' +
              '}\n' +
              '\n' +
              '### ç±»å‹å¯¼å‡º  <-- ç¦æ­¢ï¼è¿™æ˜¯ Markdown æ ‡é¢˜\n' +
              '```  <-- ç¦æ­¢ï¼ä»£ç å—å†…ä¸èƒ½æœ‰ Markdown';

            console.log("ğŸ¤– è°ƒç”¨ AI...");

            const aiRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: "anthropic/claude-sonnet-4.5",
                messages: [{ role: "user", content: prompt }]
              })
            });
            
            if (!aiRes.ok) {
              const errText = await aiRes.text();
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `âŒ AI API è°ƒç”¨å¤±è´¥: ${errText.substring(0, 500)}`
              });
              throw new Error(`AI API Error: ${errText}`);
            }
            
            const aiData = await aiRes.json();
            const rawContent = aiData.choices[0].message.content;

            // 6. è§£æ AI è¾“å‡º
            console.log("ğŸ“¦ è§£ææ–‡ä»¶...");
            const files = [];
            const lines = rawContent.split('\n');
            let currentFile = null;
            let currentAction = null;
            let currentContentLines = [];
            let inCodeBlock = false;

            const cleanContent = (linesArray) => {
              let content = linesArray.join('\n').trim();
              // ç§»é™¤ä»£ç å—æ ‡è®°
              content = content.replace(/^```[\w\-\.]*\s*$/gm, '');
              content = content.replace(/^```\s*$/gm, '');
              // ç§»é™¤åˆ†éš”ç¬¦è¡Œï¼ˆ--- æˆ–ç±»ä¼¼çš„ï¼‰
              content = content.replace(/^---+[\s-]*$/gm, '');
              // ç§»é™¤ Markdown æ ‡é¢˜ï¼ˆ###, ##, #ï¼‰
              content = content.replace(/^#{1,6}\s+.+$/gm, '');
              // ç§»é™¤ Markdown åˆ—è¡¨é¡¹ï¼ˆ- , * , 1. ç­‰ï¼‰
              content = content.replace(/^[\s]*[-*+]\s+.+$/gm, '');
              content = content.replace(/^[\s]*\d+\.\s+.+$/gm, '');
              // ç§»é™¤æ–‡ä»¶æœ«å°¾çš„ç©ºè¡Œå’Œåˆ†éš”ç¬¦
              content = content.replace(/\n+---+[\s-]*\n*$/g, '');
              content = content.replace(/\n+---+[\s-]*$/g, '');
              // ç§»é™¤å¤šä½™çš„ç©ºè¡Œï¼ˆè¿ç»­3ä¸ªæˆ–ä»¥ä¸Šç©ºè¡Œï¼‰
              content = content.replace(/\n{3,}/g, '\n\n');
              return content.trim();
            };

            for (const line of lines) {
              const modifyMatch = line.trim().match(/^###\s*MODIFY:\s*(.+)$/);
              const createMatch = line.trim().match(/^###\s*CREATE:\s*(.+)$/);
              const fileMatch = line.trim().match(/^###\s*FILE:\s*(.+)$/);
              
              if (modifyMatch || createMatch || fileMatch) {
                if (currentFile) {
                  files.push({ 
                    path: currentFile, 
                    content: cleanContent(currentContentLines),
                    action: currentAction 
                  });
                }
                currentFile = (modifyMatch || createMatch || fileMatch)[1].trim();
                currentAction = modifyMatch ? 'MODIFY' : (createMatch ? 'CREATE' : 'UNKNOWN');
                currentContentLines = [];
                inCodeBlock = false;
              } else {
                currentContentLines.push(line);
              }
            }
            
            if (currentFile) {
              files.push({ 
                path: currentFile, 
                content: cleanContent(currentContentLines),
                action: currentAction 
              });
            }

            if (files.length === 0) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `âŒ AI æœªç”Ÿæˆæœ‰æ•ˆçš„æ–‡ä»¶å—ï¼Œè¯·æ£€æŸ¥éœ€æ±‚æè¿°æ˜¯å¦æ¸…æ™°ã€‚`
              });
              throw new Error("è§£æå¤±è´¥ï¼šAI æœªç”Ÿæˆä»»ä½•æœ‰æ•ˆæ–‡ä»¶å—");
            }

            // 7. æ™ºèƒ½åˆ†æ”¯ç­–ç•¥ï¼šå…ˆç¡®å®šåˆ†æ”¯åï¼ˆéœ€è¦åœ¨éªŒè¯æ–‡ä»¶ä¹‹å‰ç¡®å®šï¼‰
            let branchName;
            let baseRef;
            
            if (parentIssueNumber) {
              // å¦‚æœæœ‰çˆ¶issueï¼Œä½¿ç”¨çˆ¶issueçš„åˆ†æ”¯å
              branchName = `zhangxiaohao/issue-${parentIssueNumber}`;
              console.log(`ğŸ”— æ£€æµ‹åˆ°çˆ¶issue #${parentIssueNumber}ï¼Œä½¿ç”¨åˆ†æ”¯: ${branchName}`);
              
              // å°è¯•è·å–çˆ¶issueçš„åˆ†æ”¯
              try {
                baseRef = await github.rest.git.getRef({ 
                  ...context.repo, 
                  ref: `heads/${branchName}` 
                });
                console.log(`âœ… çˆ¶issueåˆ†æ”¯å·²å­˜åœ¨ï¼Œå°†åœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­å¼€å‘`);
              } catch (e) {
                // çˆ¶issueåˆ†æ”¯ä¸å­˜åœ¨ï¼Œä»mainåˆ›å»º
                console.log(`âš ï¸ çˆ¶issueåˆ†æ”¯ä¸å­˜åœ¨ï¼Œä»mainåˆ›å»ºæ–°åˆ†æ”¯`);
                baseRef = await github.rest.git.getRef({ ...context.repo, ref: 'heads/main' });
                await github.rest.git.createRef({ 
                  ...context.repo, 
                  ref: `refs/heads/${branchName}`, 
                  sha: baseRef.data.object.sha 
                });
              }
            } else {
              // æ²¡æœ‰çˆ¶issueï¼Œåˆ›å»ºæ–°åˆ†æ”¯
              branchName = `zhangxiaohao/issue-${context.issue.number}`;
              baseRef = await github.rest.git.getRef({ ...context.repo, ref: 'heads/main' });
              
              try { 
                await github.rest.git.createRef({ 
                  ...context.repo, 
                  ref: `refs/heads/${branchName}`, 
                  sha: baseRef.data.object.sha 
                }); 
              } catch (e) {
                // åˆ†æ”¯å·²å­˜åœ¨ï¼Œæ›´æ–°åˆ°æœ€æ–° main
                try {
                  await github.rest.git.updateRef({
                    ...context.repo,
                    ref: `heads/${branchName}`,
                    sha: baseRef.data.object.sha,
                    force: true
                  });
                } catch (e2) {}
              }
            }
            
            // æ£€æŸ¥æ–‡ä»¶åœ¨å½“å‰åˆ†æ”¯æ˜¯å¦å­˜åœ¨ï¼ˆè€Œä¸æ˜¯ main åˆ†æ”¯ï¼‰
            const fileExistsInBranch = async (path, branch) => {
              try {
                await github.rest.repos.getContent({ 
                  ...context.repo, 
                  path,
                  ref: branch
                });
                return true;
              } catch (e) {
                return false;
              }
            };
            
            // 7. éªŒè¯å’Œè¿‡æ»¤æ–‡ä»¶ï¼ˆä½¿ç”¨å½“å‰åˆ†æ”¯æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼‰
            const validFiles = [];
            const warnings = [];
            
            for (const file of files) {
              // è·³è¿‡åç«¯æ–‡ä»¶
              if (file.path.endsWith('.go') || file.path.includes('backend/')) continue;
              
              // éªŒè¯è·¯å¾„ï¼ˆä¼ å…¥çˆ¶çº§è§„èŒƒï¼Œå…è®¸çˆ¶çº§è§„èŒƒè¦†ç›–é»˜è®¤è§„åˆ™ï¼‰
              const pathErrors = validatePath(file.path, parentSpec);
              if (pathErrors.length > 0) {
                warnings.push(...pathErrors);
              }
              
              // JSON æ ¡éªŒ
              if (file.path.endsWith('.json')) {
                try { 
                  JSON.parse(file.content); 
                } catch (e) { 
                  warnings.push(`JSON è¯­æ³•é”™è¯¯: ${file.path}`);
                  continue; 
                }
              }
              
              // æ£€æŸ¥ CREATE æ“ä½œçš„æ–‡ä»¶æ˜¯å¦åœ¨å½“å‰åˆ†æ”¯å·²å­˜åœ¨ï¼ˆå…³é”®ä¿®å¤ï¼‰
              if (file.action === 'CREATE') {
                const exists = await fileExistsInBranch(file.path, branchName);
                if (exists) {
                  warnings.push(`æ–‡ä»¶åœ¨å½“å‰åˆ†æ”¯å·²å­˜åœ¨ï¼ŒCREATE æ“ä½œæ”¹ä¸º MODIFY: ${file.path}`);
                  file.action = 'MODIFY';
                }
              }
              
              // æ£€æŸ¥å—ä¿æŠ¤æ–‡ä»¶
              if (PROJECT_STRUCTURE.protectedFiles.includes(file.path) && file.action === 'CREATE') {
                warnings.push(`å—ä¿æŠ¤æ–‡ä»¶ä¸èƒ½è¢«è¦†ç›–åˆ›å»º: ${file.path}`);
                file.action = 'MODIFY';
              }
              
              // å†…å®¹ä¸èƒ½ä¸ºç©º
              if (!file.content || file.content.trim().length === 0) {
                warnings.push(`æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œè·³è¿‡: ${file.path}`);
                continue;
              }
              
              validFiles.push(file);
            }

            const createdFiles = [];
            const modifiedFiles = [];
            
            // 9. å‡†å¤‡å®æ–½æ–¹æ¡ˆæ–‡æ¡£ï¼ˆåœ¨æ‰¹é‡æäº¤ä¹‹å‰ç”Ÿæˆï¼‰
            // æå–çº¦æŸä¿¡æ¯ç”¨äºæ–‡æ¡£
            let constraintsSummary = '';
            if (parentSpec) {
              // æ£€æŸ¥æ˜¯å¦æœ‰çº¦æŸéƒ¨åˆ†
              const constraintMatch = parentSpec.match(/--- \[çˆ¶çº§ Issue å‰ç«¯çº¦æŸ[^\]]*\] ---([\s\S]*?)(?=\n---|$)/);
              if (constraintMatch) {
                constraintsSummary = constraintMatch[1].trim();
                // é™åˆ¶é•¿åº¦ï¼Œé¿å…æ–‡æ¡£è¿‡é•¿
                if (constraintsSummary.length > 2000) {
                  constraintsSummary = constraintsSummary.substring(0, 2000) + '\n\n... (å†…å®¹å·²æˆªæ–­ï¼Œå®Œæ•´å†…å®¹è¯·æŸ¥çœ‹çˆ¶çº§ Issue)';
                }
              }
            }
            
            // æ„å»ºå®æ–½æ–¹æ¡ˆæ–‡æ¡£ï¼ˆé¿å…åµŒå¥—åå¼•å·å¯¼è‡´ YAML è§£æé”™è¯¯ï¼‰
            const branchInfo = parentIssueNumber 
              ? '**çˆ¶Issue**: #' + parentIssueNumber + '\n**åˆ†æ”¯**: `' + branchName + '`' 
              : '**åˆ†æ”¯**: `' + branchName + '`';
            
            const createdFilesList = createdFiles.length > 0 
              ? '**æ–°å»ºæ–‡ä»¶ (' + createdFiles.length + '):**\n' + createdFiles.map(f => '- `' + f + '`').join('\n') + '\n' 
              : '';
            
            const modifiedFilesList = modifiedFiles.length > 0 
              ? '**ä¿®æ”¹æ–‡ä»¶ (' + modifiedFiles.length + '):**\n' + modifiedFiles.map(f => '- `' + f + '`').join('\n') + '\n' 
              : '';
            
            const constraintsSection = constraintsSummary 
              ? `**å‰ç«¯çº¦æŸï¼ˆæ¥è‡ªçˆ¶çº§ Issue è¯„è®ºï¼ŒæŒ‰æ—¶é—´é¡ºåºï¼Œåé¢çš„ä¼˜å…ˆçº§æ›´é«˜ï¼‰**:\n\n${constraintsSummary}\n\n` 
              : '';
            
            const parentSpecSection = parentSpec && !constraintsSummary 
              ? `**çˆ¶çº§è§„èŒƒï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰**:\n\n${parentSpec.split('\n').slice(0, 100).join('\n')}${parentSpec.split('\n').length > 100 ? '\n\n...' : ''}\n` 
              : '';
            
            const constraintsNote = constraintsSummary 
              ? `\n**âš ï¸ çº¦æŸä¼˜å…ˆçº§è¯´æ˜**:\n- å‰ç«¯çº¦æŸæ¥è‡ªçˆ¶çº§ Issue çš„å¤šä¸ªè¯„è®º\n- æŒ‰æ—¶é—´é¡ºåºå¤„ç†ï¼Œåé¢çš„çº¦æŸä¼šè¦†ç›–æˆ–è¡¥å……å‰é¢çš„çº¦æŸ\n- å¦‚æœçº¦æŸä¹‹é—´æœ‰å†²çªï¼Œä»¥æœ€æ–°çš„çº¦æŸä¸ºå‡†\n` 
              : '';
            
            const warningsList = warnings.length > 0 
              ? warnings.map(w => `- ${w}`).join('\n') 
              : 'æ— è­¦å‘Š';
            
            const parentIssueNote = parentIssueNumber 
              ? `æ­¤ Issue åŸºäºçˆ¶ Issue #${parentIssueNumber}ï¼Œä½¿ç”¨åŒä¸€åˆ†æ”¯å¼€å‘` 
              : 'æ­¤ Issue åˆ›å»ºäº†æ–°åˆ†æ”¯';
            
            const constraintsNote2 = constraintsSummary 
              ? `å‰ç«¯çº¦æŸå¯èƒ½æ¥è‡ªçˆ¶çº§ Issue çš„å¤šä¸ªè¯„è®ºï¼Œè¯·ä»”ç»†é˜…è¯»æ‰€æœ‰çº¦æŸ` 
              : '';
            
            // ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥é¿å… YAML è§£æå™¨å°† ** è¯¯è®¤ä¸ºåˆ«åå¼•ç”¨
            const implementationPlanDoc = '# Issue #' + context.issue.number + ' å‰ç«¯å®æ–½æ–¹æ¡ˆ\n\n' +
              '## ğŸ“‹ éœ€æ±‚ä¿¡æ¯\n\n' +
              '**æ ‡é¢˜**: ' + process.env.ISSUE_TITLE + '\n\n' +
              '**Issue**: #' + context.issue.number + '\n\n' +
              branchInfo + '\n\n' +
              '**åˆ›å»ºæ—¶é—´**: ' + new Date().toISOString() + '\n\n' +
              '---\n\n' +
              '## ğŸ“ éœ€æ±‚æè¿°\n\n' +
              contextBody.split('\n').slice(0, 50).join('\n') + (contextBody.split('\n').length > 50 ? '\n\n...' : '') + '\n\n' +
              '---\n\n' +
              '## ğŸ¯ å®æ–½æ–¹æ¡ˆ\n\n' +
              '### æ–‡ä»¶å˜æ›´æ¸…å•\n\n' +
              createdFilesList + '\n' +
              modifiedFilesList + '\n' +
              '### é¡¹ç›®ç»“æ„çº¦æŸ\n\n' +
              constraintsSection +
              parentSpecSection +
              '**é»˜è®¤é¡¹ç›®ç»“æ„è§„èŒƒ**:\n' +
              '- é¡µé¢æ–‡ä»¶: `frontend/app/[route]/page.tsx`\n' +
              '- å¸ƒå±€æ–‡ä»¶: `frontend/app/[route]/layout.tsx`\n' +
              '- é€šç”¨ç»„ä»¶: `frontend/components/ui/`\n' +
              '- ä¸šåŠ¡ç»„ä»¶: `frontend/components/features/`\n' +
              '- Hooks: `frontend/hooks/`\n' +
              '- å·¥å…·å‡½æ•°: `frontend/lib/utils/`\n' +
              '- ç±»å‹å®šä¹‰: `frontend/types/`\n\n' +
              constraintsNote + '\n' +
              '---\n\n' +
              '## âš ï¸ è­¦å‘Š\n\n' +
              warningsList + '\n\n' +
              '---\n\n' +
              '## ğŸ“Œ æ³¨æ„äº‹é¡¹\n\n' +
              '1. æ­¤æ–‡æ¡£ç”± Agent Builder è‡ªåŠ¨ç”Ÿæˆ\n' +
              '2. è¯·éªŒè¯ä»£ç å˜æ›´åå†åˆå¹¶ PR\n' +
              '3. ' + parentIssueNote + '\n' +
              (constraintsNote2 ? '4. ' + constraintsNote2 + '\n' : '');

            // 10. æ‰¹é‡æäº¤ï¼šä½¿ç”¨ Git Tree API å°†æ‰€æœ‰æ–‡ä»¶å˜æ›´ï¼ˆä»£ç æ–‡ä»¶ + å®æ–½æ–¹æ¡ˆæ–‡æ¡£ï¼‰åˆå¹¶åˆ°ä¸€ä¸ªæäº¤ä¸­
            // è¿™æ ·å¯ä»¥ä¿ç•™çˆ¶åˆ†æ”¯çš„æ‰€æœ‰å·²æœ‰æ–‡ä»¶ï¼Œåªæ›´æ–°/æ·»åŠ æ–°æ–‡ä»¶
            const allFilesToCommit = [...validFiles];
            let docPath = null;
            
            // å¦‚æœæœ‰å®æ–½æ–¹æ¡ˆæ–‡æ¡£ï¼Œä¹ŸåŠ å…¥åˆ°æ‰¹é‡æäº¤ä¸­
            if (implementationPlanDoc) {
              // ç¡®å®šæ–‡æ¡£è·¯å¾„ï¼ˆå¦‚æœæœ‰çˆ¶ issue ä¸”æœ‰å‰ç«¯å®æ–½æ–¹æ¡ˆï¼Œä½¿ç”¨çˆ¶ issue çš„è·¯å¾„ï¼‰
              if (parentIssueNumber && parentImplementationPlan) {
                docPath = `frontend/lib/doc/implementation-plan-issue-${parentIssueNumber}.md`;
              } else {
                docPath = `frontend/lib/doc/implementation-plan-issue-${context.issue.number}.md`;
              }
              
              allFilesToCommit.push({
                path: docPath,
                content: implementationPlanDoc,
                action: 'CREATE' // æ–‡æ¡£æ€»æ˜¯åˆ›å»ºæˆ–æ›´æ–°
              });
            }
            
            if (allFilesToCommit.length > 0) {
              console.log(`ğŸ“¦ å‡†å¤‡æ‰¹é‡æäº¤ ${allFilesToCommit.length} ä¸ªæ–‡ä»¶ï¼ˆåŒ…å«å®æ–½æ–¹æ¡ˆæ–‡æ¡£ï¼‰...`);
              
              // 1. è·å–å½“å‰åˆ†æ”¯çš„æœ€æ–° commit SHA
              const currentRef = await github.rest.git.getRef({
                ...context.repo,
                ref: `heads/${branchName}`
              });
              const baseCommitSha = currentRef.data.object.sha;
              
              // 2. è·å–åŸºç¡€ treeï¼ˆè¿™ä¼šä¿ç•™æ‰€æœ‰å·²å­˜åœ¨çš„æ–‡ä»¶ï¼‰
              const baseCommit = await github.rest.git.getCommit({
                ...context.repo,
                commit_sha: baseCommitSha
              });
              const baseTreeSha = baseCommit.data.tree.sha;
              
              console.log(`ğŸ“‹ åŸºç¡€ commit: ${baseCommitSha.substring(0, 7)}, tree: ${baseTreeSha.substring(0, 7)}`);
              
              // 3. æ„å»ºæ–‡ä»¶æ ‘ï¼šä¸ºæ‰€æœ‰è¦æäº¤çš„æ–‡ä»¶åˆ›å»º blob
              const treeItems = [];
              
              for (const file of allFilesToCommit) {
                if (file.path === docPath) {
                  console.log(`ğŸ“„ å®æ–½æ–¹æ¡ˆæ–‡æ¡£: ${file.path}`);
                } else {
                  console.log(`ğŸ“ ${file.action}: ${file.path}`);
                }
                
                // åˆ›å»º blob
                const blob = await github.rest.git.createBlob({
                  ...context.repo,
                  content: Buffer.from(file.content).toString('base64'),
                  encoding: 'base64'
                });
                
                // æ·»åŠ åˆ° treeï¼ˆåªåŒ…å«è¦æ›´æ–°/æ·»åŠ çš„æ–‡ä»¶ï¼‰
                treeItems.push({
                  path: file.path,
                  mode: '100644', // æ™®é€šæ–‡ä»¶
                  type: 'blob',
                  sha: blob.data.sha
                });
                
                // è®°å½•æ–‡ä»¶å˜æ›´ï¼ˆä¸åŒ…æ‹¬æ–‡æ¡£ï¼‰
                if (file.path !== docPath) {
                  if (file.action === 'CREATE') {
                    createdFiles.push(file.path);
                  } else {
                    modifiedFiles.push(file.path);
                  }
                }
              }
              
              // 4. åˆ›å»ºæ–°çš„ treeï¼ˆä½¿ç”¨ base_tree ä¿ç•™æ‰€æœ‰å·²å­˜åœ¨çš„æ–‡ä»¶ï¼Œåªæ›´æ–° treeItems ä¸­çš„æ–‡ä»¶ï¼‰
              const newTree = await github.rest.git.createTree({
                ...context.repo,
                base_tree: baseTreeSha, // å…³é”®ï¼šä½¿ç”¨ base_tree ä¿ç•™æ‰€æœ‰å·²å­˜åœ¨çš„æ–‡ä»¶
                tree: treeItems // åªæ›´æ–°/æ·»åŠ è¿™äº›æ–‡ä»¶
              });
              
              console.log(`ğŸŒ³ æ–° tree å·²åˆ›å»º: ${newTree.data.sha.substring(0, 7)}`);
              
              // 5. åˆ›å»º commitï¼ˆä¸€ä¸ªå­ issue ä¸€ä¸ªæäº¤ï¼‰
              const commitMessage = `feat(fe): implement issue #${context.issue.number}${parentIssueNumber ? ` (parent: #${parentIssueNumber})` : ''}\n\n` +
                (createdFiles.length > 0 ? `æ–°å»º: ${createdFiles.length} ä¸ªæ–‡ä»¶\n` : '') +
                (modifiedFiles.length > 0 ? `ä¿®æ”¹: ${modifiedFiles.length} ä¸ªæ–‡ä»¶\n` : '') +
                (docPath ? `å®æ–½æ–¹æ¡ˆæ–‡æ¡£: ${docPath}` : '');
              
              const newCommit = await github.rest.git.createCommit({
                ...context.repo,
                message: commitMessage,
                tree: newTree.data.sha,
                parents: [baseCommitSha] // å…³é”®ï¼šä½¿ç”¨å½“å‰åˆ†æ”¯çš„ commit ä½œä¸ºçˆ¶èŠ‚ç‚¹ï¼Œä¿ç•™å†å²
              });
              
              console.log(`ğŸ“ æ–° commit å·²åˆ›å»º: ${newCommit.data.sha.substring(0, 7)}`);
              
              // 6. æ›´æ–°åˆ†æ”¯å¼•ç”¨ï¼ˆè¿™ä¼šä¿ç•™æ‰€æœ‰å†å²æäº¤ï¼‰
              await github.rest.git.updateRef({
                ...context.repo,
                ref: `heads/${branchName}`,
                sha: newCommit.data.sha
              });
              
              console.log(`âœ… æ‰¹é‡æäº¤å®Œæˆ: ${commitMessage}`);
              if (docPath) {
                console.log(`ğŸ“„ å®æ–½æ–¹æ¡ˆæ–‡æ¡£å·²åŒ…å«åœ¨æäº¤ä¸­: ${docPath}`);
              }
            } else {
              console.log(`âš ï¸ æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤`);
            }

            // 10. åˆ›å»ºæˆ–æ›´æ–° PRï¼ˆé»˜è®¤åˆ›å»º Draft PRï¼Œéœ€è¦éªŒè¯ï¼‰
            let prBody = '### ğŸ“¦ å˜æ›´æ¸…å•\n\n';
            if (createdFiles.length > 0) {
              prBody += '**æ–°å»ºæ–‡ä»¶ï¼š**\n' + createdFiles.map(f => '- `' + f + '`').join('\n') + '\n';
            }
            if (modifiedFiles.length > 0) {
              prBody += '**ä¿®æ”¹æ–‡ä»¶ï¼š**\n' + modifiedFiles.map(f => '- `' + f + '`').join('\n') + '\n';
            }
            if (warnings.length > 0) {
              prBody += '\n### âš ï¸ è­¦å‘Š\n' + warnings.map(w => '- ' + w).join('\n');
            }
            prBody += `\n\n### ğŸ“„ å®æ–½æ–¹æ¡ˆæ–‡æ¡£\n\nå®æ–½æ–¹æ¡ˆå·²ä¿å­˜åˆ°: \`frontend/lib/doc/implementation-plan-issue-${context.issue.number}.md\`\n`;
            prBody += '\n\n---\n';
            prBody += `æŒ‡ä»¤: \`/code-zhangxiaohao-agent\`\n`;
            prBody += `Issue: #${context.issue.number}\n`;
            if (parentIssueNumber) {
              prBody += `çˆ¶Issue: #${parentIssueNumber}\n`;
            }
            prBody += `\n**âš ï¸ æ­¤ PR ä¸º Draft çŠ¶æ€ï¼Œè¯·éªŒè¯ä»£ç åå† Ready for Review**`;

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ PR
            let existingPR = null;
            try {
              const prs = await github.rest.pulls.list({
                ...context.repo,
                head: `${context.repo.owner}:${branchName}`,
                base: 'main',
                state: 'all'
              });
              if (prs.data.length > 0) {
                existingPR = prs.data[0];
              }
            } catch (e) {}

            try {
              let pr;
              if (existingPR) {
                // æ›´æ–°ç°æœ‰ PR
                pr = await github.rest.pulls.update({
                  ...context.repo,
                  pull_number: existingPR.number,
                  title: `[FE] ${process.env.ISSUE_TITLE}${parentIssueNumber ? ` (åŸºäº #${parentIssueNumber})` : ''}`,
                  body: prBody,
                  state: 'open' // ç¡®ä¿ PR æ˜¯æ‰“å¼€çŠ¶æ€
                });
                
                await github.rest.issues.createComment({
                  ...context.repo,
                  issue_number: context.issue.number,
                  body: `âœ… PR å·²æ›´æ–°: ${pr.data.html_url}\n\næ–°å»º: ${createdFiles.length} | ä¿®æ”¹: ${modifiedFiles.length}${warnings.length > 0 ? `\n\nâš ï¸ ${warnings.length} ä¸ªè­¦å‘Šï¼Œè¯¦è§ PR` : ''}\n\nğŸ“„ å®æ–½æ–¹æ¡ˆæ–‡æ¡£: \`frontend/lib/doc/implementation-plan-issue-${context.issue.number}.md\``
                });
              } else {
                // åˆ›å»ºæ–°çš„ Draft PR
                pr = await github.rest.pulls.create({
                  ...context.repo,
                  title: `[FE] ${process.env.ISSUE_TITLE}${parentIssueNumber ? ` (åŸºäº #${parentIssueNumber})` : ''}`,
                  head: branchName,
                  base: 'main',
                  body: prBody,
                  draft: true // é»˜è®¤åˆ›å»º Draft PR
                });
                
                await github.rest.issues.createComment({
                  ...context.repo,
                  issue_number: context.issue.number,
                  body: `âœ… Draft PR å·²åˆ›å»º: ${pr.data.html_url}\n\næ–°å»º: ${createdFiles.length} | ä¿®æ”¹: ${modifiedFiles.length}${warnings.length > 0 ? `\n\nâš ï¸ ${warnings.length} ä¸ªè­¦å‘Šï¼Œè¯¦è§ PR` : ''}\n\nğŸ“„ å®æ–½æ–¹æ¡ˆæ–‡æ¡£: \`frontend/lib/doc/implementation-plan-issue-${context.issue.number}.md\`\n\n**è¯·éªŒè¯ä»£ç åï¼Œå°† PR æ ‡è®°ä¸º Ready for Review**`
                });
              }
            } catch(e) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `åˆ†æ”¯å·²æ›´æ–°: \`${branchName}\`\n\næ–°å»º: ${createdFiles.length} | ä¿®æ”¹: ${modifiedFiles.length}\n\nğŸ“„ å®æ–½æ–¹æ¡ˆæ–‡æ¡£: \`frontend/lib/doc/implementation-plan-issue-${context.issue.number}.md\`\n\nâš ï¸ PR åˆ›å»ºå¤±è´¥: ${e.message}`
              });
            }