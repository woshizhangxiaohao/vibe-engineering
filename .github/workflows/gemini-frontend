name: Vibe Frontend Agent

on:
  issue_comment:
    types: [created]

jobs:
  frontend-agent:
    if: |
      contains(github.event.comment.body, '/agent-fe') ||
      contains(github.event.comment.body, '/agent frontend')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Vibe Frontend Agent - Implement Frozen UI
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        with:
          script: |
            async function runFrontendAgent() {
              const prompt = `
                You are the **Frontend Execution Agent** for this repository.
                
                Your mission:
                Implement the frontend strictly according to the **Frozen UI Specification** in this issue.
                
                ====================
                ISSUE TITLE:
                ${process.env.ISSUE_TITLE}
                
                ISSUE BODY (Includes Frozen UI Spec):
                ${process.env.ISSUE_BODY}
                ====================
                
                ====================
                NON-NEGOTIABLE RULES
                ====================
                - UI SPEC IS A CONTRACT
                - Do NOT modify interaction philosophy
                - Do NOT add or remove UI elements
                - Do NOT improve UX beyond the spec
                - Do NOT add persistence
                - Do NOT redesign layout
                - You may ONLY:
                  - create frontend files
                  - bind data
                  - manage UI state
                  - implement loading & error states
                
                ====================
                TECH STACK
                ====================
                - Next.js (App Router)
                - TypeScript
                - Tailwind CSS
                - Single Page Interface (no routing)
                
                ====================
                REQUIRED OUTPUT
                ====================
                You must respond in the following strict format:
                
                ### File Structure
                - List all files to be created or modified
                
                ### Implementation Plan
                - Bullet points mapping UI Spec ‚Üí Components
                
                ### Code
                - Provide COMPLETE code
                - One code block per file
                - No pseudocode
                - TypeScript strict
                
                ====================
                EXECUTION ORDER
                ====================
                1. Define component boundaries
                2. Define state machine
                3. Implement UI skeleton
                4. Bind async parsing API (mock if missing)
                5. Ensure append-only feed behavior
                6. Final check: zero UI drift
                
                If the UI spec is ambiguous:
                - Ask EXACTLY ONE clarification question
                - Otherwise make reasonable assumptions and state them
                              `;

              const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [{ role: "user", content: prompt }],
                  temperature: 0.2
                })
              });

              const data = await res.json();
              if (!data.choices || !data.choices[0]) {
                throw new Error("Frontend Agent returned invalid response");
              }

              const feOutput = data.choices[0].message.content;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: [
                  "üõ†Ô∏è Frontend Agent Output (Implementation Draft)",
                  "",
                  feOutput,
                  "",
                  "---",
                  "",
                  "Frontend Execution Notice:",
                  "- UI spec respected without modification",
                  "- Append-only feed enforced",
                  "- No persistence added",
                  "- Ready for PR generation"
                ].join("\\n")
              });
            }

            await runFrontendAgent();
