name: Vibe Frontend Agent

on:
  issue_comment:
    types: [created]

jobs:
  frontend-agent:
    if: |
      contains(github.event.comment.body, '/agent-fe') ||
      contains(github.event.comment.body, '/agent frontend')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Vibe Frontend Agent - Implement Frozen UI
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          script: |
            async function runFrontendAgent() {
              const { owner, repo } = context.repo;
              const issue_number = context.issue.number;

              // 1. Fetch all comments
              const commentsRes = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number,
                per_page: 100
              });

              // 2. Find latest UI Agent output
              const uiComment = [...commentsRes.data].reverse().find(c =>
                c.body && c.body.includes("üß© UI Agent Output (Frozen UI Spec)")
              );

              if (!uiComment) {
                throw new Error("Frozen UI Spec not found. Run /agent-ui first.");
              }

              const frozenUISpec = uiComment.body;

              const prompt = `
                You are the **Frontend Execution Agent**.
                
                Your mission:
                Implement the frontend strictly according to the **Frozen UI Specification** below.
                
                ====================
                FROZEN UI SPEC (AUTHORITATIVE)
                ====================
                ${frozenUISpec}
                
                ====================
                NON-NEGOTIABLE RULES
                ====================
                - UI SPEC IS A CONTRACT
                - Do NOT modify interaction philosophy
                - Do NOT add or remove UI elements
                - Do NOT improve UX beyond the spec
                - Do NOT add persistence
                - Single Page Interface only
                
                ====================
                TECH STACK
                ====================
                - Next.js (App Router)
                - TypeScript
                - Tailwind CSS
                
                ====================
                REQUIRED OUTPUT FORMAT
                ====================
                ### File Structure
                ### Implementation Plan
                ### Code (complete files, no pseudocode)
                
                If the UI spec is ambiguous:
                - Ask EXACTLY ONE clarification question
                              `;

              const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [{ role: "user", content: prompt }],
                  temperature: 0.4
                })
              });

              const data = await res.json();
              if (!data.choices?.[0]) {
                throw new Error("Frontend Agent returned invalid response");
              }

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: [
                  "üõ†Ô∏è Frontend Agent Output (Implementation Draft)",
                  "",
                  data.choices[0].message.content,
                  "",
                  "---",
                  "UI contract respected. No UI drift."
                ].join("\\n")
              });
            }

            await runFrontendAgent();
