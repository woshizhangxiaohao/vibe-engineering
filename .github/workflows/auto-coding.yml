name: Auto Coding with Claude

on:
  issues:
    types: [labeled]

jobs:
  coding:
    # 只有在 Issue 被打上 'claude-dev' 标签时才触发
    if: github.event.label.name == 'claude-dev'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write # 添加 OIDC token 权限
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5 # 遵循你的要求使用 v5 版本
        with:
          fetch-depth: 0

      - name: Create Feature Branch
        run: |
          BRANCH_NAME="feat/issue-${{ github.event.issue.number }}"
          git checkout -b $BRANCH_NAME
          git push origin $BRANCH_NAME

      - name: Run Claude Code to Generate Code
        uses: anthropics/claude-code-action@v1
        env:
          # OpenRouter 集成配置（参考：https://openrouter.ai/docs/guides/guides/claude-code-integration）
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          # 使用 OpenRouter API key（文档要求使用 anthropic_api_key）
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          # 使用 GitHub token 避免 OIDC token 获取失败
          github_token: ${{ github.token }}
          track_progress: true
          # 告诉 Claude 读取 Issue 里的设计文档并开始写代码
          prompt: |
            CONTEXT:
            REPO: ${{ github.repository }}
            ISSUE_NUMBER: ${{ github.event.issue.number }}
            TITLE: ${{ github.event.issue.title }}
            BODY: ${{ github.event.issue.body }}

            TASK:
            请根据 Issue Body 中提供的“技术架构设计”和“Backend/Frontend Contract”，在当前分支上实现对应的代码。

            REQUIREMENTS:
            1. 严格遵守 Go/React 风格指南。
            2. 如果涉及数据库变更，请更新相关模型文件。
            3. 编写完成后，请直接通过 git 提交代码。
            4. 禁止使用 nano 编辑器进行任何操作。

      - name: Create Pull Request
        run: |
          gh pr create \
            --title "feat: implement issue #${{ github.event.issue.number }}" \
            --body "This PR was automatically generated by Claude based on the analysis in issue #${{ github.event.issue.number }}." \
            --base main \
            --head feat/issue-${{ github.event.issue.number }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
