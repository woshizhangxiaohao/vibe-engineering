name: Agent Task Runner
on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "可选：要读取的 Issue 编号（用于手动触发时拉取 issue body）"
        required: false
        type: string
      issue_body:
        description: "可选：直接提供 Issue body（优先于 issue_number）"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  run-agent:
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event.action == 'labeled' && github.event.label.name == 'agent-task') ||
      (github.event.action == 'opened' && startsWith(github.event.issue.title, '[Agent]'))
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      # 模型选择：可以通过 secret 覆盖默认值
      # OpenRouter 模型格式：openai/gpt-4o, openai/gpt-5-chat 等
      # OpenAI 模型格式：gpt-4o, gpt-4-turbo 等
      CODEX_MODEL: ${{ secrets.CODEX_MODEL }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check API Key Set
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          if [ -z "$OPENROUTER_API_KEY" ] && [ -z "$OPENAI_API_KEY" ]; then
            echo "ERROR: Neither OPENROUTER_API_KEY nor OPENAI_API_KEY secret is set. Skipping agent run." >&2
            exit 1
          fi
          if [ -n "$OPENROUTER_API_KEY" ]; then
            echo "OpenRouter API key is set (will use OpenRouter)"
          elif [ -n "$OPENAI_API_KEY" ]; then
            echo "OpenAI API key is set (will use OpenAI)"
          fi

      - name: Read Issue
        id: read_issue
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # 安全地保存 issue 内容（避免 shell 展开/命令替换）
          python3 - <<'PY'
          import json
          import os
          import urllib.request
          import urllib.error
          from pathlib import Path

          event_path = os.environ.get("GITHUB_EVENT_PATH")
          if not event_path:
            raise SystemExit("GITHUB_EVENT_PATH is not set")

          payload = json.loads(Path(event_path).read_text(encoding="utf-8"))

          event_name = os.environ.get("GITHUB_EVENT_NAME") or ""
          body = ""

          if event_name == "workflow_dispatch":
            inputs = payload.get("inputs") or {}
            body = (inputs.get("issue_body") or "").strip()
            issue_number = (inputs.get("issue_number") or "").strip()
            if not body and issue_number:
              repo = os.environ.get("GITHUB_REPOSITORY")
              token = os.environ.get("GITHUB_TOKEN")
              if not repo or not token:
                raise SystemExit("GITHUB_REPOSITORY/GITHUB_TOKEN is not set; cannot fetch issue body")
              url = f"https://api.github.com/repos/{repo}/issues/{issue_number}"
              req = urllib.request.Request(
                url,
                headers={
                  "Accept": "application/vnd.github+json",
                  "Authorization": f"Bearer {token}",
                  "X-GitHub-Api-Version": "2022-11-28",
                  "User-Agent": "agent-task-runner",
                },
              )
              try:
                with urllib.request.urlopen(req, timeout=30) as resp:
                  issue = json.loads(resp.read().decode("utf-8"))
              except urllib.error.HTTPError as e:
                raise SystemExit(f"Failed to fetch issue #{issue_number}: HTTP {e.code}") from e
              body = (issue.get("body") or "").strip()
            if not body:
              raise SystemExit("workflow_dispatch 需要提供 inputs.issue_body 或 inputs.issue_number")
          else:
            body = ((payload.get("issue") or {}).get("body") or "").strip()

          Path("ISSUE.md").write_text(body, encoding="utf-8")
          PY

          echo "Issue content saved to ISSUE.md"

      - name: Run Codex
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          CODEX_MODEL: ${{ secrets.CODEX_MODEL }}
        run: |
          set -e

          # 优先使用 OpenRouter（如果配置了），否则使用 OpenAI
          if [ -n "$OPENROUTER_API_KEY" ]; then
            echo "Using OpenRouter API"
            API_KEY="$OPENROUTER_API_KEY"
            API_BASE="https://openrouter.ai/api/v1"
            # OpenRouter 默认模型（如果未指定）
            DEFAULT_MODEL="openai/gpt-5.2"
            # 使用指定的模型或默认模型
            MODEL="${CODEX_MODEL:-$DEFAULT_MODEL}"
            
            # 创建 Codex 配置文件目录
            mkdir -p ~/.codex
            
            # 创建 config.toml 配置文件（Codex 工具支持这种方式）
            cat > ~/.codex/config.toml <<EOF
          model_provider = "openrouter"
          model = "$MODEL"
          model_reasoning_effort = "none"
          disable_response_storage = true
          preferred_auth_method = "apikey"
          # 禁用 MCP 服务器以避免连接等待
          disable_mcp = true

          [model_providers.openrouter]
          name = "OpenRouter"
          base_url = "$API_BASE"
          # 使用 Codex 支持的 wire_api 枚举值：chat / responses
          # 这里选择 chat，走 OpenAI 兼容的 Chat Completions 线路
          wire_api = "chat"
          requires_openai_auth = false
          env_key = "OPENROUTER_API_KEY"
          EOF
            
            # 设置环境变量
            export OPENROUTER_API_KEY="$API_KEY"
            export HTTP_REFERER="https://github.com/${{ github.repository }}"
            export X_TITLE="GitHub Actions Agent"
          elif [ -n "$OPENAI_API_KEY" ]; then
            echo "Using OpenAI API"
            API_KEY="$OPENAI_API_KEY"
            API_BASE="https://api.openai.com/v1"
            # OpenAI 默认模型（如果未指定）
            DEFAULT_MODEL="gpt-4o"
            # 使用指定的模型或默认模型
            MODEL="${CODEX_MODEL:-$DEFAULT_MODEL}"
            
            # 创建 Codex 配置文件目录
            mkdir -p ~/.codex
            
            # 创建 config.toml 配置文件（使用 OpenAI）
            cat > ~/.codex/config.toml <<EOF
          model_provider = "openai"
          model = "$MODEL"
          model_reasoning_effort = "none"
          disable_response_storage = true
          preferred_auth_method = "apikey"
          # 禁用 MCP 服务器以避免连接等待
          disable_mcp = true

          [model_providers.openai]
          name = "OpenAI"
          base_url = "$API_BASE"
          env_key = "OPENAI_API_KEY"
          EOF
            
            # 设置环境变量
            export OPENAI_API_KEY="$API_KEY"
          else
            echo "ERROR: Neither OPENAI_API_KEY nor OPENROUTER_API_KEY is set!"
            exit 1
          fi

          # 调试：检查 API 密钥和模型配置
          echo "API_KEY is set (length: ${#API_KEY} characters)"
          echo "API_KEY prefix: ${API_KEY:0:10}..."
          echo "API_BASE: $API_BASE"
          echo "MODEL: $MODEL"
          echo "Config file created at: ~/.codex/config.toml"
          cat ~/.codex/config.toml

          # 创建 exec plan 文件（参考 OpenAI 团队的实践）
          # 这个文件记录进度，不只是给模型看的，也是给人看的
          cat > EXEC_PLAN.md <<'PLAN'
          # Execution Plan

          ## Goal
          Implement requirements from ISSUE.md following AGENT_PROTOCOL.md

          ## Status
          - [ ] Read and understand ISSUE.md
          - [ ] Read and understand AGENT_PROTOCOL.md
          - [ ] Create execution plan
          - [ ] Implement code changes
          - [ ] Write/update tests
          - [ ] Run tests and fix failures
          - [ ] Update documentation
          - [ ] Verify all requirements met

          ## Files to Create/Modify
          (Will be updated during execution)

          ## Notes
          (Will be updated during execution)
          PLAN

          cat > CODEX_PROMPT.txt <<'PROMPT'
          Read ISSUE.md (contract) and AGENT_PROTOCOL.md (rules). Then implement ISSUE.md.

          IMPORTANT:
          - Do NOT output or discuss "JSON tool calls" or "functions.shell" formatting.
          - Just execute: read/write files in the repo and run commands as needed.
          - Update EXEC_PLAN.md with: plan (exact files), progress checkboxes, and decisions.
          - Produce real code changes (at least one file changed), then run tests if available.

          Focus on minimal, reviewable changes. No unrelated refactors.
          PROMPT

          # `-` 表示从 stdin 读取 prompt
          # Codex 工具会从 ~/.codex/config.toml 读取配置
          # 禁用 MCP 以避免连接等待（mcp startup: no servers）
          # 设置必要的环境变量
          if [ -n "$OPENROUTER_API_KEY" ]; then
            # 使用 OpenRouter，设置必要的环境变量
            env OPENROUTER_API_KEY="$OPENROUTER_API_KEY" \
                HTTP_REFERER="https://github.com/${{ github.repository }}" \
                X_TITLE="GitHub Actions Agent" \
                CODEX_DISABLE_MCP="true" \
                MCP_DISABLED="true" \
                npx -y @openai/codex exec --full-auto -C . - < CODEX_PROMPT.txt
          else
            # 使用 OpenAI
            env OPENAI_API_KEY="$API_KEY" \
                CODEX_DISABLE_MCP="true" \
                MCP_DISABLED="true" \
                npx -y @openai/codex exec --full-auto -C . - < CODEX_PROMPT.txt
          fi

      - name: Run tests (if available)
        continue-on-error: true
        run: |
          echo "=== Running tests (if available) ==="
          # Try common test commands
          if [ -f package.json ]; then
            if grep -q '"test"' package.json; then
              echo "Running npm test..."
              npm test || echo "Tests failed or not configured"
            fi
          fi
          if [ -f pytest.ini ] || [ -f setup.py ] || [ -f pyproject.toml ]; then
            echo "Running pytest..."
            python -m pytest || echo "Pytest failed or not configured"
          fi
          if [ -f Makefile ] && grep -q "^test:" Makefile; then
            echo "Running make test..."
            make test || echo "Make test failed"
          fi

      - name: Check execution plan
        continue-on-error: true
        run: |
          if [ -f EXEC_PLAN.md ]; then
            echo "=== Execution Plan ==="
            cat EXEC_PLAN.md
          else
            echo "⚠️ EXEC_PLAN.md not found (agent may not have created it)"
          fi

      - name: Prepare PR metadata
        id: pr_meta
        run: |
          set -e

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            title="[Agent PR] 手动触发 ${{ github.run_id }}"
            branch="agent/manual-${{ github.run_id }}"
            commit_message="agent: manual run ${{ github.run_id }}"
            linked="(manual trigger)"
            issue_number=""
          else
            title="[Agent PR] ${{ github.event.issue.title }}"
            branch="agent/issue-${{ github.event.issue.number }}"
            commit_message="agent: ${{ github.event.issue.title }}"
            linked="#${{ github.event.issue.number }}"
            issue_number="${{ github.event.issue.number }}"
          fi

          {
            printf "%s\n\n" "This PR is automatically generated by the Codex agent following Vibe Engineering principles."
            printf "Linked: %s\n\n" "$linked"
            
            # Include execution plan if available
            if [ -f EXEC_PLAN.md ]; then
              printf "## Execution Plan\n\n"
              cat EXEC_PLAN.md
              printf "\n\n---\n\n"
            fi
            
            printf "## Issue Content\n\n"
            printf "----\n"
            cat ISSUE.md
            printf "\n\n"
            
            printf "## Vibe Engineering Notes\n\n"
            printf "- Code changes follow AGENT_PROTOCOL.md\n"
            printf "- Tests and documentation are included for both humans and future AI agents\n"
            printf "- Changes are minimal, focused, and reviewable\n"
          } > PR_BODY.md

          echo "title=$title" >> "$GITHUB_OUTPUT"
          echo "branch=$branch" >> "$GITHUB_OUTPUT"
          echo "commit_message=$commit_message" >> "$GITHUB_OUTPUT"
          echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"

      - name: Debug git status
        run: |
          echo "=== Git Status ==="
          git status
          echo ""
          echo "=== Changed Files ==="
          git diff --name-only || echo "No changes"

      - name: Stage all changes
        run: git add -A

      - name: Ensure code changes exist
        run: |
          if git diff --cached --quiet; then
            echo "❌ Agent produced no code changes"
            exit 1
          else
            echo "✅ Code changes detected:"
            git diff --cached --stat
          fi

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: ${{ steps.pr_meta.outputs.title }}
          body-path: PR_BODY.md
          branch: ${{ steps.pr_meta.outputs.branch }}
          commit-message: ${{ steps.pr_meta.outputs.commit_message }}
          delete-branch: true
          labels: |
            ai-generated
            automated-pr

      - name: Comment on issue
        if: github.event_name != 'workflow_dispatch' && steps.create_pr.outputs.pull-request-number
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.create_pr.outputs.pull-request-number }}
          ISSUE_NUMBER: ${{ steps.pr_meta.outputs.issue_number }}
        with:
          script: |
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            if (!issueNumber || issueNumber <= 0) {
              console.log(`Skipping comment: invalid issue number (${process.env.ISSUE_NUMBER})`);
              return;
            }
            github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ PR created: #${process.env.PR_NUMBER}\n\nThe AI agent has completed the task. Please review the changes.`
            })

      - name: Comment on failure
        if: github.event_name != 'workflow_dispatch' && failure()
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.pr_meta.outputs.issue_number }}
        with:
          script: |
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            if (!issueNumber || issueNumber <= 0) {
              console.log(`Skipping comment: invalid issue number (${process.env.ISSUE_NUMBER})`);
              return;
            }
            github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ AI agent task failed. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.`
            })
