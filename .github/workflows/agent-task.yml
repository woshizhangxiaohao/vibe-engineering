name: Agent Task Runner
on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  run-agent:
    if: >-
      (github.event.action == 'labeled' && github.event.label.name == 'agent-task') ||
      (github.event.action == 'opened' && startsWith(github.event.issue.title, '[Agent]'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Aider
        run: |
          python -m pip install --upgrade pip
          python -m pip install aider-chat

      - name: Read Issue
        id: read_issue
        run: |
          # ä¿å­˜ issue å†…å®¹
          echo "${{ github.event.issue.body }}" > ISSUE.md
          
          # æå–éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆå¦‚æœ issue ä¸­æŒ‡å®šäº†ï¼‰
          # é»˜è®¤è®© aider è‡ªåŠ¨æ£€æµ‹
          echo "Issue content saved to ISSUE.md"

      - name: Run Aider
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e
          
          # åˆ›å»ºä»»åŠ¡æç¤º
          cat > task.md <<'EOF'
          $(cat ISSUE.md)
          
          Please:
          1. Read and understand the requirements above
          2. Make the necessary code changes
          3. Ensure the changes are complete and functional
          4. Add or update tests if needed
          EOF
          
          # è¿è¡Œ aiderï¼ˆè‡ªåŠ¨æ¨¡å¼ï¼‰
          aider --yes --message "$(cat task.md)" --no-git

      - name: Debug git status
        run: |
          echo "=== Git Status ==="
          git status
          echo ""
          echo "=== Changed Files ==="
          git diff --name-only || echo "No changes"

      - name: Stage all changes
        run: git add -A

      - name: Ensure code changes exist
        run: |
          if git diff --cached --quiet; then
            echo "âŒ Agent produced no code changes"
            exit 1
          else
            echo "âœ… Code changes detected:"
            git diff --cached --stat
          fi

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          title: "[Agent PR] ${{ github.event.issue.title }}"
          body: |
            ğŸ¤– This PR is automatically generated by Aider AI Agent
            
            ğŸ“‹ **Linked Issue:** #${{ github.event.issue.number }}
            
            **Issue Content:**
            ${{ github.event.issue.body }}
            
            Please review the changes carefully before merging.
          branch: agent/issue-${{ github.event.issue.number }}
          commit-message: "ğŸ¤– AI Agent: ${{ github.event.issue.title }}"
          delete-branch: true
          labels: |
            ai-generated
            automated-pr

      - name: Comment on issue
        if: steps.create_pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… PR created: #${{ steps.create_pr.outputs.pull-request-number }}\n\nThe AI agent has completed the task. Please review the changes.`
            })

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ AI agent task failed. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.`
            })
