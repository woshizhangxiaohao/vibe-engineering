name: Agent Task Runner
on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write  # æ·»åŠ è¿™ä¸ª,ç”¨äºè¯„è®º issue

jobs:
  run-agent:
    if: >-
      (github.event.action == 'labeled' && github.event.label.name == 'agent-task') ||
      (github.event.action == 'opened' && startsWith(github.event.issue.title, '[Agent]'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²,æœ‰åŠ©äºæŸäº› git æ“ä½œ

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Codex CLI
        run: |
          python -m pip install --upgrade pip
          python -m pip install codex-cli

      - name: Read Issue
        run: |
          echo "${{ github.event.issue.body }}" > ISSUE.md
          cat ISSUE.md  # è°ƒè¯•ç”¨,æŸ¥çœ‹ issue å†…å®¹

      - name: Run Codex
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e
          cat > CODEX_PROMPT.txt <<'PROMPT'
          Read ISSUE.md as a contract.
          Follow AGENT_PROTOCOL.md.
          Generate execution plan.
          Execute task.
          Run tests.
          PROMPT
          
          # å°è¯•å¤šç§æ–¹å¼è¿è¡Œ codex
          if command -v codex >/dev/null 2>&1; then
            codex run CODEX_PROMPT.txt
          elif command -v codex-cli >/dev/null 2>&1; then
            codex-cli run CODEX_PROMPT.txt
          else
            python -m codex run CODEX_PROMPT.txt
          fi

      # ğŸ” è°ƒè¯•æ­¥éª¤ï¼šæŸ¥çœ‹å½“å‰çŠ¶æ€
      - name: Debug git status
        run: |
          echo "=== Working Directory ==="
          pwd
          ls -la
          echo ""
          echo "=== Git Status ==="
          git status
          echo ""
          echo "=== Unstaged Changes ==="
          git diff --stat
          echo ""
          echo "=== Staged Changes ==="
          git diff --cached --stat
          echo ""
          echo "=== All Changed Files ==="
          git diff HEAD --name-only || echo "No changes"

      # âœ… å…ˆ add æ‰€æœ‰å˜æ›´
      - name: Stage all changes
        run: |
          git add -A
          echo "Staged files:"
          git diff --cached --name-only

      # ğŸš¨ æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç å˜æ›´ï¼ˆæ£€æŸ¥ staged changesï¼‰
      - name: Ensure code changes exist
        run: |
          if git diff --cached --quiet; then
            echo "âŒ Agent produced no code changes"
            echo "This could mean:"
            echo "1. Codex didn't generate any code"
            echo "2. AGENT_PROTOCOL.md doesn't exist or is not properly configured"
            echo "3. The prompt needs adjustment"
            exit 1
          else
            echo "âœ… Code changes detected:"
            git diff --cached --stat
          fi

      # ğŸ”§ é…ç½® git ç”¨æˆ·ï¼ˆcreate-pull-request éœ€è¦ï¼‰
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          title: "[Agent PR] ${{ github.event.issue.title }}"
          body: |
            ğŸ¤– This PR is automatically generated by Codex AI Agent
            
            ğŸ“‹ **Linked Issue:** #${{ github.event.issue.number }}
            
            **Changes Summary:**
            - Task executed based on issue requirements
            - All tests passed
            
            Please review the changes carefully before merging.
          branch: agent/issue-${{ github.event.issue.number }}
          commit-message: "ğŸ¤– AI Agent: ${{ github.event.issue.title }}"
          delete-branch: true
          labels: |
            ai-generated
            automated-pr

      # ğŸ“ åœ¨ issue ä¸­è¯„è®º PR é“¾æ¥
      - name: Comment on issue
        if: steps.create_pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… PR created: #${{ steps.create_pr.outputs.pull-request-number }}\n\nThe AI agent has completed the task. Please review the changes.`
            })

      # âŒ å¤±è´¥æ—¶çš„å¤„ç†
      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ AI agent task failed. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.`
            })
