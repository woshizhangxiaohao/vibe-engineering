name: Agent Task Runner
on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "å¯é€‰ï¼šè¦è¯»å–çš„ Issue ç¼–å·ï¼ˆç”¨äºæ‰‹åŠ¨è§¦å‘æ—¶æ‹‰å– issue bodyï¼‰"
        required: false
        type: string
      issue_body:
        description: "å¯é€‰ï¼šç›´æ¥æä¾› Issue bodyï¼ˆä¼˜å…ˆäº issue_numberï¼‰"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  run-agent:
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event.action == 'labeled' && github.event.label.name == 'agent-task') ||
      (github.event.action == 'opened' && startsWith(github.event.issue.title, '[Agent]'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check OpenAI API Key Set
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "OPENAI_API_KEY secret is not set. Skipping agent run." >&2
            exit 1
          fi

      - name: Read Issue
        id: read_issue
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # å®‰å…¨åœ°ä¿å­˜ issue å†…å®¹ï¼ˆé¿å… shell å±•å¼€/å‘½ä»¤æ›¿æ¢ï¼‰
          python3 - <<'PY'
          import json
          import os
          import urllib.request
          import urllib.error
          from pathlib import Path
          
          event_path = os.environ.get("GITHUB_EVENT_PATH")
          if not event_path:
            raise SystemExit("GITHUB_EVENT_PATH is not set")
          
          payload = json.loads(Path(event_path).read_text(encoding="utf-8"))

          event_name = os.environ.get("GITHUB_EVENT_NAME") or ""
          body = ""

          if event_name == "workflow_dispatch":
            inputs = payload.get("inputs") or {}
            body = (inputs.get("issue_body") or "").strip()
            issue_number = (inputs.get("issue_number") or "").strip()
            if not body and issue_number:
              repo = os.environ.get("GITHUB_REPOSITORY")
              token = os.environ.get("GITHUB_TOKEN")
              if not repo or not token:
                raise SystemExit("GITHUB_REPOSITORY/GITHUB_TOKEN is not set; cannot fetch issue body")
              url = f"https://api.github.com/repos/{repo}/issues/{issue_number}"
              req = urllib.request.Request(
                url,
                headers={
                  "Accept": "application/vnd.github+json",
                  "Authorization": f"Bearer {token}",
                  "X-GitHub-Api-Version": "2022-11-28",
                  "User-Agent": "agent-task-runner",
                },
              )
              try:
                with urllib.request.urlopen(req, timeout=30) as resp:
                  issue = json.loads(resp.read().decode("utf-8"))
              except urllib.error.HTTPError as e:
                raise SystemExit(f"Failed to fetch issue #{issue_number}: HTTP {e.code}") from e
              body = (issue.get("body") or "").strip()
            if not body:
              raise SystemExit("workflow_dispatch éœ€è¦æä¾› inputs.issue_body æˆ– inputs.issue_number")
          else:
            body = ((payload.get("issue") or {}).get("body") or "").strip()

          Path("ISSUE.md").write_text(body, encoding="utf-8")
          PY
 
          echo "Issue content saved to ISSUE.md"

      - name: Run Codex
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e

          cat > CODEX_PROMPT.txt <<'PROMPT'
          Read ISSUE.md as a contract.
          Follow AGENT_PROTOCOL.md.
          Generate execution plan.
          Execute task.
          Run tests.
          PROMPT

          # `-` è¡¨ç¤ºä» stdin è¯»å– prompt
          npx -y @openai/codex exec --full-auto -C . - < CODEX_PROMPT.txt

      - name: Debug git status
        run: |
          echo "=== Git Status ==="
          git status
          echo ""
          echo "=== Changed Files ==="
          git diff --name-only || echo "No changes"

      - name: Stage all changes
        run: git add -A

      - name: Ensure code changes exist
        run: |
          if git diff --cached --quiet; then
            echo "âŒ Agent produced no code changes"
            exit 1
          else
            echo "âœ… Code changes detected:"
            git diff --cached --stat
          fi

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          title: "[Agent PR] ${{ github.event.issue.title }}"
          body: |
            This PR is automatically generated by the Codex agent.
            
            ğŸ“‹ **Linked Issue:** #${{ github.event.issue.number }}
            
            **Issue Content:**
            ${{ github.event.issue.body }}
            
            Please review the changes carefully before merging.
          branch: agent/issue-${{ github.event.issue.number }}
          commit-message: "agent: ${{ github.event.issue.title }}"
          delete-branch: true
          labels: |
            ai-generated
            automated-pr

      - name: Comment on issue
        if: steps.create_pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… PR created: #${{ steps.create_pr.outputs.pull-request-number }}\n\nThe AI agent has completed the task. Please review the changes.`
            })

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ AI agent task failed. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.`
            })
