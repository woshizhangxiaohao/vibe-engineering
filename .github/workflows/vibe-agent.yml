name: Vibe Agent

# ============================================================
# ç»Ÿä¸€ Agent å…¥å£
# æ›¿ä»£: issue-router.yml, agent-ui.yml, backend-agent.yml, frontend-agent.yml
# ============================================================
#
# å‘½ä»¤æ ¼å¼:
#   /agent ui              - ç”Ÿæˆ UI è®¾è®¡è§„æ ¼
#   /agent be              - ç”ŸæˆåŽç«¯ä»£ç 
#   /agent fe              - ç”Ÿæˆå‰ç«¯ä»£ç 
#   /agent be --spec #123  - æŒ‡å®š UI Spec æ¥æº
#
# å…¼å®¹æ—§å‘½ä»¤:
#   /agent-ui, /agent-be, /agent-fe
#
# è¾“å‡ºç­–ç•¥:
#   - UI Spec â†’ docs/specs/issue-{number}-ui.md + PR
#   - åŽç«¯ä»£ç  â†’ PR
#   - å‰ç«¯ä»£ç  â†’ PR
#   - ä¸å†åœ¨ Issue è¯„è®ºä¸­è¾“å‡ºé•¿å†…å®¹ï¼Œé¿å…æŠ˜å é—®é¢˜
# ============================================================

on:
  issue_comment:
    types: [created]

env:
  # UI Spec è¾“å‡ºç›®å½•
  SPEC_DIR: docs/specs

jobs:
  # ============================================================
  # Job 1: è§£æžå‘½ä»¤
  # ============================================================
  parse-command:
    runs-on: ubuntu-latest
    outputs:
      agent_type: ${{ steps.parse.outputs.agent_type }}
      spec_source: ${{ steps.parse.outputs.spec_source }}
      user_instructions: ${{ steps.parse.outputs.user_instructions }}
      should_run: ${{ steps.parse.outputs.should_run }}

    steps:
      - name: Parse Agent Command
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment.body || '';

            // å‘½ä»¤åŒ¹é…è§„åˆ™ï¼ˆä¼˜å…ˆçº§ä»Žé«˜åˆ°ä½Žï¼‰
            const patterns = [
              // æ–°å‘½ä»¤æ ¼å¼: /agent ui, /agent be, /agent fe
              { regex: /\/agent\s+(ui|be|fe)(?:\s+|$)/i, group: 1 },
              // æ—§å‘½ä»¤æ ¼å¼å…¼å®¹: /agent-ui, /agent-be, /agent-fe
              { regex: /\/agent-(ui|be|fe)(?:\s+|$)/i, group: 1 },
              // å¸¦ç©ºæ ¼çš„æ—§æ ¼å¼: /agent ui (without dash)
              { regex: /\/agent\s+ui(?:\s+|$)/i, type: 'ui' },
            ];

            let agentType = null;

            for (const pattern of patterns) {
              const match = body.match(pattern.regex);
              if (match) {
                agentType = pattern.type || match[pattern.group].toLowerCase();
                break;
              }
            }

            if (!agentType) {
              console.log('âŒ æœªè¯†åˆ«åˆ°æœ‰æ•ˆå‘½ä»¤');
              core.setOutput('should_run', 'false');
              return;
            }

            console.log(`âœ… è¯†åˆ«å‘½ä»¤ç±»åž‹: ${agentType}`);

            // æå– --spec å‚æ•°ï¼ˆç”¨äºŽ be/fe æŒ‡å®š UI Spec æ¥æºï¼‰
            let specSource = '';
            const specMatch = body.match(/--spec\s+#?(\d+)/i);
            if (specMatch) {
              specSource = specMatch[1];
              console.log(`ðŸ“‹ æŒ‡å®š Spec æ¥æº: Issue #${specSource}`);
            }

            // æå–ç”¨æˆ·é¢å¤–æŒ‡ä»¤ï¼ˆç§»é™¤å‘½ä»¤æœ¬èº«å’Œå‚æ•°ï¼‰
            let userInstructions = body
              .replace(/\/agent[-\s]+(ui|be|fe)/gi, '')
              .replace(/--spec\s+#?\d+/gi, '')
              .replace(/https:\/\/github\.com\/[^\s]+/g, '')  // ç§»é™¤ URL
              .trim();

            if (userInstructions) {
              console.log(`ðŸ’¬ ç”¨æˆ·æŒ‡ä»¤: ${userInstructions}`);
            }

            core.setOutput('agent_type', agentType);
            core.setOutput('spec_source', specSource);
            core.setOutput('user_instructions', userInstructions);
            core.setOutput('should_run', 'true');

  # ============================================================
  # Job 2: UI Agent - ç”Ÿæˆ UI è®¾è®¡è§„æ ¼
  # ============================================================
  agent-ui:
    needs: parse-command
    if: needs.parse-command.outputs.should_run == 'true' && needs.parse-command.outputs.agent_type == 'ui'
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "vibe-agent[bot]"
          git config user.email "vibe-agent@github-actions.bot"

      - name: Generate UI Spec
        id: generate
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          USER_INSTRUCTIONS: ${{ needs.parse-command.outputs.user_instructions }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const issue = context.payload.issue;
            const issueNumber = issue.number;
            const userInstructions = process.env.USER_INSTRUCTIONS || '';

            console.log('='.repeat(60));
            console.log('ðŸŽ¨ UI AGENT - ç”Ÿæˆ UI è®¾è®¡è§„æ ¼');
            console.log('='.repeat(60));

            // Step 1: PM Compiler - å°† PRD è½¬æ¢ä¸ºæ¸…æ™°çš„äº§å“éœ€æ±‚è§„æ ¼
            console.log('\nðŸ“ Step 1: PM Compiler...');

            const pmPrompt = [
              'ä½ æ˜¯ä¸€ä¸ªã€éœ€æ±‚ç¼–è¯‘å™¨ï¼ˆPM Requirement Compilerï¼‰ã€‘ã€‚',
              '',
              'ä½ çš„èŒè´£æ˜¯å°†ã€äººç±» PM ç¼–å†™çš„éœ€æ±‚æ–‡æœ¬ã€‘è½¬æ¢ä¸ºã€æ¸…æ™°çš„äº§å“éœ€æ±‚è§„æ ¼ã€‘ã€‚',
              '',
              'è¾“å…¥ï¼ˆPM åŽŸå§‹éœ€æ±‚ï¼‰:',
              `æ ‡é¢˜: ${issue.title}`,
              `å†…å®¹: ${issue.body || 'æ— '}`,
              '',
              userInstructions ? `ç”¨æˆ·é¢å¤–æŒ‡ä»¤: ${userInstructions}` : '',
              '',
              'è¾“å‡ºè¦æ±‚:',
              '- æ¶ˆé™¤æ­§ä¹‰ï¼Œå†»ç»“äº‹å®ž',
              '- æ˜Žç¡®ç¦æ­¢é¡¹å’Œè¾¹ç•Œæƒ…å†µ',
              '- ä¸å¾—æ–°å¢žåŽŸéœ€æ±‚é‡Œä¸å­˜åœ¨çš„æ–°åŠŸèƒ½',
              '',
              'è¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰:',
              '{',
              '  "product_goal": "äº§å“ç›®æ ‡ï¼ˆä¸€å¥è¯ï¼‰",',
              '  "user_actions": ["ç”¨æˆ·åŠ¨ä½œ â†’ ç³»ç»Ÿååº”"],',
              '  "input_rules": ["è¾“å…¥è§„åˆ™"],',
              '  "output_rules": ["è¾“å‡ºè§„åˆ™"],',
              '  "forbidden_actions": ["ç¦æ­¢è¡Œä¸º"],',
              '  "edge_cases": ["å¼‚å¸¸å¤„ç†"]',
              '}',
              '',
              'åªè¿”å›ž JSONã€‚'
            ].join('\n');

            const pmRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'google/gemini-2.0-flash-001',
                messages: [{ role: 'user', content: pmPrompt }],
                temperature: 0.3
              })
            });

            if (!pmRes.ok) {
              throw new Error(`PM Compiler å¤±è´¥: ${pmRes.status}`);
            }

            const pmData = await pmRes.json();
            let pmResult = pmData.choices?.[0]?.message?.content || '';

            // æå– JSON
            const jsonMatch = pmResult.match(/```(?:json)?\s*([\s\S]*?)```/) ||
                              pmResult.match(/(\{[\s\S]*\})/);
            if (jsonMatch) pmResult = jsonMatch[1];

            let compiledRequirement;
            try {
              const parsed = JSON.parse(pmResult);
              compiledRequirement = [
                '## äº§å“ç›®æ ‡',
                parsed.product_goal || 'æœªå®šä¹‰',
                '',
                '## æ ¸å¿ƒç”¨æˆ·åŠ¨ä½œ',
                (parsed.user_actions || []).map((a, i) => `${i + 1}. ${a}`).join('\n'),
                '',
                '## è¾“å…¥è§„åˆ™',
                (parsed.input_rules || []).map(r => `- ${r}`).join('\n'),
                '',
                '## è¾“å‡ºè§„åˆ™',
                (parsed.output_rules || []).map(r => `- ${r}`).join('\n'),
                '',
                '## ç¦æ­¢è¡Œä¸º',
                (parsed.forbidden_actions || []).map(f => `- ${f}`).join('\n'),
                '',
                '## å¼‚å¸¸ä¸Žè¾¹ç•Œ',
                (parsed.edge_cases || []).map(e => `- ${e}`).join('\n')
              ].join('\n');
            } catch (e) {
              console.log('âš ï¸ JSON è§£æžå¤±è´¥ï¼Œä½¿ç”¨åŽŸå§‹å†…å®¹');
              compiledRequirement = pmResult;
            }

            console.log('âœ… PM Compiler å®Œæˆ');

            // Step 2: UI Spec Generator
            console.log('\nðŸŽ¨ Step 2: UI Spec Generator...');

            const uiPrompt = [
              'ä½ æ˜¯ UI è®¾è®¡è§„æ ¼ç”Ÿæˆå™¨ã€‚',
              '',
              'å°†äº§å“éœ€æ±‚è½¬æ¢ä¸ºã€UI è®¾è®¡è§„æ ¼ã€‘ã€‚',
              '**æ³¨æ„ï¼šåªå…³æ³¨ UI è®¾è®¡å±‚é¢ï¼Œä¸æ¶‰åŠå…·ä½“çš„æ–‡ä»¶è·¯å¾„å’Œä»£ç å®žçŽ°ã€‚**',
              '',
              '## å¯ç”¨çš„ shadcn/ui ç»„ä»¶',
              'å¸ƒå±€: Card, Tabs, Separator, ScrollArea',
              'è¡¨å•: Button, Input, Textarea, Select, Switch, Form',
              'åé¦ˆ: Alert, Dialog, Sheet, Tooltip, Sonner(toast), Progress, Skeleton',
              'å¯¼èˆª: Breadcrumb, DropdownMenu, Command, Pagination',
              'æ•°æ®: Avatar, Badge, Table, Calendar',
              '',
              '## Base.org è®¾è®¡ç³»ç»Ÿè§„èŒƒ',
              '- é¢œè‰²ï¼šBase Blue (#0000ff) ä½œä¸ºä¸»è‰²ï¼Œ90% åŒºåŸŸä½¿ç”¨ç°åº¦',
              '- åœ†è§’ï¼šæŒ‰é’®/è¾“å…¥æ¡† 12pxï¼Œå¡ç‰‡ 12-16px',
              '- æ— é˜´å½±ã€æ— è¾¹æ¡†è®¾è®¡',
              '',
              '## éœ€æ±‚',
              compiledRequirement,
              '',
              '## è¾“å‡ºæ ¼å¼',
              '',
              '# UI è®¾è®¡è§„æ ¼',
              '',
              '## åŠŸèƒ½æ¦‚è¿°',
              'ä¸€æ®µè¯æè¿°åŠŸèƒ½',
              '',
              '## é¡µé¢å¸ƒå±€',
              'æ•´ä½“å¸ƒå±€ç»“æž„',
              '',
              '## ç»„ä»¶è®¾è®¡',
              '### ç»„ä»¶åç§°',
              '- åŠŸèƒ½æè¿°',
              '- ä½¿ç”¨çš„ shadcn/ui ç»„ä»¶',
              '- è§†è§‰æ ·å¼',
              '- çŠ¶æ€å˜åŒ–',
              '',
              '## äº¤äº’æµç¨‹',
              'ç”¨æˆ·æ“ä½œ â†’ ç•Œé¢ååº”',
              '',
              '## å“åº”å¼è®¾è®¡',
              'ä¸åŒå±å¹•çš„é€‚é…',
              '',
              '---',
              'åªè¾“å‡º UI è®¾è®¡è§„æ ¼ï¼Œä¸è¦å†™ä»£ç ã€‚'
            ].join('\n');

            const uiRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'google/gemini-2.0-flash-001',
                messages: [{ role: 'user', content: uiPrompt }],
                temperature: 0.5
              })
            });

            if (!uiRes.ok) {
              throw new Error(`UI Spec Generator å¤±è´¥: ${uiRes.status}`);
            }

            const uiData = await uiRes.json();
            const uiSpec = uiData.choices?.[0]?.message?.content || '';

            console.log('âœ… UI Spec ç”Ÿæˆå®Œæˆ');

            // Step 3: å†™å…¥æ–‡ä»¶
            const specDir = process.env.SPEC_DIR || 'docs/specs';
            const specFileName = `issue-${issueNumber}-ui.md`;
            const specFilePath = path.join(specDir, specFileName);

            // ç¡®ä¿ç›®å½•å­˜åœ¨
            fs.mkdirSync(specDir, { recursive: true });

            const fileContent = [
              `# UI Spec for Issue #${issueNumber}`,
              '',
              `> åŽŸå§‹éœ€æ±‚: [#${issueNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issueNumber})`,
              `> ç”Ÿæˆæ—¶é—´: ${new Date().toISOString()}`,
              '',
              '---',
              '',
              '## éœ€æ±‚æ‘˜è¦',
              '',
              compiledRequirement,
              '',
              '---',
              '',
              uiSpec,
              '',
              '---',
              '',
              '## ä¸‹ä¸€æ­¥',
              '',
              'ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆä»£ç ï¼š',
              '```',
              `/agent be --spec #${issueNumber}  # ç”ŸæˆåŽç«¯ä»£ç `,
              `/agent fe --spec #${issueNumber}  # ç”Ÿæˆå‰ç«¯ä»£ç `,
              '```'
            ].join('\n');

            fs.writeFileSync(specFilePath, fileContent);
            console.log(`âœ… å†™å…¥æ–‡ä»¶: ${specFilePath}`);

            core.setOutput('spec_file', specFilePath);
            core.setOutput('spec_content', fileContent);

      - name: Create PR with UI Spec
        uses: actions/github-script@v7
        env:
          SPEC_FILE: ${{ steps.generate.outputs.spec_file }}
        with:
          script: |
            const { execSync } = require('child_process');
            const issue = context.payload.issue;
            const issueNumber = issue.number;
            const specFile = process.env.SPEC_FILE;

            const branchName = `ui-spec/issue-${issueNumber}`;

            // åˆ›å»ºåˆ†æ”¯å¹¶æäº¤
            try {
              execSync(`git checkout -b ${branchName}`);
              execSync(`git add ${specFile}`);
              execSync(`git commit -m "docs: add UI spec for issue #${issueNumber}"`);
              execSync(`git push origin ${branchName}`);
            } catch (e) {
              console.error('Git æ“ä½œå¤±è´¥:', e.message);
              throw e;
            }

            // åˆ›å»º PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[UI Spec] ${issue.title}`,
              head: branchName,
              base: 'main',
              body: [
                `## UI è®¾è®¡è§„æ ¼`,
                '',
                `å…³è” Issue: #${issueNumber}`,
                '',
                `### æ–‡ä»¶`,
                `- \`${specFile}\``,
                '',
                '### ä¸‹ä¸€æ­¥',
                '1. Review å¹¶ Merge æ­¤ PR',
                '2. åœ¨åŽŸ Issue ä¸­æ‰§è¡Œï¼š',
                '   ```',
                `   /agent be --spec #${issueNumber}`,
                `   /agent fe --spec #${issueNumber}`,
                '   ```',
                '',
                '---',
                'ðŸ¤– Generated by Vibe Agent'
              ].join('\n')
            });

            // åœ¨ Issue ä¸­æ·»åŠ ç®€çŸ­è¯„è®ºï¼ˆä¸æ”¾é•¿å†…å®¹ï¼Œé¿å…æŠ˜å ï¼‰
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                'âœ… **UI Spec å·²ç”Ÿæˆ**',
                '',
                `ðŸ“„ PR: #${pr.number}`,
                `ðŸ“ æ–‡ä»¶: \`${specFile}\``,
                '',
                '**ä¸‹ä¸€æ­¥ï¼š**',
                '1. Review å¹¶ Merge PR',
                '2. æ‰§è¡Œ `/agent be` æˆ– `/agent fe` ç”Ÿæˆä»£ç '
              ].join('\n')
            });

            // æ›´æ–°æ ‡ç­¾
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['ui-spec-ready']
            });

  # ============================================================
  # Job 3: Backend Agent - ç”ŸæˆåŽç«¯ä»£ç 
  # ============================================================
  agent-be:
    needs: parse-command
    if: needs.parse-command.outputs.should_run == 'true' && needs.parse-command.outputs.agent_type == 'be'
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "vibe-agent[bot]"
          git config user.email "vibe-agent@github-actions.bot"

      - name: Detect Feature Branch
        id: feature
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            let featureLabel = labels.find(l => l.startsWith('feature:'));

            if (!featureLabel && issue.body) {
              const parentMatch = issue.body.match(/(?:part of|parent|belongs to|see)\s*#(\d+)/i);
              if (parentMatch) {
                const parentNumber = parseInt(parentMatch[1]);
                try {
                  const { data: parentIssue } = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parentNumber
                  });
                  featureLabel = parentIssue.labels.map(l => l.name).find(l => l.startsWith('feature:'));
                } catch (e) {
                  console.log(`âš ï¸ æ— æ³•èŽ·å–çˆ¶ Issue #${parentNumber}`);
                }
              }
            }

            const branch = featureLabel ? featureLabel.replace(':', '/') : 'main';
            console.log(`ðŸŒ¿ ç›®æ ‡åˆ†æ”¯: ${branch}`);
            core.setOutput('branch', branch);

      - name: Prepare Context
        id: prepare
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          SPEC_SOURCE: ${{ needs.parse-command.outputs.spec_source }}
          USER_INSTRUCTIONS: ${{ needs.parse-command.outputs.user_instructions }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const issue = context.payload.issue;
            const specSource = process.env.SPEC_SOURCE;
            const userInstructions = process.env.USER_INSTRUCTIONS || '';

            console.log('='.repeat(60));
            console.log('ðŸ”§ BACKEND AGENT - å‡†å¤‡ä¸Šä¸‹æ–‡');
            console.log('='.repeat(60));

            // 1. èŽ·å– UI Spec
            let uiSpec = '';

            // ä¼˜å…ˆä»Žæ–‡ä»¶è¯»å–
            const specFile = `docs/specs/issue-${specSource || issue.number}-ui.md`;
            if (fs.existsSync(specFile)) {
              uiSpec = fs.readFileSync(specFile, 'utf8');
              console.log(`âœ… ä»Žæ–‡ä»¶è¯»å– UI Spec: ${specFile}`);
            } else if (specSource) {
              // ä»ŽæŒ‡å®š Issue èŽ·å–
              try {
                const { data: specIssue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(specSource)
                });
                uiSpec = specIssue.body || '';
                console.log(`âœ… ä»Ž Issue #${specSource} èŽ·å– UI Spec`);
              } catch (e) {
                console.log(`âš ï¸ æ— æ³•èŽ·å– Issue #${specSource}`);
              }
            } else {
              // ä½¿ç”¨å½“å‰ Issue å†…å®¹
              uiSpec = issue.body || '';
              console.log('âœ… ä½¿ç”¨å½“å‰ Issue å†…å®¹ä½œä¸ºéœ€æ±‚');
            }

            // 2. ç”Ÿæˆ API Contract
            console.log('\nðŸ“‹ ç”Ÿæˆ API Contract...');

            const contractPrompt = `åŸºäºŽä»¥ä¸‹ UI Specï¼ŒæŽ¨å¯¼æœ€å° API å¥‘çº¦ã€‚

            ${userInstructions ? `ç”¨æˆ·è¦æ±‚: ${userInstructions}\n\n` : ''}

            UI Spec:
            ${uiSpec.substring(0, 8000)}

            è¿”å›ž JSON æ•°ç»„:
            [{"endpoint": "/api/xxx", "method": "POST", "description": "æè¿°", "request": {}, "response": {}}]

            åªè¿”å›ž JSONã€‚`;

            const contractRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'google/gemini-2.0-flash-001',
                messages: [{ role: 'user', content: contractPrompt }],
                temperature: 0.3
              })
            });

            const contractData = await contractRes.json();
            let apiContract = contractData.choices?.[0]?.message?.content || '[]';

            const jsonMatch = apiContract.match(/```(?:json)?\s*([\s\S]*?)```/) || apiContract.match(/(\[[\s\S]*\])/);
            if (jsonMatch) apiContract = jsonMatch[1];

            try {
              apiContract = JSON.parse(apiContract);
              if (!Array.isArray(apiContract)) apiContract = [apiContract];
            } catch (e) {
              apiContract = [];
            }

            console.log(`âœ… API Contract: ${apiContract.length} ä¸ªæŽ¥å£`);

            // 3. è¯»å–é¡¹ç›®æ–‡ä»¶
            const systemFiles = [
              'backend/go.mod',
              'backend/CLAUDE.md',
              'backend/internal/router/router.go'
            ];

            const projectContext = {};
            for (const filePath of systemFiles) {
              try {
                if (fs.existsSync(filePath)) {
                  projectContext[filePath] = fs.readFileSync(filePath, 'utf8');
                }
              } catch (e) {}
            }

            const projectContextText = Object.entries(projectContext)
              .map(([p, c]) => `## ${p}\n\`\`\`go\n${c}\n\`\`\``)
              .join('\n\n');

            // 4. å‘å¸ƒç®€çŸ­å¯åŠ¨è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                'ðŸ”§ **Backend Agent å¯åŠ¨**',
                '',
                `**API Contract:** ${apiContract.length} ä¸ªæŽ¥å£`,
                apiContract.slice(0, 5).map((api, i) => `- \`${api.method} ${api.endpoint}\``).join('\n'),
                apiContract.length > 5 ? `- ... ç­‰ ${apiContract.length - 5} ä¸ª` : '',
                '',
                '_æ­£åœ¨ç”Ÿæˆä»£ç ..._'
              ].join('\n')
            });

            // 5. æž„å»º Prompt
            const prompt = `ä½ æ˜¯åŽç«¯ä»£ç ç”Ÿæˆä¸“å®¶ã€‚

            ## ä»»åŠ¡
            åŸºäºŽ API Contract å®žçŽ°åŽç«¯ä»£ç ã€‚

            ## API Contract
            ${JSON.stringify(apiContract, null, 2)}

            ${userInstructions ? `## ç”¨æˆ·è¦æ±‚\n${userInstructions}\n` : ''}

            ## é¡¹ç›®çº¦æŸ
            ${projectContextText || 'æ— çŽ°æœ‰ä»£ç å‚è€ƒ'}

            ## è¦æ±‚
            - éµå¾ªçŽ°æœ‰ä»£ç é£Žæ ¼
            - æ‰€æœ‰æ–‡ä»¶åœ¨ backend/ ç›®å½•ä¸‹
            - ä½¿ç”¨ Go æ ‡å‡†åº“å’Œé¡¹ç›®å·²æœ‰ä¾èµ–
            - åŒ…å«é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

            è¯·ç”Ÿæˆå®Œæ•´çš„åŽç«¯å®žçŽ°ã€‚`;

            core.setOutput('prompt', prompt);

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          track_progress: true
          prompt: ${{ steps.prepare.outputs.prompt }}
          base_branch: ${{ steps.feature.outputs.branch }}
          claude_args: |
            --model anthropic/claude-sonnet-4.5
            --max-turns 60

      - name: Update Labels
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const labels = '${{ job.status }}' === 'success'
              ? ['âœ… ai-completed']
              : ['âŒ ai-failed'];

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'ðŸ¤– ai-processing'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels
            });

  # ============================================================
  # Job 4: Frontend Agent - ç”Ÿæˆå‰ç«¯ä»£ç 
  # ============================================================
  agent-fe:
    needs: parse-command
    if: needs.parse-command.outputs.should_run == 'true' && needs.parse-command.outputs.agent_type == 'fe'
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "vibe-agent[bot]"
          git config user.email "vibe-agent@github-actions.bot"

      - name: Detect Feature Branch
        id: feature
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            let featureLabel = labels.find(l => l.startsWith('feature:'));

            if (!featureLabel && issue.body) {
              const parentMatch = issue.body.match(/(?:part of|parent|belongs to|see)\s*#(\d+)/i);
              if (parentMatch) {
                const parentNumber = parseInt(parentMatch[1]);
                try {
                  const { data: parentIssue } = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parentNumber
                  });
                  featureLabel = parentIssue.labels.map(l => l.name).find(l => l.startsWith('feature:'));
                } catch (e) {
                  console.log(`âš ï¸ æ— æ³•èŽ·å–çˆ¶ Issue #${parentNumber}`);
                }
              }
            }

            const branch = featureLabel ? featureLabel.replace(':', '/') : 'main';
            console.log(`ðŸŒ¿ ç›®æ ‡åˆ†æ”¯: ${branch}`);
            core.setOutput('branch', branch);

      - name: Prepare Context
        id: prepare
        uses: actions/github-script@v7
        env:
          SPEC_SOURCE: ${{ needs.parse-command.outputs.spec_source }}
          USER_INSTRUCTIONS: ${{ needs.parse-command.outputs.user_instructions }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const issue = context.payload.issue;
            const specSource = process.env.SPEC_SOURCE;
            const userInstructions = process.env.USER_INSTRUCTIONS || '';

            console.log('='.repeat(60));
            console.log('ðŸŽ¨ FRONTEND AGENT - å‡†å¤‡ä¸Šä¸‹æ–‡');
            console.log('='.repeat(60));

            // 1. èŽ·å– UI Spec
            let uiSpec = '';

            const specFile = `docs/specs/issue-${specSource || issue.number}-ui.md`;
            if (fs.existsSync(specFile)) {
              uiSpec = fs.readFileSync(specFile, 'utf8');
              console.log(`âœ… ä»Žæ–‡ä»¶è¯»å– UI Spec: ${specFile}`);
            } else if (specSource) {
              try {
                const { data: specIssue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(specSource)
                });
                uiSpec = specIssue.body || '';
                console.log(`âœ… ä»Ž Issue #${specSource} èŽ·å– UI Spec`);
              } catch (e) {
                console.log(`âš ï¸ æ— æ³•èŽ·å– Issue #${specSource}`);
              }
            } else {
              uiSpec = issue.body || '';
              console.log('âœ… ä½¿ç”¨å½“å‰ Issue å†…å®¹ä½œä¸ºéœ€æ±‚');
            }

            // 2. è¯»å–é¡¹ç›®æ–‡ä»¶
            const systemFiles = [
              'frontend/package.json',
              'frontend/STYLE_GUIDE.md',
              'frontend/lib/api/client.ts',
              'frontend/lib/api/types.ts'
            ];

            const projectContext = {};
            for (const filePath of systemFiles) {
              try {
                if (fs.existsSync(filePath)) {
                  projectContext[filePath] = fs.readFileSync(filePath, 'utf8');
                }
              } catch (e) {}
            }

            const projectContextText = Object.entries(projectContext)
              .map(([p, c]) => `## ${p}\n\`\`\`typescript\n${c}\n\`\`\``)
              .join('\n\n');

            // 3. å‘å¸ƒç®€çŸ­å¯åŠ¨è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                'ðŸŽ¨ **Frontend Agent å¯åŠ¨**',
                '',
                `**UI Spec:** ${specSource ? `Issue #${specSource}` : 'å½“å‰ Issue'}`,
                '',
                '_æ­£åœ¨ç”Ÿæˆä»£ç ..._'
              ].join('\n')
            });

            // 4. æž„å»º Prompt
            const prompt = `ä½ æ˜¯å‰ç«¯ä»£ç ç”Ÿæˆä¸“å®¶ã€‚

            ## ä»»åŠ¡
            åŸºäºŽ UI Spec å®žçŽ°å‰ç«¯é¡µé¢å’Œç»„ä»¶ã€‚

            ## UI Spec
            ${uiSpec.substring(0, 10000)}

            ${userInstructions ? `## ç”¨æˆ·è¦æ±‚\n${userInstructions}\n` : ''}

            ## é¡¹ç›®çº¦æŸ
            ${projectContextText || 'æ— çŽ°æœ‰ä»£ç å‚è€ƒ'}

            ## æŠ€æœ¯æ ˆ
            - Next.js 15 (App Router)
            - React 19
            - TypeScript
            - Tailwind CSS
            - shadcn/ui
            - Base.org è®¾è®¡ç³»ç»Ÿ

            ## è¦æ±‚
            - ä¸¥æ ¼éµå¾ª STYLE_GUIDE.md çš„è®¾è®¡è§„èŒƒ
            - ä½¿ç”¨ shadcn/ui ç»„ä»¶
            - æ‰€æœ‰æ–‡ä»¶åœ¨ frontend/ ç›®å½•ä¸‹
            - ä½¿ç”¨ TypeScript
            - API è°ƒç”¨ä½¿ç”¨ lib/api/client.ts

            è¯·ç”Ÿæˆå®Œæ•´çš„å‰ç«¯å®žçŽ°ã€‚`;

            core.setOutput('prompt', prompt);

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          track_progress: true
          prompt: ${{ steps.prepare.outputs.prompt }}
          base_branch: ${{ steps.feature.outputs.branch }}
          claude_args: |
            --model anthropic/claude-sonnet-4.5
            --max-turns 60

      - name: Update Labels
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const labels = '${{ job.status }}' === 'success'
              ? ['âœ… ai-completed']
              : ['âŒ ai-failed'];

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'ðŸ¤– ai-processing'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels
            });
