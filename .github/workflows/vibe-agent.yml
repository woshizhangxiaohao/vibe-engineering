name: Vibe Agent

# ============================================================
# ç»Ÿä¸€ Agent å…¥å£
# æ›¿ä»£: issue-router.yml, agent-ui.yml, backend-agent.yml, frontend-agent.yml
# ============================================================
#
# å‘½ä»¤æ ¼å¼:
#   /agent ui              - ç”Ÿæˆ UI è®¾è®¡è§„æ ¼
#   /agent spec            - ç”Ÿæˆå®Œæ•´æŠ€æœ¯è§„æ ¼ï¼ˆUI + API + æ•°æ®æ¨¡å‹ + éªŒæ”¶æ ‡å‡†ï¼‰
#   /agent be              - ç”Ÿæˆåç«¯ä»£ç 
#   /agent fe              - ç”Ÿæˆå‰ç«¯ä»£ç 
#   /agent be --spec #123  - æŒ‡å®š UI Spec æ¥æº
#
# å…¼å®¹æ—§å‘½ä»¤:
#   /agent-ui, /agent-spec, /agent-be, /agent-fe
#
# è¾“å‡ºç­–ç•¥:
#   - UI Spec â†’ docs/specs/issue-{number}-ui.md + PR
#   - Tech Spec â†’ docs/specs/issue-{number}-spec.md + PR
#   - åç«¯ä»£ç  â†’ PR
#   - å‰ç«¯ä»£ç  â†’ PR
#   - ä¸å†åœ¨ Issue è¯„è®ºä¸­è¾“å‡ºé•¿å†…å®¹ï¼Œé¿å…æŠ˜å é—®é¢˜
# ============================================================

on:
  issue_comment:
    types: [created]

env:
  # UI Spec è¾“å‡ºç›®å½•
  SPEC_DIR: docs/specs

jobs:
  # ============================================================
  # Job 1: è§£æå‘½ä»¤
  # ============================================================
  parse-command:
    if: github.event.issue.pull_request == null
    runs-on: ubuntu-latest
    outputs:
      agent_type: ${{ steps.parse.outputs.agent_type }}
      spec_source: ${{ steps.parse.outputs.spec_source }}
      user_instructions: ${{ steps.parse.outputs.user_instructions }}
      should_run: ${{ steps.parse.outputs.should_run }}

    steps:
      - name: Parse Agent Command
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment.body || '';

            // å‘½ä»¤åŒ¹é…è§„åˆ™ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰
            const patterns = [
              // æ–°å‘½ä»¤æ ¼å¼: /agent ui, /agent spec, /agent be, /agent fe
              { regex: /\/agent\s+(ui|spec|be|fe)(?:\s+|$)/i, group: 1 },
              // æ—§å‘½ä»¤æ ¼å¼å…¼å®¹: /agent-ui, /agent-spec, /agent-be, /agent-fe
              { regex: /\/agent-(ui|spec|be|fe)(?:\s+|$)/i, group: 1 },
              // å¸¦ç©ºæ ¼çš„æ—§æ ¼å¼: /agent ui (without dash)
              { regex: /\/agent\s+ui(?:\s+|$)/i, type: 'ui' },
            ];

            let agentType = null;

            for (const pattern of patterns) {
              const match = body.match(pattern.regex);
              if (match) {
                agentType = pattern.type || match[pattern.group].toLowerCase();
                break;
              }
            }

            if (!agentType) {
              console.log('âŒ æœªè¯†åˆ«åˆ°æœ‰æ•ˆå‘½ä»¤');
              core.setOutput('should_run', 'false');
              return;
            }

            console.log(`âœ… è¯†åˆ«å‘½ä»¤ç±»å‹: ${agentType}`);

            // æå– --spec å‚æ•°ï¼ˆç”¨äº be/fe æŒ‡å®š UI Spec æ¥æºï¼‰
            let specSource = '';
            const specMatch = body.match(/--spec\s+#?(\d+)/i);
            if (specMatch) {
              specSource = specMatch[1];
              console.log(`ğŸ“‹ æŒ‡å®š Spec æ¥æº: Issue #${specSource}`);
            }

            // æå–ç”¨æˆ·é¢å¤–æŒ‡ä»¤ï¼ˆç§»é™¤å‘½ä»¤æœ¬èº«å’Œå‚æ•°ï¼‰
            let userInstructions = body
              .replace(/\/agent[-\s]+(ui|be|fe)/gi, '')
              .replace(/--spec\s+#?\d+/gi, '')
              .replace(/https:\/\/github\.com\/[^\s]+/g, '')  // ç§»é™¤ URL
              .trim();

            if (userInstructions) {
              console.log(`ğŸ’¬ ç”¨æˆ·æŒ‡ä»¤: ${userInstructions}`);
            }

            core.setOutput('agent_type', agentType);
            core.setOutput('spec_source', specSource);
            core.setOutput('user_instructions', userInstructions);
            core.setOutput('should_run', 'true');

  # ============================================================
  # Job 2: UI Agent - ç”Ÿæˆ UI è®¾è®¡è§„æ ¼
  # ============================================================
  agent-ui:
    needs: parse-command
    if: needs.parse-command.outputs.should_run == 'true' && needs.parse-command.outputs.agent_type == 'ui'
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "vibe-agent[bot]"
          git config user.email "vibe-agent@github-actions.bot"

      - name: Load PM Compiler Prompt
        id: pm_prompt
        uses: ./.github/actions/load-prompt
        with:
          template: agents/vibe/pm-compiler.md
          variables: |
            {
              "title": ${{ toJson(github.event.issue.title) }},
              "body": ${{ toJson(github.event.issue.body) }},
              "user_instructions": ${{ toJson(needs.parse-command.outputs.user_instructions) }}
            }

      - name: Load UI Spec Prompt
        id: ui_prompt
        uses: ./.github/actions/load-prompt
        with:
          template: agents/vibe/ui-spec.md
          variables: '{}'

      - name: Generate UI Spec
        id: generate
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          USER_INSTRUCTIONS: ${{ needs.parse-command.outputs.user_instructions }}
          PM_PROMPT: ${{ steps.pm_prompt.outputs.prompt }}
          UI_PROMPT_TEMPLATE: ${{ steps.ui_prompt.outputs.prompt }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const issue = context.payload.issue;
            const issueNumber = issue.number;
            const userInstructions = process.env.USER_INSTRUCTIONS || '';

            console.log('='.repeat(60));
            console.log('ğŸ¨ UI AGENT - ç”Ÿæˆ UI è®¾è®¡è§„æ ¼');
            console.log('='.repeat(60));

            // Step 1: PM Compiler - å°† PRD è½¬æ¢ä¸ºæ¸…æ™°çš„äº§å“éœ€æ±‚è§„æ ¼
            console.log('\nğŸ“ Step 1: PM Compiler...');
            console.log('ğŸ“„ ä½¿ç”¨æ¨¡æ¿: agents/vibe/pm-compiler.md');

            const pmPrompt = process.env.PM_PROMPT;

            const pmRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'google/gemini-2.0-flash-001',
                messages: [{ role: 'user', content: pmPrompt }],
                temperature: 0.3
              })
            });

            if (!pmRes.ok) {
              throw new Error(`PM Compiler å¤±è´¥: ${pmRes.status}`);
            }

            const pmData = await pmRes.json();
            let pmResult = pmData.choices?.[0]?.message?.content || '';

            // æå– JSON
            const jsonMatch = pmResult.match(/```(?:json)?\s*([\s\S]*?)```/) ||
                              pmResult.match(/(\{[\s\S]*\})/);
            if (jsonMatch) pmResult = jsonMatch[1];

            let compiledRequirement;
            try {
              const parsed = JSON.parse(pmResult);
              compiledRequirement = [
                '## äº§å“ç›®æ ‡',
                parsed.product_goal || 'æœªå®šä¹‰',
                '',
                '## æ ¸å¿ƒç”¨æˆ·åŠ¨ä½œ',
                (parsed.user_actions || []).map((a, i) => `${i + 1}. ${a}`).join('\n'),
                '',
                '## è¾“å…¥è§„åˆ™',
                (parsed.input_rules || []).map(r => `- ${r}`).join('\n'),
                '',
                '## è¾“å‡ºè§„åˆ™',
                (parsed.output_rules || []).map(r => `- ${r}`).join('\n'),
                '',
                '## ç¦æ­¢è¡Œä¸º',
                (parsed.forbidden_actions || []).map(f => `- ${f}`).join('\n'),
                '',
                '## å¼‚å¸¸ä¸è¾¹ç•Œ',
                (parsed.edge_cases || []).map(e => `- ${e}`).join('\n')
              ].join('\n');
            } catch (e) {
              console.log('âš ï¸ JSON è§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å†…å®¹');
              compiledRequirement = pmResult;
            }

            console.log('âœ… PM Compiler å®Œæˆ');

            // Step 2: UI Spec Generator
            console.log('\nğŸ¨ Step 2: UI Spec Generator...');
            console.log('ğŸ“„ ä½¿ç”¨æ¨¡æ¿: agents/vibe/ui-spec.md');

            // å°† compiledRequirement æ³¨å…¥åˆ° UI Spec æ¨¡æ¿ä¸­
            const uiPrompt = process.env.UI_PROMPT_TEMPLATE.replace('{{compiled_requirement}}', compiledRequirement);

            const uiRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'google/gemini-2.0-flash-001',
                messages: [{ role: 'user', content: uiPrompt }],
                temperature: 0.5
              })
            });

            if (!uiRes.ok) {
              throw new Error(`UI Spec Generator å¤±è´¥: ${uiRes.status}`);
            }

            const uiData = await uiRes.json();
            const uiSpec = uiData.choices?.[0]?.message?.content || '';

            console.log('âœ… UI Spec ç”Ÿæˆå®Œæˆ');

            // Step 3: å†™å…¥æ–‡ä»¶
            const specDir = process.env.SPEC_DIR || 'docs/specs';
            const specFileName = `issue-${issueNumber}-ui.md`;
            const specFilePath = path.join(specDir, specFileName);

            // ç¡®ä¿ç›®å½•å­˜åœ¨
            fs.mkdirSync(specDir, { recursive: true });

            const fileContent = [
              `# UI Spec for Issue #${issueNumber}`,
              '',
              `> åŸå§‹éœ€æ±‚: [#${issueNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issueNumber})`,
              `> ç”Ÿæˆæ—¶é—´: ${new Date().toISOString()}`,
              '',
              '---',
              '',
              '## éœ€æ±‚æ‘˜è¦',
              '',
              compiledRequirement,
              '',
              '---',
              '',
              uiSpec,
              '',
              '---',
              '',
              '## ä¸‹ä¸€æ­¥',
              '',
              'ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆä»£ç ï¼š',
              '```',
              `/agent be --spec #${issueNumber}  # ç”Ÿæˆåç«¯ä»£ç `,
              `/agent fe --spec #${issueNumber}  # ç”Ÿæˆå‰ç«¯ä»£ç `,
              '```'
            ].join('\n');

            fs.writeFileSync(specFilePath, fileContent);
            console.log(`âœ… å†™å…¥æ–‡ä»¶: ${specFilePath}`);

            core.setOutput('spec_file', specFilePath);
            core.setOutput('spec_content', fileContent);

      - name: Create PR with UI Spec
        uses: actions/github-script@v7
        env:
          SPEC_FILE: ${{ steps.generate.outputs.spec_file }}
        with:
          script: |
            const { execSync } = require('child_process');
            const issue = context.payload.issue;
            const issueNumber = issue.number;
            const specFile = process.env.SPEC_FILE;

            const branchName = `ui-spec/issue-${issueNumber}`;

            // åˆ›å»ºåˆ†æ”¯å¹¶æäº¤
            try {
              execSync(`git checkout -b ${branchName}`);
              execSync(`git add ${specFile}`);
              execSync(`git commit -m "docs: add UI spec for issue #${issueNumber}"`);
              execSync(`git push origin ${branchName}`);
            } catch (e) {
              console.error('Git æ“ä½œå¤±è´¥:', e.message);
              throw e;
            }

            // åˆ›å»º PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[UI Spec] ${issue.title}`,
              head: branchName,
              base: 'main',
              body: [
                `## UI è®¾è®¡è§„æ ¼`,
                '',
                `å…³è” Issue: #${issueNumber}`,
                '',
                `### æ–‡ä»¶`,
                `- \`${specFile}\``,
                '',
                '### ä¸‹ä¸€æ­¥',
                '1. Review å¹¶ Merge æ­¤ PR',
                '2. åœ¨åŸ Issue ä¸­æ‰§è¡Œï¼š',
                '   ```',
                `   /agent be --spec #${issueNumber}`,
                `   /agent fe --spec #${issueNumber}`,
                '   ```',
                '',
                '---',
                'ğŸ¤– Generated by Vibe Agent'
              ].join('\n')
            });

            // åœ¨ Issue ä¸­æ·»åŠ ç®€çŸ­è¯„è®ºï¼ˆä¸æ”¾é•¿å†…å®¹ï¼Œé¿å…æŠ˜å ï¼‰
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                'âœ… **UI Spec å·²ç”Ÿæˆ**',
                '',
                `ğŸ“„ PR: #${pr.number}`,
                `ğŸ“ æ–‡ä»¶: \`${specFile}\``,
                '',
                '**ä¸‹ä¸€æ­¥ï¼š**',
                '1. Review å¹¶ Merge PR',
                '2. æ‰§è¡Œ `/agent be` æˆ– `/agent fe` ç”Ÿæˆä»£ç '
              ].join('\n')
            });

            // æ›´æ–°æ ‡ç­¾
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['ui-spec-ready']
            });

  # ============================================================
  # Job 3: Tech Spec Agent - ç”Ÿæˆå®Œæ•´æŠ€æœ¯è§„æ ¼
  # ============================================================
  agent-spec:
    needs: parse-command
    if: needs.parse-command.outputs.should_run == 'true' && needs.parse-command.outputs.agent_type == 'spec'
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "vibe-agent[bot]"
          git config user.email "vibe-agent@github-actions.bot"

      - name: Load PM Compiler Prompt
        id: pm_prompt
        uses: ./.github/actions/load-prompt
        with:
          template: agents/vibe/pm-compiler.md
          variables: |
            {
              "title": ${{ toJson(github.event.issue.title) }},
              "body": ${{ toJson(github.event.issue.body) }},
              "user_instructions": ${{ toJson(needs.parse-command.outputs.user_instructions) }}
            }

      - name: Load Tech Spec Prompt
        id: spec_prompt
        uses: ./.github/actions/load-prompt
        with:
          template: agents/vibe/tech-spec.md
          variables: '{}'

      - name: Generate Tech Spec
        id: generate
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          USER_INSTRUCTIONS: ${{ needs.parse-command.outputs.user_instructions }}
          PM_PROMPT: ${{ steps.pm_prompt.outputs.prompt }}
          SPEC_PROMPT_TEMPLATE: ${{ steps.spec_prompt.outputs.prompt }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const issue = context.payload.issue;
            const issueNumber = issue.number;
            const userInstructions = process.env.USER_INSTRUCTIONS || '';

            console.log('='.repeat(60));
            console.log('ğŸ“‹ TECH SPEC AGENT - ç”Ÿæˆå®Œæ•´æŠ€æœ¯è§„æ ¼');
            console.log('='.repeat(60));

            // Step 1: PM Compiler - å°† PRD è½¬æ¢ä¸ºæ¸…æ™°çš„äº§å“éœ€æ±‚è§„æ ¼
            console.log('\nğŸ“ Step 1: PM Compiler...');
            console.log('ğŸ“„ ä½¿ç”¨æ¨¡æ¿: agents/vibe/pm-compiler.md');

            const pmPrompt = process.env.PM_PROMPT;

            const pmRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'google/gemini-2.0-flash-001',
                messages: [{ role: 'user', content: pmPrompt }],
                temperature: 0.3
              })
            });

            if (!pmRes.ok) {
              throw new Error(`PM Compiler å¤±è´¥: ${pmRes.status}`);
            }

            const pmData = await pmRes.json();
            let pmResult = pmData.choices?.[0]?.message?.content || '';

            // æå– JSON
            const jsonMatch = pmResult.match(/```(?:json)?\s*([\s\S]*?)```/) ||
                              pmResult.match(/(\{[\s\S]*\})/);
            if (jsonMatch) pmResult = jsonMatch[1];

            let compiledRequirement;
            try {
              const parsed = JSON.parse(pmResult);
              compiledRequirement = [
                '## äº§å“ç›®æ ‡',
                parsed.product_goal || 'æœªå®šä¹‰',
                '',
                '## æ ¸å¿ƒç”¨æˆ·åŠ¨ä½œ',
                (parsed.user_actions || []).map((a, i) => `${i + 1}. ${a}`).join('\n'),
                '',
                '## è¾“å…¥è§„åˆ™',
                (parsed.input_rules || []).map(r => `- ${r}`).join('\n'),
                '',
                '## è¾“å‡ºè§„åˆ™',
                (parsed.output_rules || []).map(r => `- ${r}`).join('\n'),
                '',
                '## ç¦æ­¢è¡Œä¸º',
                (parsed.forbidden_actions || []).map(f => `- ${f}`).join('\n'),
                '',
                '## å¼‚å¸¸ä¸è¾¹ç•Œ',
                (parsed.edge_cases || []).map(e => `- ${e}`).join('\n')
              ].join('\n');
            } catch (e) {
              console.log('âš ï¸ JSON è§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å†…å®¹');
              compiledRequirement = pmResult;
            }

            console.log('âœ… PM Compiler å®Œæˆ');

            // Step 2: Tech Spec Generator - ä½¿ç”¨æ›´å¼ºçš„æ¨¡å‹ç”Ÿæˆå®Œæ•´è§„æ ¼
            console.log('\nğŸ“‹ Step 2: Tech Spec Generator...');
            console.log('ğŸ“„ ä½¿ç”¨æ¨¡æ¿: agents/vibe/tech-spec.md');

            // å°† compiledRequirement æ³¨å…¥åˆ° Tech Spec æ¨¡æ¿ä¸­
            let specPrompt = process.env.SPEC_PROMPT_TEMPLATE
              .replace('{{compiled_requirement}}', compiledRequirement)
              .replace(/\{\{#if user_instructions\}\}[\s\S]*?\{\{\/if\}\}/g,
                userInstructions ? `## ç”¨æˆ·é¢å¤–æŒ‡ä»¤\n${userInstructions}` : '');

            // ä½¿ç”¨ Claude ç”Ÿæˆæ›´é«˜è´¨é‡çš„æŠ€æœ¯è§„æ ¼
            const specRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'anthropic/claude-sonnet-4',
                messages: [{ role: 'user', content: specPrompt }],
                temperature: 0.5,
                max_tokens: 8000
              })
            });

            if (!specRes.ok) {
              throw new Error(`Tech Spec Generator å¤±è´¥: ${specRes.status}`);
            }

            const specData = await specRes.json();
            const techSpec = specData.choices?.[0]?.message?.content || '';

            console.log('âœ… Tech Spec ç”Ÿæˆå®Œæˆ');

            // Step 3: å†™å…¥æ–‡ä»¶
            const specDir = process.env.SPEC_DIR || 'docs/specs';
            const specFileName = `issue-${issueNumber}-spec.md`;
            const specFilePath = path.join(specDir, specFileName);

            // ç¡®ä¿ç›®å½•å­˜åœ¨
            fs.mkdirSync(specDir, { recursive: true });

            const fileContent = [
              `# Tech Spec for Issue #${issueNumber}`,
              '',
              `> åŸå§‹éœ€æ±‚: [#${issueNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issueNumber})`,
              `> ç”Ÿæˆæ—¶é—´: ${new Date().toISOString()}`,
              '',
              '---',
              '',
              techSpec,
              '',
              '---',
              '',
              '## ä¸‹ä¸€æ­¥',
              '',
              'ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆä»£ç ï¼š',
              '```',
              `/agent be --spec #${issueNumber}  # ç”Ÿæˆåç«¯ä»£ç `,
              `/agent fe --spec #${issueNumber}  # ç”Ÿæˆå‰ç«¯ä»£ç `,
              '```',
              '',
              '<!-- vibe-tech-spec -->'
            ].join('\n');

            fs.writeFileSync(specFilePath, fileContent);
            console.log(`âœ… å†™å…¥æ–‡ä»¶: ${specFilePath}`);

            core.setOutput('spec_file', specFilePath);
            core.setOutput('spec_content', fileContent);

      - name: Create PR with Tech Spec
        uses: actions/github-script@v7
        env:
          SPEC_FILE: ${{ steps.generate.outputs.spec_file }}
        with:
          script: |
            const { execSync } = require('child_process');
            const issue = context.payload.issue;
            const issueNumber = issue.number;
            const specFile = process.env.SPEC_FILE;

            const branchName = `tech-spec/issue-${issueNumber}`;

            // åˆ›å»ºåˆ†æ”¯å¹¶æäº¤
            try {
              execSync(`git checkout -b ${branchName}`);
              execSync(`git add ${specFile}`);
              execSync(`git commit -m "docs: add tech spec for issue #${issueNumber}"`);
              execSync(`git push origin ${branchName}`);
            } catch (e) {
              console.error('Git æ“ä½œå¤±è´¥:', e.message);
              throw e;
            }

            // åˆ›å»º PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Tech Spec] ${issue.title}`,
              head: branchName,
              base: 'main',
              body: [
                `## ğŸ“‹ å®Œæ•´æŠ€æœ¯è§„æ ¼`,
                '',
                `å…³è” Issue: #${issueNumber}`,
                '',
                `### æ–‡ä»¶`,
                `- \`${specFile}\``,
                '',
                '### åŒ…å«å†…å®¹',
                '- ğŸ“‹ éœ€æ±‚æè¿°',
                '- ğŸ¨ ç”¨æˆ·ä½“éªŒæµç¨‹',
                '- ğŸ”Œ åç«¯ API è®¾è®¡',
                '- ğŸ“ æ•°æ®æ¨¡å‹',
                '- ğŸ–¥ å‰ç«¯å®ç°æŒ‡å—',
                '- âœ… éªŒæ”¶æ ‡å‡† Checklist',
                '',
                '### ä¸‹ä¸€æ­¥',
                '1. Review å¹¶ Merge æ­¤ PR',
                '2. åœ¨åŸ Issue ä¸­æ‰§è¡Œï¼š',
                '   ```',
                `   /agent be --spec #${issueNumber}`,
                `   /agent fe --spec #${issueNumber}`,
                '   ```',
                '',
                '---',
                'ğŸ¤– Generated by Vibe Agent'
              ].join('\n')
            });

            // åœ¨ Issue ä¸­æ·»åŠ ç®€çŸ­è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                'âœ… **æŠ€æœ¯è§„æ ¼å·²ç”Ÿæˆ**',
                '',
                `ğŸ“„ PR: #${pr.number}`,
                `ğŸ“ æ–‡ä»¶: \`${specFile}\``,
                '',
                '**åŒ…å«å†…å®¹ï¼š**',
                '- éœ€æ±‚æè¿° + ç”¨æˆ·ä½“éªŒæµç¨‹',
                '- åç«¯ API + æ•°æ®æ¨¡å‹',
                '- å‰ç«¯å®ç°æŒ‡å—',
                '- éªŒæ”¶æ ‡å‡† Checklist',
                '',
                '**ä¸‹ä¸€æ­¥ï¼š**',
                '1. Review å¹¶ Merge PR',
                '2. æ‰§è¡Œ `/agent be` æˆ– `/agent fe` ç”Ÿæˆä»£ç '
              ].join('\n')
            });

            // æ›´æ–°æ ‡ç­¾
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['tech-spec-ready']
            });

  # ============================================================
  # Job 4: Backend Agent - ç”Ÿæˆåç«¯ä»£ç 
  # ============================================================
  agent-be:
    needs: parse-command
    if: needs.parse-command.outputs.should_run == 'true' && needs.parse-command.outputs.agent_type == 'be'
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "vibe-agent[bot]"
          git config user.email "vibe-agent@github-actions.bot"

      - name: Detect Feature Branch
        id: feature
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            let featureLabel = labels.find(l => l.startsWith('feature:'));

            if (!featureLabel && issue.body) {
              const parentMatch = issue.body.match(/(?:part of|parent|belongs to|see)\s*#(\d+)/i);
              if (parentMatch) {
                const parentNumber = parseInt(parentMatch[1]);
                try {
                  const { data: parentIssue } = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parentNumber
                  });
                  featureLabel = parentIssue.labels.map(l => l.name).find(l => l.startsWith('feature:'));
                } catch (e) {
                  console.log(`âš ï¸ æ— æ³•è·å–çˆ¶ Issue #${parentNumber}`);
                }
              }
            }

            const branch = featureLabel ? featureLabel.replace(':', '/') : 'main';
            console.log(`ğŸŒ¿ ç›®æ ‡åˆ†æ”¯: ${branch}`);
            core.setOutput('branch', branch);

      - name: Load BE Contract Prompt
        id: be_contract_prompt
        uses: ./.github/actions/load-prompt
        with:
          template: agents/vibe/be-contract.md
          variables: '{}'

      - name: Load BE Codegen Prompt
        id: be_codegen_prompt
        uses: ./.github/actions/load-prompt
        with:
          template: agents/vibe/be-codegen.md
          variables: '{}'

      - name: Prepare Context
        id: prepare
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          SPEC_SOURCE: ${{ needs.parse-command.outputs.spec_source }}
          USER_INSTRUCTIONS: ${{ needs.parse-command.outputs.user_instructions }}
          BE_CONTRACT_PROMPT: ${{ steps.be_contract_prompt.outputs.prompt }}
          BE_CODEGEN_PROMPT: ${{ steps.be_codegen_prompt.outputs.prompt }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const issue = context.payload.issue;
            const specSource = process.env.SPEC_SOURCE;
            const userInstructions = process.env.USER_INSTRUCTIONS || '';

            console.log('='.repeat(60));
            console.log('ğŸ”§ BACKEND AGENT - å‡†å¤‡ä¸Šä¸‹æ–‡');
            console.log('='.repeat(60));

            // 1. è·å– UI Spec
            let uiSpec = '';

            // ä¼˜å…ˆä»æ–‡ä»¶è¯»å–
            const specFile = `docs/specs/issue-${specSource || issue.number}-ui.md`;
            if (fs.existsSync(specFile)) {
              uiSpec = fs.readFileSync(specFile, 'utf8');
              console.log(`âœ… ä»æ–‡ä»¶è¯»å– UI Spec: ${specFile}`);
            } else if (specSource) {
              // ä»æŒ‡å®š Issue è·å–
              try {
                const { data: specIssue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(specSource)
                });
                uiSpec = specIssue.body || '';
                console.log(`âœ… ä» Issue #${specSource} è·å– UI Spec`);
              } catch (e) {
                console.log(`âš ï¸ æ— æ³•è·å– Issue #${specSource}`);
              }
            } else {
              // ä½¿ç”¨å½“å‰ Issue å†…å®¹
              uiSpec = issue.body || '';
              console.log('âœ… ä½¿ç”¨å½“å‰ Issue å†…å®¹ä½œä¸ºéœ€æ±‚');
            }

            // 2. ç”Ÿæˆ API Contract
            console.log('\nğŸ“‹ ç”Ÿæˆ API Contract...');
            console.log('ğŸ“„ ä½¿ç”¨æ¨¡æ¿: agents/vibe/be-contract.md');

            // å°†å˜é‡æ³¨å…¥åˆ°æ¨¡æ¿ä¸­
            let contractPrompt = process.env.BE_CONTRACT_PROMPT
              .replace('{{requirement}}', uiSpec.substring(0, 8000))
              .replace('{{user_instructions}}', userInstructions)
              .replace(/\{\{#if user_instructions\}\}[\s\S]*?\{\{\/if\}\}/g, userInstructions ? `ç”¨æˆ·è¦æ±‚: ${userInstructions}` : '');

            const contractRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'google/gemini-2.0-flash-001',
                messages: [{ role: 'user', content: contractPrompt }],
                temperature: 0.3
              })
            });

            const contractData = await contractRes.json();
            let apiContract = contractData.choices?.[0]?.message?.content || '[]';

            const jsonMatch = apiContract.match(/```(?:json)?\s*([\s\S]*?)```/) || apiContract.match(/(\[[\s\S]*\])/);
            if (jsonMatch) apiContract = jsonMatch[1];

            try {
              apiContract = JSON.parse(apiContract);
              if (!Array.isArray(apiContract)) apiContract = [apiContract];
            } catch (e) {
              apiContract = [];
            }

            console.log(`âœ… API Contract: ${apiContract.length} ä¸ªæ¥å£`);

            // 3. è¯»å–é¡¹ç›®æ–‡ä»¶
            const systemFiles = [
              'backend/go.mod',
              'backend/CLAUDE.md',
              'backend/internal/router/router.go'
            ];

            const projectContext = {};
            for (const filePath of systemFiles) {
              try {
                if (fs.existsSync(filePath)) {
                  projectContext[filePath] = fs.readFileSync(filePath, 'utf8');
                }
              } catch (e) {}
            }

            const projectContextText = Object.entries(projectContext)
              .map(([p, c]) => `## ${p}\n\`\`\`go\n${c}\n\`\`\``)
              .join('\n\n');

            // 4. å‘å¸ƒç®€çŸ­å¯åŠ¨è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                'ğŸ”§ **Backend Agent å¯åŠ¨**',
                '',
                `**API Contract:** ${apiContract.length} ä¸ªæ¥å£`,
                apiContract.slice(0, 5).map((api, i) => `- \`${api.method} ${api.endpoint}\``).join('\n'),
                apiContract.length > 5 ? `- ... ç­‰ ${apiContract.length - 5} ä¸ª` : '',
                '',
                '_æ­£åœ¨ç”Ÿæˆä»£ç ..._'
              ].join('\n')
            });

            // 5. æ„å»º Prompt
            console.log('ğŸ“„ ä½¿ç”¨æ¨¡æ¿: agents/vibe/be-codegen.md');

            const prompt = process.env.BE_CODEGEN_PROMPT
              .replace('{{api_contract}}', JSON.stringify(apiContract, null, 2))
              .replace('{{user_instructions}}', userInstructions)
              .replace('{{project_context}}', projectContextText || 'æ— ç°æœ‰ä»£ç å‚è€ƒ')
              .replace(/\{\{#if user_instructions\}\}[\s\S]*?\{\{\/if\}\}/g, userInstructions ? `## ç”¨æˆ·è¦æ±‚\n\n${userInstructions}` : '');

            core.setOutput('prompt', prompt);

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          track_progress: true
          prompt: ${{ steps.prepare.outputs.prompt }}
          base_branch: ${{ steps.feature.outputs.branch }}
          # å…è®¸æ‰€æœ‰ bots è§¦å‘ï¼Œé¿å… "Workflow initiated by non-human actor" é”™è¯¯
          allowed_bots: '*'
          claude_args: |
            --model anthropic/claude-sonnet-4.5
            --max-turns 60

      - name: Update Labels
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const labels = '${{ job.status }}' === 'success'
              ? ['âœ… ai-completed']
              : ['âŒ ai-failed'];

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'ğŸ¤– ai-processing'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels
            });

  # ============================================================
  # Job 5: Frontend Agent - ç”Ÿæˆå‰ç«¯ä»£ç 
  # ============================================================
  agent-fe:
    needs: parse-command
    if: needs.parse-command.outputs.should_run == 'true' && needs.parse-command.outputs.agent_type == 'fe'
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "vibe-agent[bot]"
          git config user.email "vibe-agent@github-actions.bot"

      - name: Detect Feature Branch
        id: feature
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            let featureLabel = labels.find(l => l.startsWith('feature:'));

            if (!featureLabel && issue.body) {
              const parentMatch = issue.body.match(/(?:part of|parent|belongs to|see)\s*#(\d+)/i);
              if (parentMatch) {
                const parentNumber = parseInt(parentMatch[1]);
                try {
                  const { data: parentIssue } = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parentNumber
                  });
                  featureLabel = parentIssue.labels.map(l => l.name).find(l => l.startsWith('feature:'));
                } catch (e) {
                  console.log(`âš ï¸ æ— æ³•è·å–çˆ¶ Issue #${parentNumber}`);
                }
              }
            }

            const branch = featureLabel ? featureLabel.replace(':', '/') : 'main';
            console.log(`ğŸŒ¿ ç›®æ ‡åˆ†æ”¯: ${branch}`);
            core.setOutput('branch', branch);

      - name: Get Requirement
        id: requirement
        uses: actions/github-script@v7
        env:
          SPEC_SOURCE: ${{ needs.parse-command.outputs.spec_source }}
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const specSource = process.env.SPEC_SOURCE;

            let uiSpec = '';
            let specInfo = '';

            const specFile = `docs/specs/issue-${specSource || issue.number}-ui.md`;
            if (fs.existsSync(specFile)) {
              uiSpec = fs.readFileSync(specFile, 'utf8');
              specInfo = `æ–‡ä»¶: ${specFile}`;
            } else if (specSource) {
              try {
                const { data: specIssue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(specSource)
                });
                uiSpec = specIssue.body || '';
                specInfo = `Issue #${specSource}`;
              } catch (e) {
                console.log(`âš ï¸ æ— æ³•è·å– Issue #${specSource}`);
              }
            } else {
              uiSpec = issue.body || '';
              specInfo = 'å½“å‰ Issue';
            }

            console.log(`âœ… UI Spec æ¥æº: ${specInfo}`);
            core.setOutput('spec', uiSpec);
            core.setOutput('info', specInfo);

      - name: Smart Context Discovery
        id: context
        uses: ./.github/actions/context-discovery
        with:
          requirement: ${{ steps.requirement.outputs.spec }}
          target: frontend
          max_context_size: '15000'
          core_files: '["frontend/lib/routes.ts", "frontend/lib/api/types.ts", "frontend/lib/api/client.ts"]'

      - name: Load FE Codegen Prompt
        id: fe_codegen_prompt
        uses: ./.github/actions/load-prompt
        with:
          template: agents/vibe/fe-codegen.md
          variables: '{}'

      - name: Post Start Comment
        uses: actions/github-script@v7
        env:
          SPEC_INFO: ${{ steps.requirement.outputs.info }}
          CONTEXT_STATS: ${{ steps.context.outputs.stats }}
        with:
          script: |
            const stats = JSON.parse(process.env.CONTEXT_STATS || '{}');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: [
                'ğŸ¨ **Frontend Agent å¯åŠ¨**',
                '',
                `**UI Spec:** ${process.env.SPEC_INFO}`,
                `**ä¸Šä¸‹æ–‡:** ${stats.totalFiles || 0} ä¸ªæ–‡ä»¶ (${Math.round((stats.totalSize || 0) / 1024)}KB)`,
                `**å‘ç°æ–‡ä»¶:** ${stats.discoveredFiles || 0} ä¸ªç›¸å…³ç»„ä»¶`,
                '',
                '_æ­£åœ¨ç”Ÿæˆä»£ç ..._'
              ].join('\n')
            });

      - name: Prepare Prompt
        id: prepare
        env:
          UI_SPEC: ${{ steps.requirement.outputs.spec }}
          PROJECT_CONTEXT: ${{ steps.context.outputs.context }}
          USER_INSTRUCTIONS: ${{ needs.parse-command.outputs.user_instructions }}
          FE_CODEGEN_PROMPT: ${{ steps.fe_codegen_prompt.outputs.prompt }}
        run: |
          node << 'NODEJS_SCRIPT'
          const fs = require('fs');

          const uiSpec = process.env.UI_SPEC || '';
          const projectContext = process.env.PROJECT_CONTEXT || 'æ— ç°æœ‰ä»£ç å‚è€ƒ';
          const userInstructions = process.env.USER_INSTRUCTIONS || '';
          let prompt = process.env.FE_CODEGEN_PROMPT;

          // æ›¿æ¢æ¨¡æ¿å˜é‡
          prompt = prompt
            .replace('{{requirement}}', uiSpec.substring(0, 10000))
            .replace('{{user_instructions}}', userInstructions)
            .replace('{{project_context}}', projectContext)
            .replace(/\{\{#if user_instructions\}\}[\s\S]*?\{\{\/if\}\}/g,
              userInstructions ? `## ç”¨æˆ·è¦æ±‚\n\n${userInstructions}` : '');

          console.log('ğŸ“„ Prompt prepared');
          console.log(`ğŸ“ Total prompt size: ${prompt.length} chars`);

          // å†™å…¥è¾“å‡º
          const outputFile = process.env.GITHUB_OUTPUT;
          const delimiter = 'EOF_' + Math.random().toString(36).substring(7);
          fs.appendFileSync(outputFile, `prompt<<${delimiter}\n${prompt}\n${delimiter}\n`);
          NODEJS_SCRIPT

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          track_progress: true
          prompt: ${{ steps.prepare.outputs.prompt }}
          base_branch: ${{ steps.feature.outputs.branch }}
          # å…è®¸æ‰€æœ‰ bots è§¦å‘ï¼Œé¿å… "Workflow initiated by non-human actor" é”™è¯¯
          allowed_bots: '*'
          claude_args: |
            --model anthropic/claude-sonnet-4.5
            --max-turns 60

      - name: Update Labels
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const labels = '${{ job.status }}' === 'success'
              ? ['âœ… ai-completed']
              : ['âŒ ai-failed'];

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'ğŸ¤– ai-processing'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels
            });
