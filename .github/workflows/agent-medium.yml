name: Medium Task Agent

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue ç¼–å·'
        required: true
        type: string
      continuation_context:
        description: 'ç»§ç»­è¿­ä»£çš„ä¸Šä¸‹æ–‡ä¿¡æ¯'
        required: false
        type: string
  issue_comment:
    types: [created]

jobs:
  medium-task:
    # é€šè¿‡ workflow_callã€workflow_dispatch æˆ– /agent-medium å‘½ä»¤è§¦å‘
    if: |
      github.event_name == 'workflow_call' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.comment.body, '/agent-medium')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "vibe-medium-agent"
          git config user.email "agent@vibe.bot"

      - name: Get Issue Info
        id: issue_info
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber;
            let issue;

            if (context.eventName === 'workflow_dispatch') {
              // workflow_dispatch è§¦å‘æ—¶ä» inputs è·å–
              issueNumber = parseInt('${{ github.event.inputs.issue_number }}');
              const { data } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              issue = data;
            } else {
              // issue_comment æˆ– workflow_call è§¦å‘
              issue = context.payload.issue;
              issueNumber = issue.number;
            }

            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issue.title);
            core.setOutput('issue_body', issue.body || '');

            // å­˜å‚¨åˆ°ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
            return { issueNumber, title: issue.title, body: issue.body };

      - name: Update Issue Status
        id: update_issue_status
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};

            // æ›´æ–°æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'complexity:medium'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['ğŸ¤– ai-processing', 'agent:medium']
            });

            const continuationContext = '${{ github.event.inputs.continuation_context }}' || '';
            const isContinuation = continuationContext.length > 0;

            // æŸ¥æ‰¾å·²æœ‰çš„è¿›åº¦è¿½è¸ªè¯„è®ºï¼ˆvibe-continuous åˆ›å»ºçš„ï¼‰
            let progressCommentId = null;
            let existingCommentBody = '';

            if (isContinuation) {
              // è·å– issue çš„æ‰€æœ‰è¯„è®º
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                per_page: 100
              });

              // æŸ¥æ‰¾æœ€è¿‘çš„ vibe-continuous è¿›åº¦è¯„è®ºï¼ˆåŒ…å« "ğŸ”„ è‡ªåŠ¨è¿­ä»£"ï¼‰
              for (let i = comments.length - 1; i >= 0; i--) {
                const comment = comments[i];
                if (comment.body && comment.body.includes('ğŸ”„ è‡ªåŠ¨è¿­ä»£')) {
                  progressCommentId = comment.id;
                  existingCommentBody = comment.body;
                  console.log(`æ‰¾åˆ°è¿›åº¦è¿½è¸ªè¯„è®º: #${progressCommentId}`);
                  break;
                }
              }
            }

            // æ„å»ºè¿›åº¦è¯„è®ºå†…å®¹
            const progressBody = isContinuation ? [
              existingCommentBody || `ğŸ”„ **è‡ªåŠ¨è¿­ä»£**\n\n**ä¸Šä¸‹æ–‡**: ${continuationContext}`,
              "",
              "---",
              "",
              "## ğŸ¤– Medium Agent æ‰§è¡Œä¸­",
              "",
              "**å½“å‰é˜¶æ®µ**: ğŸ”„ å‡†å¤‡ä¸­...",
              "",
              "```",
              "â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0%",
              "```",
              "",
              "**çŠ¶æ€**: â³ æ­£åœ¨åˆå§‹åŒ–...",
            ].join("\n") : [
              "ğŸ”§ **Medium Agent å¯åŠ¨**",
              "",
              "---",
              "",
              "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
              "",
              "**å½“å‰é˜¶æ®µ**: ğŸ”„ å‡†å¤‡ä¸­...",
              "",
              "```",
              "â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0%",
              "```",
              "",
              "**çŠ¶æ€**: â³ æ­£åœ¨åˆå§‹åŒ–...",
              "",
              "---",
              "> ğŸ’¡ ä¸­ç­‰ä»»åŠ¡ä¼šå…ˆåˆ†æå†å¼€å‘ï¼Œç¡®ä¿æ–¹æ¡ˆåˆç†ã€‚"
            ].join("\n");

            // æ›´æ–°æˆ–åˆ›å»ºè¿›åº¦è¯„è®º
            if (progressCommentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: progressCommentId,
                body: progressBody
              });
              console.log(`æ›´æ–°è¿›åº¦è¿½è¸ªè¯„è®º: #${progressCommentId}`);
            } else {
              const progressComment = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: progressBody
              });
              progressCommentId = progressComment.data.id;
              console.log(`åˆ›å»ºæ–°çš„è¿›åº¦è¿½è¸ªè¯„è®º: #${progressCommentId}`);
            }

            // ä¿å­˜è¯„è®º ID å’ŒåŸå§‹å†…å®¹ä¾›åç»­æ›´æ–°
            core.setOutput('progress_comment_id', progressCommentId);
            core.setOutput('existing_comment_body', existingCommentBody);

      - name: Update Progress - Loading Template
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const progressCommentId = ${{ steps.update_issue_status.outputs.progress_comment_id }};
            const continuationContext = '${{ github.event.inputs.continuation_context }}' || '';
            const isContinuation = continuationContext.length > 0;
            const existingCommentBody = `${{ steps.update_issue_status.outputs.existing_comment_body }}`;

            // æ„å»ºè¿›åº¦éƒ¨åˆ†
            const progressSection = [
              "## ğŸ¤– Medium Agent æ‰§è¡Œä¸­",
              "",
              "**å½“å‰é˜¶æ®µ**: ğŸ“ åŠ è½½æ¨¡æ¿å’Œå‡†å¤‡æç¤ºè¯...",
              "",
              "```",
              "â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 10%",
              "```",
              "",
              "**çŠ¶æ€**: â³ æ­£åœ¨åŠ è½½å¼€å‘æ¨¡æ¿...",
            ].join("\n");

            if (progressCommentId) {
              const body = isContinuation && existingCommentBody
                ? existingCommentBody.split('---')[0] + "---\n\n" + progressSection
                : [
                    "ğŸ”§ **Medium Agent å¯åŠ¨**",
                    "",
                    "---",
                    "",
                    "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                    "",
                    "**å½“å‰é˜¶æ®µ**: ğŸ“ åŠ è½½æ¨¡æ¿å’Œå‡†å¤‡æç¤ºè¯...",
                    "",
                    "```",
                    "â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 10%",
                    "```",
                    "",
                    "**çŠ¶æ€**: â³ æ­£åœ¨åŠ è½½å¼€å‘æ¨¡æ¿...",
                    "",
                    "---",
                    "> ğŸ’¡ ä¸­ç­‰ä»»åŠ¡ä¼šå…ˆåˆ†æå†å¼€å‘ï¼Œç¡®ä¿æ–¹æ¡ˆåˆç†ã€‚"
                  ].join("\n");

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: progressCommentId,
                body: body
              });
            }

      - name: Load Prompt Template
        id: prompt
        uses: ./.github/actions/load-prompt
        with:
          template: agents/medium.md
          variables: |
            {
              "repository": "${{ github.repository }}",
              "issue_number": "${{ steps.issue_info.outputs.issue_number }}",
              "title": ${{ toJson(steps.issue_info.outputs.issue_title) }},
              "body": ${{ toJson(steps.issue_info.outputs.issue_body) }},
              "continuation_context": "${{ github.event.inputs.continuation_context || '' }}"
            }

      - name: Update Progress - Running Claude
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const progressCommentId = ${{ steps.update_issue_status.outputs.progress_comment_id }};
            const continuationContext = '${{ github.event.inputs.continuation_context }}' || '';
            const isContinuation = continuationContext.length > 0;
            const existingCommentBody = `${{ steps.update_issue_status.outputs.existing_comment_body }}`;

            // æ„å»ºè¿›åº¦éƒ¨åˆ†
            const progressSection = [
              "## ğŸ¤– Medium Agent æ‰§è¡Œä¸­",
              "",
              "**å½“å‰é˜¶æ®µ**: ğŸ¤– AI æ­£åœ¨åˆ†æå’Œå¼€å‘...",
              "",
              "```",
              "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 40%",
              "```",
              "",
              "**çŠ¶æ€**: â³ Claude æ­£åœ¨å¤„ç†ä»»åŠ¡...",
              "",
              "**æç¤º**: è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…",
            ].join("\n");

            if (progressCommentId) {
              const body = isContinuation && existingCommentBody
                ? existingCommentBody.split('---')[0] + "---\n\n" + progressSection
                : [
                    "ğŸ”§ **Medium Agent å¯åŠ¨**",
                    "",
                    "---",
                    "",
                    "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                    "",
                    "**å½“å‰é˜¶æ®µ**: ğŸ¤– AI æ­£åœ¨åˆ†æå’Œå¼€å‘...",
                    "",
                    "```",
                    "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 40%",
                    "```",
                    "",
                    "**çŠ¶æ€**: â³ Claude æ­£åœ¨å¤„ç†ä»»åŠ¡...",
                    "",
                    "**æç¤º**: è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…",
                    "",
                    "---",
                    "> ğŸ’¡ ä¸­ç­‰ä»»åŠ¡ä¼šå…ˆåˆ†æå†å¼€å‘ï¼Œç¡®ä¿æ–¹æ¡ˆåˆç†ã€‚"
                  ].join("\n");

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: progressCommentId,
                body: body
              });
            }

      - name: Run Claude Code Action
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          # track_progress only supported for issue_comment events, not workflow_dispatch
          track_progress: ${{ github.event_name == 'issue_comment' }}
          prompt: ${{ steps.prompt.outputs.prompt }}
          claude_args: |
            --model anthropic/claude-sonnet-4
            --max-turns 50

      - name: Update Issue on Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const progressCommentId = ${{ steps.update_issue_status.outputs.progress_comment_id }};
            const continuationContext = '${{ github.event.inputs.continuation_context }}' || '';
            const isContinuation = continuationContext.length > 0;
            const existingCommentBody = `${{ steps.update_issue_status.outputs.existing_comment_body }}`;

            // è·å–æœ€è¿‘åˆ›å»ºçš„ PRï¼ˆç”±æœ¬æ¬¡æ‰§è¡Œåˆ›å»ºï¼‰
            let prInfo = '';
            try {
              // è·å–æœ€è¿‘çš„ PR
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                sort: 'created',
                direction: 'desc',
                per_page: 5
              });

              // æŸ¥æ‰¾æ ‡é¢˜æˆ–åˆ†æ”¯åŒ…å« issue ç¼–å·çš„ PR
              const relatedPR = prs.find(pr =>
                pr.title.includes(`#${issueNumber}`) ||
                pr.title.toLowerCase().includes(`issue-${issueNumber}`) ||
                pr.head.ref.includes(`issue-${issueNumber}`) ||
                pr.body?.includes(`#${issueNumber}`)
              );

              if (relatedPR) {
                prInfo = `\n\n**åˆ›å»ºçš„ PR**: [#${relatedPR.number} ${relatedPR.title}](${relatedPR.html_url})`;
              }
            } catch (e) {
              console.log("è·å– PR ä¿¡æ¯å¤±è´¥:", e.message);
            }

            // æ„å»ºå®ŒæˆçŠ¶æ€
            const completionSection = [
              "## âœ… Medium Agent å®Œæˆ",
              "",
              "**å½“å‰é˜¶æ®µ**: âœ… å®Œæˆ",
              "",
              "```",
              "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%",
              "```",
              "",
              "**çŠ¶æ€**: âœ… éœ€æ±‚åˆ†æå’Œä»£ç å®ç°å·²å®Œæˆ",
              prInfo,
              "",
              `**Actions æ—¥å¿—**: [æŸ¥çœ‹è¯¦æƒ…](/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }})`
            ].join("\n");

            // æ›´æ–°è¿›åº¦è¯„è®ºä¸ºå®ŒæˆçŠ¶æ€
            if (progressCommentId) {
              try {
                const body = isContinuation && existingCommentBody
                  ? existingCommentBody.split('---')[0] + "---\n\n" + completionSection
                  : [
                      "ğŸ”§ **Medium Agent**",
                      "",
                      "---",
                      "",
                      completionSection
                    ].join("\n");

                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: progressCommentId,
                  body: body
                });
              } catch (e) {
                console.log("æ— æ³•æ›´æ–°è¿›åº¦è¯„è®º:", e.message);
              }
            }

            // ç§»é™¤ processing æ ‡ç­¾ï¼Œæ·»åŠ  completed æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'ğŸ¤– ai-processing'
              });
            } catch (e) {}

            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'agent:medium'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['âœ… ai-completed']
            });

            // è‡ªåŠ¨å…³é—­ Issue ä»¥è§¦å‘ä¾èµ–é“¾
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'completed'
            });

            console.log(`âœ… Issue #${issueNumber} å·²è‡ªåŠ¨å…³é—­ï¼Œå°†è§¦å‘ä¾èµ–é“¾ä¸­çš„ä¸‹ä¸€ä¸ªä»»åŠ¡`);

      - name: Trigger Verification
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};

            console.log(`ğŸ” è§¦å‘éªŒæ”¶æ£€æŸ¥: Issue #${issueNumber}`);

            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'vibe-continuous.yml',
                ref: 'main',
                inputs: {
                  issue_number: String(issueNumber),
                  mode: 'verify'
                }
              });
              console.log(`âœ… å·²è§¦å‘ vibe-continuous éªŒæ”¶æ£€æŸ¥`);
            } catch (error) {
              console.log(`âš ï¸ è§¦å‘éªŒæ”¶æ£€æŸ¥å¤±è´¥: ${error.message}`);
              // å³ä½¿è§¦å‘å¤±è´¥ä¹Ÿä¸å½±å“æ•´ä½“æµç¨‹
            }

      - name: Update Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const progressCommentId = ${{ steps.update_issue_status.outputs.progress_comment_id }};
            const continuationContext = '${{ github.event.inputs.continuation_context }}' || '';
            const isContinuation = continuationContext.length > 0;
            const existingCommentBody = `${{ steps.update_issue_status.outputs.existing_comment_body }}`;

            // æ„å»ºå¤±è´¥çŠ¶æ€
            const failureSection = [
              "## âŒ Medium Agent å¤±è´¥",
              "",
              "**å½“å‰é˜¶æ®µ**: âŒ å¤±è´¥",
              "",
              "```",
              "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 40%",
              "```",
              "",
              "**çŠ¶æ€**: âŒ æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯",
              "",
              `**Actions æ—¥å¿—**: [æŸ¥çœ‹è¯¦æƒ…](/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }})`,
              "",
              "**å¯èƒ½çš„åŸå› :**",
              "- éœ€æ±‚æè¿°ä¸å¤Ÿæ¸…æ™°",
              "- æ¶‰åŠçš„æ¨¡å—è¿‡å¤š",
              "- æŠ€æœ¯æ–¹æ¡ˆéœ€è¦äººå·¥ç¡®è®¤",
              "",
              "**è§£å†³æ–¹æ¡ˆ:**",
              "- è¡¥å……éœ€æ±‚æè¿°åä½¿ç”¨ `/agent-medium` é‡è¯•",
              "- æˆ–å°†ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªç®€å•ä»»åŠ¡",
              "- æˆ–ä½¿ç”¨ `/agent-complex` è®© AI å…ˆæ‹†åˆ†ä»»åŠ¡"
            ].join("\n");

            // æ›´æ–°è¿›åº¦è¯„è®ºä¸ºå¤±è´¥çŠ¶æ€
            if (progressCommentId) {
              try {
                const body = isContinuation && existingCommentBody
                  ? existingCommentBody.split('---')[0] + "---\n\n" + failureSection
                  : [
                      "ğŸ”§ **Medium Agent**",
                      "",
                      "---",
                      "",
                      failureSection
                    ].join("\n");

                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: progressCommentId,
                  body: body
                });
              } catch (e) {
                console.log("æ— æ³•æ›´æ–°è¿›åº¦è¯„è®º:", e.message);
              }
            }

            // ç§»é™¤ processing æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'ğŸ¤– ai-processing'
              });
            } catch (e) {}

            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'agent:medium'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['âŒ ai-failed', 'needs-review']
            });

            // ä¸å†åˆ›å»ºé¢å¤–è¯„è®ºï¼Œæ‰€æœ‰ä¿¡æ¯éƒ½åœ¨è¿›åº¦è¿½è¸ªè¯„è®ºä¸­
