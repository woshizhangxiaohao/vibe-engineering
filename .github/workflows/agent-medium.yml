name: Medium Task Agent

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue ç¼–å·'
        required: true
        type: string
      continuation_context:
        description: 'ç»§ç»­è¿­ä»£çš„ä¸Šä¸‹æ–‡ä¿¡æ¯'
        required: false
        type: string
  issue_comment:
    types: [created]

jobs:
  medium-task:
    # é€šè¿‡ workflow_callã€workflow_dispatch æˆ– /agent-medium å‘½ä»¤è§¦å‘
    if: |
      github.event_name == 'workflow_call' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request == null &&
        contains(github.event.comment.body, '/agent-medium'))
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write
      actions: read
      checks: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "vibe-medium-agent"
          git config user.email "agent@vibe.bot"

      - name: Get Issue Info
        id: issue_info
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber;
            let issue;

            if (context.eventName === 'workflow_dispatch') {
              // workflow_dispatch è§¦å‘æ—¶ä» inputs è·å–
              issueNumber = parseInt('${{ github.event.inputs.issue_number }}');
              const { data } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              issue = data;
            } else {
              // issue_comment æˆ– workflow_call è§¦å‘
              issue = context.payload.issue;
              issueNumber = issue.number;
            }

            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issue.title);
            core.setOutput('issue_body', issue.body || '');

            // å­˜å‚¨åˆ°ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
            return { issueNumber, title: issue.title, body: issue.body };

      - name: Check for Duplicate Run
        id: check_duplicate
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const currentRunId = context.runId;

            // æ£€æŸ¥æ˜¯å¦æœ‰åŒä¸€ä¸ª issue çš„ agent æ­£åœ¨è¿è¡Œ
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'agent-medium.yml',
              status: 'in_progress',
              per_page: 20
            });

            // æŸ¥æ‰¾å…¶ä»–æ­£åœ¨è¿è¡Œçš„ç›¸åŒ issue ä»»åŠ¡
            for (const run of runs.workflow_runs) {
              if (run.id === currentRunId) continue;

              // æ£€æŸ¥è¿è¡Œæ—¶é—´ï¼Œ15åˆ†é’Ÿå†…çš„è§†ä¸ºå¯èƒ½é‡å¤
              const runTime = new Date(run.created_at);
              const now = new Date();
              const timeDiff = Math.abs(now - runTime);

              if (timeDiff < 15 * 60 * 1000) {
                console.log(`âš ï¸ å‘ç°å¯èƒ½çš„é‡å¤è¿è¡Œ (run_id: ${run.id})`);
                console.log(`   åˆ›å»ºæ—¶é—´: ${run.created_at}`);
                // æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€ä¸ª issueï¼ˆé€šè¿‡è¿è¡Œåç§°æˆ–å…¶ä»–æ–¹å¼ï¼‰
                // è¿™é‡Œç®€å•åœ°è®¤ä¸º 15 åˆ†é’Ÿå†…çš„é‡å¤è§¦å‘éœ€è¦è·³è¿‡
                core.setOutput('is_duplicate', 'true');
                return;
              }
            }

            // åŒæ—¶æ£€æŸ¥ issue æ˜¯å¦å·²ç»åœ¨å¤„ç†ä¸­
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const labels = issue.labels.map(l => l.name);
            if (labels.includes('ğŸ¤– ai-processing')) {
              console.log(`âš ï¸ Issue #${issueNumber} å·²åœ¨å¤„ç†ä¸­ï¼Œè·³è¿‡`);
              core.setOutput('is_duplicate', 'true');
              return;
            }

            core.setOutput('is_duplicate', 'false');

      - name: Skip if Duplicate
        if: steps.check_duplicate.outputs.is_duplicate == 'true'
        run: |
          echo "â­ï¸ æ£€æµ‹åˆ°é‡å¤è¿è¡Œæˆ– Issue å·²åœ¨å¤„ç†ä¸­ï¼Œè·³è¿‡æœ¬æ¬¡æ‰§è¡Œ"
          exit 0

      - name: Update Issue Status
        if: steps.check_duplicate.outputs.is_duplicate != 'true'
        id: update_issue_status
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};

            // æ›´æ–°æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'complexity:medium'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['ğŸ¤– ai-processing', 'agent:medium']
            });

            const continuationContext = '${{ github.event.inputs.continuation_context }}' || '';
            const isContinuation = continuationContext.length > 0;

            // æŸ¥æ‰¾å·²æœ‰çš„è¿›åº¦è¿½è¸ªè¯„è®ºï¼ˆvibe-continuous åˆ›å»ºçš„ï¼‰
            let progressCommentId = null;
            let existingCommentBody = '';

            if (isContinuation) {
              // è·å– issue çš„æ‰€æœ‰è¯„è®º
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                per_page: 100
              });

              // æŸ¥æ‰¾æœ€è¿‘çš„ vibe-continuous è¿›åº¦è¯„è®ºï¼ˆåŒ…å« "ğŸ”„ è‡ªåŠ¨è¿­ä»£"ï¼‰
              for (let i = comments.length - 1; i >= 0; i--) {
                const comment = comments[i];
                if (comment.body && comment.body.includes('ğŸ”„ è‡ªåŠ¨è¿­ä»£')) {
                  progressCommentId = comment.id;
                  existingCommentBody = comment.body;
                  console.log(`æ‰¾åˆ°è¿›åº¦è¿½è¸ªè¯„è®º: #${progressCommentId}`);
                  break;
                }
              }
            }

            // æ„å»ºè¿›åº¦è¯„è®ºå†…å®¹
            const progressBody = isContinuation ? [
              existingCommentBody || `ğŸ”„ **è‡ªåŠ¨è¿­ä»£**\n\n**ä¸Šä¸‹æ–‡**: ${continuationContext}`,
              "",
              "---",
              "",
              "## ğŸ¤– Medium Agent æ‰§è¡Œä¸­",
              "",
              "**å½“å‰é˜¶æ®µ**: ğŸ”„ å‡†å¤‡ä¸­...",
              "",
              "```",
              "â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0%",
              "```",
              "",
              "**çŠ¶æ€**: â³ æ­£åœ¨åˆå§‹åŒ–...",
            ].join("\n") : [
              "ğŸ”§ **Medium Agent å¯åŠ¨**",
              "",
              "---",
              "",
              "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
              "",
              "**å½“å‰é˜¶æ®µ**: ğŸ”„ å‡†å¤‡ä¸­...",
              "",
              "```",
              "â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0%",
              "```",
              "",
              "**çŠ¶æ€**: â³ æ­£åœ¨åˆå§‹åŒ–...",
              "",
              "---",
              "> ğŸ’¡ ä¸­ç­‰ä»»åŠ¡ä¼šå…ˆåˆ†æå†å¼€å‘ï¼Œç¡®ä¿æ–¹æ¡ˆåˆç†ã€‚"
            ].join("\n");

            // æ›´æ–°æˆ–åˆ›å»ºè¿›åº¦è¯„è®º
            if (progressCommentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: progressCommentId,
                body: progressBody
              });
              console.log(`æ›´æ–°è¿›åº¦è¿½è¸ªè¯„è®º: #${progressCommentId}`);
            } else {
              const progressComment = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: progressBody
              });
              progressCommentId = progressComment.data.id;
              console.log(`åˆ›å»ºæ–°çš„è¿›åº¦è¿½è¸ªè¯„è®º: #${progressCommentId}`);
            }

            // ä¿å­˜è¯„è®º ID å’ŒåŸå§‹å†…å®¹ä¾›åç»­æ›´æ–°
            core.setOutput('progress_comment_id', progressCommentId);
            core.setOutput('existing_comment_body', existingCommentBody);

      - name: Update Progress - Loading Template
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const progressCommentId = '${{ steps.update_issue_status.outputs.progress_comment_id }}' || null;
            const continuationContext = '${{ github.event.inputs.continuation_context }}' || '';
            const isContinuation = continuationContext.length > 0;
            const existingCommentBody = `${{ steps.update_issue_status.outputs.existing_comment_body }}`;

            // è¿›åº¦æ¡ç”Ÿæˆå‡½æ•°
            function generateProgressBar(percentage) {
              const totalBlocks = 20;
              const filledBlocks = Math.round((percentage / 100) * totalBlocks);
              const emptyBlocks = totalBlocks - filledBlocks;
              return 'â–ˆ'.repeat(filledBlocks) + 'â–‘'.repeat(emptyBlocks) + ` ${percentage}%`;
            }

            // æ„å»ºè¿›åº¦éƒ¨åˆ†
            const progressSection = [
              "## ğŸ¤– Medium Agent æ‰§è¡Œä¸­",
              "",
              "**å½“å‰é˜¶æ®µ**: ğŸ“ åŠ è½½æ¨¡æ¿å’Œå‡†å¤‡æç¤ºè¯...",
              "",
              "```",
              generateProgressBar(10),
              "```",
              "",
              "**çŠ¶æ€**: â³ æ­£åœ¨åŠ è½½å¼€å‘æ¨¡æ¿...",
            ].join("\n");

            if (progressCommentId) {
              const body = isContinuation && existingCommentBody
                ? existingCommentBody.split('---')[0] + "---\n\n" + progressSection
                : [
                    "ğŸ”§ **Medium Agent å¯åŠ¨**",
                    "",
                    "---",
                    "",
                    "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                    "",
                    "**å½“å‰é˜¶æ®µ**: ğŸ“ åŠ è½½æ¨¡æ¿å’Œå‡†å¤‡æç¤ºè¯...",
                    "",
                    "```",
                    generateProgressBar(10),
                    "```",
                    "",
                    "**çŠ¶æ€**: â³ æ­£åœ¨åŠ è½½å¼€å‘æ¨¡æ¿...",
                    "",
                    "---",
                    "> ğŸ’¡ ä¸­ç­‰ä»»åŠ¡ä¼šå…ˆåˆ†æå†å¼€å‘ï¼Œç¡®ä¿æ–¹æ¡ˆåˆç†ã€‚"
                  ].join("\n");

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: progressCommentId,
                body: body
              });
            }

      - name: Load Prompt Template
        id: prompt
        uses: ./.github/actions/load-prompt
        with:
          template: agents/medium.md
          variables: |
            {
              "repository": "${{ github.repository }}",
              "issue_number": "${{ steps.issue_info.outputs.issue_number }}",
              "title": ${{ toJson(steps.issue_info.outputs.issue_title) }},
              "body": ${{ toJson(steps.issue_info.outputs.issue_body) }},
              "continuation_context": "${{ github.event.inputs.continuation_context || '' }}"
            }

      - name: Update Progress - Running Claude
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const progressCommentId = '${{ steps.update_issue_status.outputs.progress_comment_id }}' || null;
            const continuationContext = '${{ github.event.inputs.continuation_context }}' || '';
            const isContinuation = continuationContext.length > 0;
            const existingCommentBody = `${{ steps.update_issue_status.outputs.existing_comment_body }}`;

            // è¿›åº¦æ¡ç”Ÿæˆå‡½æ•°
            function generateProgressBar(percentage) {
              const totalBlocks = 20;
              const filledBlocks = Math.round((percentage / 100) * totalBlocks);
              const emptyBlocks = totalBlocks - filledBlocks;
              return 'â–ˆ'.repeat(filledBlocks) + 'â–‘'.repeat(emptyBlocks) + ` ${percentage}%`;
            }

            // æ„å»ºè¿›åº¦éƒ¨åˆ†
            const progressSection = [
              "## ğŸ¤– Medium Agent æ‰§è¡Œä¸­",
              "",
              "**å½“å‰é˜¶æ®µ**: ğŸ¤– AI æ­£åœ¨åˆ†æå’Œå¼€å‘...",
              "",
              "```",
              generateProgressBar(50),
              "```",
              "",
              "**çŠ¶æ€**: â³ Claude æ­£åœ¨å¤„ç†ä»»åŠ¡...",
              "",
              "**æç¤º**: è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…",
            ].join("\n");

            if (progressCommentId) {
              const body = isContinuation && existingCommentBody
                ? existingCommentBody.split('---')[0] + "---\n\n" + progressSection
                : [
                    "ğŸ”§ **Medium Agent å¯åŠ¨**",
                    "",
                    "---",
                    "",
                    "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                    "",
                    "**å½“å‰é˜¶æ®µ**: ğŸ¤– AI æ­£åœ¨åˆ†æå’Œå¼€å‘...",
                    "",
                    "```",
                    generateProgressBar(50),
                    "```",
                    "",
                    "**çŠ¶æ€**: â³ Claude æ­£åœ¨å¤„ç†ä»»åŠ¡...",
                    "",
                    "**æç¤º**: è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…",
                    "",
                    "---",
                    "> ğŸ’¡ ä¸­ç­‰ä»»åŠ¡ä¼šå…ˆåˆ†æå†å¼€å‘ï¼Œç¡®ä¿æ–¹æ¡ˆåˆç†ã€‚"
                  ].join("\n");

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: progressCommentId,
                body: body
              });
            }

      - name: Run Claude Code Action
        if: steps.check_duplicate.outputs.is_duplicate != 'true'
        id: claude
        uses: anthropics/claude-code-action@v1
        continue-on-error: true
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          # track_progress only supports: pull_request, issues, issue_comment, pull_request_review_comment, pull_request_review
          # Not supported for workflow_dispatch or workflow_call events
          track_progress: ${{ github.event_name == 'issue_comment' }}
          prompt: ${{ steps.prompt.outputs.prompt }}
          # å…è®¸æ‰€æœ‰ bots è§¦å‘
          # è¿™å¯¹äºä»¥ä¸‹è‡ªåŠ¨åŒ–åœºæ™¯æ˜¯å¿…éœ€çš„ï¼š
          # - vibe-router è‡ªåŠ¨è·¯ç”±ä»»åŠ¡
          # - vibe-continuous è‡ªåŠ¨è¿­ä»£å’ŒéªŒæ”¶
          # - dependency-chain è§¦å‘ä¾èµ–ä»»åŠ¡
          # å¦åˆ™ä¼šæŠ¥é”™ï¼šWorkflow initiated by non-human actor
          allowed_bots: '*'
          claude_args: |
            --model anthropic/claude-sonnet-4
            --max-turns 50

      - name: Check and Handle Claude Result
        id: check_result
        run: |
          OUTCOME="${{ steps.claude.outcome }}"
          CONCLUSION="${{ steps.claude.conclusion }}"
          BRANCH_NAME="${{ steps.claude.outputs.branch_name }}"
          EXECUTION_FILE="${{ steps.claude.outputs.execution_file }}"

          echo "Claude outcome: $OUTCOME"
          echo "Claude conclusion: $CONCLUSION"
          echo "Branch name: $BRANCH_NAME"
          echo "Execution file: $EXECUTION_FILE"

          # ä¿å­˜åˆ†æ”¯åä¾›åç»­ä½¿ç”¨
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          if [ "$OUTCOME" == "failure" ] || [ "$OUTCOME" == "cancelled" ]; then
            echo "claude_failed=true" >> $GITHUB_OUTPUT

            # å°è¯•ä»å¤šä¸ªä½ç½®æå–é”™è¯¯ä¿¡æ¯
            ERROR_MSG=""
            if [ -f "/home/runner/work/_temp/claude-execution-output.json" ]; then
              ERROR_MSG=$(cat /home/runner/work/_temp/claude-execution-output.json | jq -r '.error // .message // empty' 2>/dev/null || true)
            fi

            if [ -z "$ERROR_MSG" ] && [ -f "/home/runner/work/_temp/claude-error.log" ]; then
              ERROR_MSG=$(head -c 500 /home/runner/work/_temp/claude-error.log 2>/dev/null || true)
            fi

            if [ -z "$ERROR_MSG" ]; then
              if [ "$OUTCOME" == "cancelled" ]; then
                ERROR_MSG="Claude æ‰§è¡Œè¢«å–æ¶ˆ"
              else
                ERROR_MSG="æ‰§è¡Œå¤±è´¥ï¼Œè¯·æŸ¥çœ‹ Actions æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
              fi
            fi

            echo "error_message<<EOF" >> $GITHUB_OUTPUT
            echo "$ERROR_MSG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "claude_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Exit on Claude Failure
        if: steps.check_result.outputs.claude_failed == 'true'
        run: |
          echo "Claude execution failed: ${{ steps.check_result.outputs.error_message }}"
          exit 1

      - name: Update Issue on Success
        if: success() && steps.check_duplicate.outputs.is_duplicate != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const progressCommentId = '${{ steps.update_issue_status.outputs.progress_comment_id }}' || null;
            const continuationContext = '${{ github.event.inputs.continuation_context }}' || '';
            const isContinuation = continuationContext.length > 0;
            const existingCommentBody = `${{ steps.update_issue_status.outputs.existing_comment_body }}`;
            const branchName = '${{ steps.check_result.outputs.branch_name }}' || '';

            // è·å–æœ€è¿‘åˆ›å»ºçš„ PRï¼ˆç”±æœ¬æ¬¡æ‰§è¡Œåˆ›å»ºï¼‰
            let prInfo = '';
            let relatedPR = null;
            try {
              // è·å–æœ€è¿‘çš„ PRï¼ˆåŒ…æ‹¬ open å’Œåˆšåˆå¹¶çš„ï¼‰
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                sort: 'created',
                direction: 'desc',
                per_page: 10
              });

              // æŸ¥æ‰¾æ ‡é¢˜æˆ–åˆ†æ”¯åŒ…å« issue ç¼–å·çš„ PRï¼Œæˆ–ä½¿ç”¨ claude-code-action åˆ›å»ºçš„åˆ†æ”¯
              relatedPR = prs.find(pr =>
                pr.title.includes(`#${issueNumber}`) ||
                pr.title.toLowerCase().includes(`issue-${issueNumber}`) ||
                pr.head.ref.includes(`issue-${issueNumber}`) ||
                pr.head.ref.includes(`${issueNumber}`) ||
                (branchName && pr.head.ref === branchName) ||
                pr.body?.includes(`#${issueNumber}`) ||
                pr.body?.includes(`Closes #${issueNumber}`) ||
                pr.body?.includes(`Fixes #${issueNumber}`)
              );

              if (relatedPR) {
                prInfo = `\n\n**åˆ›å»ºçš„ PR**: [#${relatedPR.number} ${relatedPR.title}](${relatedPR.html_url})`;
                console.log(`âœ… æ‰¾åˆ°å…³è” PR: #${relatedPR.number}`);
              } else {
                console.log(`âš ï¸ æœªæ‰¾åˆ°å…³è” PR`);
              }
            } catch (e) {
              console.log("è·å– PR ä¿¡æ¯å¤±è´¥:", e.message);
            }

            // å…³é”®æ£€æŸ¥ï¼šå¦‚æœæ²¡æœ‰æ‰¾åˆ° PRï¼Œä¸èƒ½å…³é—­ Issue
            if (!relatedPR) {
              console.log(`âŒ æœªæ‰¾åˆ°å…³è” PRï¼Œä¸å…³é—­ Issue #${issueNumber}`);

              // è¿›åº¦æ¡ç”Ÿæˆå‡½æ•°
              function generateProgressBar(percentage) {
                const totalBlocks = 20;
                const filledBlocks = Math.round((percentage / 100) * totalBlocks);
                const emptyBlocks = totalBlocks - filledBlocks;
                return 'â–ˆ'.repeat(filledBlocks) + 'â–‘'.repeat(emptyBlocks) + ` ${percentage}%`;
              }

              // æ„å»º claude-code-action é£æ ¼çš„è­¦å‘ŠçŠ¶æ€
              const jobUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }}`;
              const statusLine = `**âš ï¸ Claude finished** â€” No PR created â€”â€” [View job](${jobUrl})`;

              const warningSection = [
                statusLine,
                "",
                "```",
                generateProgressBar(80),
                "```",
                "",
                "---",
                "",
                "## ğŸ” What happened",
                "",
                "Agent completed execution, but no Pull Request was found.",
                "",
                "**Possible causes:**",
                "- Changes were not committed",
                "- PR creation was skipped or failed",
                "- Branch was not pushed to remote",
                "",
                "## ğŸ”§ What to do next",
                "",
                "- Review the job logs to see what Claude did",
                "- Check if there are local changes that need to be committed",
                "- Manually create a PR or retry the agent",
                "",
                "---",
                "*If you need help, review the execution logs for more details.*"
              ].join("\n");

              // æ›´æ–°è¿›åº¦è¯„è®ºä¸ºè­¦å‘ŠçŠ¶æ€
              if (progressCommentId) {
                try {
                  const body = isContinuation && existingCommentBody
                    ? existingCommentBody.split('---')[0] + "---\n\n" + warningSection
                    : [
                        "ğŸ”§ **Medium Agent**",
                        "",
                        "---",
                        "",
                        warningSection
                      ].join("\n");

                  await github.rest.issues.updateComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: progressCommentId,
                    body: body
                  });
                } catch (e) {
                  console.log("æ— æ³•æ›´æ–°è¿›åº¦è¯„è®º:", e.message);
                }
              }

              // ç§»é™¤ processing æ ‡ç­¾ï¼Œæ·»åŠ è­¦å‘Šæ ‡ç­¾
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: 'ğŸ¤– ai-processing'
                });
              } catch (e) {}

              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: 'agent:medium'
                });
              } catch (e) {}

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['âš ï¸ no-pr', 'needs-review']
              });

              // ä¸å…³é—­ Issueï¼Œç›´æ¥è¿”å›
              return;
            }

            // æ£€æŸ¥ PR çš„ CI çŠ¶æ€
            let checkRuns = [];
            try {
              const { data: checkData } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: relatedPR.head.sha,
                per_page: 50
              });
              checkRuns = checkData.check_runs || [];
            } catch (e) {
              console.log(`âš ï¸ è·å– Check Runs å¤±è´¥: ${e.message}`);
            }

            const failedChecks = checkRuns.filter(run =>
              ['failure', 'cancelled', 'timed_out', 'action_required'].includes(run.conclusion)
            );
            const pendingChecks = checkRuns.filter(run => run.status !== 'completed');

            const summarizeChecks = (runs) =>
              runs.map(r => `- ${r.name}: ${r.conclusion || r.status}`).join('\n');

            if (failedChecks.length > 0) {
              console.log(`âŒ æ£€æµ‹åˆ° ${failedChecks.length} ä¸ªå¤±è´¥çš„æ£€æŸ¥`);

              // è¿›åº¦æ¡ç”Ÿæˆå‡½æ•°
              function generateProgressBar(percentage) {
                const totalBlocks = 20;
                const filledBlocks = Math.round((percentage / 100) * totalBlocks);
                const emptyBlocks = totalBlocks - filledBlocks;
                return 'â–ˆ'.repeat(filledBlocks) + 'â–‘'.repeat(emptyBlocks) + ` ${percentage}%`;
              }

              // æ„å»º claude-code-action é£æ ¼çš„ CI å¤±è´¥çŠ¶æ€
              const jobUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }}`;
              const prUrl = relatedPR ? relatedPR.html_url : '';
              const statusParts = [`**ğŸ”¨ CI checks failed** â€”â€” [View job](${jobUrl})`];
              if (prUrl) {
                statusParts.push(`[PR #${relatedPR.number}](${prUrl})`);
              }
              const statusLine = statusParts.join(' â€¢ ');

              const ciFailureSection = [
                statusLine,
                "",
                "```",
                generateProgressBar(75),
                "```",
                "",
                "---",
                "",
                "## âŒ Failed checks",
                "",
                summarizeChecks(failedChecks),
                "",
                "## ğŸ”§ What to do next",
                "",
                "- Auto-fix has been triggered (if applicable)",
                "- Review the PR checks for detailed error messages",
                "- Manual fixes may be required for some issues",
                "",
                "---",
                "*The `/fix` command will attempt to resolve common CI failures automatically.*"
              ].join("\n");

              if (progressCommentId) {
                try {
                  const body = isContinuation && existingCommentBody
                    ? existingCommentBody.split('---')[0] + "---\n\n" + ciFailureSection
                    : [
                        "ğŸ”§ **Medium Agent**",
                        "",
                        "---",
                        "",
                        ciFailureSection
                      ].join("\n");

                  await github.rest.issues.updateComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: progressCommentId,
                    body: body
                  });
                } catch (e) {
                  console.log("æ— æ³•æ›´æ–°è¿›åº¦è¯„è®º:", e.message);
                }
              }

              // è§¦å‘ /fixï¼ˆä»…å½“ PR å­˜åœ¨ï¼‰
              const shouldTriggerFix = failedChecks.some(run => {
                const name = (run.name || '').toLowerCase();
                return name.includes('build') || name.includes('test') || name.includes('lint') || name.includes('type');
              });

              if (shouldTriggerFix) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: relatedPR.number,
                  body: [
                    "/fix",
                    "",
                    "---",
                    "ğŸ”„ **è‡ªåŠ¨ä¿®å¤**ï¼šæ£€æµ‹åˆ° CI å¤±è´¥ï¼Œå·²è§¦å‘ä¿®å¤æµç¨‹ã€‚"
                  ].join("\n")
                });
              }

              // ç§»é™¤ processing æ ‡ç­¾ï¼Œæ·»åŠ  CI å¤±è´¥æ ‡ç­¾
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: 'ğŸ¤– ai-processing'
                });
              } catch (e) {}

              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: 'agent:medium'
                });
              } catch (e) {}

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['âš ï¸ ci-failed', 'needs-review']
              });

              return;
            }

            if (pendingChecks.length > 0) {
              console.log(`â³ ä»æœ‰ ${pendingChecks.length} ä¸ªæ£€æŸ¥æœªå®Œæˆ`);

              // è¿›åº¦æ¡ç”Ÿæˆå‡½æ•°
              function generateProgressBar(percentage) {
                const totalBlocks = 20;
                const filledBlocks = Math.round((percentage / 100) * totalBlocks);
                const emptyBlocks = totalBlocks - filledBlocks;
                return 'â–ˆ'.repeat(filledBlocks) + 'â–‘'.repeat(emptyBlocks) + ` ${percentage}%`;
              }

              // æ„å»º claude-code-action é£æ ¼çš„ CI è¿›è¡Œä¸­çŠ¶æ€
              const jobUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }}`;
              const prUrl = relatedPR ? relatedPR.html_url : '';
              const statusParts = [`**â³ CI checks running** â€”â€” [View job](${jobUrl})`];
              if (prUrl) {
                statusParts.push(`[PR #${relatedPR.number}](${prUrl})`);
              }
              const statusLine = statusParts.join(' â€¢ ');

              const ciPendingSection = [
                statusLine,
                "",
                "```",
                generateProgressBar(75),
                "```",
                "",
                "---",
                "",
                "## â³ Pending checks",
                "",
                summarizeChecks(pendingChecks),
                "",
                "---",
                "*Waiting for all CI checks to complete...*"
              ].join("\n");

              if (progressCommentId) {
                try {
                  const body = isContinuation && existingCommentBody
                    ? existingCommentBody.split('---')[0] + "---\n\n" + ciPendingSection
                    : [
                        "ğŸ”§ **Medium Agent**",
                        "",
                        "---",
                        "",
                        ciPendingSection
                      ].join("\n");

                  await github.rest.issues.updateComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: progressCommentId,
                    body: body
                  });
                } catch (e) {
                  console.log("æ— æ³•æ›´æ–°è¿›åº¦è¯„è®º:", e.message);
                }
              }

              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: 'ğŸ¤– ai-processing'
                });
              } catch (e) {}

              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: 'agent:medium'
                });
              } catch (e) {}

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['âš ï¸ ci-pending', 'needs-review']
              });

              return;
            }

            // æœ‰ PR çš„æƒ…å†µï¼šæ­£å¸¸å®Œæˆæµç¨‹
            // æ„å»ºæ ‡å‡†çš„ claude-code-action æ ¼å¼è¾“å‡º
            const jobUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }}`;
            const branchUrl = branchName ? `https://github.com/${context.repo.owner}/${context.repo.repo}/tree/${branchName}` : '';
            const createPrUrl = branchName ? `https://github.com/${context.repo.owner}/${context.repo.repo}/compare/main...${branchName}?quick_pull=1&title=Issue%20%23${issueNumber}%3A%20Changes%20from%20Claude&body=This%20PR%20addresses%20issue%20%23${issueNumber}%0A%0AGenerated%20with%20%5BClaude%20Code%5D(https%3A%2F%2Fclaude.ai%2Fcode)` : '';

            // æ„å»ºçŠ¶æ€è¡Œï¼ˆæ¨¡ä»¿ claude-code-action çš„æ ¼å¼ï¼‰
            const statusParts = [`**Claude finished successfully** â€”â€” [View job](${jobUrl})`];
            if (branchName) {
              statusParts.push(`[\`${branchName}\`](${branchUrl})`);
            }
            if (relatedPR) {
              statusParts.push(`[PR #${relatedPR.number}](${relatedPR.html_url})`);
            } else if (createPrUrl) {
              statusParts.push(`[Create PR â”](${createPrUrl})`);
            }
            const statusLine = statusParts.join(' â€¢ ');

            const completionSection = [
              statusLine,
              "",
              "---",
              "",
              "## âœ… Implementation Complete",
              "",
              `**Issue**: #${issueNumber}`,
              relatedPR ? `**PR**: [#${relatedPR.number} ${relatedPR.title}](${relatedPR.html_url})` : '',
              branchName ? `**Branch**: \`${branchName}\`` : '',
              "",
              "All requirements have been implemented. Please review the changes.",
              "",
              "---",
              "*Generated with [Claude Code](https://claude.ai/code)*"
            ].filter(Boolean).join("\n");

            // æ›´æ–°è¿›åº¦è¯„è®ºä¸ºå®ŒæˆçŠ¶æ€
            if (progressCommentId) {
              try {
                const body = isContinuation && existingCommentBody
                  ? existingCommentBody.split('---')[0] + "---\n\n" + completionSection
                  : [
                      "ğŸ”§ **Medium Agent**",
                      "",
                      "---",
                      "",
                      completionSection
                    ].join("\n");

                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: progressCommentId,
                  body: body
                });
              } catch (e) {
                console.log("æ— æ³•æ›´æ–°è¿›åº¦è¯„è®º:", e.message);
              }
            }

            // ç§»é™¤ processing æ ‡ç­¾ï¼Œæ·»åŠ  completed æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'ğŸ¤– ai-processing'
              });
            } catch (e) {}

            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'agent:medium'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['âœ… ai-completed']
            });

            // åªæœ‰æ‰¾åˆ° PR æ‰å…³é—­ Issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'completed'
            });

            console.log(`âœ… Issue #${issueNumber} å·²è‡ªåŠ¨å…³é—­ï¼Œå°†è§¦å‘ä¾èµ–é“¾ä¸­çš„ä¸‹ä¸€ä¸ªä»»åŠ¡`);

      - name: Trigger Verification
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};

            console.log(`ğŸ” è§¦å‘éªŒæ”¶æ£€æŸ¥: Issue #${issueNumber}`);

            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'vibe-continuous.yml',
                ref: 'main',
                inputs: {
                  issue_number: String(issueNumber),
                  mode: 'verify'
                }
              });
              console.log(`âœ… å·²è§¦å‘ vibe-continuous éªŒæ”¶æ£€æŸ¥`);
            } catch (error) {
              console.log(`âš ï¸ è§¦å‘éªŒæ”¶æ£€æŸ¥å¤±è´¥: ${error.message}`);
              // å³ä½¿è§¦å‘å¤±è´¥ä¹Ÿä¸å½±å“æ•´ä½“æµç¨‹
            }

      - name: Update Issue on Failure
        if: failure() && steps.check_duplicate.outputs.is_duplicate != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const progressCommentId = '${{ steps.update_issue_status.outputs.progress_comment_id }}' || null;
            const continuationContext = '${{ github.event.inputs.continuation_context }}' || '';
            const isContinuation = continuationContext.length > 0;
            const existingCommentBody = `${{ steps.update_issue_status.outputs.existing_comment_body }}`;
            const errorMessage = `${{ steps.check_result.outputs.error_message || 'æœªçŸ¥é”™è¯¯' }}`;

            // è¿›åº¦æ¡ç”Ÿæˆå‡½æ•°
            function generateProgressBar(percentage) {
              const totalBlocks = 20;
              const filledBlocks = Math.round((percentage / 100) * totalBlocks);
              const emptyBlocks = totalBlocks - filledBlocks;
              return 'â–ˆ'.repeat(filledBlocks) + 'â–‘'.repeat(emptyBlocks) + ` ${percentage}%`;
            }

            // åˆ†æé”™è¯¯ç±»å‹å¹¶ç»™å‡ºé’ˆå¯¹æ€§å»ºè®®
            let errorType = "";
            let errorIcon = "âŒ";
            let nextSteps = [];

            if (errorMessage.includes("Edit") || errorMessage.includes("old_string") || errorMessage.includes("not found")) {
              errorType = "Code edit failed";
              errorIcon = "ğŸ”";
              nextSteps = [
                "The target code may have been modified",
                "Try reviewing the file manually or use `/agent-medium` to retry"
              ];
            } else if (errorMessage.includes("timeout") || errorMessage.includes("Timeout")) {
              errorType = "Task timeout";
              errorIcon = "â±ï¸";
              nextSteps = [
                "Task complexity exceeds medium agent capacity",
                "Use `/agent-complex` to break down into subtasks"
              ];
            } else if (errorMessage.includes("rate limit") || errorMessage.includes("429") || errorMessage.includes("Too Many Requests")) {
              errorType = "API rate limit";
              errorIcon = "ğŸš¦";
              nextSteps = [
                "Wait a few minutes and retry with `/agent-medium`"
              ];
            } else if (errorMessage.includes("permission") || errorMessage.includes("Permission")) {
              errorType = "Permission denied";
              errorIcon = "ğŸ”’";
              nextSteps = [
                "Check GitHub Token permissions configuration"
              ];
            } else if (errorMessage.includes("build") || errorMessage.includes("compile")) {
              errorType = "Build failed";
              errorIcon = "ğŸ”¨";
              nextSteps = [
                "Code contains syntax or compilation errors",
                "Review the build logs for specific issues"
              ];
            } else {
              errorType = "Execution error";
              errorIcon = "âš ï¸";
              nextSteps = [
                "Review the Actions logs for more details",
                "Retry with `/agent-medium` or use `/agent-complex`"
              ];
            }

            // æ„å»º claude-code-action é£æ ¼çš„å¤±è´¥çŠ¶æ€
            const jobUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }}`;
            const statusLine = `**${errorIcon} Claude failed** â€” ${errorType} â€”â€” [View job](${jobUrl})`;

            const failureSection = [
              statusLine,
              "",
              "```",
              generateProgressBar(50),
              "```",
              "",
              "---",
              "",
              "## ğŸ”§ What to do next",
              "",
              ...nextSteps.map(step => `- ${step}`),
              "",
              "<details>",
              "<summary>ğŸ“‹ Error details</summary>",
              "",
              "```",
              errorMessage.substring(0, 500),
              "```",
              "</details>",
              "",
              "---",
              "*For complex tasks, consider using `/agent-complex` to break them down into smaller, manageable pieces.*"
            ].join("\n");

            // æ›´æ–°è¿›åº¦è¯„è®ºä¸ºå¤±è´¥çŠ¶æ€
            if (progressCommentId) {
              try {
                const body = isContinuation && existingCommentBody
                  ? existingCommentBody.split('---')[0] + "---\n\n" + failureSection
                  : [
                      "ğŸ”§ **Medium Agent**",
                      "",
                      "---",
                      "",
                      failureSection
                    ].join("\n");

                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: progressCommentId,
                  body: body
                });
              } catch (e) {
                console.log("æ— æ³•æ›´æ–°è¿›åº¦è¯„è®º:", e.message);
              }
            }

            // ç§»é™¤ processing æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'ğŸ¤– ai-processing'
              });
            } catch (e) {}

            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'agent:medium'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['âŒ ai-failed', 'needs-review']
            });

            // ä¸å†åˆ›å»ºé¢å¤–è¯„è®ºï¼Œæ‰€æœ‰ä¿¡æ¯éƒ½åœ¨è¿›åº¦è¿½è¸ªè¯„è®ºä¸­

      - name: Collect Router Feedback
        if: failure() && steps.check_result.outputs.claude_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            
            console.log('ğŸ“Š æ”¶é›† Router åé¦ˆæ•°æ®...');
            
            try {
              // è¯»å–æ‰§è¡Œç»“æœæ•°æ®
              const executionFile = '/home/runner/work/_temp/claude-execution-output.json';
              let executionData = {};
              
              if (fs.existsSync(executionFile)) {
                executionData = JSON.parse(fs.readFileSync(executionFile, 'utf8'));
              }
              
              // åˆ¤æ–­æ˜¯å¦å› ä¸ºä»»åŠ¡å¤æ‚åº¦è¯¯åˆ¤å¯¼è‡´å¤±è´¥
              const isComplexityMismatch = 
                executionData.num_turns >= 45 ||  // æ¥è¿‘æˆ–è¾¾åˆ°ä¸Šé™
                executionData.subtype === 'error_max_turns';
              
              if (isComplexityMismatch) {
                console.log('âš ï¸ æ£€æµ‹åˆ°å¯èƒ½çš„å¤æ‚åº¦è¯¯åˆ¤');
                
                // è·å– Issue ä¿¡æ¯
                const { data: issue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ Router è¯„ä¼°æ ‡ç­¾
                const labels = issue.labels.map(l => l.name);
                let routerPrediction = 'M';  // é»˜è®¤ Mediumï¼ˆå› ä¸ºæ˜¯ agent-medium.ymlï¼‰
                if (labels.includes('complexity:simple')) routerPrediction = 'S';
                if (labels.includes('complexity:complex')) routerPrediction = 'L';
                
                // æ„å»ºåé¦ˆæ•°æ®
                const feedbackData = {
                  issue_number: issueNumber,
                  issue_title: issue.title,
                  issue_body_preview: (issue.body || '').substring(0, 500),
                  router_prediction: {
                    complexity: routerPrediction,
                    labels: labels.filter(l => l.startsWith('complexity:'))
                  },
                  actual_execution: {
                    agent_used: 'medium',
                    total_turns: executionData.num_turns || 0,
                    max_turns_limit: 50,
                    duration_ms: executionData.duration_ms || 0,
                    duration_seconds: Math.round((executionData.duration_ms || 0) / 1000),
                    cost_usd: executionData.total_cost_usd || 0,
                    status: 'failed_max_turns',
                    failure_reason: executionData.subtype || 'unknown'
                  },
                  suggested_complexity: 'L',  // å¦‚æœ Medium å¤±è´¥é€šå¸¸åº”è¯¥æ˜¯ L
                  feedback_timestamp: new Date().toISOString(),
                  actions_run: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
                };
                
                // åˆ›å»ºåé¦ˆç›®å½•
                const feedbackDir = 'docs/router-feedback';
                if (!fs.existsSync(feedbackDir)) {
                  fs.mkdirSync(feedbackDir, { recursive: true });
                }
                
                // ä¿å­˜åé¦ˆæ•°æ®
                const feedbackFile = path.join(feedbackDir, `issue-${issueNumber}.json`);
                fs.writeFileSync(feedbackFile, JSON.stringify(feedbackData, null, 2));
                
                console.log(`âœ… åé¦ˆæ•°æ®å·²ä¿å­˜: ${feedbackFile}`);
                console.log(`ğŸ“Š æ‰§è¡ŒæŒ‡æ ‡: ${feedbackData.actual_execution.total_turns} è½®, $${feedbackData.actual_execution.cost_usd}, ${feedbackData.actual_execution.duration_seconds}s`);
                
                // åœ¨ Issue ä¸­æ·»åŠ éšè—æ ‡è®°ï¼ˆç”¨äºåç»­åˆ†æï¼‰
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ['router-misprediction']
                });
                
                console.log('âœ… å·²æ·»åŠ  router-misprediction æ ‡ç­¾');
              } else {
                console.log('â„¹ï¸ éå¤æ‚åº¦è¯¯åˆ¤å¯¼è‡´çš„å¤±è´¥ï¼Œä¸æ”¶é›†åé¦ˆ');
              }
            } catch (error) {
              console.error(`âŒ æ”¶é›†åé¦ˆæ•°æ®å¤±è´¥: ${error.message}`);
              // å³ä½¿æ”¶é›†å¤±è´¥ä¹Ÿä¸å½±å“æ•´ä½“æµç¨‹
            }
