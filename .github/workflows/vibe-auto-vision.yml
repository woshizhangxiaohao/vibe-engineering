name: AI Product Strategist (Zero Dependency)

on:
  issues:
    types: [opened]

jobs:
  product-intelligence:
    # åªæœ‰æ ‡ç­¾åä¸º 'ai-pm' æ—¶æ‰æ‰§è¡Œ
    if: github.event.label.name == 'ai-pm'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: "Analyze Product Requirements"
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        uses: actions/github-script@v7
        with:
          script: |
            async function askAI(prompt) {
              const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  'Content-Type': 'application/json',
                  'HTTP-Referer': 'https://github.com/lessthanno/vibe-engineering-playbook'
                },
                body: JSON.stringify({
                  model: "anthropic/claude-sonnet-4.5", // 3.5 Sonnet åœ¨é€»è¾‘æ‹†è§£ä¸Šæå…·æ€§ä»·æ¯”
                  messages: [{ role: "user", content: prompt }]
                })
              });

              if (!response.ok) {
                const error = await response.text();
                throw new Error(`OpenRouter API Error: ${error}`);
              }

              const data = await response.json();
              return data.choices[0].message.content;
            }

            const title = process.env.ISSUE_TITLE;
            const body = process.env.ISSUE_BODY || "No description provided.";

            const prompt = `ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„èµ„æ·±äº§å“ç»ç† (Senior PM)ã€‚
            è¯·é’ˆå¯¹ä»¥ä¸‹æäº¤çš„åŠŸèƒ½éœ€æ±‚/é—®é¢˜åé¦ˆï¼Œæä¾›ä¸“ä¸šçš„äº§å“åŒ–å»ºè®®å’Œéœ€æ±‚æ‹†è§£ï¼š

            éœ€æ±‚æ ‡é¢˜: ${title}
            è¯¦ç»†æè¿°: ${body}

            è¯·æŒ‰ä»¥ä¸‹ç»“æ„è¾“å‡ºå»ºè®®ï¼ˆä½¿ç”¨ Markdownï¼‰ï¼š
            1. **æ ¸å¿ƒç—›ç‚¹åˆ†æ**ï¼šç®€å•æè¿°è¯¥éœ€æ±‚è§£å†³äº†ç”¨æˆ·ä»€ä¹ˆé—®é¢˜ã€‚
            2. **ç”¨æˆ·æ•…äº‹ (User Stories)**ï¼šä»¥ "ä½œä¸º...æˆ‘å¸Œæœ›...ä»¥ä¾¿äº..." çš„æ ¼å¼æä¾› 2-3 ä¸ªåœºæ™¯ã€‚
            3. **æ ¸å¿ƒåŠŸèƒ½é€»è¾‘**ï¼šæè¿°å®ç°è¯¥åŠŸèƒ½çš„ä¸»è¦ä¸šåŠ¡æµç¨‹æˆ–å…³é”®é€»è¾‘ã€‚
            4. **MVP èŒƒå›´å»ºè®®**ï¼šå“ªäº›æ˜¯å¿…é¡»åšçš„ (Must-have)ï¼Œå“ªäº›å¯ä»¥åç»­è¿­ä»£ã€‚
            5. **æ½œåœ¨é£é™©ç‚¹**ï¼šéœ€è¦æ³¨æ„çš„è¾¹ç•Œæƒ…å†µæˆ–ç”¨æˆ·ä½“éªŒå‘ç‚¹ã€‚

            è¯·ä¿æŒå›ç­”ç®€æ´ã€ä¸“ä¸šä¸”å…·æœ‰å¯å‘æ€§ã€‚`;

            console.log("Generating product insights...");
            try {
              const aiResponse = await askAI(prompt);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "ğŸ’¡ **AI äº§å“éœ€æ±‚æ´å¯Ÿ:**\n\n" + aiResponse
              });
              console.log("Insights posted successfully.");
            } catch (err) {
              console.error("Workflow failed:", err);
              core.setFailed(err.message);
            }
