name: AI Tech Architect
on:
  issues:
    types: [labeled]
jobs:
  tech-arch:
    # åªæœ‰å½“æ ‡ç­¾ä¸º 'ğŸ›  tech' æ—¶æ‰è§¦å‘
    if: github.event.label.name == 'ğŸ›  tech'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: "Deep Architecture Analysis"
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        uses: actions/github-script@v7
        with:
          script: |
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªé¡¶çº§å…¨æ ˆæ¶æ„å¸ˆï¼ˆBackend + Frontend + DevOps + å®‰å…¨ï¼‰ã€‚
            ç›®æ ‡ï¼šå°† Issue éœ€æ±‚æ‹†è§£ä¸ºå·¥ä¸šçº§ã€å¯è½åœ°çš„æŠ€æœ¯æ–¹æ¡ˆï¼Œå¹¶æ¶ˆç­ä¸ç¡®å®šæ€§ã€‚

            ### å¿…é¡»éµå¾ªçš„æ€ç»´æ¡†æ¶ï¼š
            1. **é˜²å¾¡æ€§è®¾è®¡**ï¼šå…ˆè¯†åˆ«é£é™©ï¼ˆè¶Šæƒã€è¶…å–ã€é‡æ”¾ã€æ³¨å…¥ï¼‰ï¼Œå†è®¾è®¡æ–¹æ¡ˆã€‚
            2. **ç¡¬æ ¸æŠ€æœ¯æ ˆ**ï¼šé’ˆå¯¹ Go (åç«¯) å’Œ Next.js (å‰ç«¯) æä¾›å…·ä½“çš„ Struct å®šä¹‰ã€ä¸­é—´ä»¶é€»è¾‘å’Œç»„ä»¶åˆ’åˆ†ã€‚
            3. **æƒè¡¡å–èˆ**ï¼šä¸è¦åªç»™ä¸€ä¸ªæ–¹æ¡ˆï¼Œç»™å‡º 2 å¥—å¤‡é€‰å¹¶è§£é‡Šä¸ºä»€ä¹ˆé€‰å…¶ä¸­ä¹‹ä¸€ã€‚
            4. **é—­ç¯æ‹†åˆ†**ï¼šå‰ç«¯/åç«¯è¾“å‡ºå¿…é¡»åŒ…å«å…·ä½“çš„ã€å¯ä»¥ç›´æ¥åˆ†é…ç»™å¼€å‘è€…çš„ä»»åŠ¡æè¿°ã€‚

            ### è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š
            å¿…é¡»è¿”å›ä¸¥æ ¼çš„ JSON æ ¼å¼ï¼Œä¸è¦åŒ…å«ä»»ä½•å¤šä½™æ–‡å­—ï¼š
            {
              "analysis": "è¿™é‡Œæ˜¯å®Œæ•´çš„ Markdown æ·±åº¦æŠ¥å‘Šã€‚åŒ…å«ï¼šéœ€æ±‚è¾¹ç•Œã€æ¶æ„æ€»è§ˆã€æ•°æ®è®¾è®¡(å«SQL/GORM)ã€APIè®¾è®¡ã€å®‰å…¨é£æ§ã€è¿ç»´ç­–ç•¥ã€å…³é”®5ä¸ªè¿½é—®ã€‚",
              "frontend": { 
                "title": "Frontend Implementation: ${process.env.ISSUE_TITLE}", 
                "body": "åŸºäº Next.js çš„è¯¦ç»†å¼€å‘æŒ‡å—ã€‚åŒ…å«ï¼šç›®å½•ç»“æ„ã€æ ¸å¿ƒç»„ä»¶é€»è¾‘ã€çŠ¶æ€ç®¡ç†(Zod/Zustand)ã€Server Components åˆ’åˆ†ã€API äº¤äº’å®šä¹‰ã€‚" 
              },
              "backend": { 
                "title": "Backend Implementation: ${process.env.ISSUE_TITLE}", 
                "body": "åŸºäº Go çš„è¯¦ç»†å¼€å‘æŒ‡å—ã€‚åŒ…å«ï¼šGORM Model å®šä¹‰ã€API Endpointã€ä¸šåŠ¡é€»è¾‘(Serviceå±‚)æ‹†è§£ã€å¹¶å‘æ§åˆ¶ä¸ä¸­é—´ä»¶ã€å¹‚ç­‰ç­–ç•¥ã€‚" 
              }
            }`;

            const userPrompt = `éœ€æ±‚æ ‡é¢˜: ${process.env.ISSUE_TITLE}\néœ€æ±‚å†…å®¹: ${process.env.ISSUE_BODY || "ï¼ˆæ— æè¿°ï¼‰"}`;

            try {
              const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  'Content-Type': 'application/json',
                  'HTTP-Referer': 'https://github.com/ai-tech-arch'
                },
                body: JSON.stringify({
                  model: "anthropic/claude-sonnet-4.5", // æ¨èä½¿ç”¨é€»è¾‘æœ€å¼ºçš„æ¨¡å‹
                  messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                  ],
                  response_format: { type: "json_object" }
                })
              });

              const data = await response.json();
              if (!data.choices) throw new Error("AI Response Error: " + JSON.stringify(data));
              
              const result = JSON.parse(data.choices[0].message.content);

              // 1. åœ¨åŸ Issue ä¸‹å›å¤æ·±åº¦æ¶æ„åˆ†ææŠ¥å‘Š
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "## ğŸ›  AI å…¨æ ˆæ¶æ„å»ºè®®\n\n" + result.analysis
              });

              // 2. åˆ›å»ºå‰ç«¯å­ä»»åŠ¡ Issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "ğŸ¨ " + result.frontend.title,
                body: result.frontend.body + `\n\n---\n**Parent Issue:** #${context.issue.number}`,
                labels: ['frontend', 'sub-task']
              });

              // 3. åˆ›å»ºåç«¯å­ä»»åŠ¡ Issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "âš™ï¸ " + result.backend.title,
                body: result.backend.body + `\n\n---\n**Parent Issue:** #${context.issue.number}`,
                labels: ['backend', 'sub-task']
              });

            } catch (error) {
              console.error(error);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "âŒ **AI Architect Error:** æ–¹æ¡ˆç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ OpenRouter API é¢åº¦æˆ– Prompt é™åˆ¶ã€‚"
              });
            }
