name: AI Tech Architect

on:
  issues:
    types: [labeled]

jobs:
  tech-arch:
    if: github.event.label.name == 'ğŸ›  tech'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      issues: write
    
    steps:
      - name: "Robust Architecture Analysis"
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        uses: actions/github-script@v7
        with:
          script: |
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå…¨æ ˆæ¶æ„å¸ˆã€‚ç›´æ¥è¾“å‡º JSONï¼Œç¦æ­¢åŒ…å« Markdown ä»£ç å—æ ‡ç­¾ï¼ˆå¦‚ \`\`\`jsonï¼‰ã€‚
            æ ¼å¼è¦æ±‚ï¼š
            {
              "analysis": "Markdown æ ¼å¼çš„æ·±åº¦åˆ†æï¼ˆå«éœ€æ±‚è¾¹ç•Œã€æ•°æ®æµã€æŠ€æœ¯é€‰å‹å¯¹æ¯”ã€å®‰å…¨é£é™©ã€5ä¸ªè¿½é—®ï¼‰",
              "frontend": { "title": "å‰ç«¯: ${process.env.ISSUE_TITLE}", "body": "Next.js å®ç°ç»†èŠ‚" },
              "backend": { "title": "åç«¯: ${process.env.ISSUE_TITLE}", "body": "Go å®ç°ç»†èŠ‚" }
            }`;

            const userPrompt = `æ ‡é¢˜: ${process.env.ISSUE_TITLE}\næè¿°: ${process.env.ISSUE_BODY}`;

            try {
              const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model: "openai/gpt-5.1-codex", // é€Ÿåº¦å¿«ä¸”éµå¾ª JSON æ ¼å¼å¥½
                  messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                  ],
                  response_format: { type: "json_object" }
                })
              });

              const data = await response.json();
              let rawContent = data.choices[0].message.content;

              // --- å…³é”®ä¿®å¤ï¼šæ¸…æ´— Markdown ä»£ç å— ---
              const cleanJson = rawContent.replace(/```json/g, "").replace(/```/g, "").trim();
              
              const result = JSON.parse(cleanJson);
              console.log("è§£ææˆåŠŸ");

              // 1. åˆ›å»ºè¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "## ğŸ›  æ¶æ„æ·±åº¦è§£æ\n\n" + result.analysis
              });

              // 2. åˆ›å»ºå­ä»»åŠ¡
              for (const type of ['frontend', 'backend']) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: result[type].title,
                  body: result[type].body + `\n\n---\nRef: #${context.issue.number}`,
                  labels: [type, 'sub-task']
                });
              }

            } catch (error) {
              console.error("Content that failed to parse:", error);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "âŒ **è§£æå¤±è´¥**: AI è¿”å›äº†éæ ‡å‡†çš„ JSON æ ¼å¼ï¼Œè¯·é‡è¯•ã€‚"
              });
            }
