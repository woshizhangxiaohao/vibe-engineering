name: Vibe AI Engine (Fix ESM)

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened, synchronize]

jobs:
  ai-orchestrator:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install axios
        run: npm install axios

      - name: "Vibe Flow: Run AI"
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          EVENT_CONTEXT: ${{ github.event_name }}
        uses: actions/github-script@v7
        with:
          script: |
            // ä½¿ç”¨åŠ¨æ€å¯¼å…¥è§£å†³ ESM é—®é¢˜
            const axios = (await import('axios')).default;

            async function askAI(prompt) {
              const res = await axios.post('https://openrouter.ai/api/v1/chat/completions', {
                model: "anthropic/claude-3.5-sonnet",
                messages: [{ role: "user", content: prompt }]
              }, {
                headers: {
                  'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  'Content-Type': 'application/json'
                }
              });
              return res.data.choices[0].message.content;
            }

            if (process.env.EVENT_CONTEXT === 'issues') {
              const prompt = `ä½ æ˜¯ä¸€ä¸ªå…¨æ ˆä¸“å®¶ã€‚é’ˆå¯¹ä»¥ä¸‹éœ€æ±‚ï¼Œä¸º Go + Next.js å›¢é˜Ÿåˆ¶å®šæŠ€æœ¯æ–¹æ¡ˆï¼š
              æ ‡é¢˜: ${process.env.ISSUE_TITLE}
              æè¿°: ${process.env.ISSUE_BODY}
              è¯·ç»™å‡ºï¼šGo å…³é”® Struct å®šä¹‰ã€API å®šä¹‰ã€Next.js ç»„ä»¶å»ºè®®ã€‚
              è¯·éµå¾ª Vibe Kanban çš„ç®€æ´é£æ ¼ã€‚`;
              
              const response = await askAI(prompt);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "ğŸ¤– **Vibe AI æ¶æ„å»ºè®®:**\n\n" + response
              });
            }
