name: AI Tech Architect (shadcn + Go DB)

on:
  issues:
    types: [labeled]

jobs:
  tech-arch:
    if: github.event.label.name == 'ğŸ›  tech'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: "UI-First Analysis"
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        uses: actions/github-script@v7
        with:
          script: |
            const prompt = `ä½ æ˜¯ä¸€ä¸ªå…¨æ ˆä¸“å®¶ã€‚æŠ€æœ¯æ ˆï¼šNext.js (App Router) + shadcn/ui + Go + Databaseã€‚
            ç›®æ ‡ï¼šå°†éœ€æ±‚æ‹†è§£ä¸ºå…·ä½“çš„ UI ç»„ä»¶å»ºè®®å’Œåç«¯å®ç°ã€‚
            
            éœ€æ±‚: ${process.env.ISSUE_TITLE}
            æè¿°: ${process.env.ISSUE_BODY}

            è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

            [FRONTEND]
            ### ğŸ¨ å‰ç«¯å®ç° (shadcn/ui)
            - **é¡µé¢ç»“æ„**: (ä¾‹å¦‚: Header > Sidebar > ScrollArea)
            - **æ¨è shadcn ç»„ä»¶**: (åˆ—å‡ºå…·ä½“çš„ç»„ä»¶åï¼Œå¦‚ Button, Input, Data Table, Card)
            - **æ•°æ®è¯·æ±‚**: (æè¿°ä½¿ç”¨ Server Components è¿˜æ˜¯ Client-side fetch)
            - **ä¸»è¦ Props å®šä¹‰**: (å…³é”®ç»„ä»¶çš„è¾“å…¥è¾“å‡º)

            [BACKEND]
            ### âš™ï¸ åç«¯å®ç° (Go)
            - **æ•°æ®åº“è®¾è®¡**: (æ ¸å¿ƒè¡¨ç»“æ„ä¸ GORM Struct)
            - **API å®šä¹‰**: (REST è·¯å¾„ã€å…¥å‚ã€å“åº”ç»“æ„)
            - **é€»è¾‘å…³é”®ç‚¹**: (ä¸šåŠ¡é€»è¾‘ã€å¹‚ç­‰å¤„ç†æˆ–ç‰¹æ®Šç®—æ³•)

            [ANALYSIS]
            ### ğŸ›  æ–¹æ¡ˆåˆ†æ
            - **æ ¸å¿ƒé£é™©**: (2æ¡)
            - **ç¡®è®¤é¡¹**: (3æ¡å†…)`;

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: "openai/gpt-5.1-codex", 
                messages: [{ role: "user", content: prompt }],
                temperature: 0.1
              })
            });

            const data = await response.json();
            const text = data.choices[0].message.content;

            const parts = {
              fe: text.split('[FRONTEND]')[1]?.split('[BACKEND]')[0] || "å‰ç«¯è§£æå¤±è´¥",
              be: text.split('[BACKEND]')[1]?.split('[ANALYSIS]')[0] || "åç«¯è§£æå¤±è´¥",
              ana: text.split('[ANALYSIS]')[1] || "åˆ†æè§£æå¤±è´¥"
            };

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "## ğŸ’¡ æ–¹æ¡ˆå»ºè®®\n" + parts.ana
            });

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "frontend: " + process.env.ISSUE_TITLE,
              body: parts.fe.trim(),
              labels: ['frontend']
            });

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "backend: " + process.env.ISSUE_TITLE,
              body: parts.be.trim(),
              labels: ['backend']
            });
