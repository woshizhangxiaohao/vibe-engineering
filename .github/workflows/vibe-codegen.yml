name: Vibe Codegen Agent

on:
  issue_comment:
    types: [created]

jobs:
  codegen:
    if: contains(github.event.comment.body, '/codegen')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Codegen Script
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_CONTEXT: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        uses: actions/github-script@v7
        with:
          script: |
            const axios = (await import('axios')).default;
            
            // 1. è°ƒç”¨ AI è·å–å…·ä½“æ–‡ä»¶ä»£ç 
            const prompt = `ä½ æ˜¯ä¸€ä¸ªå…¨æ ˆå·¥ç¨‹å¸ˆã€‚åŸºäºä»¥ä¸‹éœ€æ±‚ï¼Œè¯·ç›´æ¥è¾“å‡ºéœ€è¦åˆ›å»ºçš„æ–‡ä»¶è·¯å¾„å’Œå®Œæ•´ä»£ç ã€‚
            éœ€æ±‚ï¼š${process.env.ISSUE_CONTEXT}
            æ ¼å¼è¦æ±‚ï¼šå¿…é¡»ä½¿ç”¨ JSON æ•°ç»„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š[{"path": "backend/models/pomo.go", "content": "..."}]
            æŠ€æœ¯æ ˆï¼šGo (GORM), Next.js (TS)`;

            const res = await axios.post('https://openrouter.ai/api/v1/chat/completions', {
              model: "anthropic/claude-3.5-sonnet",
              messages: [{ role: "user", content: prompt }],
              response_format: { type: "json_object" } // å¼ºåˆ¶ JSON è¾“å‡º
            }, {
              headers: { 'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}` }
            });

            const files = JSON.parse(res.data.choices[0].message.content).files;

            // 2. åˆ›å»ºæ–°åˆ†æ”¯
            const branchName = `ai-codegen-${context.issue.number}-${Date.now()}`;
            const baseRef = await github.rest.git.getRef({...context.repo, ref: 'heads/main'});
            await github.rest.git.createRef({
              ...context.repo,
              ref: `refs/heads/${branchName}`,
              sha: baseRef.data.object.sha
            });

            // 3. å†™å…¥æ–‡ä»¶å¹¶æäº¤ (é€ä¸ªæ–‡ä»¶æ“ä½œ)
            for (const file of files) {
              await github.rest.repos.createOrUpdateFileContents({
                ...context.repo,
                path: file.path,
                message: `feat: ai generated ${file.path}`,
                content: Buffer.from(file.content).toString('base64'),
                branch: branchName
              });
            }

            // 4. åˆ›å»º PR
            await github.rest.pulls.create({
              ...context.repo,
              title: `[AI Codegen] ä¸º Issue #${context.issue.number} ç”Ÿæˆä»£ç `,
              head: branchName,
              base: 'main',
              body: `ğŸ¤– AI å·²æ ¹æ®æ‚¨çš„æŒ‡ä»¤è‡ªåŠ¨ç”Ÿæˆä»£ç ã€‚è¯·æ£€æŸ¥å¹¶ Mergeã€‚`
            });
