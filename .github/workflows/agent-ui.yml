name: Vibe UI Agent

on:
  issue_comment:
    types: [created]

jobs:
  ui-agent:
    if: |
      contains(github.event.comment.body, '/agent-ui') ||
      contains(github.event.comment.body, '/agent ui')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Vibe UI Agent - Generate UI Spec
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        with:
          script: |
            async function runUIAgent() {
              const owner = context.repo.owner;
              const repo = context.repo.repo;
              const issue_number = context.issue.number;
              const commentBody = context.payload.comment.body || "";

              // æå–ç”¨æˆ·é¢å¤–æŒ‡ä»¤
              const userExtra = commentBody
                .replace(/\/agent-ui\b/i, "")
                .replace(/\/agent ui\b/i, "")
                .trim();

              const pmRaw = [
                "PRD TITLE:",
                process.env.ISSUE_TITLE || "",
                "",
                "PRD BODY:",
                process.env.ISSUE_BODY || ""
              ].join("\n");

              // ==================== Step 1: PM Compiler ====================
              console.log("Step 1: è¿è¡Œ PM Compilerï¼Œå°† PRD è½¬æ¢ä¸º AI å¯æ‰§è¡ŒæŒ‡ä»¤...");
              
              const pmPrompt = [
                "ä½ æ˜¯ä¸€ä¸ªã€éœ€æ±‚ç¼–è¯‘å™¨ï¼ˆPM Requirement Compilerï¼‰ã€‘ã€‚",
                "",
                "ä½ çš„èŒè´£ä¸æ˜¯ã€Œç†è§£éœ€æ±‚ã€ï¼Œè€Œæ˜¯å°†ã€äººç±» PM ç¼–å†™çš„éœ€æ±‚æ–‡æœ¬ã€‘è½¬æ¢ä¸ºã€AI å¯æ‰§è¡Œã€ä¸å¯æ­§ä¹‰çš„æŒ‡ä»¤åˆåŒã€‘ã€‚",
                "ä½ å¿…é¡»å‡è®¾åŸå§‹ PM æ–‡æ¡£å¯èƒ½ä¸å®Œæ•´ã€å¯èƒ½å­˜åœ¨æ­§ä¹‰ã€å¯èƒ½æ··åˆç›®æ ‡/æ–¹æ¡ˆ/å®ç°çŒœæµ‹ã€‚",
                "",
                "ä½ çš„ç›®æ ‡ï¼š",
                "- æ¶ˆé™¤æ­§ä¹‰",
                "- å†»ç»“äº‹å®",
                "- æ˜ç¡®ç¦æ­¢é¡¹",
                "- ç”Ÿæˆä¸€ä¸ªã€Œä¸‹æ¸¸ Agent ä¸éœ€è¦å†åšè®¾è®¡å†³ç­–ã€çš„æ‰§è¡Œ Prompt",
                "- ä¸å¾—æ–°å¢åŸéœ€æ±‚é‡Œä¸å­˜åœ¨çš„æ–°åŠŸèƒ½",
                "",
                "====================",
                "è¾“å…¥ï¼ˆPM åŸå§‹éœ€æ±‚ï¼‰",
                "====================",
                pmRaw,
                "",
                userExtra ? "====================\nç”¨æˆ·é¢å¤–æŒ‡ä»¤\n====================\n" + userExtra + "\n" : "",
                "====================",
                "å¼ºåˆ¶å¤„ç†æ­¥éª¤",
                "====================",
                "Step 1ï¼šæå–ã€äº§å“ç›®æ ‡ã€‘ï¼ˆä¸€å¥è¯ï¼Œä¸å«æ–¹æ¡ˆç»†èŠ‚ï¼‰",
                "Step 2ï¼šæå–ã€æ ¸å¿ƒç”¨æˆ·åŠ¨ä½œã€‘ï¼ˆç”¨æˆ·åšä»€ä¹ˆ â†’ ç³»ç»Ÿå¿…é¡»å‘ç”Ÿä»€ä¹ˆï¼‰",
                "Step 3ï¼šå†»ç»“ã€è¾“å…¥è§„åˆ™ã€‘ï¼ˆä½ç½®/å½¢å¼/æ•°é‡é™åˆ¶ï¼‰",
                "Step 4ï¼šå†»ç»“ã€è¾“å‡ºè§„åˆ™ã€‘ï¼ˆå½¢æ€/ä½ç½®/ç»“æ„/é¡ºåºçº¦æŸï¼‰",
                "Step 5ï¼šå†»ç»“ã€è§’è‰²èŒè´£ã€‘ï¼ˆLLM ç”ŸæˆèŒƒå›´ã€æ˜¯å¦å…è®¸ç³»ç»Ÿç»•è¿‡ LLMï¼‰",
                "Step 6ï¼šç”Ÿæˆã€ç¦æ­¢è¡Œä¸ºåˆ—è¡¨ã€‘ï¼ˆAI ç»å¯¹ä¸èƒ½åšçš„äº‹ï¼‰",
                "Step 7ï¼šç”Ÿæˆã€å¼‚å¸¸ä¸è¾¹ç•Œè§„åˆ™ã€‘ï¼ˆå¤±è´¥æ—¶ç”¨æˆ·å¯è§æç¤ºï¼‰",
                "Step 8ï¼šå¤„ç†ã€æ­§ä¹‰ã€‘ï¼ˆé€‰æ‹©ä¸€ç§æœ€ä¿å®ˆè§£é‡Šå¹¶è®°å½•ï¼Œä¸å¾—ä¿ç•™å¤šè§£ï¼‰",
                "",
                "====================",
                "è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼ï¼‰",
                "====================",
                "å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ç»“æ„è¾“å‡º JSONï¼Œä¸å¾—æ–°å¢æˆ–åˆ å‡å­—æ®µï¼š",
                "",
                "{",
                '  "product_goal": "äº§å“ç›®æ ‡ï¼ˆä¸€å¥è¯æ€»ç»“ç”¨æˆ·æƒ³è¦ä»€ä¹ˆï¼‰",',
                '  "page_type": "æ ¹æ®éœ€æ±‚è‡ªåŠ¨åˆ¤æ–­ï¼šnew_page æˆ– existing_page",',
                '  "operation_type": "æ ¹æ®éœ€æ±‚è‡ªåŠ¨åˆ¤æ–­ï¼šadd_feature / fix_bug / refactor / style_change / remove_feature",',
                '  "target_page": "æ ¹æ®éœ€æ±‚æ¨æ–­çš„ç›®æ ‡é¡µé¢è·¯å¾„",',
                '  "target_components": ["æ ¹æ®éœ€æ±‚æ¨æ–­å¯èƒ½æ¶‰åŠçš„ç»„ä»¶"],',
                '  "change_scope": "æ ¹æ®éœ€æ±‚æ¨æ–­çš„ä¿®æ”¹èŒƒå›´æè¿°",',
                '  "preserve_list": ["æ ¹æ®éœ€æ±‚æ¨æ–­éœ€è¦ä¿ç•™çš„ç°æœ‰åŠŸèƒ½"],',
                '  "user_actions": ["ç”¨æˆ·åŠ¨ä½œ1 â†’ ç³»ç»Ÿååº”", "ç”¨æˆ·åŠ¨ä½œ2 â†’ ç³»ç»Ÿååº”"],',
                '  "input_rules": ["è¾“å…¥è§„åˆ™1", "è¾“å…¥è§„åˆ™2"],',
                '  "output_rules": ["è¾“å‡ºè§„åˆ™1", "è¾“å‡ºè§„åˆ™2"],',
                '  "ui_facts": ["UIäº‹å®1", "UIäº‹å®2"],',
                '  "llm_responsibilities": ["LLMèŒè´£1", "LLMèŒè´£2"],',
                '  "forbidden_actions": ["ç¦æ­¢è¡Œä¸º1", "ç¦æ­¢è¡Œä¸º2"],',
                '  "edge_cases": ["å¼‚å¸¸å¤„ç†1", "å¼‚å¸¸å¤„ç†2"],',
                '  "disambiguation_notes": ["æ­§ä¹‰å¤„ç†è¯´æ˜1", "æ­§ä¹‰å¤„ç†è¯´æ˜2"]',
                "}",
                "",
                "ã€operation_type è‡ªåŠ¨åˆ¤æ–­æŒ‡å—ã€‘",
                "æ ¹æ®éœ€æ±‚æè¿°è‡ªåŠ¨æ¨æ–­æ“ä½œç±»å‹ï¼š",
                "",
                "**add_feature** - å…³é”®è¯ï¼šæ·»åŠ ã€æ–°å¢ã€å¢åŠ ã€å®ç°ã€åŠ å…¥ã€æ”¯æŒ",
                "  ä¾‹ï¼šã€Œåœ¨é¦–é¡µæ·»åŠ æœç´¢åŠŸèƒ½ã€ã€Œå¢åŠ ä¸€ä¸ªæäº¤æŒ‰é’®ã€ã€Œå®ç°ç”¨æˆ·ç™»å½•ã€",
                "",
                "**fix_bug** - å…³é”®è¯ï¼šä¿®å¤ã€ä¿®æ­£ã€è§£å†³ã€bugã€é—®é¢˜ã€é”™è¯¯ã€ä¸å·¥ä½œã€å¤±æ•ˆ",
                "  ä¾‹ï¼šã€Œä¿®å¤ç‚¹å‡»æ— ååº”çš„é—®é¢˜ã€ã€Œè§£å†³é¡µé¢ç™½å±ã€ã€ŒæŒ‰é’®ç‚¹å‡»æ²¡ååº”ã€",
                "",
                "**refactor** - å…³é”®è¯ï¼šé‡æ„ã€ä¼˜åŒ–ã€æ•´ç†ã€æ‹†åˆ†ã€åˆå¹¶ã€æ”¹è¿›ä»£ç ",
                "  ä¾‹ï¼šã€Œé‡æ„ç™»å½•æ¨¡å—ã€ã€Œä¼˜åŒ–ä»£ç ç»“æ„ã€ã€ŒæŠŠç»„ä»¶æ‹†åˆ†ã€",
                "",
                "**style_change** - å…³é”®è¯ï¼šæ ·å¼ã€é¢œè‰²ã€å­—ä½“ã€å¸ƒå±€ã€ç¾åŒ–ã€UIã€è®¾è®¡",
                "  ä¾‹ï¼šã€Œä¿®æ”¹æŒ‰é’®é¢œè‰²ã€ã€Œè°ƒæ•´é—´è·ã€ã€Œæ›´æ–°UIé£æ ¼ã€",
                "",
                "**remove_feature** - å…³é”®è¯ï¼šåˆ é™¤ã€ç§»é™¤ã€å»æ‰ã€å–æ¶ˆã€ç¦ç”¨",
                "  ä¾‹ï¼šã€Œåˆ é™¤ä¾§è¾¹æ ã€ã€Œç§»é™¤å¹¿å‘Šæ¨¡å—ã€ã€Œå»æ‰å¤šä½™çš„æŒ‰é’®ã€",
                "",
                "ã€page_type è‡ªåŠ¨åˆ¤æ–­æŒ‡å—ã€‘",
                "- å¦‚æœæåˆ°ã€Œæ–°é¡µé¢ã€ã€Œåˆ›å»ºé¡µé¢ã€ã€Œæ–°å»ºã€â†’ new_page",
                "- å¦‚æœæåˆ°ç°æœ‰åŠŸèƒ½ã€ä¿®æ”¹ã€ä¿®å¤ã€ä¼˜åŒ– â†’ existing_page",
                "- å¦‚æœä¸ç¡®å®šï¼Œé»˜è®¤ existing_pageï¼ˆæ›´å®‰å…¨ï¼‰",
                "",
                "ã€target_page å’Œ target_components æ¨æ–­ã€‘",
                "- æ ¹æ®éœ€æ±‚æè¿°æ¨æ–­å¯èƒ½æ¶‰åŠçš„æ–‡ä»¶",
                "- å¦‚æœæåˆ°ã€Œé¦–é¡µã€â†’ frontend/app/page.tsx",
                "- å¦‚æœæåˆ°æŸä¸ªç»„ä»¶å â†’ frontend/components/XxxComponent.tsx",
                "- å¦‚æœä¸ç¡®å®šï¼Œå¡«å†™åˆç†çš„çŒœæµ‹ï¼Œåç»­ä¼šæ ¡éªŒ",
                "",
                "ã€change_scope å’Œ preserve_list æ¨æ–­ã€‘",
                "- æ ¹æ®éœ€æ±‚è‡ªåŠ¨æ¨æ–­ä¿®æ”¹èŒƒå›´å’Œéœ€è¦ä¿ç•™çš„åŠŸèƒ½",
                "- ç”¨æˆ·ä¸ä¼šæ˜ç¡®è¯´è¿™äº›ï¼Œä½ éœ€è¦æ ¹æ®éœ€æ±‚å†…å®¹æ¨æ–­",
                "",
                "åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚",
                "",
                "ã€å…³é”®çº¦æŸã€‘",
                "- ç¦æ­¢å‘ç”¨æˆ·æé—®æˆ–è¯·æ±‚æ¾„æ¸…",
                "- é‡åˆ°æ­§ä¹‰æ—¶ï¼Œå¿…é¡»è‡ªè¡Œé€‰æ‹©æœ€ä¿å®ˆçš„è§£é‡Š",
                "- æ— è®ºéœ€æ±‚å¤šä¹ˆæ¨¡ç³Šï¼Œéƒ½å¿…é¡»è¾“å‡ºå®Œæ•´çš„ JSON ç»“æ„",
                "- åœ¨ disambiguation_notes ä¸­è®°å½•ä½ çš„è§£é‡Šå†³ç­–"
              ].join("\n");

              const pmRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": "Bearer " + process.env.OPENROUTER_API_KEY,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [{ role: "user", content: pmPrompt }],
                  temperature: 0.3
                })
              });

              if (!pmRes.ok) {
                const err = await pmRes.text();
                await github.rest.issues.createComment({
                  owner, repo, issue_number,
                  body: "âŒ **PM Compiler è¯·æ±‚å¤±è´¥**\n\nHTTP: " + pmRes.status + "\n\n```\n" + err.substring(0, 1500) + "\n```"
                });
                throw new Error("PM Compiler failed: " + pmRes.status);
              }

              const pmData = await pmRes.json();
              const pmRawContent = pmData?.choices?.[0]?.message?.content || "";
              
              // è§£æ PM Compiler è¾“å‡ºçš„ JSON
              let pmResult;
              try {
                let jsonStr = pmRawContent.trim();
                const jsonMatch = jsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (jsonMatch) {
                  jsonStr = jsonMatch[1].trim();
                } else {
                  const firstBrace = jsonStr.indexOf("{");
                  const lastBrace = jsonStr.lastIndexOf("}");
                  if (firstBrace !== -1 && lastBrace !== -1) {
                    jsonStr = jsonStr.substring(firstBrace, lastBrace + 1);
                  }
                }
                pmResult = JSON.parse(jsonStr);
                console.log("âœ… PM Compiler è¾“å‡ºè§£ææˆåŠŸ");
              } catch (e) {
                console.error("PM Compiler JSON è§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬");
                console.error("åŸå§‹å†…å®¹:", pmRawContent.substring(0, 500));
                
                // å¦‚æœæ¨¡å‹è¿”å›äº†è¯¢é—®è€Œä¸æ˜¯ JSONï¼Œç›´æ¥æŠ¥é”™
                if (pmRawContent.includes("è¯·ç¡®è®¤") || pmRawContent.includes("è¯·æ˜ç¡®") || pmRawContent.includes("è¯·å‘Šè¯‰æˆ‘")) {
                  await github.rest.issues.createComment({
                    owner, repo, issue_number,
                    body: [
                      "âš ï¸ **PM Compiler éœ€è¦æ›´æ˜ç¡®çš„éœ€æ±‚**",
                      "",
                      "æ¨¡å‹è®¤ä¸ºéœ€æ±‚å­˜åœ¨æ­§ä¹‰ï¼Œè¯·åœ¨ Issue ä¸­è¡¥å……ä»¥ä¸‹ä¿¡æ¯ï¼š",
                      "",
                      pmRawContent,
                      "",
                      "---",
                      "è¡¥å……ä¿¡æ¯åï¼Œå†æ¬¡æ‰§è¡Œ `/agent-ui`"
                    ].join("\n")
                  });
                  throw new Error("éœ€æ±‚å­˜åœ¨æ­§ä¹‰ï¼Œå·²è¯·æ±‚ç”¨æˆ·æ¾„æ¸…");
                }
                
                pmResult = { raw: pmRawContent };
              }

              // ==================== Step 1.5: è¯»å–ç°æœ‰é¡µé¢å†…å®¹ï¼ˆå¦‚æœæ˜¯ä¿®æ”¹é¡µé¢ï¼‰====================
              let existingPageContent = "";
              let existingPagePath = "";
              
              if (pmResult.page_type === "existing_page" && pmResult.target_page) {
                existingPagePath = pmResult.target_page;
                console.log("æ£€æµ‹åˆ°ä¿®æ”¹ç°æœ‰é¡µé¢ï¼Œæ­£åœ¨è¯»å–: " + existingPagePath);
                
                const fs = require('fs');
                const path = require('path');
                
                try {
                  // å°è¯•è¯»å–ç›®æ ‡é¡µé¢
                  const fullPath = path.join(process.cwd(), existingPagePath);
                  if (fs.existsSync(fullPath)) {
                    existingPageContent = fs.readFileSync(fullPath, 'utf-8');
                    console.log("âœ… æˆåŠŸè¯»å–ç°æœ‰é¡µé¢ï¼Œé•¿åº¦: " + existingPageContent.length + " å­—ç¬¦");
                  } else {
                    console.log("âš ï¸ ç›®æ ‡é¡µé¢ä¸å­˜åœ¨: " + fullPath);
                  }
                } catch (e) {
                  console.error("è¯»å–é¡µé¢å¤±è´¥:", e.message);
                }
                
                // åŒæ—¶è¯»å–ç›¸å…³ç»„ä»¶ï¼ˆå¦‚æœé¡µé¢ä¸­æœ‰ importï¼‰
                if (existingPageContent) {
                  const importMatches = existingPageContent.match(/from\s+['"]@\/components\/([^'"]+)['"]/g) || [];
                  const componentFiles = importMatches.map(m => {
                    const match = m.match(/from\s+['"]@\/components\/([^'"]+)['"]/);
                    return match ? "frontend/components/" + match[1] + (match[1].endsWith('.tsx') ? '' : '.tsx') : null;
                  }).filter(Boolean);
                  
                  for (const compFile of componentFiles.slice(0, 5)) { // æœ€å¤šè¯»å–5ä¸ªç»„ä»¶
                    try {
                      const compPath = path.join(process.cwd(), compFile);
                      if (fs.existsSync(compPath)) {
                        const compContent = fs.readFileSync(compPath, 'utf-8');
                        existingPageContent += "\n\n// ===== " + compFile + " =====\n" + compContent;
                        console.log("âœ… è¯»å–å…³è”ç»„ä»¶: " + compFile);
                      }
                    } catch (e) {
                      // å¿½ç•¥è¯»å–å¤±è´¥çš„ç»„ä»¶
                    }
                  }
                }
              }

              // ==================== Step 2: UI Spec Generator ====================
              console.log("Step 2: è¿è¡Œ UI Spec Generatorï¼Œç”Ÿæˆ Frozen UI Spec...");

              // æ ¼å¼åŒ– PM ç»“æœä¸º UI Agent å¯ç”¨çš„è¾“å…¥
              // æ“ä½œç±»å‹æ˜ å°„
              const operationTypeMap = {
                "add_feature": "ğŸ†• æ–°å¢åŠŸèƒ½ - åœ¨ç°æœ‰ä»£ç åŸºç¡€ä¸Šæ·»åŠ æ–°åŠŸèƒ½ï¼Œä¸ä¿®æ”¹ç°æœ‰é€»è¾‘",
                "fix_bug": "ğŸ› ä¿®å¤Bug - åªä¿®æ”¹æœ‰é—®é¢˜çš„ä»£ç ï¼Œå…¶ä»–ä¿æŒä¸å˜",
                "refactor": "ğŸ”§ é‡æ„ - ä¼˜åŒ–ä»£ç ç»“æ„ï¼ŒåŠŸèƒ½å¿…é¡»ä¿æŒå®Œå…¨ä¸€è‡´",
                "style_change": "ğŸ¨ æ ·å¼è°ƒæ•´ - åªä¿®æ”¹UI/æ ·å¼ï¼Œä¸æ”¹åŠ¨ä»»ä½•é€»è¾‘",
                "remove_feature": "ğŸ—‘ï¸ ç§»é™¤åŠŸèƒ½ - åˆ é™¤æŒ‡å®šåŠŸèƒ½ï¼Œå…¶ä»–ä¿æŒä¸å˜"
              };

              let compiledRequirement;
              if (pmResult.raw) {
                compiledRequirement = pmRawContent;
              } else {
                const opType = pmResult.operation_type || "add_feature";
                compiledRequirement = [
                  "## äº§å“ç›®æ ‡",
                  pmResult.product_goal || "æœªå®šä¹‰",
                  "",
                  "## é¡µé¢ç±»å‹",
                  pmResult.page_type === "new_page" ? "**æ–°é¡µé¢** - åˆ›å»ºå…¨æ–°é¡µé¢" : "**ç°æœ‰é¡µé¢** - ä¿®æ”¹ç°æœ‰é¡µé¢",
                  "",
                  "## âš¡ æ“ä½œç±»å‹",
                  operationTypeMap[opType] || opType,
                  "",
                  "## ç›®æ ‡é¡µé¢",
                  pmResult.target_page || "frontend/app/page.tsx",
                  "",
                  "## æ¶‰åŠçš„ç»„ä»¶",
                  (pmResult.target_components || []).map(c => "- " + c).join("\n") || "- å¾…åˆ†æ",
                  "",
                  "## ğŸ¯ ä¿®æ”¹èŒƒå›´ï¼ˆç²¾ç¡®ï¼‰",
                  pmResult.change_scope || "å¾…å®šä¹‰",
                  "",
                  "## ğŸ”’ å¿…é¡»ä¿ç•™çš„åŠŸèƒ½ï¼ˆä¸å¯ä¿®æ”¹ï¼‰",
                  (pmResult.preserve_list || []).map(p => "- âŒ ç¦æ­¢ä¿®æ”¹: " + p).join("\n") || "- æ‰€æœ‰ç°æœ‰åŠŸèƒ½",
                  "",
                  "## æ ¸å¿ƒç”¨æˆ·åŠ¨ä½œ",
                  (pmResult.user_actions || []).map((a, i) => (i + 1) + ". " + a).join("\n"),
                  "",
                  "## è¾“å…¥è§„åˆ™",
                  (pmResult.input_rules || []).map(r => "- " + r).join("\n"),
                  "",
                  "## è¾“å‡ºè§„åˆ™",
                  (pmResult.output_rules || []).map(r => "- " + r).join("\n"),
                  "",
                  "## UI äº‹å®",
                  (pmResult.ui_facts || []).map(f => "- " + f).join("\n"),
                  "",
                  "## LLM èŒè´£",
                  (pmResult.llm_responsibilities || []).map(r => "- " + r).join("\n"),
                  "",
                  "## ç¦æ­¢è¡Œä¸º",
                  (pmResult.forbidden_actions || []).map(f => "- " + f).join("\n"),
                  "",
                  "## å¼‚å¸¸ä¸è¾¹ç•Œ",
                  (pmResult.edge_cases || []).map(e => "- " + e).join("\n"),
                  "",
                  "## æ­§ä¹‰å¤„ç†è¯´æ˜",
                  (pmResult.disambiguation_notes || []).map(n => "- " + n).join("\n")
                ].join("\n");
              }

              // æ„å»ºç°æœ‰é¡µé¢ä¸Šä¸‹æ–‡
              let existingPageContext = "";
              const opType = pmResult.operation_type || "add_feature";
              
              if (existingPageContent) {
                existingPageContext = [
                  "",
                  "====================",
                  "ğŸš¨ ç°æœ‰ä»£ç ï¼ˆè¿™æ˜¯ä½ çš„ä¿®æ”¹åŸºå‡†ï¼Œå¿…é¡»å®Œæ•´ç†è§£ï¼‰",
                  "====================",
                  "",
                  "**æ“ä½œç±»å‹**: " + opType,
                  "",
                  "**ä½ å¿…é¡»åšåˆ°ï¼š**",
                  "1. å…ˆå®Œæ•´é˜…è¯»å¹¶ç†è§£ç°æœ‰ä»£ç çš„ç»“æ„å’ŒåŠŸèƒ½",
                  "2. è¯†åˆ«å‡ºç°æœ‰çš„ï¼šç»„ä»¶ã€å‡½æ•°ã€çŠ¶æ€ã€äº‹ä»¶å¤„ç†ã€ç”¨æˆ·äº¤äº’æµç¨‹",
                  "3. ç†è§£æ¯ä¸ªç°æœ‰åŠŸèƒ½çš„ä½œç”¨ï¼Œç¡®ä¿ä¿®æ”¹åå®ƒä»¬ä»ç„¶æ­£å¸¸å·¥ä½œ",
                  "4. åœ¨è§„æ ¼ä¸­è¯´æ˜ä¿®æ”¹ç‚¹ï¼Œä»¥åŠå¦‚ä½•ç¡®ä¿ä¸ç ´åç°æœ‰åŠŸèƒ½",
                  "5. **ä¿®æ”¹åï¼Œæ‰€æœ‰ç°æœ‰åŠŸèƒ½å¿…é¡»100%æ­£å¸¸å·¥ä½œ**",
                  "",
                  "**æ ¸å¿ƒåŸåˆ™ï¼šå¯ä»¥ä¿®æ”¹ä»£ç ï¼Œä½†ä¸èƒ½ç ´ååŠŸèƒ½**",
                  "- âœ… å¯ä»¥ä¿®æ”¹ç°æœ‰ç»„ä»¶æ¥æ·»åŠ æ–°åŠŸèƒ½",
                  "- âœ… å¯ä»¥ä¿®æ”¹ç°æœ‰å‡½æ•°æ¥ä¿®å¤bugæˆ–å¢å¼ºåŠŸèƒ½",
                  "- âœ… å¯ä»¥è°ƒæ•´å¸ƒå±€æ¥å®¹çº³æ–°å…ƒç´ ",
                  "- âŒ ä¸èƒ½è®©ç°æœ‰çš„ç”¨æˆ·äº¤äº’æµç¨‹å¤±æ•ˆ",
                  "- âŒ ä¸èƒ½è®©ç°æœ‰çš„æ•°æ®å¤„ç†é€»è¾‘å‡ºé”™",
                  "- âŒ ä¸èƒ½åˆ é™¤ç”¨æˆ·å·²ç»ä¾èµ–çš„åŠŸèƒ½",
                  "",
                  "```tsx",
                  existingPageContent.substring(0, 10000), // é™åˆ¶é•¿åº¦é¿å… token è¶…é™
                  existingPageContent.length > 10000 ? "\n// ... ä»£ç è¿‡é•¿å·²æˆªæ–­ ..." : "",
                  "```",
                  ""
                ].join("\n");
              }

              const opTypeWarning = {
                "add_feature": "ğŸ†• è¿™æ˜¯ã€æ–°å¢åŠŸèƒ½ã€‘æ“ä½œ - å¯ä»¥ä¿®æ”¹ç°æœ‰ä»£ç æ¥é›†æˆæ–°åŠŸèƒ½ï¼Œä½†ç°æœ‰åŠŸèƒ½å¿…é¡»ä¿æŒæ­£å¸¸",
                "fix_bug": "ğŸ› è¿™æ˜¯ã€ä¿®å¤Bugã€‘æ“ä½œ - ä¿®å¤æœ‰é—®é¢˜çš„ä»£ç ï¼Œç¡®ä¿ä¸å¼•å…¥æ–°é—®é¢˜",
                "refactor": "ğŸ”§ è¿™æ˜¯ã€é‡æ„ã€‘æ“ä½œ - ä¼˜åŒ–ä»£ç ç»“æ„ï¼Œæ‰€æœ‰åŠŸèƒ½å¿…é¡»ä¿æŒå®Œå…¨ä¸€è‡´",
                "style_change": "ğŸ¨ è¿™æ˜¯ã€æ ·å¼ä¿®æ”¹ã€‘æ“ä½œ - åªä¿®æ”¹è§†è§‰è¡¨ç°ï¼Œä¸æ”¹å˜åŠŸèƒ½è¡Œä¸º",
                "remove_feature": "ğŸ—‘ï¸ è¿™æ˜¯ã€ç§»é™¤åŠŸèƒ½ã€‘æ“ä½œ - åˆ é™¤æŒ‡å®šåŠŸèƒ½ï¼Œå…¶ä»–åŠŸèƒ½ä¿æŒæ­£å¸¸"
              };

              const uiPrompt = [
                "ä½ æ˜¯å‰ç«¯å·¥ç¨‹è§„æ ¼ç”Ÿæˆå™¨ã€‚",
                "",
                "å°†éœ€æ±‚è½¬æ¢ä¸ºã€å¯ç›´æ¥ç¼–ç çš„å·¥ç¨‹è§„æ ¼ã€‘ï¼Œå‰ç«¯ Agent ä¼šæ ¹æ®è¿™ä¸ªè§„æ ¼ç”Ÿæˆä»£ç ã€‚",
                existingPageContent ? "\nğŸš¨ **è­¦å‘Šï¼šè¿™æ˜¯å¯¹ç°æœ‰ä»£ç çš„ä¿®æ”¹ï¼**\n\n" + (opTypeWarning[opType] || "") + "\n\n**ä»»ä½•ç ´åç°æœ‰åŠŸèƒ½çš„è§„æ ¼éƒ½æ˜¯å¤±è´¥çš„è§„æ ¼ï¼**\n" : "",
                "====================",
                "å¯ç”¨çš„ shadcn/ui ç»„ä»¶åº“",
                "====================",
                "é¡¹ç›®å·²é›†æˆ shadcn/uiï¼Œå¿…é¡»ä¼˜å…ˆä½¿ç”¨ä»¥ä¸‹ç°æœ‰ç»„ä»¶ï¼Œä¸è¦é‡å¤é€ è½®å­ï¼š",
                "",
                "**å¸ƒå±€ç±»**: Card, Accordion, Collapsible, Tabs, Separator, Resizable, ScrollArea, AspectRatio",
                "**è¡¨å•ç±»**: Button, Input, Textarea, Checkbox, RadioGroup, Select, Switch, Slider, Form, Field, Label, InputOTP, InputGroup",
                "**åé¦ˆç±»**: Alert, AlertDialog, Dialog, Drawer, Sheet, Popover, HoverCard, Tooltip, Sonner(toast), Progress, Skeleton, Spinner, Empty",
                "**å¯¼èˆªç±»**: Breadcrumb, NavigationMenu, Menubar, DropdownMenu, ContextMenu, Command, Pagination, Sidebar",
                "**æ•°æ®å±•ç¤ºç±»**: Avatar, Badge, Table, Calendar, Carousel, Chart, Kbd",
                "**äº¤äº’ç±»**: Toggle, ToggleGroup, ButtonGroup",
                "",
                "å¯¼å…¥æ–¹å¼: import { ComponentName } from '@/components/ui/component-name'",
                "",
                "====================",
                "éœ€æ±‚",
                "====================",
                compiledRequirement,
                existingPageContext,
                "",
                "====================",
                "è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼éµå¾ªï¼Œä¸è¦æ·»åŠ å…¶ä»–ç« èŠ‚ï¼‰",
                "====================",
                "",
                "## æ“ä½œç±»å‹",
                "æ˜ç¡®æŒ‡å®šæ“ä½œç±»å‹ï¼š",
                "- NEW_PAGE: åˆ›å»ºå…¨æ–°é¡µé¢",
                "- ADD_FEATURE: åœ¨ç°æœ‰é¡µé¢æ–°å¢åŠŸèƒ½",
                "- FIX_BUG: ä¿®å¤ç°æœ‰ä»£ç çš„é—®é¢˜",
                "- REFACTOR: é‡æ„ä»£ç ï¼ŒåŠŸèƒ½ä¸å˜",
                "- STYLE_CHANGE: åªä¿®æ”¹æ ·å¼",
                "- REMOVE_FEATURE: åˆ é™¤æŒ‡å®šåŠŸèƒ½",
                "",
                "## ç›®æ ‡é¡µé¢/ç»„ä»¶",
                "- ä¸»è¦æ–‡ä»¶è·¯å¾„ï¼šfrontend/app/xxx/page.tsx",
                "- æ¶‰åŠçš„ç»„ä»¶æ–‡ä»¶ï¼šfrontend/components/xxx.tsx",
                "",
                "## ğŸ”’ ç°æœ‰ä»£ç åˆ†æï¼ˆä¿®æ”¹ç°æœ‰ä»£ç æ—¶å¿…å¡«ï¼‰",
                "**å¿…é¡»é€ä¸€åˆ—å‡ºç°æœ‰ä»£ç çš„ç»“æ„ï¼š**",
                "",
                "### ç°æœ‰ç»„ä»¶æ¸…å•",
                "| ç»„ä»¶å | æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½ | æ˜¯å¦ä¿®æ”¹ |",
                "|--------|----------|------|----------|",
                "| Header | components/Header.tsx | é¡¶éƒ¨å¯¼èˆª | âŒ ä¿æŒä¸å˜ |",
                "| ContentCard | components/ContentCard.tsx | å†…å®¹å¡ç‰‡ | âš ï¸ éœ€ä¿®æ”¹ |",
                "",
                "### ç°æœ‰åŠŸèƒ½æ¸…å•",
                "| åŠŸèƒ½ | ä½ç½® | çŠ¶æ€ |",
                "|------|------|------|",
                "| URLè¾“å…¥ | UrlInputBar | âŒ ä¿æŒä¸å˜ |",
                "| å†…å®¹è§£æ | AppContainer.handleParse | âŒ ä¿æŒä¸å˜ |",
                "| ç»“æœå±•ç¤º | ResultFeed | âš ï¸ éœ€ä¿®æ”¹ |",
                "",
                "### ç°æœ‰å¸ƒå±€ç»“æ„",
                "```",
                "ç°æœ‰çš„ JSX ç»“æ„ï¼Œæ ‡æ³¨å“ªäº›ä¿æŒä¸å˜ï¼Œå“ªäº›éœ€è¦ä¿®æ”¹",
                "```",
                "",
                "## ğŸ¯ ç²¾ç¡®ä¿®æ”¹ç‚¹",
                "**åªåˆ—å‡ºéœ€è¦ä¿®æ”¹çš„å…·ä½“ä½ç½®å’Œå†…å®¹ï¼š**",
                "1. æ–‡ä»¶: xxx.tsx, å‡½æ•°: handleXxx, ä¿®æ”¹: æ·»åŠ xxxé€»è¾‘",
                "2. æ–‡ä»¶: yyy.tsx, ä½ç½®: returnè¯­å¥, ä¿®æ”¹: åœ¨xxxåé¢æ·»åŠ yyyç»„ä»¶",
                "",
                "## shadcn/ui ç»„ä»¶ä½¿ç”¨",
                "åˆ—å‡ºéœ€è¦ä½¿ç”¨çš„ shadcn/ui ç»„ä»¶åŠç”¨é€”",
                "",
                "## æ–°å¢ç»„ä»¶æ¸…å•ï¼ˆä»…æ–°å¢çš„ï¼‰",
                "æ¯ä¸ªã€æ–°ç»„ä»¶ã€‘ç”¨ä»¥ä¸‹æ ¼å¼ï¼š",
                "",
                "### NewComponentName",
                "- æ–‡ä»¶: frontend/components/xxx.tsx",
                "- åŠŸèƒ½: ä¸€å¥è¯æè¿°",
                "- ä½¿ç”¨çš„ shadcn/ui ç»„ä»¶: Button, Card ç­‰",
                "- Props/State/äº‹ä»¶/API",
                "",
                "## ä¿®æ”¹åçš„é¡µé¢ç»„è£…",
                "```",
                "// æ ‡æ³¨ï¼š[ä¿æŒ] è¡¨ç¤ºä¸å˜ï¼Œ[æ–°å¢] è¡¨ç¤ºæ–°åŠ ï¼Œ[ä¿®æ”¹] è¡¨ç¤ºæœ‰å˜åŒ–",
                "<MainLayout>           // [ä¿æŒ]",
                "  <Header />           // [ä¿æŒ]",
                "  <NewComponent />     // [æ–°å¢]",
                "  <ContentArea />      // [ä¿®æ”¹] - æ·»åŠ äº†xxx",
                "</MainLayout>",
                "```",
                "",
                "## çº¦æŸ",
                "- âœ… å¿…é¡»å®ç°çš„åŠŸèƒ½ç‚¹",
                "- âŒ ç¦æ­¢ä¿®æ”¹çš„ç°æœ‰åŠŸèƒ½",
                "- âš ï¸ éœ€è¦æ³¨æ„çš„è¾¹ç•Œæƒ…å†µ",
                "",
                "====================",
                "è§„åˆ™",
                "====================",
                "- åªè¾“å‡ºå·¥ç¨‹è§„æ ¼ï¼Œä¸è¦å†™ä»£ç ",
                "- **å¿…é¡»ä¼˜å…ˆä½¿ç”¨ shadcn/ui ç»„ä»¶**",
                "- è¾“å‡ºçš„è§„æ ¼å¿…é¡»è¶³å¤Ÿå…·ä½“ï¼Œè®©ä»£ç  Agent æ— éœ€å†åšå†³ç­–",
                "",
                "**ã€ä¿®æ”¹ç°æœ‰ä»£ç çš„æ ¸å¿ƒåŸåˆ™ã€‘**",
                "",
                "**å¯ä»¥ä¿®æ”¹ä»£ç ï¼Œä½†å¿…é¡»ä¿æŠ¤åŠŸèƒ½ï¼š**",
                "",
                "1. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šä¿®æ”¹åï¼Œæ‰€æœ‰ç°æœ‰åŠŸèƒ½å¿…é¡»100%æ­£å¸¸å·¥ä½œ",
                "2. **ç†è§£å†æ”¹**ï¼šå…ˆç†è§£ç°æœ‰ä»£ç çš„é€»è¾‘ï¼Œå†è¿›è¡Œä¿®æ”¹",
                "3. **ç²¾ç¡®å®šä½**ï¼šæŒ‡å‡ºå…·ä½“çš„ä¿®æ”¹ä½ç½®ï¼ˆæ–‡ä»¶ã€å‡½æ•°ã€å¤§è‡´ä½ç½®ï¼‰",
                "4. **å½±å“åˆ†æ**ï¼šè¯´æ˜ä¿®æ”¹å¯èƒ½å½±å“å“ªäº›ç°æœ‰åŠŸèƒ½ï¼Œä»¥åŠå¦‚ä½•ç¡®ä¿å®ƒä»¬æ­£å¸¸",
                "5. **é£æ ¼ä¸€è‡´**ï¼šæ–°ä»£ç ä¸ç°æœ‰ä»£ç ä½¿ç”¨ç›¸åŒçš„æ¨¡å¼å’Œé£æ ¼",
                "6. **æµ‹è¯•è¦ç‚¹**ï¼šåˆ—å‡ºä¿®æ”¹åéœ€è¦éªŒè¯çš„ç°æœ‰åŠŸèƒ½",
                "",
                "**ã€ä¸åŒæ“ä½œç±»å‹çš„è§„åˆ™ã€‘**",
                "",
                "- **ADD_FEATURE**: å¯ä»¥ä¿®æ”¹ç°æœ‰ç»„ä»¶æ¥é›†æˆæ–°åŠŸèƒ½ï¼Œç¡®ä¿åŸæœ‰äº¤äº’ä¸å—å½±å“",
                "- **FIX_BUG**: å®šä½é—®é¢˜åŸå› ï¼Œä¿®å¤æ—¶ä¸å¼•å…¥æ–°é—®é¢˜",
                "- **REFACTOR**: é‡æ„ååŠŸèƒ½å¿…é¡»å®Œå…¨ä¸€è‡´ï¼Œå¯é€šè¿‡ç›¸åŒçš„ç”¨æˆ·æ“ä½œéªŒè¯",
                "- **STYLE_CHANGE**: ä¿®æ”¹è§†è§‰è¡¨ç°ï¼Œäº¤äº’è¡Œä¸ºä¿æŒä¸å˜",
                "- **REMOVE_FEATURE**: æ˜ç¡®åˆ é™¤èŒƒå›´ï¼Œç¡®ä¿å…¶ä»–åŠŸèƒ½ä¸å—å½±å“"
              ].join("\n");

              const uiRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": "Bearer " + process.env.OPENROUTER_API_KEY,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [{ role: "user", content: uiPrompt }],
                  temperature: 0.5
                })
              });

              if (!uiRes.ok) {
                const err = await uiRes.text();
                await github.rest.issues.createComment({
                  owner, repo, issue_number,
                  body: "âŒ **UI Spec Generator è¯·æ±‚å¤±è´¥**\n\nHTTP: " + uiRes.status + "\n\n```\n" + err.substring(0, 1500) + "\n```"
                });
                throw new Error("UI Spec Generator failed: " + uiRes.status);
              }

              const uiData = await uiRes.json();
              const uiSpec = uiData?.choices?.[0]?.message?.content || "";

              if (!uiSpec.trim()) {
                await github.rest.issues.createComment({
                  owner, repo, issue_number,
                  body: "âŒ **UI Spec Generator è¿”å›ä¸ºç©º**\n\næ¨¡å‹æ²¡æœ‰è¿”å›æœ‰æ•ˆå†…å®¹ï¼Œè¯·é‡è¯•ã€‚"
                });
                throw new Error("UI Spec Generator returned empty content.");
              }

              // ==================== Step 3: Post Result ====================
              await github.rest.issues.createComment({
                owner, repo, issue_number,
                body: [
                  "ğŸ”§ **å·¥ç¨‹è§„æ ¼ (Engineering Spec)**",
                  "",
                  "---",
                  "",
                  "## éœ€æ±‚æ‘˜è¦",
                  "",
                  compiledRequirement,
                  "",
                  "---",
                  "",
                  "## å·¥ç¨‹è§„æ ¼",
                  "",
                  uiSpec.trim(),
                  "",
                  "---",
                  "",
                  "**ä¸‹ä¸€æ­¥:**",
                  "å¤åˆ¶æ­¤è¯„è®º URLï¼Œæ‰§è¡Œ `/agent-fe <URL>` ç”Ÿæˆä»£ç "
                ].join("\n")
              });

              console.log("âœ… UI Agent å®Œæˆ");
            }

            await runUIAgent();
