name: Vibe UI Agent

on:
  issue_comment:
    types: [created]

jobs:
  ui-agent:
    if: |
      contains(github.event.comment.body, '/agent-ui') ||
      contains(github.event.comment.body, '/agent ui')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Vibe UI Agent - Generate UI Spec
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        with:
          script: |
            async function runUIAgent() {
              const prompt = `
                You are the Product UI Architect Agent for this repository.
                
                Your mission is to transform a PRD into a production-ready UI and interaction specification
                that frontend engineers or agents can implement WITHOUT further design decisions.
                
                ====================
                PRD TITLE:
                ${process.env.ISSUE_TITLE}
                
                PRD BODY:
                ${process.env.ISSUE_BODY}
                ====================
                
                You must work in the following order:
                1. Extract interaction philosophy from the PRD.
                2. Define interaction style and behavioral constraints.
                3. Translate them into an engineering-ready UI specification.
                4. Produce a strict UI freeze contract to guarantee implementability.
                
                --------------------
                OUTPUT FORMAT (STRICT)
                --------------------
                
                ## Interaction Philosophy
                
                ## Interaction Style & Preferences
                
                ## Page Layout
                - Tree structure only
                
                ## Components
                For each component:
                - Responsibility
                - Interaction
                - States
                
                ## Interaction Flow
                - Linear numbered steps
                - User action â†’ system reaction
                
                ## UI States
                - Enumerated finite states only
                
                ## UI Freeze Contract
                
                ## Visual Design System
                - Color palette and semantic color usage
                - Typography system
                - Spacing scale
                - Border radius and shadows
                - Component styling guidelines
                
                --------------------
                VISUAL DESIGN SPECIFICATION (REQUIRED)
                --------------------
                You MUST include visual design specifications:
                
                ## Visual Design System
                - Color palette: Specify primary, secondary, accent colors using semantic names (e.g., primary, secondary, accent, destructive)
                - Typography: Font families, sizes, weights, line heights
                - Spacing: Consistent spacing scale (e.g., 4px, 8px, 16px, 24px, 32px)
                - Border radius: Rounded corners specification (e.g., sm, md, lg)
                - Shadows: Elevation and depth using shadows
                - Layout: Grid system, container widths, responsive breakpoints
                
                ## Component Styling Guidelines
                For each component, specify:
                - Visual appearance (colors, borders, backgrounds)
                - Size variants (if applicable)
                - State styling (hover, active, disabled, focus)
                - Spacing and padding
                - Border radius and shadows
                
                --------------------
                RULES (NON-NEGOTIABLE)
                --------------------
                - Do NOT write code
                - DO specify visual styles and aesthetics (colors, spacing, typography, shadows, etc.)
                - Do NOT design backend APIs or data models
                - Use objective, measurable design specifications
                - Do NOT add extra sections beyond the required format
                `;

              const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [{ role: "user", content: prompt }],
                  temperature: 0.6
                })
              });

              const data = await res.json();
              if (!data.choices || !data.choices[0]) {
                throw new Error("UI Agent returned invalid response");
              }

              const uiSpec = data.choices[0].message.content;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: [
                  "ðŸ§© UI Agent Output (Frozen UI Spec)",
                  "",
                  uiSpec,
                  "",
                  "---",
                  "",
                  "UI Freeze Notice:",
                  "- Interaction philosophy is frozen for this Issue",
                  "- Layout hierarchy is frozen",
                  "- Frontend Agent may only bind data and manage state",
                  "- Backend Agent must not assume UI changes"
                ].join("\n")
              });
            }

            await runUIAgent();
