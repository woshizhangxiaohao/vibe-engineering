name: Vibe UI Agent

on:
  issue_comment:
    types: [created]

jobs:
  ui-agent:
    if: |
      contains(github.event.comment.body, '/agent-ui') ||
      contains(github.event.comment.body, '/agent ui')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Vibe UI Agent - Generate UI Spec
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        with:
          script: |
            async function runUIAgent() {
              const owner = context.repo.owner;
              const repo = context.repo.repo;
              const issue_number = context.issue.number;
              const commentBody = context.payload.comment.body || "";

              // æå–ç”¨æˆ·é¢å¤–æŒ‡ä»¤
              const userExtra = commentBody
                .replace(/\/agent-ui\b/i, "")
                .replace(/\/agent ui\b/i, "")
                .trim();

              const pmRaw = [
                "PRD TITLE:",
                process.env.ISSUE_TITLE || "",
                "",
                "PRD BODY:",
                process.env.ISSUE_BODY || ""
              ].join("\n");

              // ==================== Step 1: PM Compiler ====================
              console.log("Step 1: è¿è¡Œ PM Compilerï¼Œå°† PRD è½¬æ¢ä¸º AI å¯æ‰§è¡ŒæŒ‡ä»¤...");
              
              const pmPrompt = [
                "ä½ æ˜¯ä¸€ä¸ªã€éœ€æ±‚ç¼–è¯‘å™¨ï¼ˆPM Requirement Compilerï¼‰ã€‘ã€‚",
                "",
                "ä½ çš„èŒè´£ä¸æ˜¯ã€Œç†è§£éœ€æ±‚ã€ï¼Œè€Œæ˜¯å°†ã€äººç±» PM ç¼–å†™çš„éœ€æ±‚æ–‡æœ¬ã€‘è½¬æ¢ä¸ºã€AI å¯æ‰§è¡Œã€ä¸å¯æ­§ä¹‰çš„æŒ‡ä»¤åˆåŒã€‘ã€‚",
                "ä½ å¿…é¡»å‡è®¾åŸå§‹ PM æ–‡æ¡£å¯èƒ½ä¸å®Œæ•´ã€å¯èƒ½å­˜åœ¨æ­§ä¹‰ã€å¯èƒ½æ··åˆç›®æ ‡/æ–¹æ¡ˆ/å®ç°çŒœæµ‹ã€‚",
                "",
                "ä½ çš„ç›®æ ‡ï¼š",
                "- æ¶ˆé™¤æ­§ä¹‰",
                "- å†»ç»“äº‹å®",
                "- æ˜ç¡®ç¦æ­¢é¡¹",
                "- ç”Ÿæˆä¸€ä¸ªã€Œä¸‹æ¸¸ Agent ä¸éœ€è¦å†åšè®¾è®¡å†³ç­–ã€çš„æ‰§è¡Œ Prompt",
                "- ä¸å¾—æ–°å¢åŸéœ€æ±‚é‡Œä¸å­˜åœ¨çš„æ–°åŠŸèƒ½",
                "",
                "====================",
                "è¾“å…¥ï¼ˆPM åŸå§‹éœ€æ±‚ï¼‰",
                "====================",
                pmRaw,
                "",
                userExtra ? "====================\nç”¨æˆ·é¢å¤–æŒ‡ä»¤\n====================\n" + userExtra + "\n" : "",
                "====================",
                "å¼ºåˆ¶å¤„ç†æ­¥éª¤",
                "====================",
                "Step 1ï¼šæå–ã€äº§å“ç›®æ ‡ã€‘ï¼ˆä¸€å¥è¯ï¼Œä¸å«æ–¹æ¡ˆç»†èŠ‚ï¼‰",
                "Step 2ï¼šæå–ã€æ ¸å¿ƒç”¨æˆ·åŠ¨ä½œã€‘ï¼ˆç”¨æˆ·åšä»€ä¹ˆ â†’ ç³»ç»Ÿå¿…é¡»å‘ç”Ÿä»€ä¹ˆï¼‰",
                "Step 3ï¼šå†»ç»“ã€è¾“å…¥è§„åˆ™ã€‘ï¼ˆä½ç½®/å½¢å¼/æ•°é‡é™åˆ¶ï¼‰",
                "Step 4ï¼šå†»ç»“ã€è¾“å‡ºè§„åˆ™ã€‘ï¼ˆå½¢æ€/ä½ç½®/ç»“æ„/é¡ºåºçº¦æŸï¼‰",
                "Step 5ï¼šå†»ç»“ã€è§’è‰²èŒè´£ã€‘ï¼ˆLLM ç”ŸæˆèŒƒå›´ã€æ˜¯å¦å…è®¸ç³»ç»Ÿç»•è¿‡ LLMï¼‰",
                "Step 6ï¼šç”Ÿæˆã€ç¦æ­¢è¡Œä¸ºåˆ—è¡¨ã€‘ï¼ˆAI ç»å¯¹ä¸èƒ½åšçš„äº‹ï¼‰",
                "Step 7ï¼šç”Ÿæˆã€å¼‚å¸¸ä¸è¾¹ç•Œè§„åˆ™ã€‘ï¼ˆå¤±è´¥æ—¶ç”¨æˆ·å¯è§æç¤ºï¼‰",
                "Step 8ï¼šå¤„ç†ã€æ­§ä¹‰ã€‘ï¼ˆé€‰æ‹©ä¸€ç§æœ€ä¿å®ˆè§£é‡Šå¹¶è®°å½•ï¼Œä¸å¾—ä¿ç•™å¤šè§£ï¼‰",
                "",
                "====================",
                "è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼ï¼‰",
                "====================",
                "å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ç»“æ„è¾“å‡º JSONï¼Œä¸å¾—æ–°å¢æˆ–åˆ å‡å­—æ®µï¼š",
                "",
                "{",
                '  "product_goal": "äº§å“ç›®æ ‡ï¼ˆä¸€å¥è¯ï¼‰",',
                '  "user_actions": ["ç”¨æˆ·åŠ¨ä½œ1 â†’ ç³»ç»Ÿååº”", "ç”¨æˆ·åŠ¨ä½œ2 â†’ ç³»ç»Ÿååº”"],',
                '  "input_rules": ["è¾“å…¥è§„åˆ™1", "è¾“å…¥è§„åˆ™2"],',
                '  "output_rules": ["è¾“å‡ºè§„åˆ™1", "è¾“å‡ºè§„åˆ™2"],',
                '  "ui_facts": ["UIäº‹å®1", "UIäº‹å®2"],',
                '  "llm_responsibilities": ["LLMèŒè´£1", "LLMèŒè´£2"],',
                '  "forbidden_actions": ["ç¦æ­¢è¡Œä¸º1", "ç¦æ­¢è¡Œä¸º2"],',
                '  "edge_cases": ["å¼‚å¸¸å¤„ç†1", "å¼‚å¸¸å¤„ç†2"],',
                '  "disambiguation_notes": ["æ­§ä¹‰å¤„ç†è¯´æ˜1", "æ­§ä¹‰å¤„ç†è¯´æ˜2"]',
                "}",
                "",
                "åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚"
              ].join("\n");

              const pmRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": "Bearer " + process.env.OPENROUTER_API_KEY,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-2.5-flash-preview",
                  messages: [{ role: "user", content: pmPrompt }],
                  temperature: 0.3
                })
              });

              if (!pmRes.ok) {
                const err = await pmRes.text();
                await github.rest.issues.createComment({
                  owner, repo, issue_number,
                  body: "âŒ **PM Compiler è¯·æ±‚å¤±è´¥**\n\nHTTP: " + pmRes.status + "\n\n```\n" + err.substring(0, 1500) + "\n```"
                });
                throw new Error("PM Compiler failed: " + pmRes.status);
              }

              const pmData = await pmRes.json();
              const pmRawContent = pmData?.choices?.[0]?.message?.content || "";
              
              // è§£æ PM Compiler è¾“å‡ºçš„ JSON
              let pmResult;
              try {
                let jsonStr = pmRawContent.trim();
                const jsonMatch = jsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (jsonMatch) {
                  jsonStr = jsonMatch[1].trim();
                } else {
                  const firstBrace = jsonStr.indexOf("{");
                  const lastBrace = jsonStr.lastIndexOf("}");
                  if (firstBrace !== -1 && lastBrace !== -1) {
                    jsonStr = jsonStr.substring(firstBrace, lastBrace + 1);
                  }
                }
                pmResult = JSON.parse(jsonStr);
                console.log("âœ… PM Compiler è¾“å‡ºè§£ææˆåŠŸ");
              } catch (e) {
                console.error("PM Compiler JSON è§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬");
                pmResult = { raw: pmRawContent };
              }

              // ==================== Step 2: UI Spec Generator ====================
              console.log("Step 2: è¿è¡Œ UI Spec Generatorï¼Œç”Ÿæˆ Frozen UI Spec...");

              // æ ¼å¼åŒ– PM ç»“æœä¸º UI Agent å¯ç”¨çš„è¾“å…¥
              let compiledRequirement;
              if (pmResult.raw) {
                compiledRequirement = pmRawContent;
              } else {
                compiledRequirement = [
                  "## äº§å“ç›®æ ‡",
                  pmResult.product_goal || "æœªå®šä¹‰",
                  "",
                  "## æ ¸å¿ƒç”¨æˆ·åŠ¨ä½œ",
                  (pmResult.user_actions || []).map((a, i) => (i + 1) + ". " + a).join("\n"),
                  "",
                  "## è¾“å…¥è§„åˆ™",
                  (pmResult.input_rules || []).map(r => "- " + r).join("\n"),
                  "",
                  "## è¾“å‡ºè§„åˆ™",
                  (pmResult.output_rules || []).map(r => "- " + r).join("\n"),
                  "",
                  "## UI äº‹å®",
                  (pmResult.ui_facts || []).map(f => "- " + f).join("\n"),
                  "",
                  "## LLM èŒè´£",
                  (pmResult.llm_responsibilities || []).map(r => "- " + r).join("\n"),
                  "",
                  "## ç¦æ­¢è¡Œä¸º",
                  (pmResult.forbidden_actions || []).map(f => "- " + f).join("\n"),
                  "",
                  "## å¼‚å¸¸ä¸è¾¹ç•Œ",
                  (pmResult.edge_cases || []).map(e => "- " + e).join("\n"),
                  "",
                  "## æ­§ä¹‰å¤„ç†è¯´æ˜",
                  (pmResult.disambiguation_notes || []).map(n => "- " + n).join("\n")
                ].join("\n");
              }

              const uiPrompt = [
                "ä½ æ˜¯ Product UI Architect Agentã€‚",
                "",
                "ä½ çš„ä»»åŠ¡æ˜¯å°†ã€å·²ç¼–è¯‘çš„ AI å¯æ‰§è¡Œéœ€æ±‚ã€‘è½¬æ¢ä¸ºã€ç”Ÿäº§å°±ç»ªçš„ UI äº¤äº’è§„æ ¼ã€‘ã€‚",
                "å‰ç«¯å·¥ç¨‹å¸ˆæˆ– Agent å¯ä»¥ç›´æ¥æŒ‰æ­¤è§„æ ¼å®ç°ï¼Œæ— éœ€å†åšè®¾è®¡å†³ç­–ã€‚",
                "",
                "====================",
                "å·²ç¼–è¯‘çš„éœ€æ±‚ï¼ˆAI EXECUTION PROMPTï¼‰",
                "====================",
                compiledRequirement,
                "",
                "====================",
                "è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼ï¼‰",
                "====================",
                "",
                "## äº¤äº’å“²å­¦",
                "ï¼ˆä¸€å¥è¯æè¿°æ ¸å¿ƒäº¤äº’ç†å¿µï¼‰",
                "",
                "## äº¤äº’é£æ ¼ä¸åå¥½",
                "ï¼ˆåˆ—å‡º 3-5 æ¡äº¤äº’è¡Œä¸ºçº¦æŸï¼‰",
                "",
                "## é¡µé¢å¸ƒå±€",
                "ï¼ˆä½¿ç”¨æ ‘ç»“æ„æè¿°é¡µé¢å±‚çº§ï¼Œç”¨ç¼©è¿›è¡¨ç¤ºåµŒå¥—å…³ç³»ï¼‰",
                "",
                "## ç»„ä»¶è§„æ ¼",
                "ï¼ˆå¯¹äºæ¯ä¸ªç»„ä»¶ï¼Œå¿…é¡»åŒ…å«ï¼šï¼‰",
                "",
                "### [ç»„ä»¶åç§°]",
                "- **èŒè´£**: è¯¥ç»„ä»¶çš„å”¯ä¸€èŒè´£",
                "- **äº¤äº’**: ç”¨æˆ·å¦‚ä½•ä¸ä¹‹äº¤äº’",
                "- **çŠ¶æ€**: ç»„ä»¶çš„æ‰€æœ‰å¯èƒ½çŠ¶æ€",
                "- **Props**: ç»„ä»¶æ¥æ”¶çš„æ•°æ®ï¼ˆå¦‚é€‚ç”¨ï¼‰",
                "",
                "## äº¤äº’æµç¨‹",
                "ï¼ˆçº¿æ€§ç¼–å·æ­¥éª¤ï¼Œæ ¼å¼ï¼šç”¨æˆ·æ“ä½œ â†’ ç³»ç»Ÿååº”ï¼‰",
                "",
                "1. ç”¨æˆ· [åŠ¨ä½œ] â†’ ç³»ç»Ÿ [ååº”]",
                "2. ...",
                "",
                "## UI çŠ¶æ€æšä¸¾",
                "ï¼ˆåˆ—å‡ºæ‰€æœ‰æœ‰é™çŠ¶æ€ï¼Œæ ¼å¼ï¼šçŠ¶æ€å | è§¦å‘æ¡ä»¶ | ç”¨æˆ·å¯è§å˜åŒ–ï¼‰",
                "",
                "| çŠ¶æ€ | è§¦å‘æ¡ä»¶ | ç”¨æˆ·å¯è§å˜åŒ– |",
                "|------|----------|--------------|",
                "| ... | ... | ... |",
                "",
                "## UI å†»ç»“å¥‘çº¦",
                "ï¼ˆåˆ—å‡ºä¸å¯æ›´æ”¹çš„ UI å†³ç­–ï¼‰",
                "",
                "- [ ] å†³ç­–1",
                "- [ ] å†³ç­–2",
                "",
                "====================",
                "è§„åˆ™ï¼ˆä¸å¯åå•†ï¼‰",
                "====================",
                "- ç¦æ­¢å†™ä»£ç ",
                "- ç¦æ­¢æŒ‡å®šè§†è§‰æ ·å¼ï¼ˆé¢œè‰²ã€é—´è·ã€å­—ä½“ã€å°ºå¯¸ï¼‰- ç”±è®¾è®¡ç³»ç»Ÿå¤„ç†",
                "- ç¦æ­¢è®¾è®¡åç«¯ API æˆ–æ•°æ®æ¨¡å‹",
                "- åªå…³æ³¨äº¤äº’é€»è¾‘ã€ç»„ä»¶ç»“æ„ã€çŠ¶æ€ç®¡ç†",
                "- ç¦æ­¢æ·»åŠ æ ¼å¼ä¹‹å¤–çš„ç« èŠ‚"
              ].join("\n");

              const uiRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": "Bearer " + process.env.OPENROUTER_API_KEY,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-2.5-flash-preview",
                  messages: [{ role: "user", content: uiPrompt }],
                  temperature: 0.5
                })
              });

              if (!uiRes.ok) {
                const err = await uiRes.text();
                await github.rest.issues.createComment({
                  owner, repo, issue_number,
                  body: "âŒ **UI Spec Generator è¯·æ±‚å¤±è´¥**\n\nHTTP: " + uiRes.status + "\n\n```\n" + err.substring(0, 1500) + "\n```"
                });
                throw new Error("UI Spec Generator failed: " + uiRes.status);
              }

              const uiData = await uiRes.json();
              const uiSpec = uiData?.choices?.[0]?.message?.content || "";

              if (!uiSpec.trim()) {
                await github.rest.issues.createComment({
                  owner, repo, issue_number,
                  body: "âŒ **UI Spec Generator è¿”å›ä¸ºç©º**\n\næ¨¡å‹æ²¡æœ‰è¿”å›æœ‰æ•ˆå†…å®¹ï¼Œè¯·é‡è¯•ã€‚"
                });
                throw new Error("UI Spec Generator returned empty content.");
              }

              // ==================== Step 3: Post Result ====================
              await github.rest.issues.createComment({
                owner, repo, issue_number,
                body: [
                  "ğŸ§© **UI Agent Output (Frozen UI Spec)**",
                  "",
                  "---",
                  "",
                  "## ğŸ“‹ Step 1: éœ€æ±‚ç¼–è¯‘ç»“æœ",
                  "",
                  compiledRequirement,
                  "",
                  "---",
                  "",
                  "## ğŸ¨ Step 2: UI äº¤äº’è§„æ ¼",
                  "",
                  uiSpec.trim(),
                  "",
                  "---",
                  "",
                  "**UI Freeze Notice:**",
                  "- âœ… éœ€æ±‚å·²ç¼–è¯‘ä¸º AI å¯æ‰§è¡ŒæŒ‡ä»¤",
                  "- âœ… äº¤äº’å“²å­¦å’Œå¸ƒå±€å±‚çº§å·²å†»ç»“",
                  "- âœ… Frontend Agent åªéœ€ç»‘å®šæ•°æ®å’Œç®¡ç†çŠ¶æ€",
                  "- âœ… è§†è§‰æ ·å¼ç”±è®¾è®¡ç³»ç»Ÿï¼ˆshadcn/ui + Tailwindï¼‰å¤„ç†",
                  "",
                  "**Next Step:**",
                  "å¤åˆ¶æ­¤è¯„è®º URLï¼Œç„¶åæ‰§è¡Œ `/agent-fe <æ­¤è¯„è®ºURL>` ç”Ÿæˆå‰ç«¯ä»£ç "
                ].join("\n")
              });

              console.log("âœ… UI Agent å®Œæˆ");
            }

            await runUIAgent();
