name: Issue Auto Triage with Claude

on:
  issues:
    types: [opened, labeled]
    if: contains(github.event.issue.labels.*.name, 'claude-triage')

jobs:
  triage:
    if: contains(github.event.issue.labels.*.name, 'claude-triage')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout Testing Branch
        uses: actions/checkout@v6
        with:
          ref: 'claude-code/auto-coding'
          fetch-depth: 0

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          api_key: ${{ secrets.OPENROUTER_API_KEY }}
          model: anthropic/claude-sonnet-4.5
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            TITLE: ${{ github.event.issue.title }}
            BODY: ${{ github.event.issue.body }}

            请分析这个新 Issue，并执行以下操作：
            1. 判断类型：bug / feature / question / maintenance / duplicate
            2. 评估优先级：critical / high / medium / low
            3. 推荐合适的标签（如 bug、enhancement、question 等）
            4. 如果发现重复 Issue，请评论指出原 Issue 链接

            直接使用工具自动添加推荐标签，并在 Issue 上评论说明理由。
          allowed_tools: '["github:add_label", "github:remove_label", "github:comment_on_issue", "github:search_issues"]'
