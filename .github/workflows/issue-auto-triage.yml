name: Issue Auto Triage with Claude

on:
  issues:
    types: [opened, labeled]

jobs:
  triage:
    if: contains(github.event.issue.labels.*.name, 'claude-triage')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      id-token: write # 添加 OIDC token 权限
    steps:
      - name: Checkout Testing Branch
        uses: actions/checkout@v6
        with:
          ref: "claude-code/auto-coding"
          fetch-depth: 0

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        env:
          # OpenRouter 集成配置（参考：https://openrouter.ai/docs/guides/guides/claude-code-integration）
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          # 使用 OpenRouter API key（文档要求使用 anthropic_api_key）
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          # 使用 GitHub token 避免 OIDC token 获取失败
          github_token: ${{ github.token }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            TITLE: ${{ github.event.issue.title }}
            BODY: ${{ github.event.issue.body }}

            请分析这个新 Issue，并执行以下操作：
            1. 判断类型：bug / feature / question / maintenance / duplicate
            2. 评估优先级：critical / high / medium / low
            3. 推荐合适的标签（如 bug、enhancement、question 等）
            4. 如果发现重复 Issue，请评论指出原 Issue 链接

            直接使用工具自动添加推荐标签，并在 Issue 上评论说明理由。
