name: Vercel Deployment Monitor

# ç›‘å¬éƒ¨ç½²çŠ¶æ€å˜åŒ–ï¼ˆè¿™æ˜¯ Vercel ä¼ å›ç»™ GitHub çš„ä¿¡å·ï¼‰
on:
  deployment_status:
  # ä¸´æ—¶æ·»åŠ ï¼šå½“ PR åˆå¹¶åˆ° main æ—¶ä¹Ÿè§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  push:
    branches:
      - main
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºè°ƒè¯•ï¼‰
  workflow_dispatch:

jobs:
  track-deployment:
    # åªç›‘å¬ç”Ÿäº§ç¯å¢ƒ (Production) çš„éƒ¨ç½²ï¼Œæˆ–è€… push/æ‰‹åŠ¨è§¦å‘æ—¶ä¹Ÿè¿è¡Œ
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event.deployment.environment == 'Production'
    runs-on: ubuntu-latest
    
    steps:
      - name: Locate PR and Issue
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            // 1. æ ¹æ®éƒ¨ç½²çš„ Commit SHA æ‰¾åˆ°å¯¹åº”çš„ PR
            // æ”¯æŒä¸åŒçš„è§¦å‘æ–¹å¼ï¼šdeployment_status æˆ– push
            const commitSha = context.payload.deployment?.sha || context.sha;
            console.log(`Commit SHA: ${commitSha}, Event: ${context.eventName}`);
            
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commitSha,
            });

            // è¿‡æ»¤å‡ºå·²åˆå¹¶çš„ PR
            const pr = prs.find(p => p.merged_at);
            
            if (!pr) {
              console.log("æœªæ‰¾åˆ°å…³è”çš„å·²åˆå¹¶ PRï¼Œè·³è¿‡ã€‚");
              return; // å¦‚æœæ˜¯ç›´æ¥ push åˆ° main çš„ï¼Œå¯èƒ½æ²¡æœ‰ PRï¼Œç›´æ¥ç»“æŸ
            }

            // 2. ä» PR æè¿°ä¸­æå–å…³è”çš„ Issue ID
            // åŒ¹é… "Related to #123" æˆ– "Fixes #123"
            const match = pr.body ? pr.body.match(/(?:Related to|Fixes|Closes) #(\d+)/i) : null;
            const issueNumber = match ? match[1] : null;

            // è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_url', pr.html_url);
            core.setOutput('issue_number', issueNumber);
            
            console.log(`Found PR #${pr.number}, Issue #${issueNumber || 'None'}`);

      # ========================================================
      # æµ‹è¯•æ¨¡å¼ï¼šä»…åœ¨ push/æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œï¼ˆä¸å®é™…è¯„è®ºï¼‰
      # ========================================================
      - name: Test Mode - Display Found PR and Issue
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.context.outputs.pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.context.outputs.pr_number }}';
            const issueNumber = '${{ steps.context.outputs.issue_number }}';
            
            console.log('ğŸ§ª æµ‹è¯•æ¨¡å¼ï¼šæ‰¾åˆ°å…³è”çš„ PR å’Œ Issue');
            console.log(`ğŸ“‹ PR #${prNumber}`);
            console.log(`ğŸ¯ Issue #${issueNumber || 'æ— '}`);
            console.log('');
            console.log('âœ… Workflow é…ç½®æ­£ç¡®ï¼');
            console.log('â³ ç­‰å¾… Vercel å‘é€ deployment_status äº‹ä»¶æ¥è§¦å‘å®é™…æ“ä½œ...');

      # ========================================================
      # åœºæ™¯ A: éƒ¨ç½²å¼€å§‹ (Pending) -> è¯„è®ºåœ¨ PR
      # ========================================================
      - name: Notify Start on PR
        if: github.event.deployment_status.state == 'pending' && steps.context.outputs.pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.context.outputs.pr_number }};
            const deployUrl = context.payload.deployment_status.target_url;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `â³ **Vercel æ­£åœ¨éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ...**\n\n[æŸ¥çœ‹æ—¥å¿—](${deployUrl})`
            });

      # ========================================================
      # åœºæ™¯ B: éƒ¨ç½²æˆåŠŸ (Success) -> è¯„è®º PR + å…³é—­ Issue
      # ========================================================
      - name: Handle Success
        if: github.event.deployment_status.state == 'success' && steps.context.outputs.pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.context.outputs.pr_number }};
            const issueNumber = ${{ steps.context.outputs.issue_number }};
            const deployUrl = context.payload.deployment_status.target_url;

            // 1. åœ¨ PR é‡Œåº†ç¥
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `âœ… **éƒ¨ç½²æˆåŠŸ!**\n\nçº¿ä¸Šåœ°å€: ${deployUrl}`
            });

            // 2. å¦‚æœæœ‰å…³è” Issueï¼Œå…³é—­å®ƒ
            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ğŸš€ **å·²å‘å¸ƒä¸Šçº¿**\n\né€šè¿‡ PR #${prNumber} éƒ¨ç½²æˆåŠŸã€‚\nè‡ªåŠ¨å…³é—­æ­¤ Issueã€‚`
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed'
              });
              
              // ç§»é™¤ "å¤„ç†ä¸­" æ ‡ç­¾ï¼ŒåŠ ä¸Š "å·²å®Œæˆ"
              await github.rest.issues.removeLabel({
                 owner: context.repo.owner,
                 repo: context.repo.repo,
                 issue_number: issueNumber,
                 name: 'ai-processing' // å‡è®¾ä½ ä¹‹å‰çš„æ ‡ç­¾å«è¿™ä¸ª
              }).catch(() => {});
              
               await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['âœ… deployed']
              });
            }

      # ========================================================
      # åœºæ™¯ C: éƒ¨ç½²å¤±è´¥ (Failure/Error) -> è­¦å‘Š Issue
      # ========================================================
      - name: Handle Failure
        if: (github.event.deployment_status.state == 'failure' || github.event.deployment_status.state == 'error') && steps.context.outputs.pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.context.outputs.pr_number }};
            const prUrl = ${{ steps.context.outputs.pr_url }}; // è·å–ä¹‹å‰è§£æå‡ºçš„ URL
            const issueNumber = ${{ steps.context.outputs.issue_number }};
            const deployUrl = context.payload.deployment_status.target_url;

            const errorMsg = `âŒ **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥**
            
            è¯·æ£€æŸ¥ PR ä»£ç æˆ– Vercel æ—¥å¿—ã€‚
            
            - **æ¥æº PR**: [PR #${prNumber}](${prUrl}) ğŸ‘ˆ ç‚¹å‡»è·³è½¬
            - **é”™è¯¯æ—¥å¿—**: [Vercel Logs](${deployUrl})
            `;

            // 1. åœ¨ PR é‡ŒæŠ¥é”™
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: errorMsg
            });

            // 2. å…³é”®ï¼šåœ¨ Issue é‡ŒæŠ¥é”™ï¼Œæ–¹ä¾¿ä½ åœ¨ issue åˆ—è¡¨çœ‹åˆ°æ²¡å…³æ‰
            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âš ï¸ **éƒ¨ç½²å—é˜»**\n\n${errorMsg}\n\næ­¤ Issue å°†ä¿æŒå¼€å¯çŠ¶æ€ï¼Œç­‰å¾…ä¿®å¤ã€‚`
              });
              
              // åŠ ä¸Šå¤±è´¥æ ‡ç­¾
               await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['âŒ deploy-failed']
              });
            }