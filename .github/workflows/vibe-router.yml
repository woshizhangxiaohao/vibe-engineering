name: Vibe Router - AI éœ€æ±‚å¤æ‚åº¦è·¯ç”±

on:
  issues:
    types: [opened]

env:
  # å¤æ‚åº¦é˜ˆå€¼é…ç½®
  SIMPLE_MAX_CHARS: 500      # ç®€å•éœ€æ±‚æœ€å¤§å­—ç¬¦æ•°
  MEDIUM_MAX_CHARS: 2000     # ä¸­ç­‰éœ€æ±‚æœ€å¤§å­—ç¬¦æ•°

jobs:
  route:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    outputs:
      complexity: ${{ steps.analyze.outputs.complexity }}
      reasoning: ${{ steps.analyze.outputs.reasoning }}

    steps:
      - name: Analyze Issue Complexity
        id: analyze
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title || '';
            const body = issue.body || '';
            const content = `${title}\n\n${body}`;

            console.log("=".repeat(60));
            console.log("ğŸ” VIBE ROUTER - åˆ†æéœ€æ±‚å¤æ‚åº¦");
            console.log("=".repeat(60));
            console.log(`Issue #${issue.number}: ${title}`);

            // è·³è¿‡ç‰¹æ®Šç±»å‹çš„ Issue
            const skipPatterns = [
              /^\[PRD\]/i,           // PRD æ–‡æ¡£
              /^\[Auto\]/i,          // è‡ªåŠ¨ç”Ÿæˆçš„ issue
              /^sub-issue/i,         // å­ issue
              /workflow.*fail/i,     // workflow å¤±è´¥æŠ¥å‘Š
            ];

            for (const pattern of skipPatterns) {
              if (pattern.test(title)) {
                console.log(`â­ï¸ è·³è¿‡: åŒ¹é…æ¨¡å¼ ${pattern}`);
                core.setOutput('complexity', 'skip');
                core.setOutput('reasoning', 'ç‰¹æ®Šç±»å‹ Issueï¼Œä¸è‡ªåŠ¨å¤„ç†');
                return;
              }
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰è·³è¿‡æ ‡ç­¾
            const skipLabels = ['skip-vibe', 'manual', 'question', 'discussion'];
            const issueLabels = issue.labels?.map(l => l.name.toLowerCase()) || [];
            for (const skipLabel of skipLabels) {
              if (issueLabels.includes(skipLabel)) {
                console.log(`â­ï¸ è·³è¿‡: æœ‰ ${skipLabel} æ ‡ç­¾`);
                core.setOutput('complexity', 'skip');
                core.setOutput('reasoning', `æœ‰ ${skipLabel} æ ‡ç­¾`);
                return;
              }
            }

            // ä½¿ç”¨ AI åˆ¤æ–­å¤æ‚åº¦
            const prompt = `ä½ æ˜¯ä¸€ä¸ªéœ€æ±‚å¤æ‚åº¦åˆ†æä¸“å®¶ã€‚

åˆ†æä»¥ä¸‹ GitHub Issueï¼Œåˆ¤æ–­å…¶å¼€å‘å¤æ‚åº¦ã€‚

## Issue å†…å®¹
æ ‡é¢˜: ${title}
æè¿°:
${body.substring(0, 3000)}

## åˆ¤æ–­æ ‡å‡†

**ç®€å• (S)** - ä»¥ä¸‹ä»»ä¸€æƒ…å†µï¼š
- å•æ–‡ä»¶ä¿®æ”¹ï¼ˆä¿®å¤ bugã€è°ƒæ•´æ ·å¼ã€æ”¹æ–‡æ¡ˆï¼‰
- æ·»åŠ /åˆ é™¤å•ä¸ª UI å…ƒç´ ï¼ˆæŒ‰é’®ã€å­—æ®µï¼‰
- ç®€å•çš„ API è°ƒç”¨ä¿®æ”¹
- é…ç½®æ›´æ”¹
- é¢„è®¡ < 2 å°æ—¶å·¥ä½œé‡

**ä¸­ç­‰ (M)** - ä»¥ä¸‹ä»»ä¸€æƒ…å†µï¼š
- æ¶‰åŠ 2-5 ä¸ªæ–‡ä»¶
- æ–°å¢ä¸€ä¸ªç‹¬ç«‹åŠŸèƒ½æ¨¡å—
- éœ€è¦å‰åç«¯éƒ½æ”¹ä½†é€»è¾‘ç®€å•
- æ–°å¢ API endpoint + ç®€å• UI
- é¢„è®¡ 2-8 å°æ—¶å·¥ä½œé‡

**å¤æ‚ (L)** - ä»¥ä¸‹ä»»ä¸€æƒ…å†µï¼š
- æ¶‰åŠ > 5 ä¸ªæ–‡ä»¶æˆ–è·¨å¤šä¸ªæ¨¡å—
- éœ€è¦æ•°æ®åº“ schema å˜æ›´
- éœ€è¦æ¶æ„è®¾è®¡æˆ–é‡æ„
- æ¶‰åŠç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ
- é¢„è®¡ > 1 å¤©å·¥ä½œé‡

**è·³è¿‡ (skip)** - ä»¥ä¸‹ä»»ä¸€æƒ…å†µï¼š
- ä¸æ˜¯å¼€å‘ä»»åŠ¡ï¼ˆè®¨è®ºã€é—®é¢˜ã€æ–‡æ¡£ï¼‰
- éœ€æ±‚ä¸æ˜ç¡®ï¼Œéœ€è¦äººå·¥æ¾„æ¸…
- PRD æˆ–è§„åˆ’ç±»æ–‡æ¡£

## è¾“å‡ºæ ¼å¼
ä¸¥æ ¼è¿”å› JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ï¼š
{
  "complexity": "S" | "M" | "L" | "skip",
  "reasoning": "ä¸€å¥è¯è§£é‡ŠåŸå› ",
  "estimated_hours": æ•°å­—,
  "affected_areas": ["frontend", "backend", "database"] ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ª
}`;

            try {
              const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-flash-1.5",
                  messages: [{ role: "user", content: prompt }],
                  temperature: 0.1
                })
              });

              if (!response.ok) {
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
              }

              const data = await response.json();
              let result = data.choices?.[0]?.message?.content || '';

              // æå– JSON
              const jsonMatch = result.match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                result = JSON.parse(jsonMatch[0]);
              } else {
                throw new Error("æ— æ³•è§£æ AI å“åº”");
              }

              console.log("âœ… AI åˆ†æç»“æœ:", JSON.stringify(result, null, 2));

              const complexity = result.complexity || 'M';
              const reasoning = result.reasoning || 'é»˜è®¤ä¸­ç­‰å¤æ‚åº¦';
              const areas = result.affected_areas || [];

              core.setOutput('complexity', complexity);
              core.setOutput('reasoning', reasoning);

              // æ·»åŠ å¤æ‚åº¦æ ‡ç­¾
              const labelMap = {
                'S': 'complexity:simple',
                'M': 'complexity:medium',
                'L': 'complexity:complex',
                'skip': 'needs-triage'
              };

              const labels = [labelMap[complexity] || 'complexity:medium'];

              // æ·»åŠ å½±å“åŒºåŸŸæ ‡ç­¾
              if (areas.includes('frontend')) labels.push('frontend');
              if (areas.includes('backend')) labels.push('backend');
              if (areas.includes('database')) labels.push('database');

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });

              // å‘å¸ƒåˆ†æè¯„è®º
              const complexityEmoji = {
                'S': 'ğŸŸ¢',
                'M': 'ğŸŸ¡',
                'L': 'ğŸ”´',
                'skip': 'â­ï¸'
              };

              const complexityName = {
                'S': 'ç®€å•ä»»åŠ¡',
                'M': 'ä¸­ç­‰ä»»åŠ¡',
                'L': 'å¤æ‚ä»»åŠ¡',
                'skip': 'è·³è¿‡'
              };

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: [
                  `${complexityEmoji[complexity]} **Vibe Router åˆ†æç»“æœ**`,
                  "",
                  `**å¤æ‚åº¦**: ${complexityName[complexity]} (${complexity})`,
                  `**åŸå› **: ${reasoning}`,
                  areas.length > 0 ? `**å½±å“èŒƒå›´**: ${areas.join(', ')}` : '',
                  result.estimated_hours ? `**é¢„ä¼°å·¥æ—¶**: ${result.estimated_hours} å°æ—¶` : '',
                  "",
                  "---",
                  "",
                  complexity === 'S' ? "ğŸš€ **ç®€å•ä»»åŠ¡ Agent å·²è‡ªåŠ¨è§¦å‘**ï¼Œè¯·ç¨å€™æŸ¥çœ‹ PRã€‚" :
                  complexity === 'M' ? "ğŸ”§ **ä¸­ç­‰ä»»åŠ¡å¤„ç†ä¸­**ï¼ŒAI å°†å…ˆåˆ†æå†å¼€å‘ã€‚" :
                  complexity === 'L' ? "ğŸ“‹ **å¤æ‚ä»»åŠ¡éœ€è¦æ‹†åˆ†**ï¼ŒAI å°†ç”Ÿæˆå­ Issue åˆ—è¡¨ã€‚" :
                  "â¸ï¸ æ­¤ Issue éœ€è¦äººå·¥å¤„ç†ã€‚",
                  "",
                  "> ğŸ’¡ å¦‚éœ€æ‰‹åŠ¨è§¦å‘ï¼Œå¯ä½¿ç”¨ `/agent-simple`ã€`/agent-medium` æˆ– `/agent-complex` å‘½ä»¤ã€‚"
                ].filter(Boolean).join("\n")
              });

            } catch (error) {
              console.error("âŒ åˆ†æå¤±è´¥:", error.message);

              // å¤±è´¥æ—¶é»˜è®¤ä¸ºä¸­ç­‰å¤æ‚åº¦
              core.setOutput('complexity', 'M');
              core.setOutput('reasoning', 'è‡ªåŠ¨åˆ†æå¤±è´¥ï¼Œé»˜è®¤ä¸­ç­‰å¤æ‚åº¦');

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['complexity:medium', 'needs-review']
              });
            }

  # è§¦å‘å¯¹åº”çš„ Agent
  trigger-simple:
    needs: route
    if: needs.route.outputs.complexity == 'S'
    uses: ./.github/workflows/agent-simple.yml
    secrets: inherit

  trigger-medium:
    needs: route
    if: needs.route.outputs.complexity == 'M'
    uses: ./.github/workflows/agent-medium.yml
    secrets: inherit

  trigger-complex:
    needs: route
    if: needs.route.outputs.complexity == 'L'
    uses: ./.github/workflows/agent-complex.yml
    secrets: inherit
