name: Vibe Router - AI éœ€æ±‚å¤æ‚åº¦è·¯ç”±

on:
  issues:
    types: [labeled]  # åªåœ¨æ‰‹åŠ¨æ·»åŠ æ ‡ç­¾æ—¶è§¦å‘ï¼Œä¸åœ¨åˆ›å»ºæ—¶è‡ªåŠ¨è§¦å‘

jobs:
  route:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    outputs:
      complexity: ${{ steps.analyze.outputs.complexity }}
      reasoning: ${{ steps.analyze.outputs.reasoning }}

    steps:
      - name: Check if should route
        id: should_route
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels?.map(l => l.name) || [];
            const addedLabel = context.payload.label?.name;
            
            console.log(`ğŸ“‹ æ£€æµ‹åˆ°æ ‡ç­¾æ·»åŠ : ${addedLabel}`);
            
            // åªæœ‰æ·»åŠ  needs-route æ ‡ç­¾æ—¶æ‰è§¦å‘è·¯ç”±
            if (addedLabel !== 'needs-route') {
              console.log(`â­ï¸ è·³è¿‡: æ ‡ç­¾ ${addedLabel} ä¸æ˜¯ needs-route`);
              core.setOutput('should_route', 'false');
              return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å¤æ‚åº¦æ ‡ç­¾ï¼ˆè¯´æ˜å·²ç»è¢«è·¯ç”±è¿‡ï¼‰
            const hasComplexityLabel = labels.some(l => 
              l.startsWith('complexity:')
            );
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»è¢«AIå¤„ç†è¿‡
            const hasAILabels = labels.some(l => 
              l.includes('ai:processing') || 
              l.includes('ai:completed') || 
              l.includes('ai:failed')
            );
            
            if (hasComplexityLabel) {
              console.log('â­ï¸ è·³è¿‡: å·²æœ‰å¤æ‚åº¦æ ‡ç­¾ï¼Œä¸é‡å¤è·¯ç”±');
              core.setOutput('should_route', 'false');
              return;
            }
            
            if (hasAILabels) {
              console.log('â­ï¸ è·³è¿‡: Issue å·²è¢« AI å¤„ç†è¿‡');
              core.setOutput('should_route', 'false');
              return;
            }
            
            console.log('âœ… æ»¡è¶³è·¯ç”±æ¡ä»¶ï¼Œå°†è§¦å‘è·¯ç”±åˆ†æ');
            core.setOutput('should_route', 'true');

      - name: Checkout repository
        if: steps.should_route.outputs.should_route == 'true'
        uses: actions/checkout@v4

      - name: Load Prompt Template
        if: steps.should_route.outputs.should_route == 'true'
        id: prompt
        uses: ./.github/actions/load-prompt
        with:
          template: router/complexity-analyzer.md
          variables: |
            {
              "title": ${{ toJson(github.event.issue.title) }},
              "body": ${{ toJson(github.event.issue.body) }}
            }

      - name: Analyze Issue Complexity
        if: steps.should_route.outputs.should_route == 'true'
        id: analyze
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          PROMPT_CONTENT: ${{ steps.prompt.outputs.prompt }}
        with:
          script: |
            const script = require('./.github/scripts/vibe-router.js');
            await script({
              github,
              context,
              core,
              promptContent: process.env.PROMPT_CONTENT
            });

  # è§¦å‘å¯¹åº”çš„ Agent (ä½¿ç”¨ workflow_dispatch æ›¿ä»£ workflow_callï¼Œä»¥æ­£ç¡®ä¼ é€’ Issue ä¿¡æ¯)
  trigger-simple:
    needs: route
    if: |
      needs.route.outputs.complexity == 'S' &&
      needs.route.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Trigger Simple Agent
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'agent-simple.yml',
              ref: 'main',
              inputs: {
                issue_number: String(context.payload.issue.number)
              }
            });
            console.log(`ğŸš€ å·²è§¦å‘ Simple Agent for Issue #${context.payload.issue.number}`);

  trigger-medium:
    needs: route
    if: |
      needs.route.outputs.complexity == 'M' &&
      needs.route.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Trigger Medium Agent
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'agent-medium.yml',
              ref: 'main',
              inputs: {
                issue_number: String(context.payload.issue.number)
              }
            });
            console.log(`ğŸš€ å·²è§¦å‘ Medium Agent for Issue #${context.payload.issue.number}`);

  trigger-complex:
    needs: route
    if: |
      needs.route.outputs.complexity == 'L' &&
      needs.route.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Trigger Complex Agent
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'agent-complex.yml',
              ref: 'main',
              inputs: {
                issue_number: String(context.payload.issue.number)
              }
            });
            console.log(`ğŸš€ å·²è§¦å‘ Complex Agent for Issue #${context.payload.issue.number}`);
