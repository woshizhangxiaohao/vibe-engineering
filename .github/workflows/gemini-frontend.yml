name: Vibe Frontend Agent

on:
  issue_comment:
    types: [created]

jobs:
  frontend-agent:
    if: contains(github.event.comment.body, '/agent-fe')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config user.name "vibe-frontend-agent"
          git config user.email "agent@vibe.dev"

      - name: Vibe Frontend Agent - Generate Code and Open PR
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          script: |
            const fs = require("fs");
            const path = require("path");
            const { execSync } = require("child_process");

            async function runFrontendAgent() {
              const { owner, repo } = context.repo;
              const issue_number = context.issue.number;
              const commentBody = context.payload.comment.body;

              // ==================== ‰∏ä‰∏ãÊñá‰ø°ÊÅØËæìÂá∫ ====================
              console.log("=".repeat(80));
              console.log("üîç FRONTEND AGENT - ‰∏ä‰∏ãÊñá‰ø°ÊÅØ");
              console.log("=".repeat(80));
              console.log(`üì¶ Repository: ${owner}/${repo}`);
              console.log(`üìã Issue Number: #${issue_number}`);
              console.log(`üë§ Comment Author: ${context.payload.comment.user.login}`);
              console.log(`üïê Comment Created: ${context.payload.comment.created_at}`);
              console.log(`üîó Comment URL: ${context.payload.comment.html_url}`);
              console.log("");
              console.log("üìù Êî∂Âà∞ÁöÑËØÑËÆ∫ÂÜÖÂÆπ (ÂÆåÊï¥):");
              console.log("-".repeat(80));
              console.log(commentBody);
              console.log("-".repeat(80));
              console.log("");

              // 1. Extract UI Spec comment URLs (ÊîØÊåÅÂ§ö‰∏™ URL)
              // ÊîØÊåÅ GitHub Ëá™Âä®ËΩ¨Êç¢ÁöÑ markdown ÈìæÊé•Ê†ºÂºè: [#139 (comment)](https://...)
              const urlPattern = /https:\/\/github\.com\/[^\s\)]+\/issues\/\d+#issuecomment-\d+/g;
              const urlMatches = commentBody.match(urlPattern) || [];

              console.log(`üîç ÊâæÂà∞ ${urlMatches.length} ‰∏™ URL:`);
              urlMatches.forEach((url, idx) => {
                console.log(`  ${idx + 1}. ${url}`);
              });
              console.log("");

              if (urlMatches.length === 0) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body: [
                    "‚ùå **Áº∫Â∞ëËØÑËÆ∫ URL**",
                    "",
                    "Áî®Ê≥ï: `/agent-fe <github issue comment url-1> [<url-2> ...]`",
                    "",
                    "Á§∫‰æãÔºàÂçï‰∏™ URLÔºâ:",
                    "```",
                    "/agent-fe https://github.com/owner/repo/issues/1#issuecomment-123456",
                    "ËØ∑‰ΩøÁî®Ê∑±Ëâ≤‰∏ªÈ¢ò",
                    "```",
                    "",
                    "Á§∫‰æãÔºàÂ§ö‰∏™ URLÔºâ:",
                    "```",
                    "/agent-fe \\",
                    "  https://github.com/owner/repo/issues/1#issuecomment-123456 \\",
                    "  https://github.com/owner/repo/issues/1#issuecomment-789012",
                    "```"
                  ].join("\n")
                });
                return;
              }

              // 1.1 Extract user instructions (text after URLs)
              let userInstructions = commentBody
                .replace(/\/agent-fe\s*/, "")
                .trim();
              
              // Remove all URLs from instructions
              urlMatches.forEach(url => {
                userInstructions = userInstructions.replace(url, "").trim();
              });

              console.log("üìå ÊèêÂèñÁöÑÁî®Êà∑È¢ùÂ§ñÊåá‰ª§:");
              console.log("-".repeat(80));
              console.log(userInstructions || "(Êó†)");
              console.log("-".repeat(80));
              console.log("");

              // 2. Fetch all UI Specs from multiple comments
              const uiSpecs = [];
              const commentUrls = [];
              
              for (const commentUrl of urlMatches) {
                try {
                  const commentId = commentUrl.split("#issuecomment-")[1];
                  console.log(`üì• Ëé∑ÂèñËØÑËÆ∫ÂÜÖÂÆπ: ${commentUrl} (ID: ${commentId})`);
                  
                  const commentRes = await github.rest.issues.getComment({
                    owner,
                    repo,
                    comment_id: Number(commentId)
                  });

                  const specContent = commentRes.data.body;
                  uiSpecs.push({
                    url: commentUrl,
                    content: specContent,
                    title: specContent.split('\n')[0] || 'UI Spec'
                  });
                  commentUrls.push(commentUrl);
                  
                  console.log(`‚úÖ ÊàêÂäüËé∑ÂèñËØÑËÆ∫ ${commentId}, ÂÜÖÂÆπÈïøÂ∫¶: ${specContent.length}`);
                  console.log(`   Ê†áÈ¢ò: ${specContent.split('\n')[0] || '(Êó†Ê†áÈ¢ò)'}`);
                  console.log(`   ÂÜÖÂÆπÈ¢ÑËßà: ${specContent.substring(0, 200)}${specContent.length > 200 ? '...' : ''}`);
                } catch (error) {
                  console.error(`‚ùå Ëé∑ÂèñËØÑËÆ∫Â§±Ë¥• ${commentUrl}:`, error.message);
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number,
                    body: `‚ùå **Ëé∑ÂèñËØÑËÆ∫Â§±Ë¥•**: ${commentUrl}\n\nÈîôËØØ: ${error.message}`
                  });
                  return;
                }
              }

              // 2.1 Combine all UI Specs
              const combinedUISpec = uiSpecs.map((spec, idx) => {
                return `## UI Spec ${idx + 1}: ${spec.title}\n\nÊù•Ê∫ê: ${spec.url}\n\n${spec.content}`;
              }).join("\n\n---\n\n");

              console.log(`üìã ÂêàÂπ∂ÂêéÁöÑ UI Spec ÊÄªÈïøÂ∫¶: ${combinedUISpec.length} Â≠óÁ¨¶`);
              console.log(`üìã UI Spec ÂÜÖÂÆπÈ¢ÑËßà:`);
              console.log("-".repeat(80));
              console.log(combinedUISpec.substring(0, 500) + (combinedUISpec.length > 500 ? '\n...' : ''));
              console.log("-".repeat(80));
              console.log("");

              // Use first URL as primary reference (for backward compatibility)
              const commentUrl = commentUrls[0];

              // 2.1 Analyze requirements and generate todolist
              const analysisPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™ÂâçÁ´ØÈúÄÊ±ÇÂàÜÊûê‰∏ìÂÆ∂„ÄÇËØ∑ÂàÜÊûê‰ª•‰∏ã UI ËßÑÊ†ºÂíåÁî®Êà∑Êåá‰ª§ÔºåÁîüÊàêÈúÄÊ±ÇÂàÜÊûêÂíåÂæÖÂäûÊ∏ÖÂçï„ÄÇ

                UI ËßÑÊ†ºÊù•Ê∫ê${uiSpecs.length > 1 ? `ÔºàÂÖ± ${uiSpecs.length} ‰∏™Ôºâ` : ''}:
                ${commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n")}
                
                UI ËßÑÊ†ºÂÜÖÂÆπ:
                ${combinedUISpec}
                
                ${userInstructions ? `Áî®Êà∑È¢ùÂ§ñÊåá‰ª§:\n${userInstructions}\n` : ""}ËØ∑ËøîÂõû JSON Ê†ºÂºè:
                {
                  "analysis": "ÈúÄÊ±ÇÂàÜÊûêÊÄªÁªìÔºà2-3Âè•ËØùÔºâ",
                  "todolist": [
                    "ÂæÖÂäûÈ°π1",
                    "ÂæÖÂäûÈ°π2",
                    "ÂæÖÂäûÈ°π3"
                  ]
                }
                
                Âè™ËøîÂõû JSONÔºå‰∏çË¶ÅÂÖ∂‰ªñÂÜÖÂÆπ„ÄÇ`;

              const analysisRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [
                    { role: "user", content: analysisPrompt }
                  ],
                  temperature: 0.3
                })
              });

              const analysisData = await analysisRes.json();
              const analysisRaw = analysisData.choices?.[0]?.message?.content;
              
              let analysisResult = { analysis: "", todolist: [] };
              if (analysisRaw) {
                console.log("üìä ÈúÄÊ±ÇÂàÜÊûêÂéüÂßãÂìçÂ∫î:");
                console.log("-".repeat(80));
                console.log(analysisRaw.substring(0, 500) + (analysisRaw.length > 500 ? '\n...' : ''));
                console.log("-".repeat(80));
                console.log("");
                
                let analysisJsonStr = analysisRaw.trim();
                const analysisJsonMatch = analysisJsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (analysisJsonMatch) {
                  analysisJsonStr = analysisJsonMatch[1].trim();
                }
                try {
                  analysisResult = JSON.parse(analysisJsonStr);
                  console.log("‚úÖ ÈúÄÊ±ÇÂàÜÊûêËß£ÊûêÊàêÂäü:");
                  console.log(`   ÂàÜÊûê: ${analysisResult.analysis}`);
                  console.log(`   ÂæÖÂäûÊ∏ÖÂçïÊï∞Èáè: ${analysisResult.todolist.length}`);
                  analysisResult.todolist.forEach((item, idx) => {
                    console.log(`     ${idx + 1}. ${item}`);
                  });
                  console.log("");
                } catch (e) {
                  console.error("‚ùå ÈúÄÊ±ÇÂàÜÊûêËß£ÊûêÂ§±Ë¥•:", e);
                  analysisResult.analysis = "ÈúÄÊ±ÇÂàÜÊûêÂÆåÊàê";
                  analysisResult.todolist = ["ÂÆûÁé∞ÂâçÁ´ØÁïåÈù¢"];
                }
              }

              // 2.2 Post analysis and todolist comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: [
                  "üìã **ÈúÄÊ±ÇÂàÜÊûêÂÆåÊàê**",
                  "",
                  `**Â§ÑÁêÜÁöÑ UI Spec (${uiSpecs.length} ‰∏™):**`,
                  commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n"),
                  "",
                  userInstructions ? `**Áî®Êà∑È¢ùÂ§ñÊåá‰ª§:**\n${userInstructions}\n` : "",
                  "### ÈúÄÊ±ÇÂàÜÊûê",
                  analysisResult.analysis || "Ê≠£Âú®ÂàÜÊûêÈúÄÊ±Ç...",
                  "",
                  "### üìù ÂæÖÂäûÊ∏ÖÂçï",
                  analysisResult.todolist.map((item, idx) => `- [ ] ${item}`).join("\n"),
                  "",
                  "‚è≥ ÂºÄÂßãÁîüÊàê‰ª£Á†Å..."
                ].join("\n")
              });

              // 3. Read frontend system files for project constraints
              // Read system files list from ARCHITECTURE.md
              const architectureDocPath = path.join(process.cwd(), "frontend/ARCHITECTURE.md");
              let frontendSystemFiles = [];
              
              if (fs.existsSync(architectureDocPath)) {
                const architectureDoc = fs.readFileSync(architectureDocPath, "utf8");
                // Extract system files list from markdown code block between markers
                const startMarker = "<!-- AGENT_SYSTEM_FILES_START -->";
                const endMarker = "<!-- AGENT_SYSTEM_FILES_END -->";
                const startIdx = architectureDoc.indexOf(startMarker);
                const endIdx = architectureDoc.indexOf(endMarker);
                
                if (startIdx !== -1 && endIdx !== -1) {
                  const filesSection = architectureDoc.substring(startIdx + startMarker.length, endIdx);
                  // Extract file paths from code block (lines starting with frontend/)
                  const fileLines = filesSection.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.startsWith('frontend/') && !line.startsWith('```'));
                  
                  frontendSystemFiles = fileLines;
                  console.log(`üìñ ‰ªé ARCHITECTURE.md ËØªÂèñÂà∞ ${frontendSystemFiles.length} ‰∏™Á≥ªÁªüÊñá‰ª∂`);
                } else {
                  console.log("‚ö†Ô∏è  ARCHITECTURE.md ‰∏≠Êú™ÊâæÂà∞Á≥ªÁªüÊñá‰ª∂Ê†áËÆ∞Ôºå‰ΩøÁî®ÈªòËÆ§ÂàóË°®");
                  // Fallback to default list
                  frontendSystemFiles = [
                    "frontend/package.json",
                    "frontend/tsconfig.json",
                    "frontend/tailwind.config.ts",
                    "frontend/components.json",
                    "frontend/middleware.ts",
                    "frontend/app/layout.tsx",
                    "frontend/app/page.tsx",
                    "frontend/app/globals.css",
                    "frontend/STYLE_GUIDE.md",
                    "frontend/lib/api/client.ts",
                    "frontend/lib/api/config.ts",
                    "frontend/lib/utils/utils.ts"
                  ];
                }
              } else {
                console.log("‚ö†Ô∏è  ARCHITECTURE.md ‰∏çÂ≠òÂú®Ôºå‰ΩøÁî®ÈªòËÆ§Á≥ªÁªüÊñá‰ª∂ÂàóË°®");
                  // Fallback to default list
                  frontendSystemFiles = [
                    "frontend/package.json",
                    "frontend/tsconfig.json",
                    "frontend/tailwind.config.ts",
                    "frontend/components.json",
                    "frontend/middleware.ts",
                    "frontend/app/layout.tsx",
                    "frontend/app/page.tsx",
                    "frontend/app/globals.css",
                    "frontend/STYLE_GUIDE.md",
                    "frontend/lib/api/client.ts",
                    "frontend/lib/api/config.ts",
                    "frontend/lib/utils/utils.ts"
                  ];
              }

              // 3.1 Read system files content
              const projectContext = {};
              const readFiles = [];

              for (const filePath of frontendSystemFiles) {
                try {
                  const fullPath = path.join(process.cwd(), filePath);
                  if (fs.existsSync(fullPath)) {
                    const content = fs.readFileSync(fullPath, "utf8");
                    projectContext[filePath] = content;
                    readFiles.push(filePath);
                    console.log(`‚úÖ ËØªÂèñÁ≥ªÁªüÊñá‰ª∂: ${filePath} (${content.length} Â≠óÁ¨¶)`);
                  } else {
                    console.log(`‚ö†Ô∏è  Êñá‰ª∂‰∏çÂ≠òÂú®: ${filePath}`);
                  }
                } catch (error) {
                  console.error(`‚ùå ËØªÂèñÊñá‰ª∂Â§±Ë¥• ${filePath}:`, error.message);
                }
              }

              console.log(`üìö ÂÖ±ËØªÂèñ ${readFiles.length} ‰∏™Á≥ªÁªüÊñá‰ª∂‰Ωú‰∏∫È°πÁõÆÁ∫¶Êùü`);
              console.log("");

              // 3.2 Format project context
              const projectContextText = Object.entries(projectContext)
                .map(([filePath, content]) => {
                  const ext = filePath.split('.').pop();
                  const lang = ext === 'tsx' || ext === 'ts' ? 'typescript' : ext === 'json' ? 'json' : ext === 'css' ? 'css' : 'text';
                  return `## ${filePath}\n\`\`\`${lang}\n${content}\n\`\`\``;
                })
                .join("\n\n");

              // 4. Create new branch
              const branchName = `agent-fe-${issue_number}-${Date.now()}`;
              execSync(`git checkout -b ${branchName}`);

              // 5. Build system prompt and user prompt
              const systemPrompt = `You are the **Frontend Execution Agent**.
              
              Your task:
              Generate COMPLETE, BEAUTIFUL frontend code with excellent visual design and output it in a MACHINE-PARSABLE FORMAT.
              
              ====================
              RULES (STRICT)
              ====================
              - UI spec is a contract
              - No UI redesign
              - No extra features
              - No persistence
              - Single Page Interface
              - Next.js App Router
              - TypeScript strict
              - Tailwind CSS
              - shadcn/ui component library (MANDATORY - use components from @/components/ui/)
              - **BEAUTIFUL VISUAL DESIGN IS REQUIRED** - Apply proper spacing, colors, shadows, borders, and typography
              - **DESIGN SYSTEM COMPLIANCE** - Follow the project's design system (STYLE_GUIDE.md) strictly
              - **VISUAL AESTHETICS** - Create polished, professional, and visually appealing UI
              
              ====================
              PATH CONSTRAINTS (STRICT - NO EXCEPTIONS)
              ====================
              ALL file paths MUST start with "frontend/"
              You CANNOT create files outside the frontend/ directory.
              You CANNOT create files in backend/, root, or any other directory.
              
              CRITICAL FORBIDDEN PATHS:
              - ‚ùå "frontend/components/ui/" - COMPLETELY FORBIDDEN
              - This directory contains shadcn/ui components that are READ-ONLY
              - You MUST NOT create, modify, or delete ANY files in frontend/components/ui/
              - You can ONLY import and use components from @/components/ui/
              - If you need custom components, create them in frontend/components/ (outside ui/)
              
              - ‚ùå "frontend/app/globals.css" - COMPLETELY FORBIDDEN
              - This file contains global styles managed by project maintainers
              - You MUST NOT modify globals.css
              - If you need custom styles, create CSS files in your component directory:
                * Use CSS Modules: "frontend/components/my-component.module.css"
                * Or regular CSS: "frontend/components/my-component.css"
                * Import styles in your component file
              
              Examples:
              - ‚úÖ "frontend/app/page.tsx"
              - ‚úÖ "frontend/components/my-component.tsx"
              - ‚úÖ "frontend/components/my-component.module.css" (component-specific styles)
              - ‚úÖ "frontend/components/layout/header.tsx"
              - ‚úÖ "frontend/components/layout/header.module.css" (layout-specific styles)
              - ‚ùå "frontend/components/ui/button.tsx" (REJECTED - ui/ is read-only)
              - ‚ùå "frontend/components/ui/custom-button.tsx" (REJECTED - ui/ is read-only)
              - ‚ùå "frontend/app/globals.css" (REJECTED - globals.css is read-only)
              - ‚ùå "app/page.tsx" (REJECTED - outside frontend/)
              - ‚ùå "components/button.tsx" (REJECTED - outside frontend/)
              - ‚ùå "backend/api/handler.go" (REJECTED - backend files not allowed)
              - ‚ùå "../frontend/app/page.tsx" (REJECTED - path traversal not allowed)
              
              ONLY files inside frontend/ directory are allowed.
              frontend/components/ui/ directory is STRICTLY FORBIDDEN.
              frontend/app/globals.css is STRICTLY FORBIDDEN.
              
              ====================
              OUTPUT FORMAT (MANDATORY - CRITICAL)
              ====================
              You MUST return ONLY valid JSON. No markdown code blocks, no explanations, no extra text.
              
              Required JSON structure:
              {
                "files": [
                  {
                    "path": "frontend/relative/path/to/file.tsx",
                    "content": "full file content"
                  }
                ]
              }
              
              CRITICAL RULES:
              - Start your response with { and end with }
              - Do NOT wrap JSON in markdown code blocks (no \`\`\`json)
              - Do NOT add any text before or after the JSON
              - Ensure all strings are properly escaped
              - Ensure all file paths start with "frontend/"
              
              Example of CORRECT output:
              {"files":[{"path":"frontend/app/page.tsx","content":"export default function Page() { return <div>Hello</div>; }"}]}
              
              Example of WRONG output (DO NOT DO THIS):
              \`\`\`json
              {"files":[...]}
              \`\`\`
              
              Return ONLY the JSON object, nothing else.`;
              
              const userPrompt = `
                ====================
                PROJECT ARCHITECTURE & CONSTRAINTS
                ====================
                ‰ª•‰∏ãÊòØ‰ªéÁé∞Êúâ‰ª£Á†ÅÂ∫ì‰∏≠ËØªÂèñÁöÑÁ≥ªÁªüÊñá‰ª∂ÔºåËØ∑‰∏•Ê†ºÈÅµÂæ™Ëøô‰∫õÊû∂ÊûÑÊ®°ÂºèÂíå‰ª£Á†ÅÈ£éÊ†ºÔºö
                
                ${projectContextText}
                
                ====================
                DESIGN SYSTEM REQUIREMENTS (CRITICAL)
                ====================
                Â¶ÇÊûú‰∏äÈù¢ÂåÖÂê´‰∫Ü STYLE_GUIDE.md Âíå globals.cssÔºå‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂæ™È°πÁõÆÁöÑËÆæËÆ°Á≥ªÁªüÔºö
                
                1. **È¢úËâ≤Á≥ªÁªü**ÔºàÊµÖËâ≤‰∏ªÈ¢òÔºâÔºö
                   - ËÉåÊôØÔºö‰ΩøÁî® bg-backgroundÔºàÁôΩËâ≤ #FFFFFFÔºâ
                   - Âç°ÁâáÔºö‰ΩøÁî® bg-cardÔºàÁôΩËâ≤ #FFFFFFÔºâ
                   - ‰∏ªËâ≤Ôºö‰ΩøÁî® bg-primaryÔºàÊ∑±ÁªøËâ≤ #22C55EÔºâ
                   - ÊñáÊú¨Ôºö‰ΩøÁî® text-foregroundÔºàÊ∑±Ëâ≤ #0A0A0AÔºâ
                   - Ê¨°Ë¶ÅÊñáÊú¨Ôºö‰ΩøÁî® text-muted-foregroundÔºàÁÅ∞Ëâ≤ #737373Ôºâ
                   - ËæπÊ°ÜÔºö‰ΩøÁî® borderÔºàÊµÖÁÅ∞ #E5E5E5Ôºâ
                   - Á¶ÅÊ≠¢Á°¨ÁºñÁ†ÅÈ¢úËâ≤ÂÄºÔºåÂøÖÈ°ª‰ΩøÁî®ËØ≠‰πâÂåñ Tailwind Á±ª
                
                2. **Èó¥Ë∑ùÁ≥ªÁªü**Ôºö
                   - ‰ΩøÁî®‰∏ÄËá¥ÁöÑÈó¥Ë∑ùÔºöp-1 (4px), p-2 (8px), p-4 (16px), p-6 (24px), p-8 (32px)
                   - ÁªÑ‰ª∂‰πãÈó¥‰øùÊåÅÈÄÇÂΩìÈó¥Ë∑ùÔºögap-2, gap-4, gap-6 Á≠â
                   - ÂÆπÂô®‰ΩøÁî®ÈÄÇÂΩìÁöÑ paddingÔºöp-4, p-6, p-8
                
                3. **ÂúÜËßíÂíåÈò¥ÂΩ±**Ôºö
                   - Âç°ÁâáÂíåÊåâÈíÆÔºörounded-lg Êàñ rounded-xl
                   - ËæìÂÖ•Ê°ÜÔºörounded-md
                   - Âç°ÁâáÈò¥ÂΩ±Ôºöshadow-md Êàñ shadow-lg
                   - ÊÇ¨ÂÅúÊïàÊûúÔºöhover:shadow-lg
                
                4. **ÁªÑ‰ª∂Ê†∑Âºè**Ôºö
                   - ÊâÄÊúâ shadcn/ui ÁªÑ‰ª∂‰ΩøÁî®ÈªòËÆ§Ê†∑ÂºèÔºåÈÄöËøá className ËøõË°åÂÆöÂà∂
                   - ‰ΩøÁî® Card ÁªÑ‰ª∂ÂåÖË£ÖÂÜÖÂÆπÂå∫Âüü
                   - ÊåâÈíÆ‰ΩøÁî® variant="default" Êàñ variant="outline"
                   - ËæìÂÖ•Ê°Ü‰ΩøÁî®ÈÄÇÂΩìÁöÑÂ∞∫ÂØ∏ÂíåÊ†∑Âºè
                
                5. **ËßÜËßâÂ±ÇÊ¨°**Ôºö
                   - ‰ΩøÁî® Card ÁªÑ‰ª∂ÂàõÂª∫ÂÜÖÂÆπÂå∫Âüü
                   - ‰ΩøÁî®ÂàÜÈöîÁ∫øÔºàSeparatorÔºâÂå∫ÂàÜÂÜÖÂÆπÂå∫Âùó
                   - ‰ΩøÁî®ÈÄÇÂΩìÁöÑÊ†áÈ¢òÂ±ÇÁ∫ßÔºàh1, h2, h3Ôºâ
                   - ‰ΩøÁî® Badge ÊòæÁ§∫Áä∂ÊÄÅÂíåÊ†áÁ≠æ
                
                6. **‰∫§‰∫íÂèçÈ¶à**Ôºö
                   - ÊâÄÊúâÂèØ‰∫§‰∫íÂÖÉÁ¥†ÂøÖÈ°ªÊúâ hover Áä∂ÊÄÅ
                   - ËæìÂÖ•Ê°ÜÂøÖÈ°ªÊúâ focus Áä∂ÊÄÅÔºà‰ΩøÁî® ring È¢úËâ≤Ôºâ
                   - ÊåâÈíÆÂøÖÈ°ªÊúâ active Áä∂ÊÄÅ
                   - ‰ΩøÁî® transition Á±ªÂÆûÁé∞Âπ≥ÊªëËøáÊ∏°
                
                7. **ÂìçÂ∫îÂºèËÆæËÆ°**Ôºö
                   - ‰ΩøÁî® Tailwind ÂìçÂ∫îÂºèÂâçÁºÄÔºösm:, md:, lg:, xl:
                   - Á°Æ‰øùÁßªÂä®Á´ØÂíåÊ°åÈù¢Á´ØÈÉΩÁæéËßÇ
                   - ‰ΩøÁî®ÈÄÇÂΩìÁöÑÊñ≠ÁÇπËøõË°åÂ∏ÉÂ±ÄË∞ÉÊï¥
                
                8. **ÂõæÊ†á‰ΩøÁî®**Ôºö
                   - ‰ΩøÁî® Lucide React ÂõæÊ†áÂ∫ì
                   - ÂõæÊ†áÂ§ßÂ∞èÔºöw-4 h-4 (16px), w-5 h-5 (20px), w-6 h-6 (24px)
                   - ÂõæÊ†áÈ¢úËâ≤Ôºö‰ΩøÁî® text-muted-foreground Êàñ text-foreground
                
                **ÈáçË¶Å**ÔºöÁîüÊàêÁöÑ UI ÂøÖÈ°ªÊòØÁæéËßÇÁöÑ„ÄÅ‰∏ì‰∏öÁöÑ„ÄÅÁ¨¶ÂêàÁé∞‰ª£ËÆæËÆ°Ê†áÂáÜÁöÑ„ÄÇ‰∏çË¶ÅÁîüÊàêÁÆÄÈôãÊàñÊú™ÂÆåÊàêÁöÑÁïåÈù¢„ÄÇ
                
                ====================
                SOURCE OF TRUTH${uiSpecs.length > 1 ? ` (${uiSpecs.length} UI Specs)` : ''}
                ====================
                ${commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n")}
                
                ${combinedUISpec}
                
                ${userInstructions ? `====================
                USER INSTRUCTIONS
                ====================
                ${userInstructions}` : ""}
                
                ${analysisResult.todolist.length > 0 ? `====================
                TODO LIST (ÂèÇËÄÉ)
                ====================
                ${analysisResult.todolist.map((item, idx) => `${idx + 1}. ${item}`).join("\n")}` : ""}
                
                ====================
                IMPLEMENTATION REQUIREMENTS
                ====================
                1. ÈÅµÂæ™Áé∞Êúâ‰ª£Á†ÅÊû∂ÊûÑÊ®°ÂºèÔºàÂèÇËÄÉ‰∏äÈù¢ÁöÑÁ≥ªÁªüÊñá‰ª∂Ôºâ
                2. ‰ΩøÁî®Áõ∏ÂêåÁöÑÂåÖÁªìÊûÑÂíåÂëΩÂêçÁ∫¶ÂÆö
                3. ÈÅµÂæ™Áõ∏ÂêåÁöÑ‰ª£Á†ÅÈ£éÊ†ºÂíå TypeScript Á±ªÂûãÂÆö‰πâ
                4. ‰ΩøÁî®Áõ∏ÂêåÁöÑÂ∑•ÂÖ∑ÂáΩÊï∞Âíå Hooks
                5. ÈÅµÂæ™Áõ∏ÂêåÁöÑ API Ë∞ÉÁî®Ê®°Âºè
                6. **ÂøÖÈ°ª‰ΩøÁî® shadcn/ui ÁªÑ‰ª∂Â∫ì**Ôºö
                   - ‰ªé @/components/ui/ ÂØºÂÖ•ÁªÑ‰ª∂ÔºàÂ¶Ç Button, Input, Dialog Á≠âÔºâ
                   - ÂèÇËÄÉ components.json Âíå button.tsx ‰∫ÜËß£ÁªÑ‰ª∂‰ΩøÁî®Ê®°Âºè
                   - **‰∏•Á¶Å‰øÆÊîπÊàñÂàõÂª∫ frontend/components/ui/ ÁõÆÂΩï‰∏ãÁöÑ‰ªª‰ΩïÊñá‰ª∂**
                   - **‰∏•Á¶ÅÂú® frontend/components/ui/ ÁõÆÂΩï‰∏ãÂàõÂª∫Êñ∞Êñá‰ª∂**
                   - Â¶ÇÊûúÈúÄË¶ÅËá™ÂÆö‰πâÁªÑ‰ª∂ÔºåÂú® frontend/components/ ÁõÆÂΩï‰∏ãÂàõÂª∫Ôºà‰∏çÂú® ui/ Â≠êÁõÆÂΩïÔºâ
                   - ‰ΩøÁî® Tailwind CSS ÈÄöËøá className ËøõË°åÊ†∑ÂºèÂÆöÂà∂
                   - ‰∏çË¶Å‰øÆÊîπ shadcn/ui ÁªÑ‰ª∂ÁöÑÊ∫ê‰ª£Á†Å
                7. **Ê†∑ÂºèÊñá‰ª∂ÁÆ°ÁêÜ**Ôºö
                   - **‰∏•Á¶Å‰øÆÊîπ frontend/app/globals.css Êñá‰ª∂**
                   - Â¶ÇÊûúÈúÄË¶ÅËá™ÂÆö‰πâÊ†∑ÂºèÔºåÂú®ÁªÑ‰ª∂ÁõÆÂΩï‰∏ãÂàõÂª∫Áã¨Á´ãÁöÑ CSS Êñá‰ª∂Ôºö
                     * CSS Modules: `frontend/components/my-component.module.css`
                     * ÊàñÊôÆÈÄö CSS: `frontend/components/my-component.css`
                     * Âú®ÁªÑ‰ª∂Êñá‰ª∂‰∏≠ÂØºÂÖ•Ôºö`import styles from './my-component.module.css'`
                   - ‰ºòÂÖà‰ΩøÁî® Tailwind CSS Â∑•ÂÖ∑Á±ªÔºåÂè™Âú®ÂøÖË¶ÅÊó∂‰ΩøÁî®Ëá™ÂÆö‰πâ CSS
                   - Ê†∑ÂºèÊñá‰ª∂Â∫îËØ•‰∏éÁªÑ‰ª∂Êñá‰ª∂ÊîæÂú®Âêå‰∏ÄÁõÆÂΩï‰∏ã
                8. **ÂøÖÈ°ªÈÅµÂæ™È°πÁõÆÁöÑËÆæËÆ°Á≥ªÁªü**ÔºàÂèÇËÄÉ STYLE_GUIDE.mdÔºâÔºö
                   - ‰ΩøÁî®ËØ≠‰πâÂåñÈ¢úËâ≤Á±ªÔºöbg-background, text-foreground, bg-primary, text-primary-foreground Á≠â
                   - ‰ΩøÁî®È°πÁõÆÁöÑÈ¢úËâ≤ÊñπÊ°àÔºöÊµÖËâ≤‰∏ªÈ¢ò‰ºòÂÖàÔºåÁªøËâ≤‰∏ªËâ≤Ë∞ÉÔºàÊµÖËâ≤‰∏ªÈ¢ò‰ΩøÁî®Ê∑±ÁªøËâ≤ #22C55EÔºåÊ∑±Ëâ≤‰∏ªÈ¢ò‰ΩøÁî®‰∫ÆÁªøËâ≤ #86EFACÔºâ
                   - ‰ΩøÁî®‰∏ÄËá¥ÁöÑÈó¥Ë∑ùÔºö4px, 8px, 16px, 24px, 32px Á≠â
                   - ‰ΩøÁî®ÈÄÇÂΩìÁöÑÂúÜËßíÔºörounded-sm, rounded-md, rounded-lg Á≠â
                   - ‰ΩøÁî®Èò¥ÂΩ±ÊèêÂçáÂ±ÇÊ¨°ÊÑüÔºöshadow-sm, shadow-md, shadow-lg Á≠â
                   - ‰ΩøÁî® Space Grotesk Â≠ó‰ΩìÔºàÈªòËÆ§Â∑≤ÈÖçÁΩÆÔºâ
                   - ‰ΩøÁî® Lucide React ÂõæÊ†áÂ∫ì
                9. **ÁæéËßÇÊÄßË¶ÅÊ±Ç**Ôºö
                   - Á°Æ‰øùÊâÄÊúâÁªÑ‰ª∂ÊúâÈÄÇÂΩìÁöÑÈó¥Ë∑ùÂíåÁïôÁôΩ
                   - ‰ΩøÁî®Âç°Áâá„ÄÅËæπÊ°Ü„ÄÅÈò¥ÂΩ±Êù•ÂàõÂª∫ËßÜËßâÂ±ÇÊ¨°
                   - Á°Æ‰øùÈ¢úËâ≤ÂØπÊØîÂ∫¶Á¨¶ÂêàÂèØËÆøÈóÆÊÄßÊ†áÂáÜ
                   - ‰ΩøÁî® hover„ÄÅfocus Áä∂ÊÄÅÊèêÂçá‰∫§‰∫í‰ΩìÈ™å
                   - Á°Æ‰øùÂìçÂ∫îÂºèËÆæËÆ°Âú®‰∏çÂêåÂ±èÂπïÂ∞∫ÂØ∏‰∏ãÈÉΩÁæéËßÇ
                   - ÈÅøÂÖçÁ°¨ÁºñÁ†ÅÈ¢úËâ≤ÂÄºÔºå‰ΩøÁî®ËØ≠‰πâÂåñ Tailwind Á±ª
                10. ÊâÄÊúâÊñá‰ª∂Ë∑ØÂæÑÂøÖÈ°ªÂú® frontend/ ÁõÆÂΩï‰∏ã
                11. **Á¶ÅÊ≠¢‰øÆÊîπÁöÑÊñá‰ª∂**Ôºö
                   - frontend/app/globals.cssÔºàÂÖ®Â±ÄÊ†∑ÂºèÊñá‰ª∂ÔºåÂè™ËØªÔºâ
                   - frontend/components/ui/*Ôºàshadcn/ui ÁªÑ‰ª∂ÔºåÂè™ËØªÔºâ
                   - Â¶ÇÊûúÈúÄË¶ÅÊ†∑ÂºèÔºåÂú®ÁªÑ‰ª∂ÁõÆÂΩï‰∏ãÂàõÂª∫Áã¨Á´ãÁöÑ CSS Êñá‰ª∂`;

              // 5. Call model
              const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "anthropic/claude-sonnet-4.5",
                  messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                  ],
                  temperature: 0.3
                })
              });

              const data = await res.json();
              const raw = data.choices?.[0]?.message?.content;

              if (!raw) {
                console.error("‚ùå Model returned empty response.");
                console.error("Response data:", JSON.stringify(data, null, 2));
                throw new Error("Model returned empty response.");
              }

              console.log("üìù Model raw response length:", raw.length);
              console.log("üìù Model raw response preview (first 500 chars):");
              console.log("-".repeat(80));
              console.log(raw.substring(0, 500));
              console.log("-".repeat(80));

              // 5.1 Extract JSON from possible markdown code block or find JSON object
              let jsonStr = raw.trim();
              
              console.log("üìù Model raw response length:", raw.length);
              console.log("üìù Model raw response preview (first 1000 chars):");
              console.log("-".repeat(80));
              console.log(raw.substring(0, 1000));
              console.log("-".repeat(80));
              
              // Try to extract from markdown code block first
              const jsonMatch = jsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
              if (jsonMatch) {
                jsonStr = jsonMatch[1].trim();
                console.log("‚úÖ Extracted JSON from markdown code block");
              } else {
                // Try to find JSON object by finding first { and last }
                const firstBrace = jsonStr.indexOf('{');
                const lastBrace = jsonStr.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                  jsonStr = jsonStr.substring(firstBrace, lastBrace + 1);
                  console.log("‚úÖ Extracted JSON object from text");
                } else {
                  console.log("‚ö†Ô∏è  No JSON structure found, using raw content");
                }
              }

              console.log("üìÑ JSON string length:", jsonStr.length);
              console.log("üìÑ JSON string preview (first 1000 chars):");
              console.log("-".repeat(80));
              console.log(jsonStr.substring(0, 1000));
              console.log("-".repeat(80));
              console.log("üìÑ JSON string preview (last 500 chars):");
              console.log("-".repeat(80));
              console.log(jsonStr.substring(Math.max(0, jsonStr.length - 500)));
              console.log("-".repeat(80));

              let parsed;
              try {
                parsed = JSON.parse(jsonStr);
                console.log("‚úÖ JSON parsed successfully");
                console.log(`üì¶ Parsed object has ${parsed.files?.length || 0} files`);
              } catch (parseError) {
                console.error("‚ùå JSON parse error:", parseError.message);
                console.error("‚ùå Error position:", parseError.message.match(/position (\d+)/)?.[1] || "unknown");
                console.error("‚ùå JSON string (full, length:", jsonStr.length, "chars):");
                console.error("-".repeat(80));
                console.error(jsonStr);
                console.error("-".repeat(80));
                
                // Try to fix common JSON issues
                let fixedJson = jsonStr;
                let fixed = false;
                
                // Remove trailing commas before } or ]
                fixedJson = fixedJson.replace(/,(\s*[}\]])/g, '$1');
                if (fixedJson !== jsonStr) {
                  fixed = true;
                  console.log("üîß Attempted fix: Removed trailing commas");
                }
                
                // Try parsing fixed JSON
                if (fixed) {
                  try {
                    parsed = JSON.parse(fixedJson);
                    console.log("‚úÖ Fixed JSON parsed successfully");
                    console.log(`üì¶ Parsed object has ${parsed.files?.length || 0} files`);
                  } catch (fixError) {
                    console.error("‚ùå Fixed JSON still invalid:", fixError.message);
                    throw new Error(`Model output is not valid JSON: ${parseError.message}. Fixed version also failed: ${fixError.message}`);
                  }
                } else {
                  throw new Error(`Model output is not valid JSON: ${parseError.message}`);
                }
              }

              // 6. Write files with path validation
              const generatedFiles = [];
              const fileChanges = {
                created: [],
                modified: [],
                errors: []
              };
              
              for (const file of parsed.files) {
                // 6.1 Validate path - STRICT: ONLY frontend/ directory allowed
                let normalizedPath = file.path.trim();
                
                // Remove leading slash if present
                if (normalizedPath.startsWith("/")) {
                  normalizedPath = normalizedPath.substring(1);
                }
                
                // STRICT CHECK: Path MUST start with "frontend/" - NO AUTO-FIX
                if (!normalizedPath.startsWith("frontend/")) {
                  fileChanges.errors.push(`Ë∑ØÂæÑË¢´ÊãíÁªù: ${file.path} - Âè™ÂÖÅËÆ∏Âú® frontend/ ÁõÆÂΩï‰∏ãÂàõÂª∫Êñá‰ª∂`);
                  continue;
                }
                
                // CRITICAL: FORBIDDEN PATH - components/ui/ directory is READ-ONLY
                // shadcn/ui components MUST NOT be modified, only imported and used
                if (normalizedPath.startsWith("frontend/components/ui/")) {
                  fileChanges.errors.push(`Ë∑ØÂæÑË¢´ÊãíÁªù: ${file.path} - components/ui/ ÁõÆÂΩï‰∏ãÁöÑÊñá‰ª∂ÊòØÂè™ËØªÁöÑÔºåÁ¶ÅÊ≠¢‰øÆÊîπ„ÄÇÂè™ËÉΩ‰ªé @/components/ui/ ÂØºÂÖ•‰ΩøÁî®Ôºå‰∏çËÉΩ‰øÆÊîπÊàñÂàõÂª∫Êñ∞Êñá‰ª∂„ÄÇ`);
                  continue;
                }
                
                // CRITICAL: FORBIDDEN FILE - globals.css is READ-ONLY
                // Global styles are managed by the project maintainers
                if (normalizedPath === "frontend/app/globals.css" || normalizedPath.endsWith("/globals.css")) {
                  fileChanges.errors.push(`Ë∑ØÂæÑË¢´ÊãíÁªù: ${file.path} - globals.css Êñá‰ª∂ÊòØÂè™ËØªÁöÑÔºåÁ¶ÅÊ≠¢‰øÆÊîπ„ÄÇÂ¶ÇÊûúÈúÄË¶ÅËá™ÂÆö‰πâÊ†∑ÂºèÔºåËØ∑Âú®ÁªÑ‰ª∂ÁõÆÂΩï‰∏ãÂàõÂª∫Áã¨Á´ãÁöÑ CSS Êñá‰ª∂ÔºàÂ¶Ç component.module.css Êàñ component.cssÔºâ„ÄÇ`);
                  continue;
                }
                
                // Prevent path traversal attacks (even within frontend/)
                if (normalizedPath.includes("../") || normalizedPath.includes("..\\")) {
                  fileChanges.errors.push(`Ë∑ØÂæÑ‰∏çÂÆâÂÖ®: ${file.path} - ‰∏çÂÖÅËÆ∏‰ΩøÁî®Ë∑ØÂæÑÈÅçÂéÜ`);
                  continue;
                }
                
                // Additional check: ensure normalized path is still within frontend/
                // This prevents paths like "frontend/../../other-dir/file"
                const pathParts = normalizedPath.split(path.sep);
                if (pathParts[0] !== "frontend" || pathParts.includes("..")) {
                  fileChanges.errors.push(`Ë∑ØÂæÑÊó†Êïà: ${file.path} - ÂøÖÈ°ªÂú® frontend/ ÁõÆÂΩïÂÜÖ`);
                  continue;
                }
                
                const fullPath = path.join(process.cwd(), normalizedPath);
                
                // Check if file already exists
                const fileExists = fs.existsSync(fullPath);
                
                try {
                  fs.mkdirSync(path.dirname(fullPath), { recursive: true });
                  fs.writeFileSync(fullPath, file.content, "utf8");
                  generatedFiles.push(normalizedPath);
                  
                  if (fileExists) {
                    fileChanges.modified.push(normalizedPath);
                  } else {
                    fileChanges.created.push(normalizedPath);
                  }
                } catch (error) {
                  fileChanges.errors.push(`ÂÜôÂÖ•Â§±Ë¥•: ${normalizedPath} - ${error.message}`);
                }
              }

              // 6.1 Analyze completion status (before recording changelog)
              const completionPrompt = `ËØ∑ÂàÜÊûê‰ª•‰∏ãÂÜÖÂÆπÔºåÂØπÊØîÂæÖÂäûÊ∏ÖÂçïÂíåÂÆûÈôÖÂÆåÊàêÊÉÖÂÜµ„ÄÇ

              ÂæÖÂäûÊ∏ÖÂçï:
              ${analysisResult.todolist.map((item, idx) => `${idx + 1}. ${item}`).join("\n")}
              
              ÂÆûÈôÖÁîüÊàêÁöÑÊñá‰ª∂:
              ${generatedFiles.map((f, idx) => `${idx + 1}. ${f}`).join("\n")}
              
              ËØ∑ËøîÂõû JSON Ê†ºÂºè:
              {
                "completed": ["Â∑≤ÂÆåÊàêÈ°π1", "Â∑≤ÂÆåÊàêÈ°π2"],
                "notCompleted": ["Êú™ÂÆåÊàêÈ°π1", "Êú™ÂÆåÊàêÈ°π2"],
                "summary": "ÂÆåÊàêÊÉÖÂÜµÊÄªÁªìÔºà1-2Âè•ËØùÔºâ"
              }
              
              Âè™ËøîÂõû JSONÔºå‰∏çË¶ÅÂÖ∂‰ªñÂÜÖÂÆπ„ÄÇ`;

              const completionRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [
                    { role: "user", content: completionPrompt }
                  ],
                  temperature: 0.3
                })
              });

              const completionData = await completionRes.json();
              const completionRaw = completionData.choices?.[0]?.message?.content;
              
              let completionStatus = { completed: [], notCompleted: [], summary: "" };
              if (completionRaw) {
                let completionJsonStr = completionRaw.trim();
                const completionJsonMatch = completionJsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (completionJsonMatch) {
                  completionJsonStr = completionJsonMatch[1].trim();
                }
                try {
                  completionStatus = JSON.parse(completionJsonStr);
                } catch (e) {
                  console.error("Failed to parse completion JSON:", e);
                  completionStatus.completed = analysisResult.todolist;
                  completionStatus.summary = "‰ª£Á†ÅÂ∑≤ÁîüÊàê";
                }
              }

              // 6.2 Record changes to changelog
              const changelogPath = path.join(process.cwd(), "frontend/AGENT_CHANGELOG.md");
              const timestamp = new Date().toISOString();
              const changelogEntry = [
                `## ${timestamp} - Issue #${issue_number}`,
                "",
                `**UI Spec${uiSpecs.length > 1 ? 's' : ''} (${uiSpecs.length}):**`,
                commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n"),
                userInstructions ? `**Áî®Êà∑Êåá‰ª§:** ${userInstructions}` : "",
                "",
                "### üìù ÈúÄÊ±ÇÂàÜÊûê",
                analysisResult.analysis || "ÈúÄÊ±ÇÂàÜÊûêÂÆåÊàê",
                "",
                "### ‚úÖ Â∑≤ÂÆåÊàê",
                completionStatus.completed.length > 0
                  ? completionStatus.completed.map(item => `- ${item}`).join("\n")
                  : "- ‰ª£Á†ÅÂ∑≤ÁîüÊàê",
                "",
                completionStatus.notCompleted.length > 0 ? [
                  "### ‚ùå Êú™ÂÆåÊàê",
                  completionStatus.notCompleted.map(item => `- ${item}`).join("\n"),
                  ""
                ].join("\n") : "",
                "### üìÅ Êñá‰ª∂ÂèòÊõ¥",
                "",
                `**Êñ∞Âª∫Êñá‰ª∂ (${fileChanges.created.length}):**`,
                fileChanges.created.length > 0
                  ? fileChanges.created.map(f => `- \`${f}\``).join("\n")
                  : "- Êó†",
                "",
                `**‰øÆÊîπÊñá‰ª∂ (${fileChanges.modified.length}):**`,
                fileChanges.modified.length > 0
                  ? fileChanges.modified.map(f => `- \`${f}\``).join("\n")
                  : "- Êó†",
                "",
                fileChanges.errors.length > 0 ? [
                  `**ÈîôËØØ (${fileChanges.errors.length}):**`,
                  fileChanges.errors.map(e => `- ‚ö†Ô∏è ${e}`).join("\n"),
                  ""
                ].join("\n") : "",
                "---",
                ""
              ].join("\n");
              
              // Read existing changelog or create new one
              let changelogContent = "";
              if (fs.existsSync(changelogPath)) {
                changelogContent = fs.readFileSync(changelogPath, "utf8");
              } else {
                changelogContent = [
                  "# Frontend Agent ÂèòÊõ¥Êó•Âøó",
                  "",
                  "Ê≠§Êñá‰ª∂Áî± Frontend Agent Ëá™Âä®ÁîüÊàêÂíåÁª¥Êä§ÔºåËÆ∞ÂΩïÊâÄÊúâ‰ª£Á†ÅÂèòÊõ¥ÂéÜÂè≤„ÄÇ",
                  "",
                  "---",
                  ""
                ].join("\n");
              }
              
              // Prepend new entry
              const updatedChangelog = changelogEntry + changelogContent;
              fs.writeFileSync(changelogPath, updatedChangelog, "utf8");
              
              // Add changelog to generated files if it's new or modified
              if (!generatedFiles.includes("frontend/AGENT_CHANGELOG.md")) {
                generatedFiles.push("frontend/AGENT_CHANGELOG.md");
                fileChanges.created.push("frontend/AGENT_CHANGELOG.md");
              } else if (!fileChanges.modified.includes("frontend/AGENT_CHANGELOG.md")) {
                fileChanges.modified.push("frontend/AGENT_CHANGELOG.md");
              }

              // 6.3 Update ARCHITECTURE.md if directory structure or constraints changed
              if (fs.existsSync(architectureDocPath)) {
                // Analyze if there are new important system files or directory structure changes
                const newSystemFiles = [];
                const newDirectories = new Set();
                
                // Check created files for potential system files
                for (const file of fileChanges.created) {
                  // Check if it's a configuration file or important system file
                  const fileName = path.basename(file);
                  const isConfigFile = fileName.includes('config') || 
                                      fileName.includes('package.json') || 
                                      fileName.includes('tsconfig') ||
                                      fileName.includes('tailwind') ||
                                      fileName.includes('middleware') ||
                                      fileName.includes('layout') ||
                                      fileName === 'page.tsx' ||
                                      fileName === 'globals.css' ||
                                      fileName === 'components.json';
                  
                  // Check if it's in a key directory (system-level files)
                  const isKeyDir = file.includes('/lib/api/') ||
                                  file.includes('/lib/utils/') ||
                                  file.includes('/lib/config/') ||
                                  file.includes('/lib/constants/') ||
                                  file.includes('/types/') ||
                                  file.includes('/hooks/');
                  
                  // Check if it's a root-level important file
                  const isRootFile = file === 'frontend/middleware.ts' ||
                                     file === 'frontend/components.json' ||
                                     file === 'frontend/tailwind.config.ts' ||
                                     file === 'frontend/tsconfig.json' ||
                                     file === 'frontend/package.json' ||
                                     file.startsWith('frontend/app/layout') ||
                                     file.startsWith('frontend/app/page') ||
                                     file.startsWith('frontend/app/globals');
                  
                  if (isConfigFile || isKeyDir || isRootFile) {
                    newSystemFiles.push(file);
                  }
                  
                  // Track new directories
                  const dirPath = path.dirname(file);
                  if (dirPath !== 'frontend' && dirPath.startsWith('frontend/')) {
                    newDirectories.add(dirPath);
                  }
                }
                
                // If there are new system files or significant changes, update ARCHITECTURE.md
                if (newSystemFiles.length > 0 || fileChanges.created.length > 5) {
                  console.log(`üìù Ê£ÄÊµãÂà∞Êû∂ÊûÑÂèòÂåñÔºåÂáÜÂ§áÊõ¥Êñ∞ ARCHITECTURE.md`);
                  console.log(`   Êñ∞Á≥ªÁªüÊñá‰ª∂: ${newSystemFiles.length} ‰∏™`);
                  console.log(`   Êñ∞ÁõÆÂΩï: ${newDirectories.size} ‰∏™`);
                  
                  // Read current ARCHITECTURE.md
                  let architectureContent = fs.readFileSync(architectureDocPath, "utf8");
                  
                  // Extract current system files list
                  const startMarker = "<!-- AGENT_SYSTEM_FILES_START -->";
                  const endMarker = "<!-- AGENT_SYSTEM_FILES_END -->";
                  const startIdx = architectureContent.indexOf(startMarker);
                  const endIdx = architectureContent.indexOf(endMarker);
                  
                  if (startIdx !== -1 && endIdx !== -1) {
                    // Get current system files
                    const currentFilesSection = architectureContent.substring(startIdx + startMarker.length, endIdx);
                    const currentFiles = currentFilesSection.split('\n')
                      .map(line => line.trim())
                      .filter(line => line.startsWith('frontend/') && !line.startsWith('```'));
                    
                    // Merge with new system files (avoid duplicates)
                    const allSystemFiles = [...new Set([...currentFiles, ...newSystemFiles])].sort();
                    
                    // Update system files list
                    const newFilesSection = `\n\`\`\`\n${allSystemFiles.join('\n')}\n\`\`\`\n`;
                    const updatedArchitecture = 
                      architectureContent.substring(0, startIdx + startMarker.length) +
                      newFilesSection +
                      architectureContent.substring(endIdx);
                    
                    fs.writeFileSync(architectureDocPath, updatedArchitecture, "utf8");
                    console.log(`‚úÖ Â∑≤Êõ¥Êñ∞ ARCHITECTURE.md Á≥ªÁªüÊñá‰ª∂ÂàóË°®ÔºàÂÖ± ${allSystemFiles.length} ‰∏™Êñá‰ª∂Ôºâ`);
                    
                    // Add to file changes if not already tracked
                    if (!fileChanges.modified.includes("frontend/ARCHITECTURE.md")) {
                      fileChanges.modified.push("frontend/ARCHITECTURE.md");
                    }
                  }
                }
              }

              // 7. Commit changes
              execSync("git add .");
              execSync(`git commit -m "feat: implement frontend from frozen UI spec (#${issue_number})"`);
              execSync(`git push origin ${branchName}`);

              // 8. Create PR
              const pr = await github.rest.pulls.create({
                owner,
                repo,
                title: `Frontend: implement frozen UI spec (#${issue_number})`,
                head: branchName,
                base: "main",
                body: [
                  "This PR was generated by Vibe Frontend Agent.",
                  "",
                  `**UI Spec Source${uiSpecs.length > 1 ? 's' : ''} (${uiSpecs.length}):**`,
                  commentUrls.map(url => `- ${url}`).join("\n"),
                  "",
                  userInstructions ? `**User Instructions:**\n${userInstructions}\n` : "",
                  "### ÂÆåÊàêÊÉÖÂÜµ",
                  completionStatus.summary || "‰ª£Á†ÅÂ∑≤ÁîüÊàê",
                  "",
                  "**Â∑≤ÂÆåÊàê:**",
                  completionStatus.completed.map(item => `- ‚úÖ ${item}`).join("\n") || "- ‰ª£Á†ÅÂ∑≤ÁîüÊàê",
                  "",
                  completionStatus.notCompleted.length > 0 ? [
                    "**Êú™ÂÆåÊàê:**",
                    completionStatus.notCompleted.map(item => `- ‚ùå ${item}`).join("\n"),
                    ""
                  ].join("\n") : "",
                  "- UI spec treated as immutable contract",
                  "- No UI inference or redesign",
                  "- Ready for review"
                ].join("\n")
              });

              // 9. Comment back to issue
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: [
                  "‚úÖ **Frontend implementation completed**",
                  "",
                  `üîó PR: ${pr.data.html_url}`,
                  "",
                  `**Â§ÑÁêÜÁöÑ UI Spec (${uiSpecs.length} ‰∏™):**`,
                  commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n"),
                  "",
                  "### üìä ÂÆåÊàêÊÉÖÂÜµ",
                  completionStatus.summary || "‰ª£Á†ÅÂ∑≤ÁîüÊàêÂπ∂Êèê‰∫§",
                  "",
                  "**‚úÖ Â∑≤ÂÆåÊàê:**",
                  completionStatus.completed.length > 0 
                    ? completionStatus.completed.map(item => `- ${item}`).join("\n")
                    : "- ‰ª£Á†ÅÂ∑≤ÁîüÊàê",
                  "",
                  completionStatus.notCompleted.length > 0 ? [
                    "**‚ùå Êú™ÂÆåÊàê:**",
                    completionStatus.notCompleted.map(item => `- ${item}`).join("\n"),
                    ""
                  ].join("\n") : "",
                  "**üìÅ Êñá‰ª∂ÂèòÊõ¥:**",
                  "",
                  `**Êñ∞Âª∫ (${fileChanges.created.length}):**`,
                  fileChanges.created.length > 0
                    ? fileChanges.created.map(f => `- \`${f}\``).join("\n")
                    : "- Êó†",
                  "",
                  `**‰øÆÊîπ (${fileChanges.modified.length}):**`,
                  fileChanges.modified.length > 0
                    ? fileChanges.modified.map(f => `- \`${f}\``).join("\n")
                    : "- Êó†",
                  "",
                  fileChanges.errors.length > 0 ? [
                    "**‚ö†Ô∏è ÈîôËØØ:**",
                    fileChanges.errors.map(e => `- ${e}`).join("\n"),
                    ""
                  ].join("\n") : "",
                  "**üìù ÂèòÊõ¥Êó•Âøó:**",
                  `ÊâÄÊúâÂèòÊõ¥Â∑≤ËÆ∞ÂΩïÂà∞ \`frontend/AGENT_CHANGELOG.md\``,
                  "",
                  "**üìö È°πÁõÆÁ∫¶Êùü:**",
                  `Â∑≤ËØªÂèñ ${readFiles.length} ‰∏™Á≥ªÁªüÊñá‰ª∂‰Ωú‰∏∫Êû∂ÊûÑÂèÇËÄÉ`,
                  "",
                  "---",
                  "Notes:",
                  "- ‚úÖ ‰∏•Ê†ºË∑ØÂæÑÁ∫¶ÊùüÔºöÊâÄÊúâÊñá‰ª∂‰ªÖÂú® `frontend/` ÁõÆÂΩï‰∏ã",
                  "- ‚úÖ Á¶ÅÊ≠¢Âú® `frontend/` ÁõÆÂΩïÂ§ñÂàõÂª∫‰ªª‰ΩïÊñá‰ª∂",
                  "- ‚úÖ ÈÅµÂæ™Áé∞ÊúâÈ°πÁõÆÊû∂ÊûÑÊ®°Âºè",
                  "- ‚úÖ ÂèòÊõ¥ÂéÜÂè≤Â∑≤ËÆ∞ÂΩïÂà∞ `frontend/AGENT_CHANGELOG.md`",
                  "- Frontend code generated and committed",
                  "- UI spec respected strictly",
                  "- No persistence added"
                ].join("\n")
              });
            }

            await runFrontendAgent();
