name: Vibe Frontend Agent

on:
  issue_comment:
    types: [created]

jobs:
  frontend-agent:
    if: contains(github.event.comment.body, '/agent-fe')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config user.name "vibe-frontend-agent"
          git config user.email "agent@vibe.dev"

      - name: Vibe Frontend Agent - Generate Code and Open PR
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          script: |
            const fs = require("fs");
            const path = require("path");
            const { execSync } = require("child_process");

            async function runFrontendAgent() {
              const { owner, repo } = context.repo;
              const issue_number = context.issue.number;
              const commentBody = context.payload.comment.body;

              // ==================== ä¸Šä¸‹æ–‡ä¿¡æ¯è¾“å‡º ====================
              console.log("=".repeat(80));
              console.log("ğŸ” FRONTEND AGENT - ä¸Šä¸‹æ–‡ä¿¡æ¯");
              console.log("=".repeat(80));
              console.log(`ğŸ“¦ Repository: ${owner}/${repo}`);
              console.log(`ğŸ“‹ Issue Number: #${issue_number}`);
              console.log(`ğŸ‘¤ Comment Author: ${context.payload.comment.user.login}`);
              console.log(`ğŸ• Comment Created: ${context.payload.comment.created_at}`);
              console.log(`ğŸ”— Comment URL: ${context.payload.comment.html_url}`);
              console.log("");
              console.log("ğŸ“ æ”¶åˆ°çš„è¯„è®ºå†…å®¹ (å®Œæ•´):");
              console.log("-".repeat(80));
              console.log(commentBody);
              console.log("-".repeat(80));
              console.log("");

              // 1. Extract UI Spec comment URLs (æ”¯æŒå¤šä¸ª URL)
              // æ”¯æŒ GitHub è‡ªåŠ¨è½¬æ¢çš„ markdown é“¾æ¥æ ¼å¼: [#139 (comment)](https://...)
              const urlPattern = /https:\/\/github\.com\/[^\s\)]+\/issues\/\d+#issuecomment-\d+/g;
              const urlMatches = commentBody.match(urlPattern) || [];

              console.log(`ğŸ” æ‰¾åˆ° ${urlMatches.length} ä¸ª URL:`);
              urlMatches.forEach((url, idx) => {
                console.log(`  ${idx + 1}. ${url}`);
              });
              console.log("");

              if (urlMatches.length === 0) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body: [
                    "âŒ **ç¼ºå°‘è¯„è®º URL**",
                    "",
                    "ç”¨æ³•: `/agent-fe <github issue comment url-1> [<url-2> ...]`",
                    "",
                    "ç¤ºä¾‹ï¼ˆå•ä¸ª URLï¼‰:",
                    "```",
                    "/agent-fe https://github.com/owner/repo/issues/1#issuecomment-123456",
                    "è¯·ä½¿ç”¨æ·±è‰²ä¸»é¢˜",
                    "```",
                    "",
                    "ç¤ºä¾‹ï¼ˆå¤šä¸ª URLï¼‰:",
                    "```",
                    "/agent-fe \\",
                    "  https://github.com/owner/repo/issues/1#issuecomment-123456 \\",
                    "  https://github.com/owner/repo/issues/1#issuecomment-789012",
                    "```"
                  ].join("\n")
                });
                return;
              }

              // 1.1 Extract user instructions (text after URLs)
              let userInstructions = commentBody
                .replace(/\/agent-fe\s*/, "")
                .trim();
              
              // Remove all URLs from instructions
              urlMatches.forEach(url => {
                userInstructions = userInstructions.replace(url, "").trim();
              });

              console.log("ğŸ“Œ æå–çš„ç”¨æˆ·é¢å¤–æŒ‡ä»¤:");
              console.log("-".repeat(80));
              console.log(userInstructions || "(æ— )");
              console.log("-".repeat(80));
              console.log("");

              // 2. Fetch all UI Specs from multiple comments
              const uiSpecs = [];
              const commentUrls = [];
              
              for (const commentUrl of urlMatches) {
                try {
                  const commentId = commentUrl.split("#issuecomment-")[1];
                  console.log(`ğŸ“¥ è·å–è¯„è®ºå†…å®¹: ${commentUrl} (ID: ${commentId})`);
                  
                  const commentRes = await github.rest.issues.getComment({
                    owner,
                    repo,
                    comment_id: Number(commentId)
                  });

                  const specContent = commentRes.data.body;
                  uiSpecs.push({
                    url: commentUrl,
                    content: specContent,
                    title: specContent.split('\n')[0] || 'UI Spec'
                  });
                  commentUrls.push(commentUrl);
                  
                  console.log(`âœ… æˆåŠŸè·å–è¯„è®º ${commentId}, å†…å®¹é•¿åº¦: ${specContent.length}`);
                  console.log(`   æ ‡é¢˜: ${specContent.split('\n')[0] || '(æ— æ ‡é¢˜)'}`);
                  console.log(`   å†…å®¹é¢„è§ˆ: ${specContent.substring(0, 200)}${specContent.length > 200 ? '...' : ''}`);
                } catch (error) {
                  console.error(`âŒ è·å–è¯„è®ºå¤±è´¥ ${commentUrl}:`, error.message);
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number,
                    body: `âŒ **è·å–è¯„è®ºå¤±è´¥**: ${commentUrl}\n\né”™è¯¯: ${error.message}`
                  });
                  return;
                }
              }

              // 2.1 Combine all UI Specs
              const combinedUISpec = uiSpecs.map((spec, idx) => {
                return `## UI Spec ${idx + 1}: ${spec.title}\n\næ¥æº: ${spec.url}\n\n${spec.content}`;
              }).join("\n\n---\n\n");

              console.log(`ğŸ“‹ åˆå¹¶åçš„ UI Spec æ€»é•¿åº¦: ${combinedUISpec.length} å­—ç¬¦`);
              console.log(`ğŸ“‹ UI Spec å†…å®¹é¢„è§ˆ:`);
              console.log("-".repeat(80));
              console.log(combinedUISpec.substring(0, 500) + (combinedUISpec.length > 500 ? '\n...' : ''));
              console.log("-".repeat(80));
              console.log("");

              // Use first URL as primary reference (for backward compatibility)
              const commentUrl = commentUrls[0];

              // 2.1 Analyze requirements and generate todolist
              const analysisPrompt = `ä½ æ˜¯ä¸€ä¸ªå‰ç«¯éœ€æ±‚åˆ†æä¸“å®¶ã€‚è¯·åˆ†æä»¥ä¸‹ UI è§„æ ¼å’Œç”¨æˆ·æŒ‡ä»¤ï¼Œç”Ÿæˆéœ€æ±‚åˆ†æå’Œå¾…åŠæ¸…å•ã€‚

                UI è§„æ ¼æ¥æº${uiSpecs.length > 1 ? `ï¼ˆå…± ${uiSpecs.length} ä¸ªï¼‰` : ''}:
                ${commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n")}
                
                UI è§„æ ¼å†…å®¹:
                ${combinedUISpec}
                
                ${userInstructions ? `ç”¨æˆ·é¢å¤–æŒ‡ä»¤:\n${userInstructions}\n` : ""}è¯·è¿”å› JSON æ ¼å¼:
                {
                  "analysis": "éœ€æ±‚åˆ†ææ€»ç»“ï¼ˆ2-3å¥è¯ï¼‰",
                  "todolist": [
                    "å¾…åŠé¡¹1",
                    "å¾…åŠé¡¹2",
                    "å¾…åŠé¡¹3"
                  ]
                }
                
                åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚`;

              const analysisRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [
                    { role: "user", content: analysisPrompt }
                  ],
                  temperature: 0.3
                })
              });

              const analysisData = await analysisRes.json();
              const analysisRaw = analysisData.choices?.[0]?.message?.content;
              
              let analysisResult = { analysis: "", todolist: [] };
              if (analysisRaw) {
                console.log("ğŸ“Š éœ€æ±‚åˆ†æåŸå§‹å“åº”:");
                console.log("-".repeat(80));
                console.log(analysisRaw.substring(0, 500) + (analysisRaw.length > 500 ? '\n...' : ''));
                console.log("-".repeat(80));
                console.log("");
                
                let analysisJsonStr = analysisRaw.trim();
                const analysisJsonMatch = analysisJsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (analysisJsonMatch) {
                  analysisJsonStr = analysisJsonMatch[1].trim();
                }
                try {
                  analysisResult = JSON.parse(analysisJsonStr);
                  console.log("âœ… éœ€æ±‚åˆ†æè§£ææˆåŠŸ:");
                  console.log(`   åˆ†æ: ${analysisResult.analysis}`);
                  console.log(`   å¾…åŠæ¸…å•æ•°é‡: ${analysisResult.todolist.length}`);
                  analysisResult.todolist.forEach((item, idx) => {
                    console.log(`     ${idx + 1}. ${item}`);
                  });
                  console.log("");
                } catch (e) {
                  console.error("âŒ éœ€æ±‚åˆ†æè§£æå¤±è´¥:", e);
                  analysisResult.analysis = "éœ€æ±‚åˆ†æå®Œæˆ";
                  analysisResult.todolist = ["å®ç°å‰ç«¯ç•Œé¢"];
                }
              }

              // 2.2 Post analysis and todolist comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: [
                  "ğŸ“‹ **éœ€æ±‚åˆ†æå®Œæˆ**",
                  "",
                  `**å¤„ç†çš„ UI Spec (${uiSpecs.length} ä¸ª):**`,
                  commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n"),
                  "",
                  userInstructions ? `**ç”¨æˆ·é¢å¤–æŒ‡ä»¤:**\n${userInstructions}\n` : "",
                  "### éœ€æ±‚åˆ†æ",
                  analysisResult.analysis || "æ­£åœ¨åˆ†æéœ€æ±‚...",
                  "",
                  "### ğŸ“ å¾…åŠæ¸…å•",
                  analysisResult.todolist.map((item, idx) => `- [ ] ${item}`).join("\n"),
                  "",
                  "â³ å¼€å§‹ç”Ÿæˆä»£ç ..."
                ].join("\n")
              });

              // 3. Read frontend system files for project constraints
              // Read system files list from ARCHITECTURE.md
              const architectureDocPath = path.join(process.cwd(), "frontend/ARCHITECTURE.md");
              let frontendSystemFiles = [];
              
              if (fs.existsSync(architectureDocPath)) {
                const architectureDoc = fs.readFileSync(architectureDocPath, "utf8");
                // Extract system files list from markdown code block between markers
                const startMarker = "<!-- AGENT_SYSTEM_FILES_START -->";
                const endMarker = "<!-- AGENT_SYSTEM_FILES_END -->";
                const startIdx = architectureDoc.indexOf(startMarker);
                const endIdx = architectureDoc.indexOf(endMarker);
                
                if (startIdx !== -1 && endIdx !== -1) {
                  const filesSection = architectureDoc.substring(startIdx + startMarker.length, endIdx);
                  // Extract file paths from code block (lines starting with frontend/)
                  const fileLines = filesSection.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.startsWith('frontend/') && !line.startsWith('```'));
                  
                  frontendSystemFiles = fileLines;
                  console.log(`ğŸ“– ä» ARCHITECTURE.md è¯»å–åˆ° ${frontendSystemFiles.length} ä¸ªç³»ç»Ÿæ–‡ä»¶`);
                } else {
                  console.log("âš ï¸  ARCHITECTURE.md ä¸­æœªæ‰¾åˆ°ç³»ç»Ÿæ–‡ä»¶æ ‡è®°ï¼Œä½¿ç”¨é»˜è®¤åˆ—è¡¨");
                  // Fallback to default list
                  frontendSystemFiles = [
                    "frontend/package.json",
                    "frontend/tsconfig.json",
                    "frontend/tailwind.config.ts",
                    "frontend/components.json",
                    "frontend/middleware.ts",
                    "frontend/app/layout.tsx",
                    "frontend/app/page.tsx",
                    "frontend/app/globals.css",
                    "frontend/STYLE_GUIDE.md",
                    "frontend/lib/api/client.ts",
                    "frontend/lib/api/config.ts",
                    "frontend/lib/utils/utils.ts"
                  ];
                }
              } else {
                console.log("âš ï¸  ARCHITECTURE.md ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤ç³»ç»Ÿæ–‡ä»¶åˆ—è¡¨");
                  // Fallback to default list
                  frontendSystemFiles = [
                    "frontend/package.json",
                    "frontend/tsconfig.json",
                    "frontend/tailwind.config.ts",
                    "frontend/components.json",
                    "frontend/middleware.ts",
                    "frontend/app/layout.tsx",
                    "frontend/app/page.tsx",
                    "frontend/app/globals.css",
                    "frontend/STYLE_GUIDE.md",
                    "frontend/lib/api/client.ts",
                    "frontend/lib/api/config.ts",
                    "frontend/lib/utils/utils.ts"
                  ];
              }

              // 3.1 Read system files content
              const projectContext = {};
              const readFiles = [];

              for (const filePath of frontendSystemFiles) {
                try {
                  const fullPath = path.join(process.cwd(), filePath);
                  if (fs.existsSync(fullPath)) {
                    const content = fs.readFileSync(fullPath, "utf8");
                    projectContext[filePath] = content;
                    readFiles.push(filePath);
                    console.log(`âœ… è¯»å–ç³»ç»Ÿæ–‡ä»¶: ${filePath} (${content.length} å­—ç¬¦)`);
                  } else {
                    console.log(`âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: ${filePath}`);
                  }
                } catch (error) {
                  console.error(`âŒ è¯»å–æ–‡ä»¶å¤±è´¥ ${filePath}:`, error.message);
                }
              }

              console.log(`ğŸ“š å…±è¯»å– ${readFiles.length} ä¸ªç³»ç»Ÿæ–‡ä»¶ä½œä¸ºé¡¹ç›®çº¦æŸ`);
              console.log("");

              // 3.2 è¯»å– STYLE_GUIDE.md ä½œä¸ºè®¾è®¡è§„èŒƒ
              let styleGuideContent = '';
              const styleGuidePath = path.join(process.cwd(), "frontend/STYLE_GUIDE.md");
              if (fs.existsSync(styleGuidePath)) {
                styleGuideContent = fs.readFileSync(styleGuidePath, "utf8");
                console.log(`âœ… è¯»å–æ ·å¼æŒ‡å—: frontend/STYLE_GUIDE.md (${styleGuideContent.length} å­—ç¬¦)`);
              } else {
                console.log(`âš ï¸  æ ·å¼æŒ‡å—ä¸å­˜åœ¨: frontend/STYLE_GUIDE.md`);
              }

              // 3.3 Format project context
              const projectContextText = Object.entries(projectContext)
                .map(([filePath, content]) => {
                  const ext = filePath.split('.').pop();
                  const lang = ext === 'tsx' || ext === 'ts' ? 'typescript' : ext === 'json' ? 'json' : ext === 'css' ? 'css' : 'text';
                  return `## ${filePath}\n\`\`\`${lang}\n${content}\n\`\`\``;
                })
                .join("\n\n");

              // 4. Create new branch
              const branchName = `agent-fe-${issue_number}-${Date.now()}`;
              execSync(`git checkout -b ${branchName}`);

              // 5. Build system prompt and user prompt
              const systemPrompt = `You are the **Frontend Execution Agent**.
              
              Your task:
              Generate COMPLETE, BEAUTIFUL, POLISHED frontend code with **EXCELLENT VISUAL DESIGN** and output it in a MACHINE-PARSABLE FORMAT.
              
              âš ï¸ **CRITICAL: BEAUTIFUL UI IS MANDATORY**
              Your generated UI MUST be visually stunning, professional, and modern.
              DO NOT generate plain, boring, or unpolished interfaces.
              
              ====================
              ğŸ¨ VISUAL DESIGN RULES (HIGHEST PRIORITY)
              ====================
              - **shadcn/ui (New York style)**: Use Card, Button, Badge, Separator, Skeleton, Avatar, Tabs, Dialog, etc.
              - **Cards**: ALL content areas MUST use Card component with rounded-xl shadow-lg
              - **Shadows**: Apply shadow-md or shadow-lg to elevate important elements
              - **Rounded corners**: Use rounded-lg or rounded-xl for cards, rounded-md for inputs
              - **Spacing**: Use consistent gap-4, gap-6, p-4, p-6, p-8 for proper breathing room
              - **Hover effects**: ALL interactive elements MUST have hover states (hover:shadow-lg, hover:scale-[1.02])
              - **Transitions**: Use transition-all duration-200 for smooth animations
              - **Colors**: Use semantic colors (bg-background, text-foreground, bg-primary, text-muted-foreground)
              - **Typography**: Use font-medium, font-semibold for headings, text-sm text-muted-foreground for secondary text
              - **Icons**: Use Lucide React icons with proper sizing (w-4 h-4, w-5 h-5)
              - **Borders**: Use border border-border for subtle separation
              - **Focus states**: Input fields MUST have focus:ring-2 focus:ring-primary
              
              ====================
              RULES (STRICT)
              ====================
              - UI spec is a contract
              - No UI redesign
              - No extra features
              - No persistence
              - Single Page Interface
              - Next.js App Router
              - TypeScript strict
              - Tailwind CSS
              - shadcn/ui component library (MANDATORY - use components from @/components/ui/)
              - **DESIGN SYSTEM COMPLIANCE** - Follow the project's STYLE_GUIDE.md strictly
              - **Space Grotesk font** - Already configured in the project
              - **Lucide React icons** - Use for all iconography
              
              ====================
              PATH CONSTRAINTS (STRICT - NO EXCEPTIONS)
              ====================
              ALL file paths MUST start with "frontend/"
              You CANNOT create files outside the frontend/ directory.
              You CANNOT create files in backend/, root, or any other directory.
              
              CRITICAL FORBIDDEN PATHS:
              - âŒ "frontend/components/ui/" - COMPLETELY FORBIDDEN
              - This directory contains shadcn/ui components that are READ-ONLY
              - You MUST NOT create, modify, or delete ANY files in frontend/components/ui/
              - You can ONLY import and use components from @/components/ui/
              - If you need custom components, create them in frontend/components/ (outside ui/)
              
              - âŒ "frontend/app/globals.css" - COMPLETELY FORBIDDEN
              - This file contains global styles managed by project maintainers
              - You MUST NOT modify globals.css
              - If you need custom styles, create CSS files in your component directory:
                * Use CSS Modules: "frontend/components/my-component.module.css"
                * Or regular CSS: "frontend/components/my-component.css"
                * Import styles in your component file
              
              Examples:
              - âœ… "frontend/app/page.tsx"
              - âœ… "frontend/components/my-component.tsx"
              - âœ… "frontend/components/my-component.module.css" (component-specific styles)
              - âœ… "frontend/components/layout/header.tsx"
              - âœ… "frontend/components/layout/header.module.css" (layout-specific styles)
              - âŒ "frontend/components/ui/button.tsx" (REJECTED - ui/ is read-only)
              - âŒ "frontend/components/ui/custom-button.tsx" (REJECTED - ui/ is read-only)
              - âŒ "frontend/app/globals.css" (REJECTED - globals.css is read-only)
              - âŒ "app/page.tsx" (REJECTED - outside frontend/)
              - âŒ "components/button.tsx" (REJECTED - outside frontend/)
              - âŒ "backend/api/handler.go" (REJECTED - backend files not allowed)
              - âŒ "../frontend/app/page.tsx" (REJECTED - path traversal not allowed)
              
              ONLY files inside "frontend/" directory are allowed.
              "frontend/components/ui/" directory is STRICTLY FORBIDDEN.
              "frontend/app/globals.css" is STRICTLY FORBIDDEN.
              
              ====================
              OUTPUT FORMAT (MANDATORY - CRITICAL)
              ====================
              You MUST return ONLY valid JSON. No markdown code blocks, no explanations, no extra text.
              
              Required JSON structure:
              {
                "files": [
                  {
                    "path": "frontend/relative/path/to/file.tsx",
                    "content": "full file content"
                  }
                ]
              }
              
              CRITICAL RULES:
              - Start your response with { and end with }
              - Do NOT wrap JSON in markdown code blocks (no \`\`\`json)
              - Do NOT add any text before or after the JSON
              - Ensure all strings are properly escaped
              - Ensure all file paths start with "frontend/"
              
              Example of CORRECT output:
              {"files":[{"path":"frontend/app/page.tsx","content":"export default function Page() { return <div>Hello</div>; }"}]}
              
              Example of WRONG output (DO NOT DO THIS):
              ${'```'}json
              {"files":[...]}
              ${'```'}
              
              Return ONLY the JSON object, nothing else.`;
              
              const userPrompt = `
                ====================
                PROJECT ARCHITECTURE & CONSTRAINTS
                ====================
                ä»¥ä¸‹æ˜¯ä»ç°æœ‰ä»£ç åº“ä¸­è¯»å–çš„ç³»ç»Ÿæ–‡ä»¶ï¼Œè¯·ä¸¥æ ¼éµå¾ªè¿™äº›æ¶æ„æ¨¡å¼å’Œä»£ç é£æ ¼ï¼š
                
                ${projectContextText}
                
                ====================
                ğŸ“š STYLE GUIDEï¼ˆè®¾è®¡è§„èŒƒ - å¿…é¡»ä¸¥æ ¼éµå¾ªï¼‰
                ====================
                ${styleGuideContent || 'æœªæ‰¾åˆ° STYLE_GUIDE.md æ–‡ä»¶'}
                
                ====================
                ğŸ¨ DESIGN SYSTEM REQUIREMENTS (CRITICAL - ç¾è§‚æ€§è¦æ±‚)
                ====================
                
                âš ï¸ **é‡è¦è­¦å‘Š**ï¼šç”Ÿæˆçš„ UI å¿…é¡»æ˜¯**ç²¾ç¾çš„ã€ä¸“ä¸šçš„ã€ç°ä»£åŒ–çš„**ï¼
                ä¸è¦ç”Ÿæˆç®€é™‹ã€å•è°ƒã€ç¼ºä¹è®¾è®¡æ„Ÿçš„ç•Œé¢ï¼
                
                **UI æ¡†æ¶**ï¼š
                - ç»„ä»¶åº“: shadcn/ui (New York é£æ ¼) - å¿…é¡»ä½¿ç”¨ï¼
                - åŸºç¡€é¢œè‰²: Neutral
                - å›¾æ ‡åº“: Lucide React
                - å­—ä½“: Space Grotesk (ä¸»å­—ä½“)
                
                **é¢œè‰²ç³»ç»Ÿ**ï¼ˆæµ…è‰²ä¸»é¢˜ä¼˜å…ˆï¼‰ï¼š
                - èƒŒæ™¯ï¼šä½¿ç”¨ bg-backgroundï¼ˆç™½è‰² #FFFFFFï¼‰
                - å¡ç‰‡ï¼šä½¿ç”¨ bg-cardï¼ˆç™½è‰² #FFFFFFï¼‰
                - ä¸»è‰²ï¼šä½¿ç”¨ bg-primaryï¼ˆæ·±ç»¿è‰² #22C55Eï¼‰
                - æ–‡æœ¬ï¼šä½¿ç”¨ text-foregroundï¼ˆæ·±è‰² #0A0A0Aï¼‰
                - æ¬¡è¦æ–‡æœ¬ï¼šä½¿ç”¨ text-muted-foregroundï¼ˆç°è‰² #737373ï¼‰
                - è¾¹æ¡†ï¼šä½¿ç”¨ borderï¼ˆæµ…ç° #E5E5E5ï¼‰
                - âŒ ç¦æ­¢ç¡¬ç¼–ç é¢œè‰²å€¼ï¼Œå¿…é¡»ä½¿ç”¨è¯­ä¹‰åŒ– Tailwind ç±»
                
                **è§†è§‰å±‚æ¬¡ï¼ˆå¿…é¡»å®ç°ï¼‰**ï¼š
                - ä½¿ç”¨ Card ç»„ä»¶åˆ›å»ºå†…å®¹åŒºåŸŸï¼Œæ·»åŠ  shadow-md æˆ– shadow-lg é˜´å½±
                - ä½¿ç”¨ rounded-lg æˆ– rounded-xl åœ†è§’
                - ç»„ä»¶ä¹‹é—´ä½¿ç”¨ gap-4ã€gap-6 ç­‰é—´è·
                - ä½¿ç”¨ hover:shadow-lgã€hover:scale-[1.02] ç­‰æ‚¬åœæ•ˆæœ
                - ä½¿ç”¨ transition-all duration-200 å®ç°å¹³æ»‘è¿‡æ¸¡
                
                **äº¤äº’åé¦ˆï¼ˆå¿…é¡»å®ç°ï¼‰**ï¼š
                - æ‰€æœ‰å¯ç‚¹å‡»å…ƒç´ å¿…é¡»æœ‰ hover çŠ¶æ€å˜åŒ–
                - è¾“å…¥æ¡†å¿…é¡»æœ‰ focus:ring-2 focus:ring-primary ç„¦ç‚¹çŠ¶æ€
                - æŒ‰é’®å¿…é¡»æœ‰ active:scale-95 ç‚¹å‡»åé¦ˆ
                - åŠ è½½çŠ¶æ€ä½¿ç”¨ Skeleton ç»„ä»¶æˆ– Spinner
                
                **å¸ƒå±€è§„èŒƒ**ï¼š
                - ä½¿ç”¨ flexã€grid å¸ƒå±€ï¼Œç¦æ­¢ä½¿ç”¨ position: relative ä½œä¸ºä¸»å¸ƒå±€
                - å“åº”å¼è®¾è®¡ï¼šä½¿ç”¨ sm:ã€md:ã€lg:ã€xl: å‰ç¼€
                - å®¹å™¨ä½¿ç”¨ max-w-7xl mx-auto px-4 sm:px-6 lg:px-8
                - å†…å®¹åŒºåŸŸä½¿ç”¨é€‚å½“çš„ paddingï¼šp-4ã€p-6ã€p-8
                
                **å›¾æ ‡ä½¿ç”¨**ï¼š
                - ä½¿ç”¨ Lucide React å›¾æ ‡åº“
                - å›¾æ ‡å¤§å°ï¼šw-4 h-4 (16px)ã€w-5 h-5 (20px)ã€w-6 h-6 (24px)
                - å›¾æ ‡é¢œè‰²ï¼šä½¿ç”¨ text-muted-foreground æˆ– text-foreground
                - é…åˆæ–‡æœ¬æ—¶ä½¿ç”¨ inline-flex items-center gap-2
                
                **ç»„ä»¶ä½¿ç”¨è§„èŒƒ**ï¼š
                - å¿…é¡»ä» @/components/ui/ å¯¼å…¥ shadcn/ui ç»„ä»¶
                - Cardã€Buttonã€Inputã€Badgeã€Separatorã€Skeleton ç­‰ç»„ä»¶å¿…é¡»ä½¿ç”¨
                - ä½¿ç”¨ cn() å·¥å…·å‡½æ•°åˆå¹¶ç±»å
                - è¡¨å•ä½¿ç”¨ react-hook-form + zod éªŒè¯
                
                **åŠ¨ç”»å’Œè¿‡æ¸¡**ï¼š
                - é¡µé¢åŠ è½½ä½¿ç”¨ staggered animationï¼ˆå»¶è¿ŸåŠ¨ç”»ï¼‰
                - åˆ—è¡¨é¡¹ä½¿ç”¨ animate-in fade-in slide-in-from-bottom
                - æ‚¬åœæ•ˆæœä½¿ç”¨ transition-all duration-200 ease-in-out
                - ç¦ç”¨åŠ¨ç”»ä½¿ç”¨ motion-reduce:transition-none
                
                ğŸ¯ **ç¾è§‚æ€§æ£€æŸ¥æ¸…å•**ï¼ˆå¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼‰ï¼š
                - [ ] æ‰€æœ‰å¡ç‰‡æœ‰åœ†è§’å’Œé˜´å½±
                - [ ] æ‰€æœ‰æŒ‰é’®æœ‰æ‚¬åœæ•ˆæœ
                - [ ] æ–‡æœ¬æœ‰åˆé€‚çš„å­—ä½“å¤§å°å’Œé¢œè‰²å±‚æ¬¡
                - [ ] å›¾æ ‡ä¸æ–‡æœ¬å¯¹é½ä¸”å¤§å°åˆé€‚
                - [ ] é—´è·å‡åŒ€ï¼Œå¸ƒå±€æ•´æ´
                - [ ] å“åº”å¼è®¾è®¡åœ¨å„å°ºå¯¸ä¸‹éƒ½ç¾è§‚
                - [ ] åŠ è½½çŠ¶æ€æœ‰ skeleton æˆ– spinner
                - [ ] ç©ºçŠ¶æ€æœ‰å‹å¥½çš„æç¤º
                
                ====================
                SOURCE OF TRUTH${uiSpecs.length > 1 ? ` (${uiSpecs.length} UI Specs)` : ''}
                ====================
                ${commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n")}
                
                ${combinedUISpec}
                
                ${userInstructions ? `====================
                USER INSTRUCTIONS
                ====================
                ${userInstructions}` : ""}
                
                ${analysisResult.todolist.length > 0 ? `====================
                TODO LIST (å‚è€ƒ)
                ====================
                ${analysisResult.todolist.map((item, idx) => `${idx + 1}. ${item}`).join("\n")}` : ""}
                
                ====================
                âš¡ IMPLEMENTATION REQUIREMENTS
                ====================
                
                ğŸ¯ **æ ¸å¿ƒåŸåˆ™ï¼šç”Ÿæˆçš„ UI å¿…é¡»æ˜¯ç²¾ç¾çš„ã€ä¸“ä¸šçš„ã€ç°ä»£åŒ–çš„ï¼**
                
                1. **éµå¾ªé¡¹ç›®æ¶æ„**ï¼š
                   - éµå¾ªç°æœ‰ä»£ç æ¶æ„æ¨¡å¼ï¼ˆå‚è€ƒä¸Šé¢çš„ç³»ç»Ÿæ–‡ä»¶ï¼‰
                   - ä½¿ç”¨ç›¸åŒçš„åŒ…ç»“æ„å’Œå‘½åçº¦å®š
                   - éµå¾ªç›¸åŒçš„ä»£ç é£æ ¼å’Œ TypeScript ç±»å‹å®šä¹‰
                   - ä½¿ç”¨ç›¸åŒçš„å·¥å…·å‡½æ•°å’Œ Hooks
                   - éµå¾ªç›¸åŒçš„ API è°ƒç”¨æ¨¡å¼
                
                2. **å¿…é¡»ä½¿ç”¨ shadcn/ui ç»„ä»¶åº“ï¼ˆNew York é£æ ¼ï¼‰**ï¼š
                   - ä» @/components/ui/ å¯¼å…¥ç»„ä»¶ï¼ˆå¦‚ Button, Input, Card, Badge, Dialog ç­‰ï¼‰
                   - å¸¸ç”¨ç»„ä»¶ï¼šCard, Button, Input, Badge, Separator, Skeleton, Avatar, Tabs
                   - **ä¸¥ç¦ä¿®æ”¹æˆ–åˆ›å»º frontend/components/ui/ ç›®å½•ä¸‹çš„ä»»ä½•æ–‡ä»¶**
                   - å¦‚æœéœ€è¦è‡ªå®šä¹‰ç»„ä»¶ï¼Œåœ¨ frontend/components/ ç›®å½•ä¸‹åˆ›å»ºï¼ˆä¸åœ¨ ui/ å­ç›®å½•ï¼‰
                   - ä½¿ç”¨ cn() å·¥å…·å‡½æ•°åˆå¹¶ç±»å
                
                3. **å¿…é¡»ä¸¥æ ¼éµå¾ª STYLE_GUIDE.md è®¾è®¡è§„èŒƒ**ï¼š
                   - ä½¿ç”¨è¯­ä¹‰åŒ–é¢œè‰²ç±»ï¼šbg-background, text-foreground, bg-primary ç­‰
                   - ä½¿ç”¨é¡¹ç›®é¢œè‰²æ–¹æ¡ˆï¼šæµ…è‰²ä¸»é¢˜ä¼˜å…ˆï¼Œç»¿è‰²ä¸»è‰²è°ƒ
                   - ä½¿ç”¨ Space Grotesk å­—ä½“ï¼ˆå·²åœ¨é¡¹ç›®ä¸­é…ç½®ï¼‰
                   - ä½¿ç”¨ Lucide React å›¾æ ‡åº“
                
                4. **ğŸ¨ ç¾è§‚æ€§è¦æ±‚ï¼ˆå…³é”® - å¿…é¡»ä¸¥æ ¼æ‰§è¡Œï¼‰**ï¼š
                   
                   ğŸ“¦ **å¡ç‰‡å’Œå®¹å™¨**ï¼š
                   - æ‰€æœ‰å†…å®¹åŒºåŸŸä½¿ç”¨ Card ç»„ä»¶åŒ…è£…
                   - å¡ç‰‡å¿…é¡»æœ‰åœ†è§’ï¼šrounded-lg æˆ– rounded-xl
                   - å¡ç‰‡å¿…é¡»æœ‰é˜´å½±ï¼šshadow-md æˆ– shadow-lg
                   - å¡ç‰‡æ‚¬åœæ•ˆæœï¼šhover:shadow-xl transition-shadow
                   
                   ğŸ­ **äº¤äº’æ•ˆæœ**ï¼š
                   - æŒ‰é’®æ‚¬åœï¼šhover:bg-primary/90 æˆ– hover:scale-105
                   - å¡ç‰‡æ‚¬åœï¼šhover:shadow-lg hover:scale-[1.02]
                   - è¾“å…¥æ¡†ç„¦ç‚¹ï¼šfocus:ring-2 focus:ring-primary
                   - è¿‡æ¸¡åŠ¨ç”»ï¼štransition-all duration-200 ease-in-out
                   
                   ğŸ“ **é—´è·å’Œå¸ƒå±€**ï¼š
                   - å®¹å™¨å†…è¾¹è·ï¼šp-4ã€p-6ã€p-8
                   - å…ƒç´ é—´è·ï¼šgap-2ã€gap-4ã€gap-6
                   - æœ€å¤§å®½åº¦ï¼šmax-w-7xl mx-auto
                   - å“åº”å¼å†…è¾¹è·ï¼špx-4 sm:px-6 lg:px-8
                   
                   ğŸ¨ **é¢œè‰²å’Œå¯¹æ¯”**ï¼š
                   - ä¸»æ–‡æœ¬ï¼štext-foreground
                   - æ¬¡è¦æ–‡æœ¬ï¼štext-muted-foreground
                   - è¾¹æ¡†ï¼šborder border-border
                   - åˆ†éš”çº¿ï¼š<Separator className="my-4" />
                   
                   âœ¨ **åŠ¨ç”»æ•ˆæœ**ï¼š
                   - é¡µé¢åŠ è½½åŠ¨ç”»ï¼šanimate-in fade-in duration-500
                   - åˆ—è¡¨é¡¹æ¸å…¥ï¼šanimate-in slide-in-from-bottom-4
                   - éª¨æ¶å±åŠ è½½ï¼š<Skeleton className="h-4 w-full" />
                   
                   ğŸ“± **å“åº”å¼è®¾è®¡**ï¼š
                   - ä½¿ç”¨ sm:ã€md:ã€lg:ã€xl: å‰ç¼€
                   - ç§»åŠ¨ç«¯ä¼˜å…ˆï¼šw-full md:w-1/2 lg:w-1/3
                   - ç½‘æ ¼å¸ƒå±€ï¼šgrid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4
                
                5. **æ ·å¼æ–‡ä»¶ç®¡ç†**ï¼š
                   - **ä¸¥ç¦ä¿®æ”¹ frontend/app/globals.css æ–‡ä»¶**
                   - ä¼˜å…ˆä½¿ç”¨ Tailwind CSS å·¥å…·ç±»
                   - å¦‚æœéœ€è¦è‡ªå®šä¹‰æ ·å¼ï¼Œåœ¨ç»„ä»¶ç›®å½•ä¸‹åˆ›å»º CSS Modules
                
                6. **ç¦æ­¢ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
                   - frontend/app/globals.cssï¼ˆå…¨å±€æ ·å¼æ–‡ä»¶ï¼Œåªè¯»ï¼‰
                   - frontend/components/ui/*ï¼ˆshadcn/ui ç»„ä»¶ï¼Œåªè¯»ï¼‰
                
                7. **æ‰€æœ‰æ–‡ä»¶è·¯å¾„å¿…é¡»åœ¨ frontend/ ç›®å½•ä¸‹**`;

              // 5. Call model
              const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "anthropic/claude-sonnet-4.5",
                  messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                  ],
                  temperature: 0.3
                })
              });

              const data = await res.json();
              const raw = data.choices?.[0]?.message?.content;

              if (!raw) {
                console.error("âŒ Model returned empty response.");
                console.error("Response data:", JSON.stringify(data, null, 2));
                throw new Error("Model returned empty response.");
              }

              console.log("ğŸ“ Model raw response length:", raw.length);
              console.log("ğŸ“ Model raw response preview (first 500 chars):");
              console.log("-".repeat(80));
              console.log(raw.substring(0, 500));
              console.log("-".repeat(80));

              // 5.1 Extract JSON from possible markdown code block or find JSON object
              let jsonStr = raw.trim();
              
              console.log("ğŸ“ Model raw response length:", raw.length);
              console.log("ğŸ“ Model raw response preview (first 1000 chars):");
              console.log("-".repeat(80));
              console.log(raw.substring(0, 1000));
              console.log("-".repeat(80));
              
              // Try to extract from markdown code block first
              const jsonMatch = jsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
              if (jsonMatch) {
                jsonStr = jsonMatch[1].trim();
                console.log("âœ… Extracted JSON from markdown code block");
              } else {
                // Try to find JSON object by finding first { and last }
                const firstBrace = jsonStr.indexOf('{');
                const lastBrace = jsonStr.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                  jsonStr = jsonStr.substring(firstBrace, lastBrace + 1);
                  console.log("âœ… Extracted JSON object from text");
                } else {
                  console.log("âš ï¸  No JSON structure found, using raw content");
                }
              }

              console.log("ğŸ“„ JSON string length:", jsonStr.length);
              console.log("ğŸ“„ JSON string preview (first 1000 chars):");
              console.log("-".repeat(80));
              console.log(jsonStr.substring(0, 1000));
              console.log("-".repeat(80));
              console.log("ğŸ“„ JSON string preview (last 500 chars):");
              console.log("-".repeat(80));
              console.log(jsonStr.substring(Math.max(0, jsonStr.length - 500)));
              console.log("-".repeat(80));

              let parsed;
              try {
                parsed = JSON.parse(jsonStr);
                console.log("âœ… JSON parsed successfully");
                console.log(`ğŸ“¦ Parsed object has ${parsed.files?.length || 0} files`);
              } catch (parseError) {
                console.error("âŒ JSON parse error:", parseError.message);
                console.error("âŒ Error position:", parseError.message.match(/position (\d+)/)?.[1] || "unknown");
                console.error("âŒ JSON string (full, length:", jsonStr.length, "chars):");
                console.error("-".repeat(80));
                console.error(jsonStr);
                console.error("-".repeat(80));
                
                // Try to fix common JSON issues
                let fixedJson = jsonStr;
                let fixed = false;
                
                // Remove trailing commas before } or ]
                fixedJson = fixedJson.replace(/,(\s*[}\]])/g, '$1');
                if (fixedJson !== jsonStr) {
                  fixed = true;
                  console.log("ğŸ”§ Attempted fix: Removed trailing commas");
                }
                
                // Try parsing fixed JSON
                if (fixed) {
                  try {
                    parsed = JSON.parse(fixedJson);
                    console.log("âœ… Fixed JSON parsed successfully");
                    console.log(`ğŸ“¦ Parsed object has ${parsed.files?.length || 0} files`);
                  } catch (fixError) {
                    console.error("âŒ Fixed JSON still invalid:", fixError.message);
                    throw new Error(`Model output is not valid JSON: ${parseError.message}. Fixed version also failed: ${fixError.message}`);
                  }
                } else {
                  throw new Error(`Model output is not valid JSON: ${parseError.message}`);
                }
              }

              // 6. Write files with path validation
              const generatedFiles = [];
              const fileChanges = {
                created: [],
                modified: [],
                errors: []
              };
              
              for (const file of parsed.files) {
                // 6.1 Validate path - STRICT: ONLY frontend/ directory allowed
                let normalizedPath = file.path.trim();
                
                // Remove leading slash if present
                if (normalizedPath.startsWith("/")) {
                  normalizedPath = normalizedPath.substring(1);
                }
                
                // STRICT CHECK: Path MUST start with "frontend/" - NO AUTO-FIX
                if (!normalizedPath.startsWith("frontend/")) {
                  fileChanges.errors.push(`è·¯å¾„è¢«æ‹’ç»: ${file.path} - åªå…è®¸åœ¨ frontend/ ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶`);
                  continue;
                }
                
                // CRITICAL: FORBIDDEN PATH - components/ui/ directory is READ-ONLY
                // shadcn/ui components MUST NOT be modified, only imported and used
                if (normalizedPath.startsWith("frontend/components/ui/")) {
                  fileChanges.errors.push(`è·¯å¾„è¢«æ‹’ç»: ${file.path} - components/ui/ ç›®å½•ä¸‹çš„æ–‡ä»¶æ˜¯åªè¯»çš„ï¼Œç¦æ­¢ä¿®æ”¹ã€‚åªèƒ½ä» @/components/ui/ å¯¼å…¥ä½¿ç”¨ï¼Œä¸èƒ½ä¿®æ”¹æˆ–åˆ›å»ºæ–°æ–‡ä»¶ã€‚`);
                  continue;
                }
                
                // CRITICAL: FORBIDDEN FILE - globals.css is READ-ONLY
                // Global styles are managed by the project maintainers
                if (normalizedPath === "frontend/app/globals.css" || normalizedPath.endsWith("/globals.css")) {
                  fileChanges.errors.push(`è·¯å¾„è¢«æ‹’ç»: ${file.path} - globals.css æ–‡ä»¶æ˜¯åªè¯»çš„ï¼Œç¦æ­¢ä¿®æ”¹ã€‚å¦‚æœéœ€è¦è‡ªå®šä¹‰æ ·å¼ï¼Œè¯·åœ¨ç»„ä»¶ç›®å½•ä¸‹åˆ›å»ºç‹¬ç«‹çš„ CSS æ–‡ä»¶ï¼ˆå¦‚ component.module.css æˆ– component.cssï¼‰ã€‚`);
                  continue;
                }
                
                // Prevent path traversal attacks (even within frontend/)
                if (normalizedPath.includes("../") || normalizedPath.includes("..\\")) {
                  fileChanges.errors.push(`è·¯å¾„ä¸å®‰å…¨: ${file.path} - ä¸å…è®¸ä½¿ç”¨è·¯å¾„éå†`);
                  continue;
                }
                
                // Additional check: ensure normalized path is still within frontend/
                // This prevents paths like "frontend/../../other-dir/file"
                const pathParts = normalizedPath.split('/');
                if (pathParts[0] !== "frontend" || pathParts.includes("..")) {
                  fileChanges.errors.push(`è·¯å¾„æ— æ•ˆ: ${file.path} - å¿…é¡»åœ¨ frontend/ ç›®å½•å†…`);
                  continue;
                }
                
                const fullPath = path.join(process.cwd(), normalizedPath);
                
                // Check if file already exists
                const fileExists = fs.existsSync(fullPath);
                
                try {
                  fs.mkdirSync(path.dirname(fullPath), { recursive: true });
                  fs.writeFileSync(fullPath, file.content, "utf8");
                  generatedFiles.push(normalizedPath);
                  
                  if (fileExists) {
                    fileChanges.modified.push(normalizedPath);
                  } else {
                    fileChanges.created.push(normalizedPath);
                  }
                } catch (error) {
                  fileChanges.errors.push(`å†™å…¥å¤±è´¥: ${normalizedPath} - ${error.message}`);
                }
              }

              // 6.1 Analyze completion status (before recording changelog)
              const completionPrompt = `è¯·åˆ†æä»¥ä¸‹å†…å®¹ï¼Œå¯¹æ¯”å¾…åŠæ¸…å•å’Œå®é™…å®Œæˆæƒ…å†µã€‚

              å¾…åŠæ¸…å•:
              ${analysisResult.todolist.map((item, idx) => `${idx + 1}. ${item}`).join("\n")}
              
              å®é™…ç”Ÿæˆçš„æ–‡ä»¶:
              ${generatedFiles.map((f, idx) => `${idx + 1}. ${f}`).join("\n")}
              
              è¯·è¿”å› JSON æ ¼å¼:
              {
                "completed": ["å·²å®Œæˆé¡¹1", "å·²å®Œæˆé¡¹2"],
                "notCompleted": ["æœªå®Œæˆé¡¹1", "æœªå®Œæˆé¡¹2"],
                "summary": "å®Œæˆæƒ…å†µæ€»ç»“ï¼ˆ1-2å¥è¯ï¼‰"
              }
              
              åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚`;

              const completionRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [
                    { role: "user", content: completionPrompt }
                  ],
                  temperature: 0.3
                })
              });

              const completionData = await completionRes.json();
              const completionRaw = completionData.choices?.[0]?.message?.content;
              
              let completionStatus = { completed: [], notCompleted: [], summary: "" };
              if (completionRaw) {
                let completionJsonStr = completionRaw.trim();
                const completionJsonMatch = completionJsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (completionJsonMatch) {
                  completionJsonStr = completionJsonMatch[1].trim();
                }
                try {
                  completionStatus = JSON.parse(completionJsonStr);
                } catch (e) {
                  console.error("Failed to parse completion JSON:", e);
                  completionStatus.completed = analysisResult.todolist;
                  completionStatus.summary = "ä»£ç å·²ç”Ÿæˆ";
                }
              }

              // 6.2 Record changes to changelog
              const changelogPath = path.join(process.cwd(), "frontend/AGENT_CHANGELOG.md");
              const timestamp = new Date().toISOString();
              const changelogEntry = [
                `## ${timestamp} - Issue #${issue_number}`,
                "",
                `**UI Spec${uiSpecs.length > 1 ? 's' : ''} (${uiSpecs.length}):**`,
                commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n"),
                userInstructions ? `**ç”¨æˆ·æŒ‡ä»¤:** ${userInstructions}` : "",
                "",
                "### ğŸ“ éœ€æ±‚åˆ†æ",
                analysisResult.analysis || "éœ€æ±‚åˆ†æå®Œæˆ",
                "",
                "### âœ… å·²å®Œæˆ",
                completionStatus.completed.length > 0
                  ? completionStatus.completed.map(item => `- ${item}`).join("\n")
                  : "- ä»£ç å·²ç”Ÿæˆ",
                "",
                completionStatus.notCompleted.length > 0 ? [
                  "### âŒ æœªå®Œæˆ",
                  completionStatus.notCompleted.map(item => `- ${item}`).join("\n"),
                  ""
                ].join("\n") : "",
                "### ğŸ“ æ–‡ä»¶å˜æ›´",
                "",
                `**æ–°å»ºæ–‡ä»¶ (${fileChanges.created.length}):**`,
                fileChanges.created.length > 0
                  ? fileChanges.created.map(f => `- \`${f}\``).join("\n")
                  : "- æ— ",
                "",
                `**ä¿®æ”¹æ–‡ä»¶ (${fileChanges.modified.length}):**`,
                fileChanges.modified.length > 0
                  ? fileChanges.modified.map(f => `- \`${f}\``).join("\n")
                  : "- æ— ",
                "",
                fileChanges.errors.length > 0 ? [
                  `**é”™è¯¯ (${fileChanges.errors.length}):**`,
                  fileChanges.errors.map(e => `- âš ï¸ ${e}`).join("\n"),
                  ""
                ].join("\n") : "",
                "---",
                ""
              ].join("\n");
              
              // Read existing changelog or create new one
              let changelogContent = "";
              if (fs.existsSync(changelogPath)) {
                changelogContent = fs.readFileSync(changelogPath, "utf8");
              } else {
                changelogContent = [
                  "# Frontend Agent å˜æ›´æ—¥å¿—",
                  "",
                  "æ­¤æ–‡ä»¶ç”± Frontend Agent è‡ªåŠ¨ç”Ÿæˆå’Œç»´æŠ¤ï¼Œè®°å½•æ‰€æœ‰ä»£ç å˜æ›´å†å²ã€‚",
                  "",
                  "---",
                  ""
                ].join("\n");
              }
              
              // Prepend new entry
              const updatedChangelog = changelogEntry + changelogContent;
              fs.writeFileSync(changelogPath, updatedChangelog, "utf8");
              
              // Add changelog to generated files if it's new or modified
              if (!generatedFiles.includes("frontend/AGENT_CHANGELOG.md")) {
                generatedFiles.push("frontend/AGENT_CHANGELOG.md");
                fileChanges.created.push("frontend/AGENT_CHANGELOG.md");
              } else if (!fileChanges.modified.includes("frontend/AGENT_CHANGELOG.md")) {
                fileChanges.modified.push("frontend/AGENT_CHANGELOG.md");
              }

              // 6.3 Update ARCHITECTURE.md if directory structure or constraints changed
              if (fs.existsSync(architectureDocPath)) {
                // Analyze if there are new important system files or directory structure changes
                const newSystemFiles = [];
                const newDirectories = new Set();
                
                // Check created files for potential system files
                for (const file of fileChanges.created) {
                  // Check if it's a configuration file or important system file
                  const fileName = path.basename(file);
                  const isConfigFile = fileName.includes('config') || 
                                      fileName.includes('package.json') || 
                                      fileName.includes('tsconfig') ||
                                      fileName.includes('tailwind') ||
                                      fileName.includes('middleware') ||
                                      fileName.includes('layout') ||
                                      fileName === 'page.tsx' ||
                                      fileName === 'globals.css' ||
                                      fileName === 'components.json';
                  
                  // Check if it's in a key directory (system-level files)
                  const isKeyDir = file.includes('/lib/api/') ||
                                  file.includes('/lib/utils/') ||
                                  file.includes('/lib/config/') ||
                                  file.includes('/lib/constants/') ||
                                  file.includes('/types/') ||
                                  file.includes('/hooks/');
                  
                  // Check if it's a root-level important file
                  const isRootFile = file === 'frontend/middleware.ts' ||
                                     file === 'frontend/components.json' ||
                                     file === 'frontend/tailwind.config.ts' ||
                                     file === 'frontend/tsconfig.json' ||
                                     file === 'frontend/package.json' ||
                                     file.startsWith('frontend/app/layout') ||
                                     file.startsWith('frontend/app/page') ||
                                     file.startsWith('frontend/app/globals');
                  
                  if (isConfigFile || isKeyDir || isRootFile) {
                    newSystemFiles.push(file);
                  }
                  
                  // Track new directories
                  const dirPath = path.dirname(file);
                  if (dirPath !== 'frontend' && dirPath.startsWith('frontend/')) {
                    newDirectories.add(dirPath);
                  }
                }
                
                // If there are new system files or significant changes, update ARCHITECTURE.md
                if (newSystemFiles.length > 0 || fileChanges.created.length > 5) {
                  console.log(`ğŸ“ æ£€æµ‹åˆ°æ¶æ„å˜åŒ–ï¼Œå‡†å¤‡æ›´æ–° ARCHITECTURE.md`);
                  console.log(`   æ–°ç³»ç»Ÿæ–‡ä»¶: ${newSystemFiles.length} ä¸ª`);
                  console.log(`   æ–°ç›®å½•: ${newDirectories.size} ä¸ª`);
                  
                  // Read current ARCHITECTURE.md
                  let architectureContent = fs.readFileSync(architectureDocPath, "utf8");
                  
                  // Extract current system files list
                  const startMarker = "<!-- AGENT_SYSTEM_FILES_START -->";
                  const endMarker = "<!-- AGENT_SYSTEM_FILES_END -->";
                  const startIdx = architectureContent.indexOf(startMarker);
                  const endIdx = architectureContent.indexOf(endMarker);
                  
                  if (startIdx !== -1 && endIdx !== -1) {
                    // Get current system files
                    const currentFilesSection = architectureContent.substring(startIdx + startMarker.length, endIdx);
                    const currentFiles = currentFilesSection.split('\n')
                      .map(line => line.trim())
                      .filter(line => line.startsWith('frontend/') && !line.startsWith('```'));
                    
                    // Merge with new system files (avoid duplicates)
                    const allSystemFiles = [...new Set([...currentFiles, ...newSystemFiles])].sort();
                    
                    // Update system files list
                    const newFilesSection = `\n\`\`\`\n${allSystemFiles.join('\n')}\n\`\`\`\n`;
                    const updatedArchitecture = 
                      architectureContent.substring(0, startIdx + startMarker.length) +
                      newFilesSection +
                      architectureContent.substring(endIdx);
                    
                    fs.writeFileSync(architectureDocPath, updatedArchitecture, "utf8");
                    console.log(`âœ… å·²æ›´æ–° ARCHITECTURE.md ç³»ç»Ÿæ–‡ä»¶åˆ—è¡¨ï¼ˆå…± ${allSystemFiles.length} ä¸ªæ–‡ä»¶ï¼‰`);
                    
                    // Add to file changes if not already tracked
                    if (!fileChanges.modified.includes("frontend/ARCHITECTURE.md")) {
                      fileChanges.modified.push("frontend/ARCHITECTURE.md");
                    }
                  }
                }
              }

              // 7. Commit changes
              execSync("git add .");
              execSync(`git commit -m "feat: implement frontend from frozen UI spec (#${issue_number})"`);
              execSync(`git push origin ${branchName}`);

              // 8. Create PR
              const pr = await github.rest.pulls.create({
                owner,
                repo,
                title: `Frontend: implement frozen UI spec (#${issue_number})`,
                head: branchName,
                base: "main",
                body: [
                  "This PR was generated by Vibe Frontend Agent.",
                  "",
                  `**UI Spec Source${uiSpecs.length > 1 ? 's' : ''} (${uiSpecs.length}):**`,
                  commentUrls.map(url => `- ${url}`).join("\n"),
                  "",
                  userInstructions ? `**User Instructions:**\n${userInstructions}\n` : "",
                  "### å®Œæˆæƒ…å†µ",
                  completionStatus.summary || "ä»£ç å·²ç”Ÿæˆ",
                  "",
                  "**å·²å®Œæˆ:**",
                  completionStatus.completed.map(item => `- âœ… ${item}`).join("\n") || "- ä»£ç å·²ç”Ÿæˆ",
                  "",
                  completionStatus.notCompleted.length > 0 ? [
                    "**æœªå®Œæˆ:**",
                    completionStatus.notCompleted.map(item => `- âŒ ${item}`).join("\n"),
                    ""
                  ].join("\n") : "",
                  "- UI spec treated as immutable contract",
                  "- No UI inference or redesign",
                  "- Ready for review"
                ].join("\n")
              });

              // 9. Comment back to issue
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: [
                  "âœ… **Frontend implementation completed**",
                  "",
                  `ğŸ”— PR: ${pr.data.html_url}`,
                  "",
                  `**å¤„ç†çš„ UI Spec (${uiSpecs.length} ä¸ª):**`,
                  commentUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n"),
                  "",
                  "### ğŸ“Š å®Œæˆæƒ…å†µ",
                  completionStatus.summary || "ä»£ç å·²ç”Ÿæˆå¹¶æäº¤",
                  "",
                  "**âœ… å·²å®Œæˆ:**",
                  completionStatus.completed.length > 0 
                    ? completionStatus.completed.map(item => `- ${item}`).join("\n")
                    : "- ä»£ç å·²ç”Ÿæˆ",
                  "",
                  completionStatus.notCompleted.length > 0 ? [
                    "**âŒ æœªå®Œæˆ:**",
                    completionStatus.notCompleted.map(item => `- ${item}`).join("\n"),
                    ""
                  ].join("\n") : "",
                  "**ğŸ“ æ–‡ä»¶å˜æ›´:**",
                  "",
                  `**æ–°å»º (${fileChanges.created.length}):**`,
                  fileChanges.created.length > 0
                    ? fileChanges.created.map(f => `- \`${f}\``).join("\n")
                    : "- æ— ",
                  "",
                  `**ä¿®æ”¹ (${fileChanges.modified.length}):**`,
                  fileChanges.modified.length > 0
                    ? fileChanges.modified.map(f => `- \`${f}\``).join("\n")
                    : "- æ— ",
                  "",
                  fileChanges.errors.length > 0 ? [
                    "**âš ï¸ é”™è¯¯:**",
                    fileChanges.errors.map(e => `- ${e}`).join("\n"),
                    ""
                  ].join("\n") : "",
                  "**ğŸ“ å˜æ›´æ—¥å¿—:**",
                  `æ‰€æœ‰å˜æ›´å·²è®°å½•åˆ° \`frontend/AGENT_CHANGELOG.md\``,
                  "",
                  "**ğŸ“š é¡¹ç›®çº¦æŸ:**",
                  `å·²è¯»å– ${readFiles.length} ä¸ªç³»ç»Ÿæ–‡ä»¶ä½œä¸ºæ¶æ„å‚è€ƒ`,
                  "",
                  "---",
                  "Notes:",
                  "- âœ… ä¸¥æ ¼è·¯å¾„çº¦æŸï¼šæ‰€æœ‰æ–‡ä»¶ä»…åœ¨ `frontend/` ç›®å½•ä¸‹",
                  "- âœ… ç¦æ­¢åœ¨ `frontend/` ç›®å½•å¤–åˆ›å»ºä»»ä½•æ–‡ä»¶",
                  "- âœ… éµå¾ªç°æœ‰é¡¹ç›®æ¶æ„æ¨¡å¼",
                  "- âœ… å˜æ›´å†å²å·²è®°å½•åˆ° `frontend/AGENT_CHANGELOG.md`",
                  "- Frontend code generated and committed",
                  "- UI spec respected strictly",
                  "- No persistence added"
                ].join("\n")
              });
            }

            await runFrontendAgent();
