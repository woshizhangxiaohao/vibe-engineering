name: Fix PR Build Errors

on:
  issue_comment:
    types: [created]

jobs:
  fix-build-errors:
    # åªåœ¨ PR è¯„è®ºä¸­åŒ…å« /fix æ—¶è§¦å‘
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/fix')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      # ========== æ­¥éª¤ 1ï¼šè·å– PR ä¿¡æ¯ ==========
      - name: Get PR Details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            core.setOutput('branch', pr.head.ref);
            core.setOutput('sha', pr.head.sha);
            core.setOutput('title', pr.title);
            
            console.log(`PR Branch: ${pr.head.ref}`);
            console.log(`PR SHA: ${pr.head.sha}`);

      # ========== æ­¥éª¤ 2ï¼šCheckout PR åˆ†æ”¯ ==========
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.branch }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "ai-fix-bot"
          git config user.email "fix-bot@github-actions.bot"

      # ========== æ­¥éª¤ 3ï¼šå®‰è£…ä¾èµ–å¹¶è¿è¡Œ Build ==========
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        working-directory: frontend
        run: npm ci

      - name: Run Build and Capture Errors
        id: build
        working-directory: frontend
        continue-on-error: true
        run: |
          # è¿è¡Œ build å¹¶æ•è·è¾“å‡º
          BUILD_OUTPUT=$(npm run build 2>&1) || true
          
          # ä¿å­˜åˆ°æ–‡ä»¶ï¼ˆå¤„ç†å¤šè¡Œè¾“å‡ºï¼‰
          echo "$BUILD_OUTPUT" > /tmp/build_output.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
          if echo "$BUILD_OUTPUT" | grep -q "error"; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
            echo "âŒ Build å¤±è´¥ï¼Œå‘ç°é”™è¯¯"
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
            echo "âœ… Build æˆåŠŸ"
          fi

      # ========== æ­¥éª¤ 4ï¼šè§£æé”™è¯¯å¹¶è¯„è®º ==========
      - name: Parse and Comment Errors
        if: steps.build.outputs.has_errors == 'true'
        id: errors
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const buildOutput = fs.readFileSync('/tmp/build_output.txt', 'utf8');
            
            // æå– TypeScript/ESLint é”™è¯¯
            // æ ¼å¼: ./path/to/file.tsx:line:col: error message
            const errorPattern = /\.\/([^\s:]+):(\d+):(\d+):\s*(.+)/g;
            const errors = [];
            let match;
            
            while ((match = errorPattern.exec(buildOutput)) !== null) {
              errors.push({
                file: match[1],
                line: match[2],
                column: match[3],
                message: match[4]
              });
            }
            
            // ä¹Ÿæ•è· Next.js çš„ç±»å‹é”™è¯¯æ ¼å¼
            // Type error: xxx
            const typeErrorPattern = /Type error:\s*(.+)/g;
            while ((match = typeErrorPattern.exec(buildOutput)) !== null) {
              errors.push({
                file: 'unknown',
                line: '0',
                column: '0',
                message: `Type error: ${match[1]}`
              });
            }
            
            // æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯
            let errorSummary = '';
            if (errors.length > 0) {
              errorSummary = errors.map((e, i) => 
                `### é”™è¯¯ ${i + 1}\n- **æ–‡ä»¶**: \`${e.file}\`\n- **ä½ç½®**: è¡Œ ${e.line}, åˆ— ${e.column}\n- **é”™è¯¯**: ${e.message}`
              ).join('\n\n');
            } else {
              // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°å…·ä½“æ ¼å¼ï¼Œç›´æ¥æ˜¾ç¤ºæœ€å 100 è¡Œ
              const lines = buildOutput.split('\n');
              const lastLines = lines.slice(-100).join('\n');
              errorSummary = '```\n' + lastLines + '\n```';
            }
            
            // ä¿å­˜é”™è¯¯ä¿¡æ¯ä¾› Claude ä½¿ç”¨
            core.setOutput('error_details', errorSummary);
            core.setOutput('error_count', errors.length.toString());
            
            // å‘å¸ƒè¿›åº¦è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                'ğŸ” **Build é”™è¯¯åˆ†æå®Œæˆ**',
                '',
                `å‘ç° ${errors.length || 'è‹¥å¹²'} ä¸ªé”™è¯¯ï¼š`,
                '',
                errorSummary,
                '',
                '---',
                'ğŸ¤– **æ­£åœ¨è°ƒç”¨ AI ä¿®å¤...**'
              ].join('\n')
            });

      # ========== æ­¥éª¤ 5ï¼šå¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œæç¤ºæˆåŠŸ ==========
      - name: Comment Success
        if: steps.build.outputs.has_errors == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âœ… **Build æˆåŠŸï¼** æ²¡æœ‰å‘ç°é”™è¯¯ï¼Œæ— éœ€ä¿®å¤ã€‚'
            });

      # ========== æ­¥éª¤ 6ï¼šè°ƒç”¨ Claude ä¿®å¤ ==========
      - name: Fix with Claude
        if: steps.build.outputs.has_errors == 'true'
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          track_progress: true
          use_oauth: false
          # å…³é”®ï¼šç›´æ¥åœ¨å½“å‰åˆ†æ”¯ä¿®å¤ï¼Œä¸åˆ›å»ºæ–° PR
          direct_push: true
          prompt: |
            ä½ æ˜¯ä»£ç ä¿®å¤ä¸“å®¶ã€‚å½“å‰ PR çš„ Build å¤±è´¥äº†ï¼Œéœ€è¦ä½ ä¿®å¤ã€‚

            ## PR ä¿¡æ¯
            - åˆ†æ”¯: ${{ steps.pr.outputs.branch }}
            - æ ‡é¢˜: ${{ steps.pr.outputs.title }}

            ## Build é”™è¯¯è¯¦æƒ…
            ${{ steps.errors.outputs.error_details }}

            ## ä»»åŠ¡
            1. ä»”ç»†åˆ†æä¸Šé¢çš„é”™è¯¯ä¿¡æ¯
            2. æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶å¹¶ä¿®å¤é”™è¯¯
            3. ç¡®ä¿ä¿®å¤åä»£ç èƒ½æ­£ç¡®ç¼–è¯‘
            4. åªä¿®å¤æŠ¥é”™çš„é—®é¢˜ï¼Œä¸è¦åšå…¶ä»–æ”¹åŠ¨

            ## çº¦æŸ
            - åªä¿®æ”¹æœ‰é”™è¯¯çš„æ–‡ä»¶
            - ä¿æŒä»£ç é£æ ¼ä¸€è‡´
            - å‚è€ƒ frontend/lib/api/types.ts ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ç±»å‹
            - å¦‚æœæ˜¯ TypeScript ç±»å‹é”™è¯¯ï¼Œç¡®ä¿ä½¿ç”¨å·²å®šä¹‰çš„å±æ€§

            è¯·ç›´æ¥ä¿®å¤ä»£ç ã€‚
          claude_args: |
            --model anthropic/claude-sonnet-4.5
            --max-turns 30

      # ========== æ­¥éª¤ 7ï¼šä¿®å¤å®Œæˆåè¯„è®º ==========
      - name: Comment Fix Complete
        if: steps.build.outputs.has_errors == 'true' && success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                'âœ… **AI ä¿®å¤å®Œæˆï¼**',
                '',
                'ä»£ç å·²æ¨é€åˆ°å½“å‰ PR åˆ†æ”¯ï¼ŒVercel å°†è‡ªåŠ¨é‡æ–°éƒ¨ç½²ã€‚',
                '',
                'è¯·æ£€æŸ¥ä¿®æ”¹æ˜¯å¦æ­£ç¡®ã€‚'
              ].join('\n')
            });

      # ========== å¤±è´¥å¤„ç† ==========
      - name: Handle Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                'âŒ **è‡ªåŠ¨ä¿®å¤å¤±è´¥**',
                '',
                'è¯·æŸ¥çœ‹ [Actions æ—¥å¿—](/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦æƒ…ã€‚',
                '',
                'å¯èƒ½éœ€è¦æ‰‹åŠ¨ä¿®å¤ã€‚'
              ].join('\n')
            });
