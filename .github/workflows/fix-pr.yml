name: Fix PR Build Errors

on:
  issue_comment:
    types: [created]

jobs:
  fix-build-errors:
    # åªåœ¨ PR è¯„è®ºä¸­åŒ…å« /fix æ—¶è§¦å‘
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/fix')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      # ========== æ­¥éª¤ 1ï¼šè·å– PR ä¿¡æ¯ ==========
      - name: Get PR Details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            core.setOutput('branch', pr.head.ref);
            core.setOutput('sha', pr.head.sha);
            core.setOutput('title', pr.title);
            
            console.log(`PR Branch: ${pr.head.ref}`);
            console.log(`PR SHA: ${pr.head.sha}`);

      # ========== æ­¥éª¤ 2ï¼šCheckout PR åˆ†æ”¯ ==========
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.branch }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "ai-fix-bot"
          git config user.email "fix-bot@github-actions.bot"

      # ========== æ­¥éª¤ 3ï¼šå®‰è£…ä¾èµ–å¹¶è¿è¡Œ Build ==========
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        working-directory: frontend
        run: npm ci

      - name: Run Build and Capture Errors
        id: build
        working-directory: frontend
        continue-on-error: true
        run: |
          # è¿è¡Œ build å¹¶æ•è·è¾“å‡º
          BUILD_OUTPUT=$(npm run build 2>&1) || true
          
          # ä¿å­˜åˆ°æ–‡ä»¶ï¼ˆå¤„ç†å¤šè¡Œè¾“å‡ºï¼‰
          echo "$BUILD_OUTPUT" > /tmp/build_output.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
          if echo "$BUILD_OUTPUT" | grep -q "error"; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
            echo "âŒ Build å¤±è´¥ï¼Œå‘ç°é”™è¯¯"
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
            echo "âœ… Build æˆåŠŸ"
          fi

      # ========== æ­¥éª¤ 4ï¼šè§£æé”™è¯¯å¹¶è¯„è®º ==========
      - name: Parse and Comment Errors
        if: steps.build.outputs.has_errors == 'true'
        id: errors
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const buildOutput = fs.readFileSync('/tmp/build_output.txt', 'utf8');
            const errors = [];
            
            // 1. æ•è· Next.js/Turbopack æ ¼å¼çš„é”™è¯¯ï¼ˆåŒ…å«æ–‡ä»¶è·¯å¾„ï¼‰
            // æ ¼å¼: ./path/to/file.tsx:line:col
            // åé¢è·Ÿç€é”™è¯¯ä¿¡æ¯
            const nextjsErrorPattern = /\.\/([^\s:]+):(\d+):(\d+)\n([^\n]*(?:Type error|Module not found|Error)[^\n]*)/g;
            let match;
            while ((match = nextjsErrorPattern.exec(buildOutput)) !== null) {
              errors.push({
                file: match[1],
                line: match[2],
                column: match[3],
                message: match[4].trim()
              });
            }
            
            // 2. æ•è· Module not found é”™è¯¯
            // æ ¼å¼: Module not found: Can't resolve 'xxx'
            const moduleNotFoundPattern = /Module not found: Can't resolve '([^']+)'/g;
            while ((match = moduleNotFoundPattern.exec(buildOutput)) !== null) {
              // æ£€æŸ¥æ˜¯å¦å·²ç»é€šè¿‡ä¸Šé¢çš„ pattern æ•è·äº†
              const alreadyCaptured = errors.some(e => e.message.includes(match[1]));
              if (!alreadyCaptured) {
                errors.push({
                  file: 'package.json',
                  line: '0',
                  column: '0',
                  message: `ç¼ºå°‘ä¾èµ–: npm install ${match[1]}`
                });
              }
            }
            
            // 3. æ•è·å¸¦æ–‡ä»¶è·¯å¾„çš„ Type error
            // æ ¼å¼: ./path/file.tsx:line:col\nType error: xxx
            const typeErrorWithFilePattern = /\.\/([^\s:]+):(\d+):(\d+)\s*\n\s*Type error:\s*(.+)/g;
            while ((match = typeErrorWithFilePattern.exec(buildOutput)) !== null) {
              const alreadyCaptured = errors.some(e => e.file === match[1] && e.line === match[2]);
              if (!alreadyCaptured) {
                errors.push({
                  file: match[1],
                  line: match[2],
                  column: match[3],
                  message: `Type error: ${match[4]}`
                });
              }
            }
            
            // æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯
            let errorSummary = '';
            if (errors.length > 0) {
              errorSummary = errors.map((e, i) => 
                `### é”™è¯¯ ${i + 1}\n- **æ–‡ä»¶**: \`${e.file}\`\n- **ä½ç½®**: è¡Œ ${e.line}, åˆ— ${e.column}\n- **é”™è¯¯**: ${e.message}`
              ).join('\n\n');
            }
            
            // å§‹ç»ˆé™„åŠ å®Œæ•´çš„ build æ—¥å¿—ï¼ˆæœ€å 150 è¡Œï¼‰ï¼Œè®© AI æœ‰å®Œæ•´ä¸Šä¸‹æ–‡
            const lines = buildOutput.split('\n');
            const lastLines = lines.slice(-150).join('\n');
            errorSummary += '\n\n---\n\n### å®Œæ•´ Build æ—¥å¿—\n```\n' + lastLines + '\n```';
            
            // ä¿å­˜é”™è¯¯ä¿¡æ¯ä¾› Claude ä½¿ç”¨
            core.setOutput('error_details', errorSummary);
            core.setOutput('error_count', errors.length.toString());
            
            // å‘å¸ƒè¿›åº¦è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                'ğŸ” **Build é”™è¯¯åˆ†æå®Œæˆ**',
                '',
                `å‘ç° ${errors.length || 'è‹¥å¹²'} ä¸ªé”™è¯¯ï¼š`,
                '',
                errorSummary,
                '',
                '---',
                'ğŸ¤– **æ­£åœ¨è°ƒç”¨ AI ä¿®å¤...**'
              ].join('\n')
            });

      # ========== æ­¥éª¤ 5ï¼šå¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œæç¤ºæˆåŠŸ ==========
      - name: Comment Success
        if: steps.build.outputs.has_errors == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âœ… **Build æˆåŠŸï¼** æ²¡æœ‰å‘ç°é”™è¯¯ï¼Œæ— éœ€ä¿®å¤ã€‚'
            });

      # ========== æ­¥éª¤ 6ï¼šè°ƒç”¨ Claude ä¿®å¤ ==========
      - name: Fix with Claude
        if: steps.build.outputs.has_errors == 'true'
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          track_progress: true
          use_oauth: false
          # å…³é”®ï¼šç›´æ¥åœ¨å½“å‰åˆ†æ”¯ä¿®å¤ï¼Œä¸åˆ›å»ºæ–° PR
          direct_push: true
          # å…è®¸æ‰€æœ‰ bots è§¦å‘ï¼Œé¿å… "Workflow initiated by non-human actor" é”™è¯¯
          allowed_bots: '*'
          prompt: |
            ä½ æ˜¯ä»£ç ä¿®å¤ä¸“å®¶ã€‚å½“å‰ PR çš„ Build å¤±è´¥äº†ï¼Œéœ€è¦ä½ ä¿®å¤ã€‚

            ## PR ä¿¡æ¯
            - åˆ†æ”¯: ${{ steps.pr.outputs.branch }}
            - æ ‡é¢˜: ${{ steps.pr.outputs.title }}

            ## Build é”™è¯¯è¯¦æƒ…
            ${{ steps.errors.outputs.error_details }}

            ## ä»»åŠ¡
            1. ä»”ç»†åˆ†æä¸Šé¢çš„é”™è¯¯ä¿¡æ¯å’Œå®Œæ•´ Build æ—¥å¿—
            2. æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶å¹¶ä¿®å¤é”™è¯¯
            3. ç¡®ä¿ä¿®å¤åä»£ç èƒ½æ­£ç¡®ç¼–è¯‘
            4. åªä¿®å¤æŠ¥é”™çš„é—®é¢˜ï¼Œä¸è¦åšå…¶ä»–æ”¹åŠ¨

            ## å¸¸è§é”™è¯¯ä¿®å¤æŒ‡å—

            ### Module not found é”™è¯¯
            - éœ€è¦å®‰è£…ç¼ºå¤±çš„ npm åŒ…
            - ä¿®æ”¹ package.json æ·»åŠ ä¾èµ–ï¼Œä¾‹å¦‚ï¼šæ·»åŠ  "react-markdown": "^10.0.0" åˆ° dependencies

            ### Cannot find namespace 'YT' é”™è¯¯
            - éœ€è¦åˆ›å»ºå…¨å±€ç±»å‹å£°æ˜æ–‡ä»¶
            - åœ¨ frontend/types/ ç›®å½•åˆ›å»º .d.ts æ–‡ä»¶
            - **é‡è¦**ï¼šå…¨å±€å£°æ˜æ–‡ä»¶ä¸èƒ½æœ‰ `export {}` æˆ–ä»»ä½• export è¯­å¥ï¼Œå¦åˆ™ä¼šå˜æˆæ¨¡å—

            ### Type error: Property 'xxx' does not exist
            - æ£€æŸ¥ frontend/lib/api/types.ts ä¸­çš„ç±»å‹å®šä¹‰
            - åªä½¿ç”¨å·²å®šä¹‰çš„å±æ€§

            ## çº¦æŸ
            - åªä¿®æ”¹æœ‰é”™è¯¯çš„æ–‡ä»¶
            - ä¿æŒä»£ç é£æ ¼ä¸€è‡´
            - ä¿®å¤åè¿è¡Œ npm run build éªŒè¯

            è¯·ç›´æ¥ä¿®å¤ä»£ç ã€‚
          claude_args: |
            --model anthropic/claude-sonnet-4.5
            --max-turns 30

      # ========== æ­¥éª¤ 7ï¼šä¿®å¤å®Œæˆåè¯„è®º ==========
      - name: Comment Fix Complete
        if: steps.build.outputs.has_errors == 'true' && success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                'âœ… **AI ä¿®å¤å®Œæˆï¼**',
                '',
                'ä»£ç å·²æ¨é€åˆ°å½“å‰ PR åˆ†æ”¯ï¼ŒVercel å°†è‡ªåŠ¨é‡æ–°éƒ¨ç½²ã€‚',
                '',
                'è¯·æ£€æŸ¥ä¿®æ”¹æ˜¯å¦æ­£ç¡®ã€‚'
              ].join('\n')
            });

      # ========== å¤±è´¥å¤„ç† ==========
      - name: Handle Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                'âŒ **è‡ªåŠ¨ä¿®å¤å¤±è´¥**',
                '',
                'è¯·æŸ¥çœ‹ [Actions æ—¥å¿—](/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦æƒ…ã€‚',
                '',
                'å¯èƒ½éœ€è¦æ‰‹åŠ¨ä¿®å¤ã€‚'
              ].join('\n')
            });
