name: Issue Router

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

# é…ç½®ï¼šè¯„è®ºæ•°é‡é˜ˆå€¼ï¼Œè¶…è¿‡æ­¤æ•°é‡å°†åˆ›å»ºå­ Issue
env:
  COMMENT_THRESHOLD: 8

jobs:
  route:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Route Issue to Agent
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const comment = context.payload.comment;
            const body = comment?.body || issue?.body || '';
            const COMMENT_THRESHOLD = parseInt(process.env.COMMENT_THRESHOLD) || 8;

            // è¯†åˆ«è§¦å‘å‘½ä»¤ï¼ˆæ”¯æŒæ™®é€šå‘½ä»¤å’Œ new å‘½ä»¤ï¼‰
            const triggers = {
              '/agent-new-ui': { label: 'agent:ui', forceNew: true },
              '/agent-new-be': { label: 'agent:backend', forceNew: true },
              '/agent-new-fe': { label: 'agent:frontend', forceNew: true },
              '/agent-ui': { label: 'agent:ui', forceNew: false },
              '/agent-be': { label: 'agent:backend', forceNew: false },
              '/agent-fe': { label: 'agent:frontend', forceNew: false },
            };

            let matched = null;
            // æŒ‰ä¼˜å…ˆçº§åŒ¹é…ï¼ˆnew å‘½ä»¤ä¼˜å…ˆï¼‰
            for (const [trigger, config] of Object.entries(triggers)) {
              if (body.includes(trigger)) {
                matched = { trigger, ...config };
                break;
              }
            }

            if (!matched) return;

            // è·å–å½“å‰ Issue çš„è¯„è®ºæ•°é‡
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              per_page: 100
            });

            const commentCount = comments.length;
            const shouldCreateNewIssue = matched.forceNew || commentCount >= COMMENT_THRESHOLD;

            // æŸ¥æ‰¾çœŸæ­£çš„æ ¹çˆ¶ issueï¼ˆé¿å…å¤šå±‚åµŒå¥—ï¼‰
            let rootParentNumber = issue.number;
            let rootParentTitle = issue.title;

            // æ£€æŸ¥å½“å‰ issue æ˜¯å¦å·²ç»æ˜¯å­ issueï¼ˆæŸ¥æ‰¾ body ä¸­çš„ Parent: #xxxï¼‰
            const parentMatch = issue.body?.match(/Parent:\s*#(\d+)/);
            if (parentMatch) {
              // å½“å‰ issue æ˜¯å­ issueï¼Œè·å–å…¶çˆ¶ issue
              const parentNumber = parseInt(parentMatch[1]);
              try {
                const { data: parentIssue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parentNumber
                });
                // ç»§ç»­æ£€æŸ¥çˆ¶ issue æ˜¯å¦è¿˜æœ‰çˆ¶ï¼ˆé€’å½’æ‰¾æ ¹ï¼‰
                const grandParentMatch = parentIssue.body?.match(/Parent:\s*#(\d+)/);
                if (grandParentMatch) {
                  rootParentNumber = parseInt(grandParentMatch[1]);
                  // è·å–æ ¹çˆ¶ issue çš„æ ‡é¢˜
                  const { data: rootParent } = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: rootParentNumber
                  });
                  rootParentTitle = rootParent.title;
                } else {
                  rootParentNumber = parentNumber;
                  rootParentTitle = parentIssue.title;
                }
              } catch (e) {
                console.log(`Warning: Could not fetch parent issue #${parentNumber}: ${e.message}`);
              }
            }

            if (shouldCreateNewIssue) {
              // åˆ›å»ºå­ Issue
              const timestamp = new Date().toISOString().slice(0, 16).replace('T', ' ');
              const agentType = matched.trigger.replace('/agent-', '').replace('new-', '').toUpperCase();

              // æå–å‘½ä»¤å‚æ•°ï¼ˆå¦‚ URLï¼‰
              const commandMatch = body.match(new RegExp(`${matched.trigger.replace('-', '\\-')}\\s+([^\\s]+)`));
              const commandArgs = commandMatch ? commandMatch[1] : '';

              // æ¸…ç†çˆ¶ issue æ ‡é¢˜ï¼Œç§»é™¤å·²æœ‰çš„å‰ç¼€å’Œåç¼€
              let cleanTitle = rootParentTitle
                // ç§»é™¤å¼€å¤´çš„ agent ç±»å‹æ ‡ç­¾ï¼Œå¦‚ [BE], [FE], [UI], [BE+FE] ç­‰
                .replace(/^\s*(\[[A-Z+]+\]\s*)+/g, '')
                // ç§»é™¤ç»“å°¾çš„ "(from #xxx)" åç¼€ï¼ˆå¯èƒ½æœ‰å¤šä¸ªï¼‰
                .replace(/\s*\(from #\d+\)\s*/g, '')
                // ç§»é™¤ç»“å°¾çš„ "(å­ä»»åŠ¡ from #xxx)" åç¼€
                .replace(/\s*\(å­ä»»åŠ¡ from #\d+\)\s*$/g, '')
                .trim();

              const newIssueBody = [
                `## ğŸ”— å…³è”çˆ¶ Issue`,
                ``,
                `Parent: #${rootParentNumber}`,
                ``,
                `---`,
                ``,
                `## ğŸ“‹ åŸå§‹éœ€æ±‚`,
                ``,
                issue.body || 'æ— æè¿°',
                ``,
                `---`,
                ``,
                `## ğŸ¤– Agent ä»»åŠ¡`,
                ``,
                `å‘½ä»¤: \`${matched.trigger}${commandArgs ? ' ' + commandArgs : ''}\``,
                ``,
                `è§¦å‘æ—¶é—´: ${timestamp}`,
                ``,
                `---`,
                ``,
                `> ğŸ’¡ æ­¤ Issue ç”± Issue Router è‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºé¿å…è¯„è®ºæŠ˜å é—®é¢˜ã€‚`
              ].join('\n');

              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[${agentType}] ${cleanTitle} (from #${issue.number})`,
                body: newIssueBody,
                labels: [matched.label, 'ğŸ¤– ai-processing', 'sub-issue']
              });

              // åœ¨çˆ¶ Issue æ·»åŠ é“¾æ¥è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: [
                  `ğŸ”€ **å·²åˆ›å»ºå­ Issue**`,
                  ``,
                  `ç”±äºå½“å‰ Issue è¯„è®ºè¾ƒå¤šï¼ˆ${commentCount} æ¡ï¼‰ï¼Œå·²è‡ªåŠ¨åˆ›å»ºå­ Issue ä»¥ä¿æŒæ¸…æ™°åº¦ã€‚`,
                  ``,
                  `â¡ï¸ è¯·å‰å¾€ #${newIssue.number} æŸ¥çœ‹ AI Agent æ‰§è¡Œè¿›åº¦ã€‚`,
                  ``,
                  `å‘½ä»¤: \`${matched.trigger}\``,
                  matched.forceNew ? `> ğŸ’¡ ä½¿ç”¨äº† \`-new-\` å‘½ä»¤å¼ºåˆ¶åˆ›å»ºæ–° Issue` : `> ğŸ’¡ è¯„è®ºè¶…è¿‡é˜ˆå€¼ (${COMMENT_THRESHOLD}) è‡ªåŠ¨åˆ›å»º`
                ].join('\n')
              });

              // åœ¨æ–° Issue æ·»åŠ è§¦å‘è¯„è®ºï¼ˆåŒ…å«åŸå§‹å‘½ä»¤ä»¥è§¦å‘å¯¹åº”çš„ agent workflowï¼‰
              // å°† /agent-new-xxx è½¬æ¢ä¸º /agent-xxx ä»¥è§¦å‘å®é™…çš„ agent
              const agentCommand = matched.trigger.replace('-new-', '-');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: newIssue.number,
                body: `${agentCommand}${commandArgs ? ' ' + commandArgs : ''}\n\n` +
                      `---\n\n` +
                      `ğŸ¤– **AI Agent è§¦å‘ä¸­...**\n\n` +
                      `> æ­¤è¯„è®ºç”± Issue Router è‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºè§¦å‘å¯¹åº”çš„ Agent Workflowã€‚\n` +
                      `> è¯·åœ¨ [Actions](/${context.repo.owner}/${context.repo.repo}/actions) æ ‡ç­¾é¡µæŸ¥çœ‹å®æ—¶è¿›åº¦ã€‚`
              });

            } else {
              // ç»§ç»­åœ¨å½“å‰ Issue å¤„ç†
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [matched.label, 'ğŸ¤– ai-processing']
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ğŸ¤– **AI Agent å·²å¯åŠ¨**\n\n` +
                      `å‘½ä»¤: \`${matched.trigger}\`\n` +
                      `çŠ¶æ€: å¤„ç†ä¸­...\n` +
                      `è¯„è®ºæ•°: ${commentCount}/${COMMENT_THRESHOLD} (è¶…è¿‡é˜ˆå€¼å°†è‡ªåŠ¨åˆ›å»ºå­ Issue)\n\n` +
                      `è¯·åœ¨ [Actions](/${context.repo.owner}/${context.repo.repo}/actions) æ ‡ç­¾é¡µæŸ¥çœ‹å®æ—¶è¿›åº¦ã€‚`
              });
            }
