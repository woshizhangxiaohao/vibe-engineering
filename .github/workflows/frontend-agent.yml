name: Frontend Agent

on:
  issue_comment:
    types: [created]

jobs:
  frontend-agent:
    if: contains(github.event.comment.body, '/agent-fe')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "ai-frontend-agent"
          git config user.email "agent@github-actions.bot"

      # ========== æ­¥éª¤ 1ï¼šè§£æå‘½ä»¤å’Œå‡†å¤‡ä¸Šä¸‹æ–‡ ==========
      - name: Parse Command & Prepare Context
        id: prepare
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          script: |
            const fs = require("fs");
            const path = require("path");

            const issue = context.payload.issue;
            const comment = context.payload.comment;
            const commentBody = comment.body;

            console.log("=".repeat(80));
            console.log("ğŸ¨ FRONTEND AGENT - è§£æå‘½ä»¤");
            console.log("=".repeat(80));

            // 1. æå– UI Spec URLï¼ˆæ”¯æŒ issue å’Œ commentï¼‰
            const urlPattern = /https:\/\/github\.com\/[^\s\)]+\/issues\/\d+(?:#(?:issuecomment-|issue-)\d+)?/g;
            const urls = commentBody.match(urlPattern) || [];

            console.log(`æ‰¾åˆ° ${urls.length} ä¸ª URL`);

            // å¦‚æœæ²¡æœ‰æä¾› URLï¼Œåˆ™é»˜è®¤ä½¿ç”¨å½“å‰ Issue çš„å†…å®¹
            let useCurrentIssue = false;
            if (urls.length === 0) {
              console.log("âš ï¸ æœªæä¾› URLï¼Œå°†ä½¿ç”¨å½“å‰ Issue å†…å®¹ä½œä¸ºéœ€æ±‚");
              useCurrentIssue = true;
            }

            // 2. æå–ç”¨æˆ·é¢å¤–æŒ‡ä»¤
            let userInstructions = commentBody
              .replace(/\/agent-fe\s*/, "")
              .trim();

            urls.forEach(url => {
              userInstructions = userInstructions.replace(url, "").trim();
            });

            console.log("ç”¨æˆ·æŒ‡ä»¤:", userInstructions || "(æ— )");

            // 3. è·å– UI Spec å†…å®¹
            const uiSpecs = [];
            const specUrls = [];

            if (useCurrentIssue) {
              // ä½¿ç”¨å½“å‰ Issue çš„å†…å®¹ä½œä¸ºéœ€æ±‚
              const content = issue.body || "";
              const title = issue.title;
              const url = `https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issue.number}`;
              uiSpecs.push({ url, content, title });
              specUrls.push(url);
              console.log(`âœ… ä½¿ç”¨å½“å‰ Issue: ${title}`);
            } else {
              // ä»æä¾›çš„ URL è·å–å†…å®¹
              for (const url of urls) {
                try {
                  const isIssueUrl = !url.includes("#issuecomment-");
                  let content, title;

                  if (isIssueUrl) {
                    const issueNum = url.match(/\/issues\/(\d+)/)[1];
                    const { data } = await github.rest.issues.get({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: parseInt(issueNum)
                    });
                    content = data.body || "";
                    title = data.title;
                  } else {
                    const commentId = url.split("#issuecomment-")[1];
                    const { data } = await github.rest.issues.getComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      comment_id: parseInt(commentId)
                    });
                    content = data.body;
                    title = content.split('\n')[0] || 'UI Spec';
                  }

                  uiSpecs.push({ url, content, title });
                  specUrls.push(url);
                  console.log(`âœ… è·å– UI Spec: ${title}`);
                } catch (error) {
                  console.error(`âŒ è·å–å¤±è´¥: ${url}`);
                  throw error;
                }
              }
            }

            const combinedUISpec = uiSpecs.map((spec, idx) =>
              `## UI Spec ${idx + 1}: ${spec.title}\n\n${spec.content}`
            ).join("\n\n---\n\n");

            // 4. è¯»å–é¡¹ç›®æ–‡ä»¶
            const systemFiles = [
              "frontend/package.json",
              "frontend/STYLE_GUIDE.md",
              "frontend/next.config.ts",
              "frontend/tsconfig.json",
              "frontend/components.json",
              "frontend/app/layout.tsx",
              "frontend/lib/api/client.ts",
              "frontend/lib/api/types.ts",
              "frontend/lib/api/examples.tsx"
            ];

            const projectContext = {};
            for (const filePath of systemFiles) {
              try {
                const fullPath = path.join(process.cwd(), filePath);
                if (fs.existsSync(fullPath)) {
                  projectContext[filePath] = fs.readFileSync(fullPath, "utf8");
                  console.log(`âœ… è¯»å–: ${filePath}`);
                }
              } catch (e) {
                console.log(`âš ï¸ è·³è¿‡: ${filePath}`);
              }
            }

            const projectContextText = Object.entries(projectContext)
              .map(([path, content]) => `## ${path}\n\`\`\`typescript\n${content}\n\`\`\``)
              .join("\n\n");

            // 5. å‘å¸ƒå¯åŠ¨è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                "ğŸ¨ **Frontend Agent å¯åŠ¨**",
                "",
                `**UI Spec æ¥æº:**`,
                specUrls.map((url, idx) => `${idx + 1}. ${url}`).join("\n"),
                "",
                userInstructions ? `**ç”¨æˆ·æŒ‡ä»¤:** ${userInstructions}\n` : "",
                "_Claude Code Action æ­£åœ¨ç”Ÿæˆä»£ç ..._"
              ].join("\n")
            });

            // 6. æ„å»º Promptï¼ˆä¸æŒ‡å®šåˆ†æ”¯åï¼Œè®© claude-code-action è‡ªå·±åˆ›å»ºï¼‰
            const prompt = `ä½ æ˜¯å‰ç«¯ä»£ç ç”Ÿæˆä¸“å®¶ã€‚

            ## ä»»åŠ¡
            åŸºäº UI Spec å®ç°å‰ç«¯é¡µé¢å’Œç»„ä»¶ã€‚

            ## UI Spec
            ${combinedUISpec}

            ${userInstructions ? `## ç”¨æˆ·è¦æ±‚\n${userInstructions}\n` : ""}

            ## é¡¹ç›®çº¦æŸ
            ${projectContextText || "æ— ç°æœ‰ä»£ç å‚è€ƒ"}

            ## æŠ€æœ¯æ ˆ
            - Next.js 15 (App Router)
            - React 19
            - TypeScript
            - Tailwind CSS
            - shadcn/ui
            - Base.org è®¾è®¡ç³»ç»Ÿ

            ## è¦æ±‚
            - ä¸¥æ ¼éµå¾ª STYLE_GUIDE.md çš„è®¾è®¡è§„èŒƒ
            - ä½¿ç”¨ shadcn/ui ç»„ä»¶
            - æ‰€æœ‰æ–‡ä»¶åœ¨ frontend/ ç›®å½•ä¸‹
            - ä½¿ç”¨ TypeScript
            - éµå¾ª Base.org çš„æç®€è®¾è®¡å“²å­¦
            - API è°ƒç”¨ä½¿ç”¨ lib/api/client.ts
            - ç±»å‹å®šä¹‰å‚è€ƒ lib/api/types.tsï¼ˆå¿…é¡»ä½¿ç”¨å·²å®šä¹‰çš„ç±»å‹å’Œå±æ€§ï¼‰
            - é”™è¯¯å¤„ç†å‚è€ƒ lib/api/examples.tsx çš„æ¨¡å¼

            ## é”™è¯¯å¤„ç†è§„èŒƒ
            ApiError ç±»åªæœ‰ä»¥ä¸‹å±æ€§ï¼š
            - status: number (HTTP çŠ¶æ€ç )
            - statusText: string
            - data?: unknown
            - message: string (ç»§æ‰¿è‡ª Error)
            
            æ­£ç¡®ç”¨æ³•ï¼š
            \`\`\`typescript
            if (err instanceof ApiError) {
              setError(err.message);
            }
            \`\`\`

            è¯·ç”Ÿæˆå®Œæ•´çš„å‰ç«¯å®ç°ã€‚`;

            core.setOutput("prompt_content", prompt);
            core.setOutput("spec_urls", specUrls.join(", "));

            console.log("âœ… ä¸Šä¸‹æ–‡å‡†å¤‡å®Œæˆ");

      # ========== æ­¥éª¤ 2ï¼šæ‰§è¡Œ Claude Code Action ==========
      # claude-code-action ä¼šè‡ªåŠ¨ï¼šåˆ›å»ºåˆ†æ”¯ã€ç”Ÿæˆä»£ç ã€å‘å¸ƒè¿›åº¦è¯„è®ºã€æä¾› PR é“¾æ¥
      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          track_progress: true
          prompt: ${{ steps.prepare.outputs.prompt_content }}
          claude_args: |
            --model anthropic/claude-sonnet-4.5
            --max-turns 60

      # ========== æ­¥éª¤ 3ï¼šæˆåŠŸåæ›´æ–°æ ‡ç­¾ ==========
      - name: Update Labels on Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            // æ›´æ–°æ ‡ç­¾
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'ğŸ¤– ai-processing'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['âœ… ai-completed']
            });

      # ========== å¤±è´¥å¤„ç† ==========
      - name: Handle Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                "âŒ **Frontend Agent å¤±è´¥**",
                "",
                `ğŸ“‹ UI Spec: ${{ steps.prepare.outputs.spec_urls }}`,
                "",
                "è¯·æŸ¥çœ‹ [Actions æ—¥å¿—](/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦æƒ…ã€‚",
                "",
                "å¯èƒ½çš„åŸå› :",
                "- UI Spec ä¸å¤Ÿæ˜ç¡®",
                "- ä»£ç ç”Ÿæˆé”™è¯¯",
                "- ä¾èµ–é—®é¢˜",
                "",
                "å»ºè®®: æä¾›æ›´è¯¦ç»†çš„ UI Spec æˆ–ç»„ä»¶éœ€æ±‚ã€‚"
              ].join("\n")
            });

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'ğŸ¤– ai-processing'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['âŒ ai-failed']
            });
