name: Simple Task Agent

on:
  workflow_call:
  issue_comment:
    types: [created]

jobs:
  simple-task:
    # é€šè¿‡ workflow_call æˆ– /agent-simple å‘½ä»¤è§¦å‘
    if: |
      github.event_name == 'workflow_call' ||
      contains(github.event.comment.body, '/agent-simple')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "vibe-simple-agent"
          git config user.email "agent@vibe.bot"

      - name: Update Issue Status
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            // æ›´æ–°æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'complexity:simple'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['ğŸ¤– ai-processing', 'agent:simple']
            });

      - name: Run Claude Code Action
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          track_progress: true
          prompt: |
            ## ä»»åŠ¡ç±»å‹
            è¿™æ˜¯ä¸€ä¸ª **ç®€å•ä»»åŠ¡**ï¼Œè¯·ç›´æ¥å®ç°ï¼Œä¸éœ€è¦å¤æ‚åˆ†æã€‚

            ## Issue ä¿¡æ¯
            - ä»“åº“: ${{ github.repository }}
            - Issue: #${{ github.event.issue.number }}
            - æ ‡é¢˜: ${{ github.event.issue.title }}

            ## éœ€æ±‚æè¿°
            ${{ github.event.issue.body }}

            ## æ‰§è¡Œè¦æ±‚
            1. **ç›´æ¥å¼€å§‹ç¼–ç **ï¼Œä¸éœ€è¦å…ˆåˆ†ææˆ–è§„åˆ’
            2. éµå¾ªé¡¹ç›®ç°æœ‰ä»£ç é£æ ¼ï¼ˆå‚è€ƒ CLAUDE.md å’Œ STYLE_GUIDE.mdï¼‰
            3. ä¿®æ”¹å°½é‡æœ€å°åŒ–ï¼Œåªåšå¿…è¦çš„æ”¹åŠ¨
            4. å¦‚æœæ¶‰åŠå‰ç«¯ï¼Œä½¿ç”¨ shadcn/ui ç»„ä»¶
            5. å¦‚æœæ¶‰åŠåç«¯ï¼Œéµå¾ªç°æœ‰çš„ handler/service/repository æ¨¡å¼
            6. å®Œæˆååˆ›å»º PR

            ## é¡¹ç›®ç»“æ„æç¤º
            - å‰ç«¯: frontend/ (Next.js + TypeScript + shadcn/ui)
            - åç«¯: backend/ (Go + Gin)
            - ç±»å‹å®šä¹‰: frontend/lib/api/types.ts
            - API å®¢æˆ·ç«¯: frontend/lib/api/client.ts

            ## æ³¨æ„äº‹é¡¹
            - ä¸è¦è¿‡åº¦è®¾è®¡
            - ä¸è¦æ·»åŠ ä¸å¿…è¦çš„åŠŸèƒ½
            - å¦‚æœéœ€æ±‚ä¸æ˜ç¡®ï¼Œåšæœ€ç®€å•çš„å®ç°

          claude_args: |
            --model anthropic/claude-sonnet-4
            --max-turns 30

      - name: Update Issue on Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            // ç§»é™¤ processing æ ‡ç­¾ï¼Œæ·»åŠ  completed æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'ğŸ¤– ai-processing'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['âœ… ai-completed']
            });

            // å‘å¸ƒæˆåŠŸè¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                "âœ… **Simple Agent å®Œæˆ**",
                "",
                "PR å·²åˆ›å»ºï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹çš„è¿›åº¦è¿½è¸ªè¯„è®ºè·å–é“¾æ¥ã€‚",
                "",
                "---",
                "> ğŸ¤– ç”± Vibe Simple Agent è‡ªåŠ¨å¤„ç†"
              ].join("\n")
            });

      - name: Update Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'ğŸ¤– ai-processing'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['âŒ ai-failed', 'needs-review']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                "âŒ **Simple Agent å¤±è´¥**",
                "",
                "è¯·æŸ¥çœ‹ [Actions æ—¥å¿—](/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦æƒ…ã€‚",
                "",
                "**å¯èƒ½çš„åŸå› :**",
                "- éœ€æ±‚æè¿°ä¸å¤Ÿæ¸…æ™°",
                "- ä»£ç ç”Ÿæˆé‡åˆ°é—®é¢˜",
                "- API è°ƒç”¨è¶…æ—¶",
                "",
                "**è§£å†³æ–¹æ¡ˆ:**",
                "- è¡¥å……éœ€æ±‚æè¿°åä½¿ç”¨ `/agent-simple` é‡è¯•",
                "- æˆ–ä½¿ç”¨ `/agent-medium` è®© AI å…ˆåˆ†æå†å¼€å‘",
                "",
                "---",
                "> ğŸ¤– ç”± Vibe Simple Agent å¤„ç†"
              ].join("\n")
            });
