name: Simple Task Agent

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue ç¼–å·'
        required: true
        type: string
      continuation_context:
        description: 'ç»§ç»­è¿­ä»£çš„ä¸Šä¸‹æ–‡ä¿¡æ¯'
        required: false
        type: string
  issue_comment:
    types: [created]

jobs:
  simple-task:
    # é€šè¿‡ workflow_callã€workflow_dispatch æˆ– /agent-simple å‘½ä»¤è§¦å‘
    if: |
      github.event_name == 'workflow_call' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.comment.body, '/agent-simple')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "vibe-simple-agent"
          git config user.email "agent@vibe.bot"

      - name: Get Issue Info
        id: issue_info
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber;
            let issue;

            if (context.eventName === 'workflow_dispatch') {
              // workflow_dispatch è§¦å‘æ—¶ä» inputs è·å–
              issueNumber = parseInt('${{ github.event.inputs.issue_number }}');
              const { data } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              issue = data;
            } else {
              // issue_comment æˆ– workflow_call è§¦å‘
              issue = context.payload.issue;
              issueNumber = issue.number;
            }

            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issue.title);
            core.setOutput('issue_body', issue.body || '');

            return { issueNumber, title: issue.title, body: issue.body };

      - name: Update Issue Status
        id: update_issue_status
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};

            // æ›´æ–°æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'complexity:simple'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['ğŸ¤– ai-processing', 'agent:simple']
            });
            
            // åˆ›å»ºè¿›åº¦è¿½è¸ªè¯„è®º
            const progressComment = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                "âš¡ **Simple Agent å¯åŠ¨**",
                "",
                "---",
                "",
                "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                "",
                "**å½“å‰é˜¶æ®µ**: ğŸ”„ å‡†å¤‡ä¸­...",
                "",
                "```",
                "â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0%",
                "```",
                "",
                "**çŠ¶æ€**: â³ æ­£åœ¨åˆå§‹åŒ–...",
                "",
                "---",
                "> ğŸ’¡ ç®€å•ä»»åŠ¡å°†ç›´æ¥å¼€å§‹å¼€å‘ã€‚"
              ].join("\n")
            });
            
            // ä¿å­˜è¯„è®º ID ä¾›åç»­æ›´æ–°
            core.setOutput('progress_comment_id', progressComment.data.id);

      - name: Update Progress - Loading Template
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const progressCommentId = ${{ steps.update_issue_status.outputs.progress_comment_id }};
            
            if (progressCommentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: progressCommentId,
                body: [
                  "âš¡ **Simple Agent å¯åŠ¨**",
                  "",
                  "---",
                  "",
                  "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                  "",
                  "**å½“å‰é˜¶æ®µ**: ğŸ“ åŠ è½½æ¨¡æ¿å’Œå‡†å¤‡æç¤ºè¯...",
                  "",
                  "```",
                  "â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 10%",
                  "```",
                  "",
                  "**çŠ¶æ€**: â³ æ­£åœ¨åŠ è½½å¼€å‘æ¨¡æ¿...",
                  "",
                  "---",
                  "> ğŸ’¡ ç®€å•ä»»åŠ¡å°†ç›´æ¥å¼€å§‹å¼€å‘ã€‚"
                ].join("\n")
              });
            }

      - name: Load Prompt Template
        id: prompt
        uses: ./.github/actions/load-prompt
        with:
          template: agents/simple.md
          variables: |
            {
              "repository": "${{ github.repository }}",
              "issue_number": "${{ steps.issue_info.outputs.issue_number }}",
              "title": ${{ toJson(steps.issue_info.outputs.issue_title) }},
              "body": ${{ toJson(steps.issue_info.outputs.issue_body) }}
            }

      - name: Update Progress - Running Claude
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const progressCommentId = ${{ steps.update_issue_status.outputs.progress_comment_id }};
            
            if (progressCommentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: progressCommentId,
                body: [
                  "âš¡ **Simple Agent å¯åŠ¨**",
                  "",
                  "---",
                  "",
                  "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                  "",
                  "**å½“å‰é˜¶æ®µ**: ğŸ¤– AI æ­£åœ¨å¼€å‘...",
                  "",
                  "```",
                  "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 40%",
                  "```",
                  "",
                  "**çŠ¶æ€**: â³ Claude æ­£åœ¨å¤„ç†ä»»åŠ¡...",
                  "",
                  "**æç¤º**: è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…",
                  "",
                  "---",
                  "> ğŸ’¡ ç®€å•ä»»åŠ¡å°†ç›´æ¥å¼€å§‹å¼€å‘ã€‚"
                ].join("\n")
              });
            }

      - name: Run Claude Code Action
        id: claude
        uses: anthropics/claude-code-action@v1
        continue-on-error: true
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          # track_progress only supported for issue_comment events, not workflow_call
          track_progress: ${{ github.event_name == 'issue_comment' }}
          prompt: ${{ steps.prompt.outputs.prompt }}
          claude_args: |
            --model anthropic/claude-sonnet-4
            --max-turns 30

      - name: Check Claude Execution Result
        id: check_result
        run: |
          if [ "${{ steps.claude.outcome }}" == "failure" ]; then
            echo "claude_failed=true" >> $GITHUB_OUTPUT
            if [ -f "/home/runner/work/_temp/claude-execution-output.json" ]; then
              ERROR_MSG=$(cat /home/runner/work/_temp/claude-execution-output.json | jq -r '.error // .message // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "æ‰§è¡Œå¤±è´¥ï¼Œè¯·æŸ¥çœ‹ Actions æ—¥å¿—")
              echo "error_message<<EOF" >> $GITHUB_OUTPUT
              echo "$ERROR_MSG" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "error_message=Claude æ‰§è¡Œå¤±è´¥ï¼Œè¯·æŸ¥çœ‹ Actions æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯" >> $GITHUB_OUTPUT
            fi
          else
            echo "claude_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Fail if Claude Failed
        if: steps.check_result.outputs.claude_failed == 'true'
        run: |
          echo "Claude execution failed: ${{ steps.check_result.outputs.error_message }}"
          exit 1

      - name: Update Issue on Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const progressCommentId = ${{ steps.update_issue_status.outputs.progress_comment_id }};

            // æ›´æ–°è¿›åº¦è¯„è®ºä¸ºå®ŒæˆçŠ¶æ€
            if (progressCommentId) {
              try {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: progressCommentId,
                  body: [
                    "âš¡ **Simple Agent å¯åŠ¨**",
                    "",
                    "---",
                    "",
                    "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                    "",
                    "**å½“å‰é˜¶æ®µ**: âœ… å®Œæˆ",
                    "",
                    "```",
                    "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%",
                    "```",
                    "",
                    "**çŠ¶æ€**: âœ… ä»»åŠ¡å·²å®Œæˆ",
                    "",
                    "---",
                    "> ğŸ’¡ ç®€å•ä»»åŠ¡å°†ç›´æ¥å¼€å§‹å¼€å‘ã€‚"
                  ].join("\n")
                });
              } catch (e) {
                console.log("æ— æ³•æ›´æ–°è¿›åº¦è¯„è®º:", e.message);
              }
            }

            // ç§»é™¤ processing æ ‡ç­¾ï¼Œæ·»åŠ  completed æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'ğŸ¤– ai-processing'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['âœ… ai-completed']
            });

            // è‡ªåŠ¨å…³é—­ Issue ä»¥è§¦å‘ä¾èµ–é“¾
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'completed'
            });

            console.log(`âœ… Issue #${issueNumber} å·²è‡ªåŠ¨å…³é—­ï¼Œå°†è§¦å‘ä¾èµ–é“¾ä¸­çš„ä¸‹ä¸€ä¸ªä»»åŠ¡`);

            // å‘å¸ƒæˆåŠŸè¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                "âœ… **Simple Agent å®Œæˆ**",
                "",
                "PR å·²åˆ›å»ºï¼ŒIssue å·²è‡ªåŠ¨å…³é—­ã€‚",
                "",
                "---",
                "> ğŸ¤– ç”± Vibe Simple Agent è‡ªåŠ¨å¤„ç†"
              ].join("\n")
            });

      - name: Update Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const progressCommentId = ${{ steps.update_issue_status.outputs.progress_comment_id }};
            const errorMessage = `${{ steps.check_result.outputs.error_message || 'æœªçŸ¥é”™è¯¯' }}`;

            // åˆ†æé”™è¯¯ç±»å‹
            let errorAnalysis = "";
            let suggestion = "";

            if (errorMessage.includes("Edit") || errorMessage.includes("old_string") || errorMessage.includes("not found")) {
              errorAnalysis = "ä»£ç ç¼–è¾‘å¤±è´¥ - ç›®æ ‡ä»£ç å—æœªæ‰¾åˆ°";
              suggestion = "æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å·²æ›´æ–°";
            } else if (errorMessage.includes("timeout") || errorMessage.includes("Timeout")) {
              errorAnalysis = "æ‰§è¡Œè¶…æ—¶";
              suggestion = "ä½¿ç”¨ `/agent-medium` å¤„ç†";
            } else if (errorMessage.includes("build") || errorMessage.includes("compile")) {
              errorAnalysis = "æ„å»ºå¤±è´¥";
              suggestion = "æŸ¥çœ‹æ—¥å¿—å®šä½å…·ä½“é”™è¯¯";
            } else {
              errorAnalysis = "æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯";
              suggestion = "æŸ¥çœ‹ Actions æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯";
            }

            // æ›´æ–°è¿›åº¦è¯„è®ºä¸ºå¤±è´¥çŠ¶æ€
            if (progressCommentId) {
              try {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: progressCommentId,
                  body: [
                    "âš¡ **Simple Agent**",
                    "",
                    "---",
                    "",
                    "## âŒ æ‰§è¡Œå¤±è´¥",
                    "",
                    `**é”™è¯¯ç±»å‹**: ${errorAnalysis}`,
                    "",
                    `**Actions æ—¥å¿—**: [æŸ¥çœ‹è¯¦æƒ…](/${{ github.repository }}/actions/runs/${{ github.run_id }})`,
                    "",
                    `**å»ºè®®**: ${suggestion}`,
                    "",
                    "<details>",
                    "<summary>é”™è¯¯è¯¦æƒ…</summary>",
                    "",
                    "```",
                    errorMessage.substring(0, 500),
                    "```",
                    "</details>"
                  ].join("\n")
                });
              } catch (e) {
                console.log("æ— æ³•æ›´æ–°è¿›åº¦è¯„è®º:", e.message);
              }
            }

            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'ğŸ¤– ai-processing'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['âŒ ai-failed', 'needs-review']
            });

            // ä¸å†åˆ›å»ºé¢å¤–è¯„è®ºï¼Œä¿¡æ¯å·²åœ¨è¿›åº¦è¯„è®ºä¸­
            console.log(`Issue #${issueNumber} å·²æ ‡è®°ä¸ºå¤±è´¥ï¼Œé”™è¯¯: ${errorAnalysis}`);
