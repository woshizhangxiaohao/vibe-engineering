name: Sync Issue Status

on:
  schedule:
    - cron: '0 9 * * 1'  # æ¯å‘¨ä¸€æ—©ä¸Š 9 ç‚¹ UTC
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'

jobs:
  check-implementation:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check InsightFlow implementation status
        id: check
        run: |
          chmod +x ./scripts/check-issue-status.sh
          ./scripts/check-issue-status.sh > status_report.txt
          cat status_report.txt
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat status_report.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post status report as comment
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const report = `${{ steps.check.outputs.report }}`;

            // èŽ·å–é…ç½®çš„ issue åˆ—è¡¨
            const issueNumbers = [176, 179, 181, 182];

            for (const issueNumber of issueNumbers) {
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `## ðŸ¤– è‡ªåŠ¨çŠ¶æ€æ£€æµ‹æŠ¥å‘Š\n\n${report}\n\n---\n*æ­¤æŠ¥å‘Šç”± GitHub Action è‡ªåŠ¨ç”ŸæˆäºŽ ${new Date().toISOString()}*`
                });
              } catch (error) {
                console.log(`è·³è¿‡ issue #${issueNumber}: ${error.message}`);
              }
            }

      - name: Create summary
        run: |
          echo "## ðŸ“Š InsightFlow å®žçŽ°çŠ¶æ€æ£€æµ‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat status_report.txt >> $GITHUB_STEP_SUMMARY
