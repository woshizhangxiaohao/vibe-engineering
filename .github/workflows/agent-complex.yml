name: Complex Task Agent

on:
  workflow_call:
  issue_comment:
    types: [created]

jobs:
  complex-task:
    # é€šè¿‡ workflow_call æˆ– /agent-complex å‘½ä»¤è§¦å‘
    if: |
      github.event_name == 'workflow_call' ||
      contains(github.event.comment.body, '/agent-complex')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Issue Status
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            // æ›´æ–°æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'complexity:complex'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['ğŸ¤– ai-processing', 'agent:complex', 'epic']
            });

            // å‘å¸ƒå¼€å§‹åˆ†æçš„è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                "ğŸ“‹ **Complex Agent å¯åŠ¨**",
                "",
                "å¤æ‚ä»»åŠ¡å°†è¢«æ‹†åˆ†ä¸ºå¤šä¸ªå­ Issue...",
                "",
                "**æ‰§è¡Œè®¡åˆ’:**",
                "1. åˆ†æéœ€æ±‚å¹¶è¯†åˆ«æ¨¡å—",
                "2. æ‹†åˆ†ä¸ºå¯ç‹¬ç«‹å¼€å‘çš„å­ä»»åŠ¡",
                "3. åˆ›å»ºå­ Issue å¹¶è®¾ç½®ä¾èµ–å…³ç³»",
                "4. æŒ‰ä¾èµ–é¡ºåºè‡ªåŠ¨è§¦å‘å¼€å‘",
                "",
                "> ğŸ’¡ å¤æ‚ä»»åŠ¡éœ€è¦æ‹†åˆ†åæ‰èƒ½é«˜æ•ˆå¤„ç†ã€‚"
              ].join("\n")
            });

      - name: Load Prompt Template
        id: prompt
        uses: ./.github/actions/load-prompt
        with:
          template: agents/complex.md
          variables: |
            {
              "title": ${{ toJson(github.event.issue.title) }},
              "body": ${{ toJson(github.event.issue.body) }}
            }

      - name: Analyze and Create Sub-Issues
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          PROMPT_CONTENT: ${{ steps.prompt.outputs.prompt }}
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title || '';
            const body = issue.body || '';

            console.log("=".repeat(60));
            console.log("ğŸ“‹ COMPLEX AGENT - ä»»åŠ¡æ‹†åˆ†");
            console.log("=".repeat(60));

            // ä½¿ç”¨ä»æ¨¡æ¿åŠ è½½çš„ prompt
            const prompt = process.env.PROMPT_CONTENT;
            console.log("ğŸ“„ ä½¿ç”¨æ¨¡æ¿: agents/complex.md");

            try {
              const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "anthropic/claude-sonnet-4",
                  messages: [{ role: "user", content: prompt }],
                  temperature: 0.2
                })
              });

              if (!response.ok) {
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
              }

              const data = await response.json();
              let result = data.choices?.[0]?.message?.content || '';

              // æå– JSON
              const jsonMatch = result.match(/\{[\s\S]*\}/);
              if (!jsonMatch) {
                throw new Error("æ— æ³•è§£æ AI å“åº”");
              }

              const parsed = JSON.parse(jsonMatch[0]);
              const tasks = parsed.tasks || [];
              const architectureNotes = parsed.architecture_notes || '';

              console.log(`âœ… è¯†åˆ«åˆ° ${tasks.length} ä¸ªå­ä»»åŠ¡`);

              if (tasks.length === 0) {
                throw new Error("æœªèƒ½æ‹†åˆ†å‡ºå­ä»»åŠ¡");
              }

              // åˆ›å»ºå­ Issues
              const createdIssues = [];
              const typeLabels = {
                'database': ['database', 'backend'],
                'backend': ['backend'],
                'frontend': ['frontend'],
                'fullstack': ['frontend', 'backend']
              };

              const typeAgents = {
                'database': 'agent-medium',
                'backend': 'agent-medium',
                'frontend': 'agent-medium',
                'fullstack': 'agent-medium'
              };

              for (let i = 0; i < tasks.length; i++) {
                const task = tasks[i];

                // æ„å»ºä¾èµ–è¯´æ˜
                let dependsText = '';
                if (task.depends_on && task.depends_on.length > 0) {
                  const depTitles = task.depends_on.map(idx => {
                    if (createdIssues[idx]) {
                      return `#${createdIssues[idx].number}`;
                    }
                    return `ä»»åŠ¡ ${idx + 1}`;
                  });
                  dependsText = `\n\n**å‰ç½®ä¾èµ–:** ${depTitles.join(', ')}`;
                }

                // éªŒæ”¶æ ‡å‡†
                const criteriaText = task.acceptance_criteria?.length > 0
                  ? `\n\n**éªŒæ”¶æ ‡å‡†:**\n${task.acceptance_criteria.map(c => `- [ ] ${c}`).join('\n')}`
                  : '';

                const subIssueBody = [
                  `## ğŸ”— å…³è”`,
                  ``,
                  `Parent: #${issue.number}`,
                  `ä»»åŠ¡åºå·: ${i + 1}/${tasks.length}`,
                  dependsText,
                  ``,
                  `---`,
                  ``,
                  `## ğŸ“‹ ä»»åŠ¡æè¿°`,
                  ``,
                  task.description,
                  criteriaText,
                  ``,
                  `---`,
                  ``,
                  `## ğŸ“Š ä»»åŠ¡ä¿¡æ¯`,
                  ``,
                  `- **ç±»å‹:** ${task.type}`,
                  `- **ä¼˜å…ˆçº§:** P${task.priority}`,
                  `- **é¢„ä¼°å·¥æ—¶:** ${task.estimated_hours} å°æ—¶`,
                  ``,
                  `---`,
                  ``,
                  `> ğŸ¤– æ­¤ Issue ç”± Complex Agent è‡ªåŠ¨åˆ›å»º`,
                  `> å®Œæˆå‰ç½®ä¾èµ–åï¼Œä½¿ç”¨ \`/agent-medium\` æˆ– \`/agent-simple\` è§¦å‘å¼€å‘`
                ].filter(Boolean).join('\n');

                const labels = [
                  'sub-issue',
                  `priority:P${task.priority}`,
                  ...(typeLabels[task.type] || [])
                ];

                // æ ¹æ®é¢„ä¼°å·¥æ—¶å†³å®šå¤æ‚åº¦æ ‡ç­¾
                if (task.estimated_hours <= 2) {
                  labels.push('complexity:simple');
                } else if (task.estimated_hours <= 6) {
                  labels.push('complexity:medium');
                } else {
                  labels.push('complexity:complex');
                }

                const { data: subIssue } = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[${task.type.toUpperCase()}] ${task.title}`,
                  body: subIssueBody,
                  labels: labels
                });

                createdIssues.push({
                  number: subIssue.number,
                  title: task.title,
                  type: task.type,
                  priority: task.priority,
                  depends_on: task.depends_on || []
                });

                console.log(`âœ… åˆ›å»ºå­ Issue #${subIssue.number}: ${task.title}`);
              }

              // åœ¨çˆ¶ Issue å‘å¸ƒæ±‡æ€»è¯„è®º
              const summaryTable = createdIssues.map((iss, idx) => {
                const deps = iss.depends_on.length > 0
                  ? iss.depends_on.map(d => `#${createdIssues[d]?.number || '?'}`).join(', ')
                  : '-';
                return `| ${idx + 1} | #${iss.number} | ${iss.title} | ${iss.type} | P${iss.priority} | ${deps} |`;
              }).join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: [
                  "âœ… **ä»»åŠ¡æ‹†åˆ†å®Œæˆ**",
                  "",
                  `å…±åˆ›å»º **${createdIssues.length}** ä¸ªå­ Issueï¼š`,
                  "",
                  "| # | Issue | æ ‡é¢˜ | ç±»å‹ | ä¼˜å…ˆçº§ | ä¾èµ– |",
                  "|---|-------|------|------|--------|------|",
                  summaryTable,
                  "",
                  architectureNotes ? `**æ¶æ„è¯´æ˜:**\n${architectureNotes}\n` : '',
                  "---",
                  "",
                  "**ä¸‹ä¸€æ­¥æ“ä½œ:**",
                  "1. æ£€æŸ¥å­ Issue çš„æ‹†åˆ†æ˜¯å¦åˆç†",
                  "2. ä»æ²¡æœ‰ä¾èµ–çš„ Issue å¼€å§‹ï¼ˆä¼˜å…ˆçº§é«˜çš„å…ˆåšï¼‰",
                  "3. åœ¨å­ Issue ä¸­ä½¿ç”¨ `/agent-medium` æˆ– `/agent-simple` è§¦å‘å¼€å‘",
                  "",
                  "> ğŸ’¡ å»ºè®®æŒ‰ç…§ æ•°æ®åº“ â†’ åç«¯ â†’ å‰ç«¯ çš„é¡ºåºå¼€å‘",
                  "",
                  "---",
                  "> ğŸ¤– ç”± Vibe Complex Agent è‡ªåŠ¨å¤„ç†"
                ].filter(Boolean).join("\n")
              });

              // æ›´æ–°æ ‡ç­¾
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  name: 'ğŸ¤– ai-processing'
                });
              } catch (e) {}

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['âœ… ai-completed', 'has-subtasks']
              });

              // è‡ªåŠ¨è§¦å‘ç¬¬ä¸€ä¸ªæ— ä¾èµ–çš„å­ä»»åŠ¡
              const firstTask = createdIssues.find(iss => !iss.depends_on || iss.depends_on.length === 0);
              if (firstTask) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: firstTask.number,
                  body: `/agent-medium\n\n---\n\nğŸ¤– **è‡ªåŠ¨è§¦å‘å¼€å‘**\n\næ­¤ä»»åŠ¡æ— å‰ç½®ä¾èµ–ï¼Œè‡ªåŠ¨å¼€å§‹å¼€å‘ã€‚`
                });
                console.log(`ğŸš€ è‡ªåŠ¨è§¦å‘å­ä»»åŠ¡ #${firstTask.number}`);
              }

            } catch (error) {
              console.error("âŒ ä»»åŠ¡æ‹†åˆ†å¤±è´¥:", error.message);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: [
                  "âŒ **Complex Agent å¤±è´¥**",
                  "",
                  `é”™è¯¯: ${error.message}`,
                  "",
                  "**å¯èƒ½çš„åŸå› :**",
                  "- éœ€æ±‚æè¿°ä¸å¤Ÿè¯¦ç»†",
                  "- éœ€æ±‚èŒƒå›´è¿‡å¤§æˆ–è¿‡å°",
                  "- API è°ƒç”¨å¤±è´¥",
                  "",
                  "**è§£å†³æ–¹æ¡ˆ:**",
                  "- è¡¥å……éœ€æ±‚æè¿°ï¼ˆåŒ…å«å…·ä½“åŠŸèƒ½ç‚¹ï¼‰",
                  "- ä½¿ç”¨ `/agent-complex` é‡è¯•",
                  "- æˆ–æ‰‹åŠ¨æ‹†åˆ†éœ€æ±‚åä½¿ç”¨ `/agent-medium`",
                  "",
                  "---",
                  "> ğŸ¤– ç”± Vibe Complex Agent å¤„ç†"
                ].join("\n")
              });

              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  name: 'ğŸ¤– ai-processing'
                });
              } catch (e) {}

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['âŒ ai-failed', 'needs-review']
              });

              core.setFailed(error.message);
            }
