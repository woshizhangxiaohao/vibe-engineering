name: Complex Task Agent

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue ç¼–å·'
        required: true
        type: string
  issue_comment:
    types: [created]

jobs:
  complex-task:
    # é€šè¿‡ workflow_callã€workflow_dispatch æˆ– /agent-complex å‘½ä»¤è§¦å‘
    if: |
      github.event_name == 'workflow_call' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.comment.body, '/agent-complex')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read
      actions: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Issue Info
        id: issue_info
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber;
            let issue;

            if (context.eventName === 'workflow_dispatch') {
              // workflow_dispatch è§¦å‘æ—¶ä» inputs è·å–
              issueNumber = parseInt('${{ github.event.inputs.issue_number }}');
              const { data } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              issue = data;
            } else {
              // issue_comment æˆ– workflow_call è§¦å‘
              issue = context.payload.issue;
              issueNumber = issue.number;
            }

            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issue.title);
            core.setOutput('issue_body', issue.body || '');

            return { issueNumber, title: issue.title, body: issue.body };

      - name: Route and Trigger Agent
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const title = ${{ toJson(steps.issue_info.outputs.issue_title) }};
            const body = ${{ toJson(steps.issue_info.outputs.issue_body) }};

            console.log("=".repeat(60));
            console.log("ğŸ“‹ COMPLEX AGENT - è·¯ç”±åˆ°å¯¹åº” Agent");
            console.log("=".repeat(60));
            console.log(`Issue #${issueNumber}: ${title}`);

            // ä» body è§£æç±»å‹ä¿¡æ¯
            // åŒ¹é…: "ç±»å‹: å…¨æ ˆï¼ˆåç«¯ + å‰ç«¯ï¼‰" æˆ– "**ç±»å‹**: åç«¯" ç­‰
            const typeMatch = body.match(/ç±»å‹[ï¼š:]\s*(.+)/i);
            const typeText = typeMatch ? typeMatch[1].toLowerCase() : '';

            let agentType = null;
            let agentWorkflow = null;
            let isFullstack = false;

            // ä¼˜å…ˆä» body åˆ¤æ–­
            if (typeText.includes('å…¨æ ˆ') || typeText.includes('åç«¯') && typeText.includes('å‰ç«¯')) {
              isFullstack = true;
              agentType = 'backend';
              agentWorkflow = 'agent-be.yml';
              console.log("ğŸ“Œ æ£€æµ‹åˆ°å…¨æ ˆä»»åŠ¡ï¼Œå…ˆè§¦å‘åç«¯ Agent");
            } else if (typeText.includes('åç«¯') || typeText.includes('backend')) {
              agentType = 'backend';
              agentWorkflow = 'agent-be.yml';
              console.log("ğŸ“Œ æ£€æµ‹åˆ°åç«¯ä»»åŠ¡");
            } else if (typeText.includes('å‰ç«¯') || typeText.includes('frontend')) {
              agentType = 'frontend';
              agentWorkflow = 'agent-fe.yml';
              console.log("ğŸ“Œ æ£€æµ‹åˆ°å‰ç«¯ä»»åŠ¡");
            } else {
              // ä»æ ‡é¢˜åˆ¤æ–­
              const titleUpper = title.toUpperCase();
              if (titleUpper.includes('[BE+FE]') || titleUpper.includes('[FE+BE]') || titleUpper.includes('[FULLSTACK]')) {
                isFullstack = true;
                agentType = 'backend';
                agentWorkflow = 'agent-be.yml';
                console.log("ğŸ“Œ ä»æ ‡é¢˜æ£€æµ‹åˆ°å…¨æ ˆä»»åŠ¡ [BE+FE]ï¼Œå…ˆè§¦å‘åç«¯ Agent");
              } else if (titleUpper.includes('[BE]') || titleUpper.includes('[BACKEND]')) {
                agentType = 'backend';
                agentWorkflow = 'agent-be.yml';
                console.log("ğŸ“Œ ä»æ ‡é¢˜æ£€æµ‹åˆ°åç«¯ä»»åŠ¡ [BE]");
              } else if (titleUpper.includes('[FE]') || titleUpper.includes('[FRONTEND]')) {
                agentType = 'frontend';
                agentWorkflow = 'agent-fe.yml';
                console.log("ğŸ“Œ ä»æ ‡é¢˜æ£€æµ‹åˆ°å‰ç«¯ä»»åŠ¡ [FE]");
              } else {
                // é»˜è®¤ä½¿ç”¨ agent-medium
                agentType = 'medium';
                agentWorkflow = 'agent-medium.yml';
                console.log("ğŸ“Œ æœªè¯†åˆ«ç±»å‹ï¼Œä½¿ç”¨ Medium Agent");
              }
            }

            // å‘å¸ƒè¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                "ğŸ“‹ **Complex Agent - ä»»åŠ¡è·¯ç”±**",
                "",
                `æ£€æµ‹åˆ°ä»»åŠ¡ç±»å‹: **${agentType}**`,
                "",
                `æ­£åœ¨è§¦å‘ \`${agentWorkflow}\`...`,
                "",
                "---",
                "> ğŸ¤– ç”± Vibe Complex Agent å¤„ç†"
              ].join("\n")
            });

            // æ·»åŠ æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'complexity:complex'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['ğŸ¤– ai-processing', `agent:${agentType}`]
            });

            // è§¦å‘å¯¹åº” Agent
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: agentWorkflow,
                ref: 'main',
                inputs: {
                  issue_number: String(issueNumber)
                }
              });

              console.log(`ğŸš€ å·²è§¦å‘ ${agentWorkflow} for Issue #${issueNumber}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âœ… **${agentType.charAt(0).toUpperCase() + agentType.slice(1)} Agent å·²è§¦å‘**\n\n> ğŸ“Š å¯é€šè¿‡ [Actions](/${context.repo.owner}/${context.repo.repo}/actions) æŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€`
              });

            } catch (err) {
              console.error(`âŒ è§¦å‘ ${agentWorkflow} å¤±è´¥: ${err.message}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: [
                  "âŒ **è§¦å‘ Agent å¤±è´¥**",
                  "",
                  `é”™è¯¯: ${err.message}`,
                  "",
                  `è¯·æ‰‹åŠ¨ä½¿ç”¨ \`/agent-be\` æˆ– \`/agent-fe\` å‘½ä»¤è§¦å‘ã€‚`,
                  "",
                  "---",
                  "> ğŸ¤– ç”± Vibe Complex Agent å¤„ç†"
                ].join("\n")
              });

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['âŒ ai-failed', 'needs-review']
              });

              core.setFailed(err.message);
            }
