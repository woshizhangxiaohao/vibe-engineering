name: Error Handler

on:
  workflow_run:
    workflows: 
      - "Backend Agent"
      - "Vibe Frontend Agent"
      - "Vibe UI Agent"
    types:
      - completed

jobs:
  handle-errors:
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      actions: read
    
    steps:
      - name: Report Failure to Issue
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            
            // æŸ¥æ‰¾å…³è”çš„ Issueï¼ˆä» PR æˆ– branch åç§°ï¼‰
            let issueNumber = null;
            
            // å°è¯•ä» branch åç§°æå– issue number
            const branchMatch = run.head_branch?.match(/issue-(\d+)/);
            if (branchMatch) {
              issueNumber = parseInt(branchMatch[1]);
            }
            
            // å¦‚æœæœ‰å…³è”çš„ PRï¼Œä» PR è·å–
            if (!issueNumber && run.pull_requests.length > 0) {
              issueNumber = run.pull_requests[0].number;
            }
            
            // è·å–å¤±è´¥çš„ jobs
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run.id
            });
            
            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');
            
            const errorReport = [
              "## âŒ Workflow æ‰§è¡Œå¤±è´¥",
              "",
              `**Workflow:** ${run.name}`,
              `**è¿è¡Œ ID:** ${run.id}`,
              `**è§¦å‘åˆ†æ”¯:** ${run.head_branch}`,
              `**è§¦å‘äº‹ä»¶:** ${run.event}`,
              "",
              "### å¤±è´¥çš„ Jobs:",
              ...failedJobs.map(job => `- **${job.name}** (${job.conclusion})`),
              "",
              `ğŸ”— [æŸ¥çœ‹å®Œæ•´æ—¥å¿—](${run.html_url})`,
              "",
              "---",
              "_è‡ªåŠ¨ç”Ÿæˆçš„é”™è¯¯æŠ¥å‘Š - Error Handler_"
            ].join("\n");
            
            if (issueNumber) {
              // è¯„è®ºåˆ°å…³è”çš„ Issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: errorReport
              });
              
              // ç§»é™¤ processing æ ‡ç­¾ï¼Œæ·»åŠ  failed æ ‡ç­¾
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'ğŸ¤– ai-processing'
              }).catch(() => {});
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['âŒ ai-failed']
              });
            } else {
              // åˆ›å»ºæ–° Issue æŠ¥å‘Šé”™è¯¯
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Auto] Workflow å¤±è´¥: ${run.name}`,
                body: errorReport,
                labels: ['ğŸ› bug', 'ğŸ¤– auto-generated', 'workflow-failure']
              });
            }
