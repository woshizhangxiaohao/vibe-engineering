name: Error Handler

on:
  workflow_run:
    workflows:
      - "Backend Agent"
      - "Vibe Frontend Agent"
      - "Vibe UI Agent"
    types:
      - completed

  # æ‰‹åŠ¨è§¦å‘æµ‹è¯•
  workflow_dispatch:
    inputs:
      run_id:
        description: 'è¦åˆ†æçš„ workflow run ID'
        required: true
        type: string
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆä¸è§¦å‘è‡ªåŠ¨ä¿®å¤ï¼‰'
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write

jobs:
  handle-errors:
    # è‡ªåŠ¨è§¦å‘æ—¶åªå¤„ç†å¤±è´¥çš„ workflowï¼Œæ‰‹åŠ¨è§¦å‘æ—¶æ€»æ˜¯è¿è¡Œ
    if: github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Collect Error Info
        id: error_info
        uses: actions/github-script@v7
        with:
          script: |
            // æ”¯æŒæ‰‹åŠ¨è§¦å‘å’Œè‡ªåŠ¨è§¦å‘ä¸¤ç§æ¨¡å¼
            const isManualTrigger = context.eventName === 'workflow_dispatch';
            const runId = isManualTrigger
              ? parseInt('${{ inputs.run_id }}')
              : context.payload.workflow_run.id;

            // è·å– workflow run ä¿¡æ¯
            const runData = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });
            const run = runData.data;

            // æŸ¥æ‰¾å…³è”çš„ Issue
            let issueNumber = null;
            const branchMatch = run.head_branch?.match(/issue-(\d+)/);
            if (branchMatch) {
              issueNumber = parseInt(branchMatch[1]);
            }
            if (!issueNumber && run.pull_requests && run.pull_requests.length > 0) {
              issueNumber = run.pull_requests[0].number;
            }

            // è·å–å¤±è´¥çš„ jobs å’Œæ—¥å¿—
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            // è·å–æ¯ä¸ªå¤±è´¥ job çš„æ—¥å¿—ï¼ˆæˆªå–æœ€åéƒ¨åˆ†ï¼‰
            let errorLogs = [];
            for (const job of failedJobs.slice(0, 2)) { // æœ€å¤š2ä¸ª job
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });
                // åªä¿ç•™æœ€å 150 è¡Œï¼Œé¿å…å¤ªé•¿
                const logLines = logs.data.split('\n').slice(-150).join('\n');
                errorLogs.push({
                  jobName: job.name,
                  logs: logLines.substring(0, 8000) // é™åˆ¶é•¿åº¦
                });
              } catch (e) {
                errorLogs.push({ jobName: job.name, logs: 'Failed to fetch logs' });
              }
            }

            // ä¿å­˜ç»“æœ
            const result = {
              issueNumber,
              runId: run.id,
              runUrl: run.html_url,
              workflowName: run.name,
              headBranch: run.head_branch,
              event: run.event,
              failedJobs: failedJobs.map(j => j.name),
              errorLogs
            };

            core.setOutput('result', JSON.stringify(result));
            core.setOutput('issue_number', issueNumber || '');
            core.setOutput('error_logs_json', JSON.stringify(errorLogs));
            return result;

      - name: Analyze Error with Claude (OpenRouter)
        id: analyze
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          ERROR_INFO='${{ steps.error_info.outputs.result }}'
          WORKFLOW_NAME=$(echo "$ERROR_INFO" | jq -r '.workflowName')
          HEAD_BRANCH=$(echo "$ERROR_INFO" | jq -r '.headBranch')
          FAILED_JOBS=$(echo "$ERROR_INFO" | jq -r '.failedJobs | join(", ")')
          ERROR_LOGS='${{ steps.error_info.outputs.error_logs_json }}'

          # æ„å»º prompt
          PROMPT="ä½ æ˜¯ä¸€ä¸ª CI/CD é”™è¯¯åˆ†æä¸“å®¶ã€‚è¯·åˆ†æä»¥ä¸‹ GitHub Actions workflow å¤±è´¥çš„åŸå› ï¼Œå¹¶æä¾›ç®€æ´çš„åˆ†ææŠ¥å‘Šã€‚

          ## Workflow ä¿¡æ¯
          - Workflow: ${WORKFLOW_NAME}
          - Branch: ${HEAD_BRANCH}
          - å¤±è´¥çš„ Jobs: ${FAILED_JOBS}

          ## é”™è¯¯æ—¥å¿—
          ${ERROR_LOGS}

          è¯·è¾“å‡ºä»¥ä¸‹æ ¼å¼çš„åˆ†ææŠ¥å‘Šï¼ˆä½¿ç”¨ä¸­æ–‡ï¼‰ï¼š

          ## ğŸ” é”™è¯¯åˆ†æ

          ### æ ¹æœ¬åŸå› 
          [ä¸€å¥è¯æè¿°æ ¹æœ¬åŸå› ]

          ### é”™è¯¯ç±»å‹
          [é€‰æ‹©ä¸€ä¸ª: é…ç½®é—®é¢˜ | ä»£ç é”™è¯¯ | è¾“å…¥ç¼ºå¤± | æƒé™é—®é¢˜ | ä¸´æ—¶æ•…éšœ | å…¶ä»–]

          ### è¯¦ç»†è¯´æ˜
          [2-3å¥è¯è¯¦ç»†è§£é‡Šé—®é¢˜]

          ### å»ºè®®ä¿®å¤æ–¹æ¡ˆ
          [åˆ—å‡º1-3ä¸ªå…·ä½“çš„ä¿®å¤æ­¥éª¤]

          ### æ˜¯å¦å¯è‡ªåŠ¨ä¿®å¤
          [æ˜¯/å¦] - [åŸå› ]"

          # è°ƒç”¨ OpenRouter API
          RESPONSE=$(curl -s -X POST "https://openrouter.ai/api/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${OPENROUTER_API_KEY}" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              '{
                "model": "anthropic/claude-sonnet-4",
                "messages": [{"role": "user", "content": $prompt}],
                "max_tokens": 1500
              }')")

          # æå–åˆ†æç»“æœ
          ANALYSIS=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "AI åˆ†æå¤±è´¥ï¼Œè¯·æŸ¥çœ‹åŸå§‹æ—¥å¿—"')

          # ä¿å­˜åˆ°æ–‡ä»¶ä»¥ä¾¿åç»­æ­¥éª¤ä½¿ç”¨
          echo "$ANALYSIS" > /tmp/analysis.md

          # è®¾ç½®è¾“å‡º
          echo "analysis<<EOF" >> $GITHUB_OUTPUT
          echo "$ANALYSIS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Analysis to Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const errorInfo = ${{ steps.error_info.outputs.result }};

            let analysis = '';
            try {
              analysis = fs.readFileSync('/tmp/analysis.md', 'utf8');
            } catch (e) {
              analysis = '_AI åˆ†ææš‚ä¸å¯ç”¨_';
            }

            const reportBody = [
              "## âŒ Workflow æ‰§è¡Œå¤±è´¥",
              "",
              `**Workflow:** ${errorInfo.workflowName}`,
              `**è¿è¡Œ ID:** ${errorInfo.runId}`,
              `**è§¦å‘åˆ†æ”¯:** ${errorInfo.headBranch}`,
              `**è§¦å‘äº‹ä»¶:** ${errorInfo.event}`,
              "",
              "### å¤±è´¥çš„ Jobs:",
              ...errorInfo.failedJobs.map(job => `- **${job}**`),
              "",
              `ğŸ”— [æŸ¥çœ‹å®Œæ•´æ—¥å¿—](${errorInfo.runUrl})`,
              "",
              "---",
              "",
              analysis,
              "",
              "---",
              "_è‡ªåŠ¨ç”Ÿæˆ - Error Handler with AI Analysis_"
            ].join("\n");

            if (errorInfo.issueNumber) {
              // è¯„è®ºåˆ°å…³è”çš„ Issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: errorInfo.issueNumber,
                body: reportBody
              });

              // æ›´æ–°æ ‡ç­¾
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: errorInfo.issueNumber,
                name: 'ğŸ¤– ai-processing'
              }).catch(() => {});

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: errorInfo.issueNumber,
                labels: ['âŒ ai-failed', 'ğŸ” analyzed']
              });

              core.setOutput('target_issue', errorInfo.issueNumber);
              console.log(`âœ… å·²è¯„è®ºåˆ° Issue #${errorInfo.issueNumber}`);
            } else {
              // åˆ›å»ºæ–° Issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Auto] Workflow å¤±è´¥: ${errorInfo.workflowName}`,
                body: reportBody,
                labels: ['ğŸ› bug', 'ğŸ¤– auto-generated', 'workflow-failure', 'ğŸ” analyzed']
              });

              core.setOutput('target_issue', newIssue.data.number);
              console.log(`âœ… å·²åˆ›å»º Issue #${newIssue.data.number}`);
            }

      - name: Check if Auto-Fix is Possible
        id: check_fix
        run: |
          ANALYSIS=$(cat /tmp/analysis.md || echo "")

          # ç®€å•åˆ¤æ–­æ˜¯å¦å¯ä»¥è‡ªåŠ¨ä¿®å¤
          if echo "$ANALYSIS" | grep -q "æ˜¯å¦å¯è‡ªåŠ¨ä¿®å¤" && \
             echo "$ANALYSIS" | grep -q "ä»£ç é”™è¯¯" && \
             echo "$ANALYSIS" | grep -E "æ˜¯å¦å¯è‡ªåŠ¨ä¿®å¤.*æ˜¯|æ˜¯.*æ˜¯å¦å¯è‡ªåŠ¨ä¿®å¤" | grep -qv "å¦"; then
            echo "can_auto_fix=true" >> $GITHUB_OUTPUT
          else
            echo "can_auto_fix=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Auto-Fix (if applicable)
        if: steps.check_fix.outputs.can_auto_fix == 'true' && inputs.test_mode != true
        uses: actions/github-script@v7
        with:
          script: |
            const errorInfo = ${{ steps.error_info.outputs.result }};

            // è§¦å‘ fix-pr workflow
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'fix-pr.yml',
              ref: 'main',
              inputs: {
                pr_number: String(errorInfo.issueNumber || ''),
                error_context: `Workflow ${errorInfo.workflowName} failed. Check issue for AI analysis.`
              }
            }).catch(e => {
              console.log('Could not trigger auto-fix:', e.message);
            });

            // è¯„è®ºé€šçŸ¥
            if (errorInfo.issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: errorInfo.issueNumber,
                body: 'ğŸ”§ **æ­£åœ¨å°è¯•è‡ªåŠ¨ä¿®å¤...** è¯·ç¨å€™æŸ¥çœ‹ç»“æœã€‚'
              });
            }
