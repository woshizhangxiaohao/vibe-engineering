name: Dependency Chain Trigger

# å½“å­ Issue å…³é—­æ—¶ï¼Œæ£€æŸ¥å¹¶è§¦å‘ä¾èµ–é“¾ä¸­çš„ä¸‹ä¸€ä¸ªä»»åŠ¡
on:
  issues:
    types: [closed]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'æŒ‡å®šå·²å®Œæˆçš„å­ Issue ç¼–å·'
        required: true
        type: string
      force:
        description: 'å…è®¸åœ¨ Issue æœªå…³é—­æ—¶è°ƒè¯•ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  trigger-next-task:
    # åªå¤„ç† sub-issue æ ‡ç­¾çš„ issue
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.issue.labels.*.name, 'sub-issue')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      actions: write

    steps:
      - name: Check and Trigger Next Task
        uses: actions/github-script@v7
        with:
          script: |
            const isManual = context.eventName === 'workflow_dispatch';
            let closedIssue = context.payload.issue;

            if (isManual) {
              const rawIssueNumber = '${{ github.event.inputs.issue_number }}';
              const force = '${{ github.event.inputs.force }}' === 'true';
              const issueNumber = parseInt(rawIssueNumber);

              if (!issueNumber || Number.isNaN(issueNumber)) {
                console.log('âŒ æœªæä¾›æœ‰æ•ˆçš„ issue_numberï¼Œé€€å‡º');
                return;
              }

              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              closedIssue = issue;

              const labels = issue.labels.map(l => l.name);
              if (!labels.includes('sub-issue')) {
                console.log(`â­ï¸ Issue #${issueNumber} ä¸æ˜¯ sub-issueï¼Œè·³è¿‡`);
                return;
              }

              if (issue.state !== 'closed' && !force) {
                console.log(`â­ï¸ Issue #${issueNumber} æœªå…³é—­ï¼Œæœªå¼€å¯ forceï¼Œè·³è¿‡`);
                return;
              }

              console.log(`ğŸ› ï¸ æ‰‹åŠ¨è°ƒè¯•æ¨¡å¼ï¼šä½¿ç”¨ Issue #${issueNumber} ä½œä¸ºä¾èµ–å®Œæˆç‚¹`);
            }

            const closedIssueNumber = closedIssue.number;
            const closedIssueBody = closedIssue.body || '';

            console.log("=".repeat(60));
            console.log("ğŸ”— DEPENDENCY CHAIN TRIGGER");
            console.log("=".repeat(60));
            console.log(`âœ… Issue #${closedIssueNumber} å·²å…³é—­: ${closedIssue.title}`);

            // ä» issue body ä¸­æå– parent issue ç¼–å·
            const parentMatch = closedIssueBody.match(/Parent:\s*#(\d+)/i);
            if (!parentMatch) {
              console.log("â­ï¸ æœªæ‰¾åˆ° Parent Issueï¼Œè·³è¿‡ä¾èµ–é“¾æ£€æŸ¥");
              return;
            }

            const parentIssueNumber = parseInt(parentMatch[1]);
            console.log(`ğŸ“‹ Parent Issue: #${parentIssueNumber}`);

            // è·å–æ‰€æœ‰å…·æœ‰ç›¸åŒ parent çš„ sub-issues
            const { data: allIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              labels: 'sub-issue',
              per_page: 100
            });

            // è¿‡æ»¤å‡ºåŒä¸€ä¸ª parent çš„å­ä»»åŠ¡
            const siblingIssues = allIssues.filter(issue => {
              const body = issue.body || '';
              const match = body.match(/Parent:\s*#(\d+)/i);
              return match && parseInt(match[1]) === parentIssueNumber;
            });

            console.log(`ğŸ“Š åŒä¸€ Parent ä¸‹å…±æœ‰ ${siblingIssues.length} ä¸ªå­ä»»åŠ¡`);

            // è§£ææ¯ä¸ª sibling çš„ä¾èµ–å…³ç³»
            const issueMap = new Map(); // number -> { issue, depends_on: [numbers], state }

            for (const issue of siblingIssues) {
              const body = issue.body || '';
              const depends = [];

              // æå–ä¾èµ–ï¼šæ”¯æŒå¤šç§æ ¼å¼
              // - **å‰ç½®ä¾èµ–:** #123, #124
              // - **å‰ç½®ä¾èµ–:** #123 #124 (ç©ºæ ¼åˆ†éš”)
              // - å‰ç½®ä¾èµ–: 123, 124 (ä¸å¸¦#)
              const depsMatch = body.match(/\*{0,2}å‰ç½®ä¾èµ–\*{0,2}[ï¼š:]?\s*((?:#?\d+[\s,]*)+)/i);
              if (depsMatch) {
                // æå–æ‰€æœ‰æ•°å­—
                const depNumbers = depsMatch[1].match(/\d+/g);
                if (depNumbers) {
                  for (const num of depNumbers) {
                    depends.push(parseInt(num));
                  }
                }
              }

              issueMap.set(issue.number, {
                issue: issue,
                depends_on: depends,
                state: issue.state
              });

              console.log(`  - #${issue.number}: ${issue.state}, ä¾èµ–: ${depends.length > 0 ? depends.map(d => '#' + d).join(', ') : 'æ— '}`);
            }

            // æ‰¾å‡ºä¾èµ–åˆšå…³é—­çš„ issue çš„ä»»åŠ¡
            const dependentIssues = [];
            for (const [number, info] of issueMap.entries()) {
              if (info.depends_on.includes(closedIssueNumber) && info.state === 'open') {
                dependentIssues.push(info);
              }
            }

            if (dependentIssues.length === 0) {
              console.log("âœ… æ²¡æœ‰å…¶ä»–ä»»åŠ¡ä¾èµ–æ­¤ Issueï¼Œä¾èµ–é“¾æ£€æŸ¥å®Œæˆ");
              return;
            }

            console.log(`\nğŸ” å‘ç° ${dependentIssues.length} ä¸ªä»»åŠ¡ä¾èµ– #${closedIssueNumber}`);

            // æ£€æŸ¥æ¯ä¸ªä¾èµ–ä»»åŠ¡çš„æ‰€æœ‰å‰ç½®ä¾èµ–æ˜¯å¦éƒ½å·²å…³é—­
            let triggeredCount = 0;

            for (const depInfo of dependentIssues) {
              const depIssue = depInfo.issue;
              const allDeps = depInfo.depends_on;

              console.log(`\nğŸ“Œ æ£€æŸ¥ #${depIssue.number}: ${depIssue.title}`);
              console.log(`   æ‰€æœ‰ä¾èµ–: ${allDeps.map(d => '#' + d).join(', ')}`);

              // æ£€æŸ¥æ‰€æœ‰ä¾èµ–æ˜¯å¦éƒ½å·²å…³é—­
              let allDepsClosed = true;
              for (const depNumber of allDeps) {
                const depState = issueMap.get(depNumber)?.state;
                if (depState !== 'closed') {
                  console.log(`   âŒ ä¾èµ– #${depNumber} æœªå…³é—­ (çŠ¶æ€: ${depState || 'æœªçŸ¥'})`);
                  allDepsClosed = false;
                }
              }

              if (!allDepsClosed) {
                console.log(`   â³ ä¾èµ–æœªå…¨éƒ¨å®Œæˆï¼Œæš‚ä¸è§¦å‘`);
                continue;
              }

              console.log(`   âœ… æ‰€æœ‰ä¾èµ–å·²å…³é—­ï¼Œå‡†å¤‡è§¦å‘ Agent`);

              // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å¤„ç†ä¸­
              const labels = depIssue.labels.map(l => l.name);
              if (labels.includes('ai:processing')) {
                console.log(`   â­ï¸ å·²åœ¨å¤„ç†ä¸­ï¼Œè·³è¿‡`);
                continue;
              }
              if (labels.includes('ai:completed')) {
                console.log(`   â­ï¸ å·²å®Œæˆï¼Œè·³è¿‡`);
                continue;
              }

              // ç¡®å®š agent ç±»å‹
              let agentWorkflow = 'agent-medium.yml';
              let agentType = 'Medium';

              if (labels.includes('complexity:simple')) {
                agentWorkflow = 'agent-simple.yml';
                agentType = 'Simple';
              } else if (labels.includes('complexity:complex')) {
                agentWorkflow = 'agent-complex.yml';
                agentType = 'Complex';
              }

              // è§¦å‘ agent
              try {
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: agentWorkflow,
                  ref: 'main',
                  inputs: {
                    issue_number: String(depIssue.number)
                  }
                });

                console.log(`   ğŸš€ å·²è§¦å‘ ${agentType} Agent for #${depIssue.number}`);

                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´è®© workflow run åˆ›å»º
                await new Promise(resolve => setTimeout(resolve, 2000));

                // æŸ¥è¯¢åˆšè§¦å‘çš„ workflow run
                let actionUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions`;
                try {
                  const { data: runs } = await github.rest.actions.listWorkflowRuns({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    workflow_id: agentWorkflow,
                    per_page: 5
                  });

                  // æ‰¾åˆ°åŒ¹é…æ­¤ issue çš„æœ€æ–° run
                  const latestRun = runs.workflow_runs.find(run =>
                    run.status === 'queued' || run.status === 'in_progress' || run.status === 'pending'
                  ) || runs.workflow_runs[0];

                  if (latestRun) {
                    actionUrl = latestRun.html_url;
                  }
                } catch (e) {
                  console.log(`   âš ï¸ è·å– Action URL å¤±è´¥: ${e.message}`);
                }

                // å‘è¯„è®ºé€šçŸ¥
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: depIssue.number,
                  body: [
                    `ğŸ”— **ä¾èµ–é“¾è§¦å‘**`,
                    ``,
                    `å‰ç½®ä¾èµ– #${closedIssueNumber} å·²å®Œæˆå¹¶å…³é—­ï¼Œè‡ªåŠ¨å¯åŠ¨ ${agentType} Agentã€‚`,
                    ``,
                    `**å·²å®Œæˆçš„ä¾èµ–:**`,
                    allDeps.map(d => `- âœ… #${d}`).join('\n'),
                    ``,
                    `---`,
                    `> ğŸ“Š **Actions æ—¥å¿—**: [æŸ¥çœ‹è¯¦æƒ…](${actionUrl})`
                  ].join('\n')
                });

                triggeredCount++;

              } catch (error) {
                console.error(`   âŒ è§¦å‘å¤±è´¥: ${error.message}`);

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: depIssue.number,
                  body: [
                    `âš ï¸ **è‡ªåŠ¨è§¦å‘å¤±è´¥**`,
                    ``,
                    `å‰ç½®ä¾èµ– #${closedIssueNumber} å·²å®Œæˆï¼Œä½†è‡ªåŠ¨è§¦å‘å¤±è´¥: ${error.message}`,
                    ``,
                    `è¯·æ‰‹åŠ¨ä½¿ç”¨ \`/agent-${agentType.toLowerCase()}\` å‘½ä»¤è§¦å‘ã€‚`
                  ].join('\n')
                });
              }
            }

            // æ±‡æ€»
            console.log("\n" + "=".repeat(60));
            console.log(`ğŸ“Š ä¾èµ–é“¾è§¦å‘å®Œæˆ: æˆåŠŸè§¦å‘ ${triggeredCount} ä¸ªä»»åŠ¡`);
            console.log("=".repeat(60));
