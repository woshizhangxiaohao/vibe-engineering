name: Agent Architect (Plan FE)

on:
  issue_comment:
    types: [created]

jobs:
  architect:
    # è§¦å‘æŒ‡ä»¤ï¼š/plan-fe
    if: contains(github.event.comment.body, '/plan-fe')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Generate File Tree
        id: file_tree
        run: |
          # ç”Ÿæˆé¡¹ç›®ç›®å½•ç»“æ„ (æ’é™¤å¹²æ‰°é¡¹)
          # maxdepth 5 æ§åˆ¶æ·±åº¦ï¼Œé˜²æ­¢ Token æº¢å‡º
          TREE=$(find . -maxdepth 5 -not -path '*/.*' -not -path '*/node_modules*' -not -path '*/dist*' -not -path '*/build*' -not -path '*/.next*' | sed 's|./||' | sort)
          
          # å°†ç»“æœå†™å…¥ç¯å¢ƒå˜é‡ (å¤„ç†å¤šè¡Œå­—ç¬¦ä¸²)
          echo "TREE<<EOF" >> $GITHUB_ENV
          echo "$TREE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Analyze Structure & Plan
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          PROJECT_TREE: ${{ env.TREE }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        with:
          script: |
            const issueBody = process.env.ISSUE_BODY;
            const tree = process.env.PROJECT_TREE;
            const commentBody = process.env.COMMENT_BODY;
            const treeLines = tree.split('\n').filter(l => l.trim());
            
            console.log("ğŸš€ æ¶æ„å¸ˆå¼€å§‹åˆ†æ...");

            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            const fileExists = async (path) => {
              try {
                await github.rest.repos.getContent({ ...context.repo, path });
                return true;
              } catch (e) {
                return false;
              }
            };

            // æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨ï¼ˆé€šè¿‡æ£€æŸ¥ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼‰
            const dirExists = async (dirPath) => {
              try {
                const { data } = await github.rest.repos.getContent({ 
                  ...context.repo, 
                  path: dirPath 
                });
                return Array.isArray(data);
              } catch (e) {
                return false;
              }
            };

            // ä»æ–‡æœ¬ä¸­æå–å¯èƒ½çš„æ–‡ä»¶è·¯å¾„
            const extractPaths = (text) => {
              const patterns = [
                /(?:frontend|src)\/[\w\-\.\/\(\)]+\.(?:tsx|ts|css|json)/g,
                /app\/[\w\-\.\/\(\)]+\.(?:tsx|ts)/g,
                /components\/[\w\-\.\/]+\.(?:tsx|ts)/g,
                /hooks\/[\w\-\.\/]+\.(?:tsx|ts)/g,
                /lib\/[\w\-\.\/]+\.(?:tsx|ts)/g,
                /types\/[\w\-\.\/]+\.(?:tsx|ts)/g
              ];
              
              const paths = new Set();
              for (const pattern of patterns) {
                const matches = text.match(pattern) || [];
                matches.forEach(p => {
                  let normalized = p;
                  if (!normalized.startsWith('frontend/') && !normalized.startsWith('src/')) {
                    normalized = 'frontend/' + normalized;
                  }
                  paths.add(normalized);
                });
              }
              return Array.from(paths);
            };

            // åˆ†æç°æœ‰ç»„ä»¶å’Œå·¥å…·å‡½æ•°
            const analyzeExistingAssets = () => {
              const assets = {
                uiComponents: [],
                features: [],
                hooks: [],
                utils: [],
                services: [],
                types: [],
                pages: []
              };
              
              treeLines.forEach(line => {
                if (line.includes('components/ui/') && line.endsWith('.tsx')) {
                  assets.uiComponents.push(line);
                } else if (line.includes('components/features/') && line.endsWith('.tsx')) {
                  assets.features.push(line);
                } else if (line.includes('hooks/') && (line.endsWith('.ts') || line.endsWith('.tsx'))) {
                  assets.hooks.push(line);
                } else if (line.includes('lib/utils/') && line.endsWith('.ts')) {
                  assets.utils.push(line);
                } else if (line.includes('lib/api/services/') && line.endsWith('.ts')) {
                  assets.services.push(line);
                } else if (line.includes('types/') && line.endsWith('.ts')) {
                  assets.types.push(line);
                } else if (line.includes('app/') && line.includes('page.tsx')) {
                  assets.pages.push(line);
                }
              });
              
              return assets;
            };

            // 1. è‡ªåŠ¨å¯»æ‰¾å¹¶è¯»å–çˆ¶çº§ Issue
            const parentRegex = /(?:Parent|Ref|çˆ¶ä»»åŠ¡|çˆ¶çº§|çˆ¶éœ€æ±‚|å…³è”çˆ¶éœ€æ±‚)[\s:ï¼š]+#(\d+)/i;
            const parentMatch = issueBody.match(parentRegex);
            let fullContext = issueBody;
            let parentSpec = '';

            if (parentMatch) {
              const parentId = parentMatch[1];
              console.log(`ğŸ”— å‘ç°å…³è”çˆ¶éœ€æ±‚: #${parentId}`);
              try {
                const parentIssue = await github.rest.issues.get({
                  ...context.repo,
                  issue_number: parentId
                });
                parentSpec = parentIssue.data.body;
                fullContext += '\n\n--- [ç³»ç»Ÿè¿½åŠ ï¼šçˆ¶çº§æ¶æ„è§„èŒƒ (Issue #' + parentId + ')] ---\n' + parentSpec;
                
                // è¯»å–çˆ¶çº§ issue çš„è¯„è®º
                const parentComments = await github.rest.issues.listComments({
                  ...context.repo,
                  issue_number: parentId
                });
                if (parentComments.data.length > 0) {
                  const parentCommentsText = parentComments.data
                    .map(c => '[' + c.user.login + ']:\n' + c.body)
                    .join('\n\n---\n\n');
                  fullContext += '\n\n--- [çˆ¶çº§ Issue è¯„è®º] ---\n' + parentCommentsText;
                  parentSpec += '\n\n' + parentCommentsText;
                }
              } catch (e) {
                console.log(`âš ï¸ è¯»å–çˆ¶çº§éœ€æ±‚å¤±è´¥: ${e.message}`);
              }
            }

            // 2. åˆ†æç°æœ‰èµ„æº
            console.log("ğŸ“Š åˆ†æç°æœ‰é¡¹ç›®èµ„æº...");
            const existingAssets = analyzeExistingAssets();
            
            // 3. ä»éœ€æ±‚ä¸­æå–å¯èƒ½çš„æ–‡ä»¶è·¯å¾„
            const allText = fullContext + '\n' + commentBody;
            const mentionedPaths = extractPaths(allText);
            console.log(`ğŸ“‹ ä»éœ€æ±‚ä¸­è¯†åˆ«åˆ° ${mentionedPaths.length} ä¸ªå¯èƒ½çš„æ–‡ä»¶è·¯å¾„`);
            
            // 4. æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§
            const pathStatus = [];
            for (const path of mentionedPaths.slice(0, 20)) { // é™åˆ¶æ£€æŸ¥æ•°é‡
              const exists = await fileExists(path);
              pathStatus.push({ path, exists, type: exists ? 'å·²å­˜åœ¨' : 'éœ€æ–°å»º' });
            }
            
            // 5. åˆ†æç›®å½•ç»“æ„éœ€æ±‚
            const dirsToCheck = new Set();
            mentionedPaths.forEach(path => {
              const dir = path.substring(0, path.lastIndexOf('/'));
              if (dir) dirsToCheck.add(dir);
            });
            
            const dirStatus = [];
            for (const dir of Array.from(dirsToCheck).slice(0, 15)) {
              const exists = await dirExists(dir);
              dirStatus.push({ dir, exists, type: exists ? 'å·²å­˜åœ¨' : 'éœ€æ–°å»º' });
            }

            // 6. æ„å»ºè¯¦ç»†çš„åˆ†ææŠ¥å‘Š
            const existingAssetsReport = 
              '### ğŸ“¦ ç°æœ‰é¡¹ç›®èµ„æº\n\n' +
              '**UI ç»„ä»¶** (' + existingAssets.uiComponents.length + ' ä¸ª):\n' +
              (existingAssets.uiComponents.length > 0 
                ? existingAssets.uiComponents.slice(0, 10).map(c => '- `' + c + '`').join('\n') + 
                  (existingAssets.uiComponents.length > 10 ? '\n... (è¿˜æœ‰ ' + (existingAssets.uiComponents.length - 10) + ' ä¸ª)' : '')
                : 'æ— ') + '\n\n' +
              '**ä¸šåŠ¡ç»„ä»¶** (' + existingAssets.features.length + ' ä¸ª):\n' +
              (existingAssets.features.length > 0 
                ? existingAssets.features.slice(0, 10).map(c => '- `' + c + '`').join('\n') + 
                  (existingAssets.features.length > 10 ? '\n... (è¿˜æœ‰ ' + (existingAssets.features.length - 10) + ' ä¸ª)' : '')
                : 'æ— ') + '\n\n' +
              '**Hooks** (' + existingAssets.hooks.length + ' ä¸ª):\n' +
              (existingAssets.hooks.length > 0 
                ? existingAssets.hooks.slice(0, 10).map(h => '- `' + h + '`').join('\n') + 
                  (existingAssets.hooks.length > 10 ? '\n... (è¿˜æœ‰ ' + (existingAssets.hooks.length - 10) + ' ä¸ª)' : '')
                : 'æ— ') + '\n\n' +
              '**å·¥å…·å‡½æ•°** (' + existingAssets.utils.length + ' ä¸ª):\n' +
              (existingAssets.utils.length > 0 
                ? existingAssets.utils.slice(0, 10).map(u => '- `' + u + '`').join('\n') + 
                  (existingAssets.utils.length > 10 ? '\n... (è¿˜æœ‰ ' + (existingAssets.utils.length - 10) + ' ä¸ª)' : '')
                : 'æ— ') + '\n\n' +
              '**API Services** (' + existingAssets.services.length + ' ä¸ª):\n' +
              (existingAssets.services.length > 0 
                ? existingAssets.services.slice(0, 10).map(s => '- `' + s + '`').join('\n') + 
                  (existingAssets.services.length > 10 ? '\n... (è¿˜æœ‰ ' + (existingAssets.services.length - 10) + ' ä¸ª)' : '')
                : 'æ— ') + '\n\n' +
              '**ç°æœ‰é¡µé¢** (' + existingAssets.pages.length + ' ä¸ª):\n' +
              (existingAssets.pages.length > 0 
                ? existingAssets.pages.map(p => '- `' + p + '`').join('\n')
                : 'æ— ') + '\n\n';

            const pathStatusReport = pathStatus.length > 0 
              ? '### ğŸ“ æ–‡ä»¶è·¯å¾„æ£€æŸ¥ç»“æœ\n\n' +
                pathStatus.map(s => '- `' + s.path + '` - **' + s.type + '**').join('\n') + '\n\n'
              : '';

            const dirStatusReport = dirStatus.length > 0
              ? '### ğŸ“‚ ç›®å½•ç»“æ„æ£€æŸ¥ç»“æœ\n\n' +
                dirStatus.map(s => '- `' + s.dir + '` - **' + s.type + '**').join('\n') + '\n\n'
              : '';

            // 7. æ„å»ºå¢å¼ºçš„ Prompt
            const prompt = 'ä½ æ˜¯ä¸€åèµ„æ·±å‰ç«¯æ¶æ„å¸ˆ (Next.js ä¸“å®¶)ã€‚\n\n' +
              'ã€ä»»åŠ¡ç›®æ ‡ã€‘\n' +
              'åˆ†æç”¨æˆ·éœ€æ±‚ï¼ŒåŸºäºå½“å‰é¡¹ç›®ç»“æ„ï¼Œè§„åˆ’æ–‡ä»¶è·¯å¾„å’Œç›®å½•ç»“æ„ã€‚\n' +
              '**æ³¨æ„ï¼šä¸è¦å†™å…·ä½“çš„ä»£ç å®ç°ï¼Œåªè¾“å‡ºè®¾è®¡æ–¹æ¡ˆå’Œæ–‡ä»¶åˆ—è¡¨ã€‚**\n\n' +
              'ã€å½“å‰é¡¹ç›®ç›®å½•ç»“æ„ã€‘\n' +
              tree + '\n\n' +
              existingAssetsReport +
              pathStatusReport +
              dirStatusReport +
              (parentSpec ? 'ã€âš ï¸ çˆ¶çº§è§„èŒƒ - æœ€é«˜ä¼˜å…ˆçº§ã€‘\n' +
                'ä»¥ä¸‹å†…å®¹æ¥è‡ªçˆ¶çº§ Issueï¼Œ**å¿…é¡»ä¸¥æ ¼éµå®ˆ**ï¼Œç‰¹åˆ«æ˜¯ç›®å½•ç»“æ„å’Œæ–‡ä»¶è·¯å¾„ï¼š\n' +
                parentSpec + '\n\n' : '') +
              'ã€éœ€æ±‚æè¿°ã€‘\n' +
              fullContext + '\n\n' +
              'ã€è¡¥å……æŒ‡ä»¤ã€‘\n' +
              commentBody + '\n\n' +
              'ã€ä½ çš„å·¥ä½œã€‘\n' +
              'è¯·åŸºäºä»¥ä¸Šä¿¡æ¯ï¼Œå‘Šè¯‰å·¥ç¨‹å¸ˆåº”è¯¥åˆ›å»ºæˆ–ä¿®æ”¹å“ªäº›æ–‡ä»¶ã€‚\n\n' +
              '1. **æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥**ï¼š\n' +
              '   - å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œæ˜ç¡®æ ‡æ³¨ä¸º"ä¿®æ”¹"è€Œé"æ–°å»º"\n' +
              '   - å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ˜ç¡®æ ‡æ³¨ä¸º"æ–°å»º"\n' +
              '   - å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œæ˜ç¡®è¯´æ˜éœ€è¦æ–°å»ºç›®å½•\n\n' +
              '2. **è·¯å¾„æ£€æŸ¥**ï¼š\n' +
              '   - ä¸¥æ ¼éµå®ˆ Next.js App Router (app/page.tsx) è§„èŒƒ\n' +
              '   - å¦‚æœçˆ¶çº§è§„èŒƒä¸­æ˜ç¡®æŒ‡å®šäº†è·¯å¾„ï¼ˆå¦‚ app/(main)/video/page.tsxï¼‰ï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§çˆ¶çº§è§„èŒƒæ‰§è¡Œ\n\n' +
              '3. **å¤ç”¨æ£€æŸ¥**ï¼š\n' +
              '   - ä»”ç»†æ£€æŸ¥ä¸Šè¿°"ç°æœ‰é¡¹ç›®èµ„æº"ï¼Œå¦‚æœå·²æœ‰å¯å¤ç”¨çš„ç»„ä»¶ã€Hooksã€å·¥å…·å‡½æ•°ï¼Œ**å¿…é¡»æ˜ç¡®æŒ‡å‡ºåº”å¤ç”¨å®ƒ**\n' +
              '   - ä¸è¦é‡å¤é€ è½®å­ï¼Œä¼˜å…ˆä½¿ç”¨ç°æœ‰èµ„æº\n' +
              '   - å¦‚æœç°æœ‰èµ„æºä¸å®Œå…¨åŒ¹é…ï¼Œè¯´æ˜å¦‚ä½•åŸºäºç°æœ‰èµ„æºæ‰©å±•\n\n' +
              '4. **æ¶æ„åˆç†æ€§**ï¼š\n' +
              '   - å°† UI ç»„ä»¶ã€é¡µé¢é€»è¾‘ã€å·¥å…·å‡½æ•°åˆ†å¼€æ”¾ç½®\n' +
              '   - éµå¾ªé¡¹ç›®çš„ç›®å½•ç»“æ„è§„èŒƒ\n' +
              '   - è¯´æ˜ä¸ºä»€ä¹ˆè¿™ä¹ˆåˆ†é…ç›®å½•\n\n' +
              '5. **ç›®å½•æ–°å»ºéœ€æ±‚**ï¼š\n' +
              '   - æ˜ç¡®è¯´æ˜å“ªäº›ç›®å½•éœ€è¦æ–°å»º\n' +
              '   - è¯´æ˜æ–°å»ºç›®å½•çš„å¿…è¦æ€§å’Œç”¨é€”\n\n' +
              'ã€è¾“å‡ºæ ¼å¼ã€‘\n' +
              'è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š\n\n' +
              '## ğŸ—ï¸ å‰ç«¯å®æ–½æ–¹æ¡ˆ\n\n' +
              '### ğŸ“‹ æ–‡ä»¶æ¸…å•\n\n' +
              '#### âœ… éœ€æ–°å»ºæ–‡ä»¶\n' +
              '- `frontend/app/xxx/page.tsx`: (è¯´æ˜ç”¨é€”ï¼Œä¸ºä»€ä¹ˆéœ€è¦æ–°å»º)\n' +
              '- `frontend/components/xxx.tsx`: (è¯´æ˜ç»„ä»¶é€»è¾‘)\n\n' +
              '#### ğŸ”§ éœ€ä¿®æ”¹æ–‡ä»¶\n' +
              '- `frontend/app/xxx/page.tsx`: (è¯´æ˜éœ€è¦ä¿®æ”¹ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆ)\n\n' +
              '#### ğŸ“‚ éœ€æ–°å»ºç›®å½•\n' +
              '- `frontend/app/(main)/video/`: (è¯´æ˜ç›®å½•ç”¨é€”å’Œå¿…è¦æ€§)\n\n' +
              '### ğŸ”„ å¤ç”¨ç°æœ‰èµ„æº\n' +
              '- `components/ui/button.tsx`: (è¯´æ˜å¦‚ä½•å¤ç”¨ï¼Œæ˜¯å¦éœ€è¦æ‰©å±•)\n' +
              '- `hooks/use-debounce.ts`: (è¯´æ˜å¦‚ä½•å¤ç”¨)\n\n' +
              '### ğŸ’¡ è®¾è®¡æ€è·¯\n' +
              '(ç®€è¿°ä¸ºä»€ä¹ˆè¿™ä¹ˆåˆ†é…ç›®å½•ï¼Œæ¶æ„è®¾è®¡çš„è€ƒè™‘ï¼Œä»¥åŠå¦‚ä½•æœ€å¤§åŒ–å¤ç”¨ç°æœ‰èµ„æº)';

            console.log("ğŸ¤– æ­£åœ¨è°ƒç”¨ OpenRouter AI...");

            // 8. è°ƒç”¨ AI
            const aiRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: "anthropic/claude-sonnet-4.5",
                messages: [{ role: "user", content: prompt }]
              })
            });

            if (!aiRes.ok) {
                const errText = await aiRes.text();
                throw new Error(`OpenRouter Error: ${aiRes.status} - ${errText}`);
            }
            
            const aiData = await aiRes.json();
            const plan = aiData.choices[0].message.content;

            // 9. å›å¤è¯„è®º
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: plan
            });
            console.log("âœ… æ–¹æ¡ˆå·²å‘å¸ƒåˆ°è¯„è®ºåŒº");