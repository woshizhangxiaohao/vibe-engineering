name: 'Load Prompt Template'
description: 'ä»æ–‡ä»¶åŠ è½½ prompt æ¨¡æ¿å¹¶æ¸²æŸ“å˜é‡'

inputs:
  template:
    description: 'æ¨¡æ¿æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹äº .github/prompts/ï¼‰'
    required: true
  variables:
    description: 'JSON æ ¼å¼çš„å˜é‡æ˜ å°„ï¼Œç”¨äºæ›¿æ¢æ¨¡æ¿ä¸­çš„ {{variable}} å ä½ç¬¦'
    required: false
    default: '{}'

outputs:
  prompt:
    description: 'æ¸²æŸ“åçš„ prompt å†…å®¹'
    value: ${{ steps.render.outputs.prompt }}

runs:
  using: 'composite'
  steps:
    - name: Render Prompt Template
      id: render
      shell: bash
      env:
        TEMPLATE_PATH: ${{ inputs.template }}
        VARIABLES_JSON: ${{ inputs.variables }}
      run: |
        FULL_PATH=".github/prompts/${TEMPLATE_PATH}"

        if [ ! -f "$FULL_PATH" ]; then
          echo "âŒ æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨: $FULL_PATH"
          exit 1
        fi

        echo "ğŸ“„ åŠ è½½æ¨¡æ¿: $FULL_PATH"

        # è¯»å–æ¨¡æ¿å†…å®¹
        CONTENT=$(cat "$FULL_PATH")

        # ä½¿ç”¨ Node.js æ¸²æŸ“å˜é‡ï¼ˆæ›´å¯é åœ°å¤„ç†å¤šè¡Œå†…å®¹å’Œç‰¹æ®Šå­—ç¬¦ï¼‰
        node << 'NODEJS_SCRIPT'
        const fs = require('fs');

        const templatePath = process.env.FULL_PATH || '.github/prompts/' + process.env.TEMPLATE_PATH;
        const variablesJson = process.env.VARIABLES_JSON || '{}';

        let content = fs.readFileSync(templatePath, 'utf8');
        let variables = {};

        try {
          variables = JSON.parse(variablesJson);
        } catch (e) {
          console.error('âš ï¸ æ— æ³•è§£æå˜é‡ JSON:', e.message);
        }

        // æ›¿æ¢ {{variable}} æ ¼å¼çš„å ä½ç¬¦
        for (const [key, value] of Object.entries(variables)) {
          const placeholder = new RegExp(`\\{\\{\\s*${key}\\s*\\}\\}`, 'g');
          content = content.replace(placeholder, String(value));
        }

        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœªæ›¿æ¢çš„å ä½ç¬¦
        const unreplaced = content.match(/\{\{\s*\w+\s*\}\}/g);
        if (unreplaced) {
          console.warn('âš ï¸ å­˜åœ¨æœªæ›¿æ¢çš„å ä½ç¬¦:', [...new Set(unreplaced)].join(', '));
        }

        // å†™å…¥ GitHub è¾“å‡ºï¼ˆå¤„ç†å¤šè¡Œå†…å®¹ï¼‰
        const outputFile = process.env.GITHUB_OUTPUT;
        if (outputFile) {
          const delimiter = 'EOF_' + Math.random().toString(36).substring(7);
          fs.appendFileSync(outputFile, `prompt<<${delimiter}\n${content}\n${delimiter}\n`);
        }

        console.log('âœ… Prompt æ¸²æŸ“å®Œæˆ');
        console.log('ğŸ“Š å˜é‡æ•°é‡:', Object.keys(variables).length);
        console.log('ğŸ“ å†…å®¹é•¿åº¦:', content.length, 'å­—ç¬¦');
        NODEJS_SCRIPT
