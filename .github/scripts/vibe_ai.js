const axios = require('axios');

async function askAI(prompt, model = "anthropic/claude-3.5-sonnet") {
  const res = await axios.post('https://openrouter.ai/api/v1/chat/completions', {
    model: model,
    messages: [{ role: "user", content: prompt }]
  }, {
    headers: {
      'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
      'HTTP-Referer': 'https://github.com/vibe-kanban'
    }
  });
  return res.data.choices[0].message.content;
}

if (process.env.EVENT_CONTEXT === 'issues') {
  const issue = context.payload.issue;
  const prompt = `[Vibe Mode: Spec Generation]
  éœ€æ±‚ï¼š${issue.title} - ${issue.body}
  ä½œä¸ºå…¨æ ˆä¸“å®¶ï¼Œè¯·æŒ‰ç…§ Context, Backend (Go), Frontend (Next.js), Checklist ç»“æ„ç»™å‡ºç®€æ´çš„æŠ€æœ¯æ¥åŠ›å¡ç‰‡ã€‚`;
  
  const response = await askAI(prompt);
  await github.rest.issues.createComment({
    ...context.repo,
    issue_number: issue.number,
    body: `## ğŸŒŠ Vibe Relay Card\n\n${response}\n\n--- \n*Generated by OpenRouter AI*`
  });

} else if (process.env.EVENT_CONTEXT === 'pull_request') {
  const pr = context.payload.pull_request;
  const { data: diff } = await github.rest.pulls.get({
    ...context.repo,
    pull_number: pr.number,
    mediaType: { format: 'diff' }
  });

  const prompt = `[Vibe Mode: Night Watch]
  åˆ†ææ­¤ Go/Next.js çš„ diffã€‚
  ç»™å‡º Vibe Score (1-10)ï¼ŒæŒ‡å‡º Critical Fixes å’Œ 1 ä¸ªä¼˜åŒ–å»ºè®®ã€‚
  Diff: ${diff.slice(0, 4000)}`;

  const response = await askAI(prompt);
  await github.rest.issues.createComment({
    ...context.repo,
    issue_number: pr.number,
    body: `### ğŸ›¡ï¸ AI Guard Report\n\n${response}`
  });
}
